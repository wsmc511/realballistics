<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ballistic Calculator</title>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ballistic Calculator">
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#f5f5f5">
    <!-- Icons for PWA -->
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="icon" href="/icons/icon-192.png">
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 15px;
            background-color: #f5f5f5;
            padding-bottom: 20px;
        }
        h2 { 
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #333;
        }
        .form-group { 
            margin-bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        label { 
            display: inline-block;
            width: 100%;
            max-width: 180px;
            color: #555;
            font-size: 0.9rem;
        }
        input, select { 
            width: 100%;
            max-width: 200px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        button { 
            margin: 5px 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            min-width: 80px;
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        button.add-session { 
            background-color: #28a745; 
            color: white; 
        }
        button.add-session:hover { 
            background-color: #218838; 
        }
        button.calculate-save { 
            background-color: #28a745; 
            color: white; 
        }
        button.calculate-save:hover { 
            background-color: #218838; 
        }
        button.cancel-edit { 
            background-color: #ffc107; 
            color: white; 
        }
        button.cancel-edit:hover { 
            background-color: #e0a800; 
        }
        button.view-all { 
            background-color: #007bff; 
            color: white; 
        }
        button.view-all:hover { 
            background-color: #0056b3; 
        }
        button.clear-all { 
            background-color: #6c757d; 
            color: white; 
        }
        button.clear-all:hover { 
            background-color: #5a6268; 
        }
        button.search { 
            background-color: #17a2b8; 
            color: white; 
        }
        button.search:hover { 
            background-color: #138496; 
        }
        button.clear-search { 
            background-color: #dc3545; 
            color: white; 
        }
        button.clear-search:hover { 
            background-color: #c82333; 
        }
        button.delete-selected { 
            background-color: #ff6f61; 
            color: white; 
        }
        button.delete-selected:hover { 
            background-color: #ff4d3d; 
        }
        button.compare-selected { 
            background-color: #20c997; 
            color: white; 
        }
        button.compare-selected:hover { 
            background-color: #1ba87e; 
        }
        button.view-session, button.edit-session { 
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
        button.view-session { 
            background-color: #007bff; 
            color: white; 
        }
        button.view-session:hover { 
            background-color: #0056b3; 
        }
        button.edit-session { 
            background-color: #17a2b8; 
            color: white; 
        }
        button.edit-session:hover { 
            background-color: #138496; 
        }
        button.login, button.logout, button.reset-password { 
            background-color: #007bff; 
            color: white; 
        }
        button.login:hover, button.logout:hover, button.reset-password:hover { 
            background-color: #0056b3; 
        }
        button.back-to-login { 
            background-color: #6c757d; 
            color: white; 
        }
        button.back-to-login:hover { 
            background-color: #5a6268; 
        }
        table { 
            border-collapse: collapse;
            margin-top: 10px;
            width: 100%;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd;
            padding: 6px;
            text-align: right;
            font-size: 0.85rem;
        }
        th { 
            background-color: #f2f2f2;
            color: #333;
        }
        td:first-child, th:first-child { 
            text-align: center;
        }
        .message { 
            color: green;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        .error { 
            color: red;
            font-size: 0.9rem;
        }
        .session-controls { 
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .search-group { 
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
        }
        #ballisticForm { 
            display: none;
            margin-top: 10px;
        }
        .filter-section {
            display: none !important;
        }
        .filter-section.active {
            display: block !important;
        }
        .toggle-filter {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .toggle-filter:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        .forgot-password {
            display: block;
            margin: 5px 0;
            font-size: 0.9rem;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .forgot-password:hover {
            text-decoration: underline;
        }
        #resetPasswordForm {
            display: none;
            margin-top: 10px;
        }
        @media (max-width: 576px) {
            body {
                margin: 10px;
                padding-bottom: 15px;
            }
            h2 {
                font-size: 1.1rem;
            }
            label {
                font-size: 0.85rem;
                max-width: 100%;
            }
            input, select {
                font-size: 0.85rem;
                max-width: 100%;
            }
            button {
                font-size: 0.85rem;
                padding: 6px 10px;
                min-width: 70px;
            }
            button.view-session, button.edit-session {
                font-size: 0.75rem;
                padding: 3px 6px;
            }
            th, td {
                font-size: 0.75rem;
                padding: 4px;
            }
            .trajectory-table th, .trajectory-table td {
                font-size: 0.7rem;
                padding: 3px;
            }
            .trajectory-table th:nth-child(1), .trajectory-table td:nth-child(1),
            .trajectory-table th:nth-child(2), .trajectory-table td:nth-child(2),
            .trajectory-table th:nth-child(3), .trajectory-table td:nth-child(3) {
                font-weight: bold;
            }
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .session-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .search-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-section {
                display: none !important;
            }
            .filter-section.active {
                display: block !important;
            }
            .forgot-password {
                font-size: 0.85rem;
            }
        }
        .trajectory-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #trajectoryTitle {
            display: inline-block;
        }
        #trajectoryDescription {
            font-size: 0.9rem;
            color: #555;
            font-style: italic;
        }
        #compareForm {
            display: none;
            margin-top: 10px;
        }
        .flattest-trajectory {
            background-color: #28a745 !important;
            color: white;
        }
        #loginForm {
            margin-top: 20px;
            display: none;
        }
        #appContent {
            display: none;
        }
        .user-info {
            margin-bottom: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Sticky header for trajectory table */
        .trajectory-table {
            position: relative;
        }
        .trajectory-table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Sticky header for comparison table */
        #comparisonTable {
            position: relative;
        }
        #comparisonTable thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
</head>
<body>
    <div id="loginForm">
        <h2>Login to Ballistic Calculator</h2>
        <form id="authForm">
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="login_email" autocomplete="email">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="login_password" autocomplete="current-password">
            </div>
            <button type="button" class="login" onclick="login()">Login</button>
            <button type="button" class="login" onclick="signup()">Sign Up</button>
        </form>
        <a class="forgot-password" onclick="showResetPasswordForm()">Forgot Password?</a>
        <form id="resetPasswordForm">
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="reset_email" autocomplete="email">
            </div>
            <button type="button" class="reset-password" onclick="resetPassword()">Reset Password</button>
            <button type="button" class="back-to-login" onclick="showLoginForm()">Back to Login</button>
        </form>

        <form id="newPasswordForm" style="display: none;">
            <h3>Set New Password</h3>
            <div class="form-group">
                <label>New Password:</label>
                <input type="password" id="new_password" autocomplete="new-password" placeholder="Enter your new password">
            </div>
            <div class="form-group">
                <label>Confirm Password:</label>
                <input type="password" id="confirm_password" autocomplete="new-password" placeholder="Confirm your new password">
            </div>
            <button type="button" class="reset-password" onclick="updatePassword()">Update Password</button>
            <button type="button" class="back-to-login" onclick="showLoginForm()">Back to Login</button>
        </form>
        <div id="authMessage"></div>
    </div>

    <div id="appContent">
        <div class="user-info">
            <span id="userEmail"></span>
            <button class="logout" onclick="logout()">Logout</button>
        </div>
        <!-- Home Page Section -->
        <div id="homePage" style="display: block;">
            <div style="text-align: center; padding: 40px 20px;">
                <h1 style="color: #333; margin-bottom: 10px;">Welcome to Real Ballistics</h1>
                <p style="color: #666; margin-bottom: 40px; font-size: 1.1em;">Professional ballistic calculation and ammunition management system</p>
                
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <button class="home-nav-button" onclick="showZeroProfile()" style="background-color: #007BFF; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ?  Shooting Profile
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Calculate trajectories, manage sessions</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showFirearmLibrary()" style="background-color: #17a2b8; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        🔫 Firearm Library
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Manage firearm profiles</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showBulletLibrary()" style="background-color: #28a745; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ?  Bullet Library
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Manage ammunition database</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showDOPE()" style="background-color: #dc3545; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ?  DOPE
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Data On Previous Engagements</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Shooting Profile Section -->
        <div id="shootingProfileSection" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                <h2 style="margin: 0;">Zero Profile</h2>
            </div>
            <button class="add-session" onclick="toggleForm()">Add New</button>
        <form id="ballisticForm">
            <div class="form-group">
                <label>Load from Firearm Library:</label>
                <select id="zeroFirearmSelect" onchange="loadZeroFirearmData()">
                    <option value="">Select a saved firearm (optional)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Load from Bullet Library:</label>
                <select id="zeroBulletSelect" onchange="loadZeroBulletData()">
                    <option value="">Select a saved bullet (optional)</option>
                </select>
            </div>
            <hr style="margin: 20px 0; border: 1px solid #ddd;">
            <div class="form-group">
                <label>Shooter Name:</label>
                <input type="text" name="shooter_name">
            </div>
            <div class="form-group">
                <label>Firearm Type:</label>
                <select name="firearm_type">
                    <option value="">Select</option>
                    <option value="Rifle">Rifle</option>
                    <option value="Pistol">Pistol</option>
                </select>
            </div>
            <div class="form-group">
                <label>Firearm Name:</label>
                <input type="text" name="firearm_name">
            </div>
            <div class="form-group">
                <label>Optic Name:</label>
                <input type="text" name="optic_name">
            </div>
            <div class="form-group">
                <label>Caliber:</label>
                <input type="text" name="caliber">
            </div>
            <div class="form-group">
                <label>Barrel Length (inches):</label>
                <input type="number" step="0.1" name="barrel_length">
            </div>
            <div class="form-group">
                <label>Barrel Twist Rate:</label>
                <select name="barrel_twist_rate">
                    <option value="">Select Twist Rate</option>
                    <option value="1:7">1:7</option>
                    <option value="1:8">1:8</option>
                    <option value="1:9">1:9</option>
                    <option value="1:9.25">1:9.25</option>
                    <option value="1:10">1:10</option>
                    <option value="1:10.5">1:10.5</option>
                    <option value="1:11">1:11</option>
                    <option value="1:12">1:12</option>
                    <option value="1:14">1:14</option>
                    <option value="1:16">1:16</option>
                    <option value="1:18.75">1:18.75</option>
                    <option value="1:20">1:20</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bullet Grain (gr):</label>
                <input type="number" name="bullet_grain">
            </div>
            <div class="form-group">
                <label>Muzzle Velocity (fps):</label>
                <input type="number" name="muzzle_velocity">
            </div>
            <div class="form-group">
                <label>Muzzle Energy (ft-lbs):</label>
                <input type="number" name="muzzle_energy">
            </div>
            <div class="form-group">
                <label>Ballistic Coefficient:</label>
                <input type="number" step="0.001" name="ballistic_coefficient">
            </div>
            <div class="form-group">
                <label>Zero Distance (yards):</label>
                <input type="number" name="zero_distance">
            </div>
            <div class="form-group">
                <label>Height Over Bore (inches):</label>
                <input type="number" step="0.01" name="height_over_bore">
            </div>
            <div class="form-group">
                <label>Drag Model:</label>
                <select name="drag_model">
                    <option value="">Select</option>
                    <option value="G1">G1</option>
                    <option value="G7">G7</option>
                </select>
            </div>
            <div class="form-group">
                <label>Step Interval (yards):</label>
                <input type="number" name="step_interval_yards">
            </div>
            <div class="form-group">
                <label>Max Distance (yards):</label>
                <input type="number" name="max_distance_yards">
            </div>
            <div class="form-group">
                <label>Wind Speed (mph):</label>
                <input type="number" name="wind_speed">
            </div>
            <div class="form-group">
                <label>Wind Angle (degrees):</label>
                <input type="number" name="wind_angle">
            </div>
            <button type="button" class="calculate-save" onclick="calculateAndSave()">Calculate & Save</button>
            <button type="button" class="cancel-edit" onclick="cancelEdit()" style="display: none;" id="cancelEditButton">Cancel Edit</button>
        </form>

        <!-- Bullet Library Section -->
        <div id="bulletLibrarySection" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                <h2 style="margin: 0;">Bullet Library</h2>
            </div>
            <button class="add-session" onclick="showAddBulletForm()">Add New Bullet</button>
            
            <!-- Add Bullet Form -->
            <form id="addBulletForm" style="display: none; margin-top: 15px; background-color: white; padding: 15px; border-radius: 5px;">
                <h3>Add New Bullet</h3>
                <div class="form-group">
                    <label>Manufacturer Name:</label>
                    <input type="text" id="bullet_manufacturer" placeholder="e.g. Federal, Hornady, Barnes" required>
                </div>
                <div class="form-group">
                    <label>Caliber:</label>
                    <input type="text" id="bullet_caliber" placeholder="e.g. .308 Win, 6.5 Creedmoor" required>
                </div>
                <div class="form-group">
                    <label>Grain:</label>
                    <input type="number" id="bullet_grain" min="10" max="1000" placeholder="e.g. 168" required>
                </div>
                <div class="form-group">
                    <label>Ballistic Coefficient:</label>
                    <input type="number" id="bullet_bc" step="0.001" min="0.100" max="1.000" placeholder="e.g. 0.462" required>
                </div>
                <div class="form-group">
                    <label>Drag Model:</label>
                    <select id="bullet_drag_model" required>
                        <option value="">Select Drag Model</option>
                        <option value="G1">G1</option>
                        <option value="G7">G7</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bullet Type:</label>
                    <select id="bullet_type" required>
                        <option value="">Select Type</option>
                        <option value="FMJ">FMJ (Full Metal Jacket)</option>
                        <option value="HP">HP (Hollow Point)</option>
                        <option value="SP">SP (Soft Point)</option>
                        <option value="JHP">JHP (Jacketed Hollow Point)</option>
                        <option value="OTM">OTM (Open Tip Match)</option>
                        <option value="AP">AP (Armor Piercing)</option>
                    </select>
                </div>
                <button type="button" onclick="saveBullet()" class="add-session">Save Bullet</button>
                <button type="button" onclick="cancelAddBullet()" class="back-to-login">Cancel</button>
            </form>

            <!-- Bullet Library Table -->
            <div id="bulletLibraryTable" style="margin-top: 15px;">
                <table id="bulletTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Manufacturer</th>
                            <th>Caliber</th>
                            <th>Grain</th>
                            <th>BC</th>
                            <th>Drag</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulletTableBody">
                    </tbody>
                </table>
                <div id="noBulletsMessage" style="text-align: center; padding: 20px; color: #666;">
                    No bullets in your library yet. Click "Add New Bullet" to get started!
                </div>
            </div>
        </div>

        <!-- DOPE Section -->
        <div id="dopeSection" style="display: none; padding: 20px; background-color: white; min-height: 400px; position: relative; z-index: 1000;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                <h2 style="margin: 0;">DOPE - Data On Previous Engagements</h2>
            </div>
            <button class="add-session" onclick="showAddDopeForm()">Log New Engagement</button>
            
            <!-- Add DOPE Form -->
            <form id="addDopeForm" style="display: none; margin-top: 15px; background-color: white; padding: 15px; border-radius: 5px;">
                <h3>Log New Engagement</h3>
                
                <!-- Reference Data Selection -->
                <div class="form-group">
                    <label>Shooting Profile (Optional):</label>
                    <select id="dope_shooting_profile" onchange="populateFromShootingProfile()">
                        <option value="">Select a shooting profile...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Bullet Library (Optional):</label>
                    <select id="dope_bullet_library" onchange="populateFromBulletLibrary()">
                        <option value="">Select a bullet...</option>
                    </select>
                </div>
                
                <!-- Date and Time -->
                <div class="form-group">
                    <label>Engagement Date:</label>
                    <input type="date" id="engagement_date" required>
                </div>
                
                <div class="form-group">
                    <label>Engagement Time:</label>
                    <input type="time" id="engagement_time">
                </div>
                
                <!-- Range Data -->
                <div class="form-group">
                    <label>Range to Target:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="range_to_target" step="0.01" placeholder="Distance" required>
                        <select id="range_unit" required>
                            <option value="">Unit</option>
                            <option value="meters">Meters</option>
                            <option value="yards">Yards</option>
                        </select>
                    </div>
                </div>
                
                <!-- Wind Conditions -->
                <div class="form-group">
                    <label>Wind Speed:</label>
                    <input type="number" id="wind_speed" step="0.1" placeholder="Speed (mph/kph)">
                </div>
                
                <div class="form-group">
                    <label>Wind Direction (degrees):</label>
                    <input type="number" id="wind_direction" min="0" max="360" step="0.1" placeholder="0-360">
                </div>
                
                <div class="form-group">
                    <label>Wind Type:</label>
                    <select id="wind_type">
                        <option value="">Select Type</option>
                        <option value="Crosswind">Crosswind</option>
                        <option value="Headwind">Headwind</option>
                        <option value="Tailwind">Tailwind</option>
                    </select>
                </div>
                
                <!-- Environmental Conditions -->
                <div class="form-group">
                    <label>Temperature:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="temperature" step="0.1" placeholder="Temperature">
                        <select id="temperature_unit">
                            <option value="">Unit</option>
                            <option value="C">Celsius</option>
                            <option value="F" selected>Fahrenheit</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Barometric Pressure:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="barometric_pressure" step="0.01" placeholder="Pressure">
                        <select id="pressure_unit">
                            <option value="">Unit</option>
                            <option value="inHg" selected>inHg</option>
                            <option value="mb">mb</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Humidity (%):</label>
                    <input type="number" id="humidity" min="0" max="100" step="0.1" placeholder="0-100">
                </div>
                
                <div class="form-group">
                    <label>Altitude:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="altitude" step="0.1" placeholder="Meters">
                        <select id="altitude_reference">
                            <option value="">Reference</option>
                            <option value="Above Sea Level" selected>Above Sea Level</option>
                            <option value="Below Sea Level">Below Sea Level</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ballistic Factors -->
                <div class="form-group">
                    <label>Angle of Fire (degrees):</label>
                    <input type="number" id="angle_of_fire" min="-90" max="90" step="0.01" placeholder="-90 to 90">
                </div>
                
                <div class="form-group">
                    <label>Spin Drift:</label>
                    <input type="number" id="spin_drift" step="0.0001" placeholder="Drift value">
                </div>
                
                <div class="form-group">
                    <label>Coriolis Effect:</label>
                    <input type="number" id="coriolis_effect" step="0.0001" placeholder="Effect value">
                </div>
                
                <!-- Target Movement -->
                <div class="form-group">
                    <label>Target Movement Speed:</label>
                    <input type="number" id="target_movement_speed" step="0.01" placeholder="Speed">
                </div>
                
                <div class="form-group">
                    <label>Target Movement Direction (degrees):</label>
                    <input type="number" id="target_movement_direction" min="0" max="360" step="0.1" placeholder="0-360">
                </div>
                
                <!-- Equipment Settings -->
                <div class="form-group">
                    <label>Optic Magnification:</label>
                    <input type="number" id="optic_magnification" step="0.1" placeholder="e.g. 4.5">
                </div>
                
                <div class="form-group">
                    <label>Optic Adjustment Units:</label>
                    <select id="optic_adjustment_units">
                        <option value="">Select Units</option>
                        <option value="MOA">MOA</option>
                        <option value="MRAD">MRAD</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Parallax Setting (meters):</label>
                    <input type="number" id="parallax_setting" step="0.1" placeholder="Distance">
                </div>
                
                <!-- Conditions and Outcome -->
                <div class="form-group">
                    <label>Atmospheric Conditions:</label>
                    <textarea id="atmospheric_conditions" placeholder="Describe atmospheric conditions..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Barrel Condition:</label>
                    <input type="text" id="barrel_condition" placeholder="e.g. Clean, Fouled, Hot">
                </div>
                
                <div class="form-group">
                    <label>Time of Flight (seconds):</label>
                    <input type="number" id="time_of_flight" step="0.001" placeholder="Flight time">
                </div>
                
                <div class="form-group">
                    <label>Light Conditions:</label>
                    <input type="text" id="light_conditions" placeholder="e.g. Bright sun, Overcast, Dawn">
                </div>
                
                <div class="form-group">
                    <label>Engagement Outcome:</label>
                    <input type="text" id="engagement_outcome" placeholder="e.g. Hit center, Miss high, First round hit">
                </div>
                
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="engagement_notes" placeholder="Additional notes about the engagement..."></textarea>
                </div>
                
                <button type="button" onclick="saveDope()" class="add-session">Save Engagement</button>
                <button type="button" onclick="cancelAddDope()" class="back-to-login">Cancel</button>
            </form>

            <!-- DOPE Table -->
            <div id="dopeTable" style="margin-top: 15px;">
                <h3>Previous Engagements</h3>
                <table id="dopeEngagementsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Range</th>
                            <th>Wind</th>
                            <th>Temperature</th>
                            <th>Outcome</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dopeTableBody">
                    </tbody>
                </table>
                <div id="noDopeMessage" style="text-align: center; padding: 20px; color: #666;">
                    No engagements logged yet. Click "Log New Engagement" to get started!
                </div>
            </div>
        </div>

            <div id="message"></div>

            <h2>Filter</h2>
            <button class="toggle-filter" onclick="toggleFilters()">Show Filters</button>
            <div class="filter-section" id="filterSection">
            <div class="session-controls">
                <button class="view-all" onclick="viewAll()">View All</button>
                <button class="clear-all" onclick="clearAll()">Clear All</button>
                <div class="search-group">
                    <label>Shooter Name:</label>
                    <input type="text" id="search_shooter_name">
                </div>
                <div class="search-group">
                    <label>Firearm Type:</label>
                    <select id="search_firearm_type">
                        <option value="">All</option>
                        <option value="Rifle">Rifle</option>
                        <option value="Pistol">Pistol</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>Firearm Name:</label>
                    <input type="text" id="search_firearm_name">
                </div>
                <div class="search-group">
                    <label>Bullet Grain (gr):</label>
                    <input type="number" id="search_bullet_grain">
                </div>
                <div class="search-group">
                    <label>Barrel Length (in):</label>
                    <input type="number" step="0.1" id="search_barrel_length">
                </div>
                <div class="search-group">
                    <label>Zero Distance (yd):</label>
                    <input type="number" id="search_zero_distance">
                </div>
                <button class="search" onclick="searchSessions()">Search</button>
                <button class="clear-search" onclick="clearSearch()">Clear Search</button>
                <button class="delete-selected" onclick="deleteSelected()">Delete Selected</button>
                <button class="compare-selected" onclick="showCompareForm()">Compare Selected</button>
            </div>
        </div>

        <form id="compareForm">
            <div class="form-group">
                <label>Step Interval (yards):</label>
                <input type="number" id="compare_step_interval" name="compare_step_interval" placeholder="Enter Value">
            </div>
            <div class="form-group">
                <label>Max Distance (yards):</label>
                <input type="number" id="compare_max_distance" name="compare_max_distance" placeholder="Enter Value">
            </div>
            <button type="button" class="calculate-save" onclick="compareSelected()">Compare</button>
            <button type="button" class="cancel-edit" onclick="hideCompareForm()">Cancel</button>
        </form>

        <h2>Saved</h2>
        <table id="sessionsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllSessions" onchange="toggleSelectAllSessions()"> Select</th>
                    <th>Shooter</th>
                    <th>Firearm Type</th>
                    <th>Firearm</th>
                    <th>Optic</th>
                    <th>Caliber</th>
                    <th>Barrel</th>
                    <th>Twist</th>
                    <th>Gr</th>
                    <th>Zero</th>
                    <th>Range</th>
                    <th>Step</th>
                    <th>HOB</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sessionsBody"></tbody>
        </table>

        <div class="trajectory-header">
            <h2 id="trajectoryTitle">Trajectory Grid</h2>
            <span id="trajectoryDescription"></span>
        </div>
        <table id="trajectoryTable" class="trajectory-table">
            <thead>
                <tr>
                    <th>Distance (yd)</th>
                    <th>Hold (in)</th>
                    <th>Hold (MOA)</th>
                    <th>Velocity (fps)</th>
                    <th>Energy (ft-lbs)</th>
                    <th>Drop (in)</th>
                </tr>
            </thead>
            <tbody id="trajectoryBody"></tbody>
        </table>

            <h2 id="comparisonTitle" style="display: none;">Trajectory Comparison</h2>
            <table id="comparisonTable" style="display: none;">
                <thead id="comparisonTableHead"></thead>
                <tbody id="comparisonTableBody"></tbody>
            </table>
        </div>
        <!-- End Shooting Profile Section -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // Navigation Functions
        window.showHomePage = function() {
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('shootingProfileSection').style.display = 'none';
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('ballisticForm').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
            const filterSection = document.getElementById('filterSection');
            if (filterSection) filterSection.style.display = 'none';
            
            // Remove the active bullet library content to fix display issue
            const activeBulletLibrary = document.getElementById('activeBulletLibrary');
            if (activeBulletLibrary) {
                activeBulletLibrary.remove();
            }
        };

        window.showShootingProfile = function() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('shootingProfileSection').style.display = 'block';
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('ballisticForm').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
            
            // Remove any active bullet library content to prevent interference
            const activeBulletLibrary = document.getElementById('activeBulletLibrary');
            if (activeBulletLibrary) {
                activeBulletLibrary.remove();
            }
            
            // Reset filter section state properly using CSS classes
            const filterSection = document.getElementById('filterSection');
            const filterButton = document.querySelector('button[onclick="toggleFilters()"]');
            if (filterSection && filterButton) {
                filterSection.classList.remove('active');
                filterButton.textContent = 'Show Filters';
            }
            
            // Ensure toggleFilters function is properly bound after section switch
            setTimeout(() => {
                const toggleButton = document.querySelector('.toggle-filter');
                console.log('Rebinding toggle button:', !!toggleButton);
                if (toggleButton) {
                    // Remove any existing event listeners and re-add
                    toggleButton.onclick = null;
                    toggleButton.onclick = function() { 
                        console.log('Button clicked, calling toggleFilters');
                        window.toggleFilters(); 
                    };
                    console.log('Toggle button rebound successfully');
                }
            }, 100);
            
            viewAll(); // Load the shooting sessions
            loadBulletLibraryDropdown(); // Load bullet library options
        };

        // Define bullet library functions first for immediate button access
        window.showBulletLibrary = async function() {
            // Simple, direct approach - create bullet library content in the main content area
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('shootingProfileSection').style.display = 'none';
            
            // Hide all other sections first
            const hideElement = (id) => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            };
            hideElement('bulletLibrarySection');
            hideElement('filterSection');
            hideElement('ballisticForm');
            hideElement('compareForm');
            hideElement('compareResults');
            hideElement('addBulletForm');
            
            // Create bullet library directly in the main app content
            const appContent = document.getElementById('appContent');
            const bulletContent = document.createElement('div');
            bulletContent.id = 'activeBulletLibrary';
            bulletContent.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                        <h2 style="margin: 0;">Bullet Library</h2>
                    </div>
                    <button onclick="showAddBulletFormDirect()" style="background-color: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Add New Bullet</button>
                    <div id="bulletLibraryContent">Loading your bullets...</div>
                </div>
            `;
            
            // Remove any existing active bullet library
            const existing = document.getElementById('activeBulletLibrary');
            if (existing) existing.remove();
            
            // Add the new bullet library
            appContent.appendChild(bulletContent);
            
            // Load the bullets
            await loadBulletLibraryDirect();
        };

        window.hideBulletLibrary = function() {
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.showAddBulletForm = function() {
            document.getElementById('addBulletForm').style.display = 'block';
            document.getElementById('bullet_manufacturer').value = '';
            document.getElementById('bullet_caliber').value = '';
            document.getElementById('bullet_grain').value = '';
            document.getElementById('bullet_bc').value = '';
            document.getElementById('bullet_drag_model').value = '';
            document.getElementById('bullet_type').value = '';
        };

        window.cancelAddBullet = function() {
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.saveBullet = async function() {
            const manufacturer = document.getElementById('bullet_manufacturer').value.trim();
            const caliber = document.getElementById('bullet_caliber').value.trim();
            const grain = parseInt(document.getElementById('bullet_grain').value);
            const bc = parseFloat(document.getElementById('bullet_bc').value);
            const dragModel = document.getElementById('bullet_drag_model').value;
            const bulletType = document.getElementById('bullet_type').value;

            if (!manufacturer || !caliber || !grain || !bc || !dragModel || !bulletType) {
                alert('Please fill in all fields');
                return;
            }

            if (bc < 0.1 || bc > 1.0) {
                alert('Ballistic coefficient must be between 0.1 and 1.0');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .insert([{
                        user_id: currentUser.id,
                        manufacturer_name: manufacturer,
                        caliber: caliber,
                        grain: grain,
                        ballistic_coefficient: bc,
                        drag_model: dragModel,
                        bullet_type: bulletType
                    }]);

                if (error) {
                    console.error('Error saving bullet:', error);
                    alert('Error saving bullet. Please try again.');
                } else {
                    console.log('Bullet saved successfully');
                    document.getElementById('addBulletForm').style.display = 'none';
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error saving bullet. Please try again.');
            }
        };

        window.loadBulletLibrary = async function() {
            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('manufacturer_name', { ascending: true });

                if (error) {
                    console.error('Error loading bullets:', error);
                    return;
                }

                const tableBody = document.getElementById('bulletTableBody');
                const table = document.getElementById('bulletTable');
                const noMessage = document.getElementById('noBulletsMessage');

                if (data && data.length > 0) {
                    table.style.display = 'table';
                    noMessage.style.display = 'none';
                    
                    tableBody.innerHTML = '';
                    data.forEach(bullet => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${bullet.manufacturer_name}</td>
                            <td>${bullet.caliber}</td>
                            <td>${bullet.grain}</td>
                            <td>${bullet.ballistic_coefficient}</td>
                            <td>${bullet.drag_model}</td>
                            <td>${bullet.bullet_type}</td>
                            <td>
                                <button onclick="deleteBullet(${bullet.id})" class="back-to-login" style="padding: 4px 8px; margin: 2px;">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    table.style.display = 'none';
                    noMessage.style.display = 'block';
                }
            } catch (e) {
                console.error('Error loading bullet library:', e);
            }
        };

        window.deleteBullet = async function(bulletId) {
            if (!confirm('Are you sure you want to delete this bullet?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('bullet_library')
                    .delete()
                    .eq('id', bulletId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error deleting bullet:', error);
                    alert('Error deleting bullet. Please try again.');
                } else {
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error deleting bullet. Please try again.');
            }
        };

        // Temporarily disable Service Worker to fix caching issues
        // Will re-enable after filter functionality is working
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js?v=4')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                        registration.update();
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        */

        // Bullet Library Functions - Global scope for button access (using the first definition above)

        window.hideBulletLibrary = function() {
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.showAddBulletForm = function() {
            document.getElementById('addBulletForm').style.display = 'block';
            document.getElementById('bullet_manufacturer').value = '';
            document.getElementById('bullet_caliber').value = '';
            document.getElementById('bullet_grain').value = '';
            document.getElementById('bullet_bc').value = '';
            document.getElementById('bullet_drag_model').value = '';
            document.getElementById('bullet_type').value = '';
        };

        window.cancelAddBullet = function() {
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.saveBullet = async function() {
            const manufacturer = document.getElementById('bullet_manufacturer').value.trim();
            const caliber = document.getElementById('bullet_caliber').value.trim();
            const grain = parseInt(document.getElementById('bullet_grain').value);
            const bc = parseFloat(document.getElementById('bullet_bc').value);
            const dragModel = document.getElementById('bullet_drag_model').value;
            const bulletType = document.getElementById('bullet_type').value;

            if (!manufacturer || !caliber || !grain || !bc || !dragModel || !bulletType) {
                alert('Please fill in all fields');
                return;
            }

            if (bc < 0.1 || bc > 1.0) {
                alert('Ballistic coefficient must be between 0.1 and 1.0');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .insert([{
                        user_id: currentUser.id,
                        manufacturer_name: manufacturer,
                        caliber: caliber,
                        grain: grain,
                        ballistic_coefficient: bc,
                        drag_model: dragModel,
                        bullet_type: bulletType
                    }]);

                if (error) {
                    console.error('Error saving bullet:', error);
                    alert('Error saving bullet. Please try again.');
                } else {
                    console.log('Bullet saved successfully');
                    document.getElementById('addBulletForm').style.display = 'none';
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error saving bullet. Please try again.');
            }
        };

        window.loadBulletLibrary = async function() {
            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('manufacturer_name', { ascending: true });

                if (error) {
                    console.error('Error loading bullets:', error);
                    return;
                }

                const tableBody = document.getElementById('bulletTableBody');
                const table = document.getElementById('bulletTable');
                const noMessage = document.getElementById('noBulletsMessage');

                if (data && data.length > 0) {
                    table.style.display = 'table';
                    noMessage.style.display = 'none';
                    
                    tableBody.innerHTML = '';
                    data.forEach(bullet => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${bullet.manufacturer_name}</td>
                            <td>${bullet.caliber}</td>
                            <td>${bullet.grain}</td>
                            <td>${bullet.ballistic_coefficient}</td>
                            <td>${bullet.drag_model}</td>
                            <td>${bullet.bullet_type}</td>
                            <td>
                                <button onclick="deleteBullet(${bullet.id})" class="back-to-login" style="padding: 4px 8px; margin: 2px;">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    table.style.display = 'none';
                    noMessage.style.display = 'block';
                }
            } catch (e) {
                console.error('Error loading bullet library:', e);
            }
        };

        window.deleteBullet = async function(bulletId) {
            if (!confirm('Are you sure you want to delete this bullet?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('bullet_library')
                    .delete()
                    .eq('id', bulletId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error deleting bullet:', error);
                    alert('Error deleting bullet. Please try again.');
                } else {
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error deleting bullet. Please try again.');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.warn('Starting Ballistic Calculator script execution');

            if (!window.supabase) {
                console.error('Supabase client not loaded');
                document.getElementById('authMessage').innerHTML = '<div class="error">Error: Supabase client failed to load. Please check your network or CDN.</div>';
                return;
            }

            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnaXFvamNvaG92b2d1d3hsZWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMjkzMjEsImV4cCI6MjA2MjkwNTMyMX0.a8XUU4QuxHIS5oUpSyvx0EyxtmwFXOxnH9Mq-5bzGck';
            const supabase = window.supabase.createClient(
                'https://pgiqojcohovoguwxleij.supabase.co',
                supabaseKey
            );
            
            // Make supabase globally accessible for DOPE functions
            window.supabaseClient = supabase;

            let editSessionId = null;
            let currentUser = null;

            // Check user session on load
            async function checkSession() {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = `Logged in as: ${currentUser.email}`;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                } else {
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('appContent').style.display = 'none';
                }
                
                // Check if user came from password reset email
                checkPasswordResetURL();
            }

            // Check if URL contains password reset parameters
            async function checkPasswordResetURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const hashFragment = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hashFragment);
                const isReset = urlParams.get('reset');
                const token = urlParams.get('access_token') || hashParams.get('access_token');
                const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
                const type = urlParams.get('type') || hashParams.get('type');
                const pathname = window.location.pathname;
                
                console.log('Hash parsing debug:', {
                    rawHash: window.location.hash,
                    hashFragment: hashFragment,
                    hashToken: hashParams.get('access_token'),
                    hashRefresh: hashParams.get('refresh_token'),
                    hashType: hashParams.get('type')
                });
                
                console.log('URL check:', { 
                    pathname, 
                    isReset, 
                    token: token ? 'FOUND' : null, 
                    refreshToken: refreshToken ? 'FOUND' : null, 
                    type, 
                    hashFragment: window.location.hash,
                    fullURL: window.location.href 
                });
                
                if (isReset === 'true' || token || type === 'recovery' || pathname === '/password-reset') {
                    console.log('Password reset detected - waiting for Supabase to process tokens');
                    
                    // Wait a moment for Supabase to process the authentication tokens
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check if Supabase has automatically established a session after processing the tokens
                    const { data: { session } } = await supabase.auth.getSession();
                    console.log('Session check result after delay:', session ? 'SESSION FOUND' : 'NO SESSION');
                    
                    if (session && session.user) {
                        console.log('Found active session for password reset - user can update password');
                        // Don't log out - user is authenticated and can update password
                        currentUser = session.user;
                        
                        // Show login form with password reset form
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('appContent').style.display = 'none';
                        showNewPasswordForm();
                        document.getElementById('authMessage').innerHTML = '<div class="message">Please enter your new password below.</div>';
                    } else {
                        console.log('No active session - showing email form');
                        // Log out current user and show email form
                        await supabase.auth.signOut();
                        currentUser = null;
                        
                        // Show login form and email reset form
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('appContent').style.display = 'none';
                        showResetPasswordForm();
                        document.getElementById('authMessage').innerHTML = '<div class="message">Please enter your email address below to reset your password.</div>';
                    }
                }
            }

            // Handle password reset token from URL
            async function handlePasswordResetToken(token) {
                console.log('Handling password reset token:', token);
                try {
                    // For Supabase, the token handling is often automatic
                    // Let's check if we're already authenticated after the redirect
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session && session.user) {
                        console.log('User session found after reset redirect:', session.user);
                        document.getElementById('authMessage').innerHTML = `<div class="message">Reset link verified! Please enter your new password below.</div>`;
                    } else {
                        // Try to exchange the token
                        const { data, error } = await supabase.auth.getUser(token);
                        
                        if (error) {
                            console.error('Token verification error:', error);
                            document.getElementById('authMessage').innerHTML = `<div class="error">Invalid or expired reset link. Please request a new password reset.</div>`;
                        } else {
                            console.log('Token verified successfully:', data);
                            document.getElementById('authMessage').innerHTML = `<div class="message">Reset link verified! Please enter your new password below.</div>`;
                        }
                    }
                } catch (e) {
                    console.error('Token handling error:', e);
                    document.getElementById('authMessage').innerHTML = `<div class="error">Error processing reset link. Please try again.</div>`;
                }
            }

            // Handle login
            window.login = async function() {
                const email = document.getElementById('login_email').value;
                const password = document.getElementById('login_password').value;
                const authMessage = document.getElementById('authMessage');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    authMessage.innerHTML = `<div class="error">Login failed: ${error.message}</div>`;
                    return;
                }

                currentUser = data.user;
                document.getElementById('userEmail').textContent = `Logged in as: ${currentUser.email}`;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                authMessage.innerHTML = '';
            };

            // Handle sign-up
            window.signup = async function() {
                const email = document.getElementById('login_email').value.trim();
                const password = document.getElementById('login_password').value.trim();
                const authMessage = document.getElementById('authMessage');

                // Validate email and password before attempting sign-up
                if (!email || !password) {
                    authMessage.innerHTML = '<div class="error">Please enter an Email Address and Password, then click the Sign Up button. A confirmation email will be sent to the email address provided.</div>';
                    return;
                }

                console.log('Attempting to sign up with email:', email);
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });

                console.log('Sign-up response:', { data, error });

                if (error) {
                    console.log('Sign-up error:', error);
                    if (error.message.toLowerCase().includes('already registered') || error.message.toLowerCase().includes('user already exists')) {
                        authMessage.innerHTML = '<div class="error">This email is already registered. Please log in or use a different email.</div>';
                    } else {
                        authMessage.innerHTML = `<div class="error">Sign-up failed: ${error.message}</div>`;
                    }
                    return;
                }

                // Check if the user already exists by examining the response
                if (data.user) {
                    // If the user has a last_sign_in_at, they are an existing user
                    if (data.user.last_sign_in_at) {
                        console.log('Existing user detected (last_sign_in_at exists):', data.user);
                        authMessage.innerHTML = '<div class="error">This email is already registered. Please log in or use a different email.</div>';
                        return;
                    }
                    // Check identities array; if empty or indicates existing user, they are already registered
                    if (!data.user.identities || data.user.identities.length === 0) {
                        console.log('Existing user detected (no new identities):', data.user);
                        authMessage.innerHTML = '<div class="error">This email is already registered. Please log in or use a different email.</div>';
                        return;
                    }
                }

                // If we reach here, the sign-up is successful
                authMessage.innerHTML = '<div class="message">Sign-up successful! A confirmation email has been sent to your email address. Please confirm your email, then log in.</div>';
                document.getElementById('login_email').value = '';
                document.getElementById('login_password').value = '';
            };

            // Show the reset password form
            window.showResetPasswordForm = function() {
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'block';
                document.getElementById('newPasswordForm').style.display = 'none';
                document.querySelector('.forgot-password').style.display = 'none';
                
                // Only clear the message if not coming from password reset email
                const urlParams = new URLSearchParams(window.location.search);
                const isReset = urlParams.get('reset');
                if (isReset !== 'true') {
                    document.getElementById('authMessage').innerHTML = '';
                }
            };

            // Show the new password form
            window.showNewPasswordForm = function() {
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'none';
                document.getElementById('newPasswordForm').style.display = 'block';
                document.querySelector('.forgot-password').style.display = 'none';
            };

            // Handle password update
            window.updatePassword = async function() {
                const newPassword = document.getElementById('new_password').value.trim();
                const confirmPassword = document.getElementById('confirm_password').value.trim();
                const authMessage = document.getElementById('authMessage');

                if (!newPassword || !confirmPassword) {
                    authMessage.innerHTML = '<div class="error">Please enter both password fields.</div>';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    authMessage.innerHTML = '<div class="error">Passwords do not match.</div>';
                    return;
                }

                if (newPassword.length < 6) {
                    authMessage.innerHTML = '<div class="error">Password must be at least 6 characters long.</div>';
                    return;
                }

                try {
                    const { data, error } = await supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (error) {
                        authMessage.innerHTML = `<div class="error">Failed to update password: ${error.message}</div>`;
                        return;
                    }

                    authMessage.innerHTML = '<div class="message">Password updated successfully! You can now log in with your new password.</div>';
                    
                    // Clear form and show login
                    document.getElementById('new_password').value = '';
                    document.getElementById('confirm_password').value = '';
                    
                    setTimeout(() => {
                        showLoginForm();
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 2000);
                    
                } catch (e) {
                    authMessage.innerHTML = '<div class="error">An error occurred while updating your password. Please try again.</div>';
                }
            };

            // Show the login form
            window.showLoginForm = function() {
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('resetPasswordForm').style.display = 'none';
                document.getElementById('authMessage').innerHTML = '';
                document.querySelector('.forgot-password').style.display = 'block';
                document.getElementById('reset_email').value = '';
            };

            // Handle password reset
window.resetPassword = async function() {
        const email = document.getElementById('reset_email').value.trim();
        const authMessage = document.getElementById('authMessage');

        if (!email) {
            authMessage.innerHTML = '<div class="error">Please enter your email address to reset your password.</div>';
            return;
        }

        console.log('Attempting to reset password for email:', email);
        const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: 'https://realballistics.com/?reset=true'
        });

        console.log('Password reset response:', { data, error });

        if (error) {
            console.log('Password reset error:', error);
            authMessage.innerHTML = `<div class="error">Failed to send password reset email: ${error.message}</div>`;
            return;
        }

        authMessage.innerHTML = '<div class="message">A password reset link has been sent to your email address. Please check your inbox (and spam/junk folder) to reset your password.</div>';
        document.getElementById('reset_email').value = '';
    };

            // Handle logout
            window.logout = async function() {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    document.getElementById('authMessage').innerHTML = `<div class="error">Logout failed: ${error.message}</div>`;
                    return;
                }

                currentUser = null;
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('authMessage').innerHTML = '<div class="message">Logged out successfully.</div>';
                document.getElementById('login_email').value = '';
                document.getElementById('login_password').value = '';
            };

            // Initialize session check
            checkSession();

            function adjustMuzzleVelocity(caliber, barrelLength, muzzleVelocity) {
                if (!barrelLength || isNaN(barrelLength) || !muzzleVelocity || isNaN(muzzleVelocity)) {
                    return muzzleVelocity;
                }
                let standardLength, fpsPerInch;
                if (caliber && caliber.toLowerCase().includes('5.56')) {
                    standardLength = 20;
                    fpsPerInch = 25;
                } else if (caliber && caliber.toLowerCase().includes('9mm')) {
                    standardLength = 4;
                    fpsPerInch = 30;
                } else {
                    standardLength = 16;
                    fpsPerInch = 25;
                }
                const lengthDifference = barrelLength - standardLength;
                const velocityAdjustment = lengthDifference * fpsPerInch;
                return Math.max(muzzleVelocity + velocityAdjustment, 0);
            }

            window.toggleForm = function() {
                const form = document.getElementById('ballisticForm');
                const addButton = document.querySelector('.add-session');
                if (form.style.display === 'none' || form.style.display === '') {
                    form.style.display = 'block';
                    addButton.textContent = 'Hide Form';
                    loadBulletLibraryDropdown(); // Load bullet library options when form opens
                } else {
                    form.style.display = 'none';
                    addButton.textContent = 'Add New';
                    cancelEditWithoutToggle();
                }
            };

            window.toggleFilters = function() {
                console.log('toggleFilters called');
                const filterSection = document.getElementById('filterSection');
                const toggleButton = document.querySelector('.toggle-filter');
                
                console.log('Filter elements found:', { filterSection: !!filterSection, toggleButton: !!toggleButton });
                
                if (!filterSection || !toggleButton) {
                    console.error('Filter elements not found');
                    return;
                }
                
                filterSection.classList.toggle('active');
                toggleButton.textContent = filterSection.classList.contains('active') ? 'Hide Filters' : 'Show Filters';
                console.log('Filter toggled, active:', filterSection.classList.contains('active'));
            };

            // Load bullet library entries into dropdown
            window.loadBulletLibraryDropdown = async function() {
                const select = document.getElementById('bulletLibrarySelect');
                if (!select || !currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (error) {
                        console.error('Error loading bullet library:', error);
                        return;
                    }

                    // Clear existing options except the default
                    select.innerHTML = '<option value="">Select a saved bullet (optional)</option>';

                    // Add bullet options
                    data.forEach(bullet => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(bullet);
                        option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr ${bullet.bullet_type} (BC: ${bullet.ballistic_coefficient})`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading bullet library dropdown:', error);
                }
            };

            // Load selected bullet data into form
            window.loadBulletData = function() {
                const select = document.getElementById('bulletLibrarySelect');
                const form = document.getElementById('ballisticForm');
                
                if (!select.value || !form) return;

                try {
                    const bulletData = JSON.parse(select.value);
                    
                    // Populate only the specified fields from bullet library
                    form.caliber.value = bulletData.caliber || '';
                    form.bullet_grain.value = bulletData.grain || '';
                    form.muzzle_velocity.value = bulletData.muzzle_velocity || '';
                    form.muzzle_energy.value = bulletData.muzzle_energy || '';
                    form.ballistic_coefficient.value = bulletData.ballistic_coefficient || '';
                    form.drag_model.value = bulletData.drag_model || '';
                    
                    console.log('Loaded bullet data:', bulletData.manufacturer_name, bulletData.caliber, bulletData.grain + 'gr');
                } catch (error) {
                    console.error('Error loading bullet data:', error);
                }
            };

            function cancelEditWithoutToggle() {
                console.log('Canceling edit without toggling form');
                const form = document.getElementById('ballisticForm');
                form.reset();
                editSessionId = null;
                document.getElementById('cancelEditButton').style.display = 'none';
                document.getElementById('message').innerHTML = '';
            }

            function formatHold(hold) {
                const holdValue = parseFloat(hold);
                if (holdValue >= 0) {
                    return `+${holdValue.toFixed(2)}`;
                } else {
                    return holdValue.toFixed(2);
                }
            }

            function calculateMOA(holdInInches, distanceYards) {
                if (distanceYards === 0) return '0.00'; // Avoid division by zero at 0 yards
                const moa = holdInInches / (distanceYards * 1.047 / 100);
                return moa >= 0 ? `+${moa.toFixed(2)}` : moa.toFixed(2);
            }

            const workerScript = `
                self.onmessage = function(e) {
                    const { inputs } = e.data;

                    const GRAVITY = 32.174; // ft/s²
                    const STD_AIR_DENSITY = 0.0765; // lb/ft³ at sea level, 59°F
                    const DT = 0.001;

                    const bulletMass = inputs.bullet_grain / 7000; // Convert grains to pounds
                    const muzzleVelocity = inputs.muzzle_velocity; // ft/s
                    const zeroDistance = inputs.zero_distance * 3; // Convert yards to feet
                    const heightOverBore = inputs.height_over_bore / 12; // Convert inches to feet
                    const stepIntervalFeet = inputs.step_interval_yards * 3;
                    const maxDistanceFeet = inputs.max_distance_yards * 3;
                    
                    // Calculate bullet diameter and cross-sectional area from caliber
                    let caliberInches;
                    if (inputs.caliber.includes('5.56')) {
                        caliberInches = 0.224;
                    } else if (inputs.caliber.includes('.223')) {
                        caliberInches = 0.224;
                    } else if (inputs.caliber.includes('.308') || inputs.caliber.includes('7.62')) {
                        caliberInches = 0.308;
                    } else if (inputs.caliber.includes('6.5')) {
                        caliberInches = 0.264;
                    } else if (inputs.caliber.includes('.30-06')) {
                        caliberInches = 0.308;
                    } else if (inputs.caliber.includes('.270')) {
                        caliberInches = 0.277;
                    } else {
                        // Try to extract number
                        const caliberMatch = inputs.caliber.match(/[\d.]+/);
                        caliberInches = caliberMatch ? parseFloat(caliberMatch[0]) : 0.224;
                    }
                    
                    const bulletDiameter = caliberInches / 12; // Convert inches to feet
                    const bulletArea = Math.PI * Math.pow(bulletDiameter / 2, 2); // ft²
                    
                    // Debug logging
                    self.postMessage({ log: 'Caliber: ' + inputs.caliber + ', Extracted: ' + caliberInches + ', Area: ' + bulletArea });
                    
                    // Wind components
                    const windSpeed = inputs.wind_speed || 0; // mph
                    const windAngle = (inputs.wind_angle || 0) * Math.PI / 180; // Convert to radians

                    const targetDistances = Array.from(
                        { length: Math.floor(inputs.max_distance_yards / inputs.step_interval_yards) + 1 },
                        (_, i) => i * stepIntervalFeet
                    );

                    function getDragCoefficient(velocity, dragModel) {
                        const mach = velocity / 1116; // Speed of sound at sea level
                        
                        // Use proper drag model (G1, G7, etc.)
                        if (dragModel === 'G7') {
                            // G7 drag model for boat-tail bullets
                            if (mach >= 3.0) return 0.1198;
                            if (mach >= 2.5) return 0.1270;
                            if (mach >= 2.0) return 0.1348;
                            if (mach >= 1.5) return 0.1431;
                            if (mach >= 1.0) return 0.1618;
                            if (mach >= 0.9) return 0.1825;
                            return 0.2066;
                        } else {
                            // G1 drag model (default)
                            if (mach >= 3.0) return 0.1629;
                            if (mach >= 2.5) return 0.1659;
                            if (mach >= 2.0) return 0.1629;
                            if (mach >= 1.8) return 0.1659;
                            if (mach >= 1.5) return 0.2031;
                            if (mach >= 1.0) return 0.2597;
                            if (mach >= 0.9) return 0.3010;
                            return 0.3287;
                        }
                    }

                    function computeDerivatives(state) {
                        const [x, y, vx, vy] = state;
                        const speed = Math.sqrt(vx * vx + vy * vy) || 0.0001;
                        
                        // Proper ballistic coefficient application
                        const cd = getDragCoefficient(speed, inputs.drag_model);
                        
                        // Check for invalid values
                        if (!bulletArea || bulletArea <= 0 || !inputs.ballistic_coefficient || inputs.ballistic_coefficient <= 0) {
                            self.postMessage({ log: 'Invalid bulletArea=' + bulletArea + ' or BC=' + inputs.ballistic_coefficient });
                            return [vx, vy, 0, -GRAVITY, 0, speed]; // Fallback to gravity only
                        }
                        
                        // Wind effects (convert mph to ft/s)
                        const windVx = windSpeed * 1.467 * Math.cos(windAngle);
                        const windVy = windSpeed * 1.467 * Math.sin(windAngle);
                        const relativeVx = vx - windVx;
                        const relativeVy = vy - windVy;
                        const relativeSpeed = Math.sqrt(relativeVx * relativeVx + relativeVy * relativeVy) || 0.0001;
                        
                        // Calibrated drag for realistic BC values (0.2-0.6 range)
                        const dragAcceleration = (STD_AIR_DENSITY * relativeSpeed * relativeSpeed) / (20000 * inputs.ballistic_coefficient);
                        const ax = -dragAcceleration * (relativeVx / relativeSpeed);
                        const ay = -GRAVITY - (dragAcceleration * (relativeVy / relativeSpeed));
                        
                        // Check for NaN in accelerations
                        if (isNaN(ax) || isNaN(ay)) {
                            self.postMessage({ log: 'NaN detected: ax=' + ax + ', ay=' + ay + ', dragAccel=' + dragAcceleration + ', BC=' + inputs.ballistic_coefficient });
                            return [vx, vy, 0, -GRAVITY, 0, speed]; // Fallback
                        }
                        
                        return [vx, vy, ax, ay, dragAcceleration, speed];
                    }

                    function rk4Step(state, dt) {
                        const k1 = computeDerivatives(state);
                        const k2 = computeDerivatives([
                            state[0] + 0.5 * dt * k1[0],
                            state[1] + 0.5 * dt * k1[1],
                            state[2] + 0.5 * dt * k1[2],
                            state[3] + 0.5 * dt * k1[3]
                        ]);
                        const k3 = computeDerivatives([
                            state[0] + 0.5 * dt * k2[0],
                            state[1] + 0.5 * dt * k2[1],
                            state[2] + 0.5 * dt * k2[2],
                            state[3] + 0.5 * dt * k2[3]
                        ]);
                        const k4 = computeDerivatives([
                            state[0] + dt * k3[0],
                            state[1] + dt * k3[1],
                            state[2] + dt * k3[2],
                            state[3] + dt * k3[3]
                        ]);

                        return [
                            state[0] + (dt / 6) * (k1[0] + 2 * k2[0] + 2 * k3[0] + k4[0]),
                            state[1] + (dt / 6) * (k1[1] + 2 * k2[1] + 2 * k3[1] + k4[1]),
                            state[2] + (dt / 6) * (k1[2] + 2 * k2[2] + 2 * k3[2] + k4[2]),
                            state[3] + (dt / 6) * (k1[3] + 2 * k2[3] + 2 * k3[3] + k4[3])
                        ];
                    }

                    function simulateTrajectory(initialAngle) {
                        let state = [0, -heightOverBore, muzzleVelocity * Math.cos(initialAngle), muzzleVelocity * Math.sin(initialAngle)];
                        let t = 0;
                        const trajectory = [];

                        // Debug initial conditions
                        self.postMessage({ log: 'Initial state: x=' + state[0] + ', y=' + state[1] + ', vx=' + state[2] + ', vy=' + state[3] });
                        self.postMessage({ log: 'Max distance: ' + maxDistanceFeet + ' ft, Height over bore: ' + heightOverBore + ' ft' });

                        let lastState = [...state, t];
                        trajectory.push({ x: state[0], y: state[1], v: Math.sqrt(state[2] * state[2] + state[3] * state[3]), t });

                        const keyDistances = [0, 75, 150];
                        let closestPoints = keyDistances.map(dist => ({ dist: dist, closestX: null, drag: null, speed: null, minDiff: Infinity }));

                        let iterations = 0;
                        while (state[0] <= maxDistanceFeet && iterations < 100000) {
                            const derivatives = computeDerivatives(state);
                            state = rk4Step(state, DT);
                            t += DT;
                            iterations++;

                            if (iterations === 1) {
                                self.postMessage({ log: 'First iteration - state after step: x=' + state[0] + ', y=' + state[1] + ', vx=' + state[2] + ', vy=' + state[3] });
                            }

                            if (state[0] - lastState[0] >= 0.001) {
                                const fraction = (state[0] - lastState[0]) / (state[0] - lastState[0] || 0.0001);
                                const interpX = state[0];
                                const interpY = lastState[1] + fraction * (state[1] - lastState[1]);
                                const interpVx = lastState[2] + fraction * (state[2] - lastState[2]);
                                const interpVy = lastState[3] + fraction * (state[3] - lastState[3]);
                                const interpT = lastState[4] + fraction * (t - lastState[4]);
                                const interpV = Math.sqrt(interpVx * interpVx + interpVy * interpVy);
                                trajectory.push({ x: interpX, y: interpY, v: interpV, t: interpT });

                                keyDistances.forEach((keyDist, index) => {
                                    const diff = Math.abs(interpX - keyDist);
                                    if (diff < closestPoints[index].minDiff) {
                                        closestPoints[index] = {
                                            dist: keyDist,
                                            closestX: interpX,
                                            drag: derivatives[4],
                                            speed: derivatives[5],
                                            minDiff: diff
                                        };
                                    }
                                });

                                targetDistances.forEach(target => {
                                    if (state[0] >= target && lastState[0] < target) {
                                        const fractionTarget = (target - lastState[0]) / (state[0] - lastState[0] || 0.0001);
                                        const interpYTarget = lastState[1] + fractionTarget * (state[1] - lastState[1]);
                                        const interpVxTarget = lastState[2] + fractionTarget * (state[2] - lastState[2]);
                                        const interpVyTarget = lastState[3] + fractionTarget * (state[3] - lastState[3]);
                                        const interpTTarget = lastState[4] + fractionTarget * (t - lastState[4]);
                                        const interpVTarget = Math.sqrt(interpVxTarget * interpVxTarget + interpVyTarget * interpVyTarget);
                                        trajectory.push({ x: target, y: interpYTarget, v: interpVTarget, t: interpTTarget });
                                    }
                                });

                                lastState = [...state, t];
                            }
                        }

                        self.postMessage({ log: 'Simulated trajectory points: ' + trajectory.length });
                        return { trajectory: trajectory.sort((a, b) => a.x - b.x), closestPoints };
                    }

                    function zeroTrajectory(inputs) {
                        const zeroDistance = inputs.zero_distance * 3;
                        let angleLow = -0.01;
                        let angleHigh = 0.01;
                        let yLow = simulateTrajectory(angleLow).trajectory.reduce((closest, point) => {
                            const dist = Math.abs(point.x - zeroDistance);
                            return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                        }, { x: 0, y: 0 }).y;
                        let yHigh = simulateTrajectory(angleHigh).trajectory.reduce((closest, point) => {
                            const dist = Math.abs(point.x - zeroDistance);
                            return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                        }, { x: 0, y: 0 }).y;

                        let trajectory, closestPoints;
                        let converged = false;
                        for (let i = 0; i < 1000; i++) {
                            const angle = (angleLow + angleHigh) / 2;
                            const result = simulateTrajectory(angle);
                            trajectory = result.trajectory;
                            closestPoints = result.closestPoints;
                            const zeroPoint = trajectory.reduce((closest, point) => {
                                const dist = Math.abs(point.x - zeroDistance);
                                return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, trajectory[0]);
                            const y = zeroPoint.y;

                            if (i % 500 === 0) {
                                self.postMessage({ log: 'Iteration ' + i + ': Angle=' + angle.toFixed(12) + ', y at ' + inputs.zero_distance + 'yd=' + y.toFixed(12) });
                            }

                            if (Math.abs(y) < 0.00001) {
                                converged = true;
                                break;
                            }

                            if (y > 0) {
                                angleHigh = angle;
                                yHigh = y;
                            } else {
                                angleLow = angle;
                                yLow = y;
                            }

                            if (Math.abs(yHigh - yLow) < 1e-12) {
                                self.postMessage({ log: 'Zeroing stagnating' });
                                break;
                            }
                        }

                        if (!converged) {
                            self.postMessage({ log: 'Zeroing failed to converge within tolerance' });
                            angleLow = 0.01;
                            angleHigh = 0.02;
                            yLow = simulateTrajectory(angleLow).trajectory.reduce((closest, point) => {
                                const dist = Math.abs(point.x - zeroDistance);
                                return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, { x: 0, y: 0 }).y;
                            yHigh = simulateTrajectory(angleHigh).trajectory.reduce((closest, point) => {
                                const dist = Math.abs(point.x - zeroDistance);
                                return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, { x: 0, y: 0 }).y;

                            for (let i = 0; i < 1000; i++) {
                                const angle = (angleLow + angleHigh) / 2;
                                const result = simulateTrajectory(angle);
                                trajectory = result.trajectory;
                                closestPoints = result.closestPoints;
                                const zeroPoint = trajectory.reduce((closest, point) => {
                                    const dist = Math.abs(point.x - zeroDistance);
                                    return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                                }, trajectory[0]);
                                const y = zeroPoint.y;

                                if (i % 500 === 0) {
                                    self.postMessage({ log: 'Fallback Iteration ' + i + ': Angle=' + angle.toFixed(12) + ', y at ' + inputs.zero_distance + 'yd=' + y.toFixed(12) });
                                }

                                if (Math.abs(y) < 0.00001) {
                                    converged = true;
                                    break;
                                }

                                if (y > 0) {
                                    angleHigh = angle;
                                    yHigh = y;
                                } else {
                                    angleLow = angle;
                                    yLow = y;
                                }

                                if (Math.abs(yHigh - yLow) < 1e-12) {
                                    self.postMessage({ log: 'Fallback zeroing stagnating' });
                                    break;
                                }
                            }
                        }

                        if (!converged) {
                            self.postMessage({ error: 'Zeroing failed after fallback' });
                            return;
                        }

                        self.postMessage({ log: 'Drag at key points (0, 75, 150 ft): ' + JSON.stringify(closestPoints) });
                        self.postMessage({ log: 'Final trajectory at zero distance: ' + JSON.stringify(trajectory.find(p => Math.abs(p.x - zeroDistance) < 0.001)) });

                        const results_grid = trajectory.filter(point => targetDistances.includes(point.x)).map(point => ({
                            distance_yd: (point.x / 3).toFixed(0),
                            drop_in: (point.y * 12).toFixed(2),
                            hold_in: (-point.y * 12).toFixed(2),
                            velocity_fps: point.v.toFixed(0),
                            energy_ftlbs: (0.5 * bulletMass * point.v * point.v / 32.174).toFixed(1)
                        }));

                        self.postMessage({ log: 'Ballistic Coefficient used: ' + inputs.ballistic_coefficient });
                        self.postMessage({ log: 'Muzzle velocity: ' + muzzleVelocity + ' fps' });
                        self.postMessage({ log: 'First 5 trajectory points with velocity: ' + JSON.stringify(trajectory.slice(0, 5).map(p => ({x: p.x, v: p.v}))) });
                        self.postMessage({ log: 'Sample velocity at 100yd: ' + JSON.stringify(trajectory.filter(p => Math.abs(p.x - 300) < 1).map(p => ({x: p.x, v: p.v}))) });
                        self.postMessage({ log: 'Results Grid first 3 points: ' + JSON.stringify(results_grid.slice(0, 3)) });
                        self.postMessage({ results_grid, converged });
                    }

                    zeroTrajectory(inputs);
                };
            `;

            const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
            const workerURL = URL.createObjectURL(workerBlob);
            const worker = new Worker(workerURL);

            worker.onmessage = function(e) {
                (async () => {
                    if (e.data.log) {
                        console.log(e.data.log);
                    } else if (e.data.error) {
                        console.error(e.data.error);
                        const messageDiv = document.getElementById('message');
                        messageDiv.innerHTML = `<div class="error">Error: ${e.data.error}</div>`;
                    } else {
                        const { results_grid, converged } = e.data;
                        const messageDiv = document.getElementById('message');
                        if (!converged) {
                            messageDiv.innerHTML = `<div class="error">Error: Zeroing failed completely.</div>`;
                            return;
                        }

                        const tbody = document.getElementById('trajectoryBody');
                        tbody.innerHTML = '';
                        results_grid.forEach(point => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${point.distance_yd}</td>
                                <td>${formatHold(point.hold_in)}</td>
                                <td>${calculateMOA(parseFloat(point.hold_in), parseFloat(point.distance_yd))}</td>
                                <td>${point.velocity_fps}</td>
                                <td>${point.energy_ftlbs}</td>
                                <td>${point.drop_in}</td>
                            `;
                            tbody.appendChild(row);
                        });

                        const form = document.getElementById('ballisticForm');
                        const inputs = {
                            shooter_name: form.shooter_name.value,
                            firearm_type: form.firearm_type.value,
                            firearm_name: form.firearm_name.value,
                            optic_name: form.optic_name.value,
                            caliber: form.caliber.value,
                            barrel_length: parseFloat(form.barrel_length.value) || null,
                            barrel_twist_rate: form.barrel_twist_rate.value || null,
                            bullet_grain: parseInt(form.bullet_grain.value),
                            muzzle_velocity: parseFloat(form.muzzle_velocity.value),
                            muzzle_energy: parseFloat(form.muzzle_energy.value) || null,
                            ballistic_coefficient: parseFloat(form.ballistic_coefficient.value),
                            zero_distance: parseFloat(form.zero_distance.value),
                            height_over_bore: parseFloat(form.height_over_bore.value),
                            drag_model: form.drag_model.value,
                            step_interval_yards: parseInt(form.step_interval_yards.value),
                            max_distance_yards: parseInt(form.max_distance_yards.value),
                            wind_speed: form.wind_speed.value !== '' ? parseFloat(form.wind_speed.value) : null,
                            wind_angle: form.wind_angle.value !== '' ? parseFloat(form.wind_angle.value) : null
                        };

                        const sessionData = {
                            shooter_name: inputs.shooter_name,
                            firearm_type: inputs.firearm_type,
                            firearm_name: inputs.firearm_name,
                            optic_name: inputs.optic_name,
                            caliber: inputs.caliber,
                            barrel_length: inputs.barrel_length,
                            barrel_twist_rate: inputs.barrel_twist_rate,
                            bullet_grain: inputs.bullet_grain,
                            muzzle_velocity: inputs.muzzle_velocity,
                            muzzle_energy: inputs.muzzle_energy,
                            ballistic_coefficient: inputs.ballistic_coefficient,
                            zero_distance: inputs.zero_distance,
                            height_over_bore: inputs.height_over_bore,
                            drag_model: inputs.drag_model,
                            step_interval_yards: inputs.step_interval_yards,
                            max_distance_yards: inputs.max_distance_yards,
                            wind_speed: inputs.wind_speed,
                            wind_angle: inputs.wind_angle,
                            environment: {
                                wind_speed: inputs.wind_speed,
                                wind_angle: inputs.wind_angle
                            },
                            results_grid: results_grid,
                            user_id: currentUser.id // Tie the session to the logged-in user
                        };

                        let operation;
                        if (editSessionId) {
                            const { data: existingRecord, error: fetchError } = await supabase
                                .from('ballistic_sessions')
                                .select('*')
                                .eq('id', editSessionId)
                                .eq('user_id', currentUser.id)
                                .single();

                            if (fetchError || !existingRecord) {
                                console.error('Error verifying session before update:', fetchError || 'Record not found');
                                messageDiv.innerHTML = `<div class="error">Error: Session with ID ${editSessionId} not found before update. ${fetchError ? fetchError.message : ''}</div>`;
                                return;
                            }
                            console.log(`Verified session exists before update:`, existingRecord);
                            console.log(`Comparing IDs - editSessionId: ${editSessionId}, record ID: ${existingRecord.id}, match: ${editSessionId === existingRecord.id}`);
                            console.log(`Session data to update:`, sessionData);
                            console.log(`Barrel twist rate in sessionData:`, sessionData.barrel_twist_rate);

                            console.log(`Updating session with ID: ${editSessionId}`);
                            operation = supabase.from('ballistic_sessions').update(sessionData).eq('id', editSessionId).eq('user_id', currentUser.id).select();
                        } else {
                            console.log('Inserting new session', sessionData);
                            operation = supabase.from('ballistic_sessions').insert([sessionData]).select();
                        }

                        const { data, error, status, statusText, count } = await operation;
                        if (error) {
                            console.error('Supabase operation error:', { error, status, statusText, count });
                            messageDiv.innerHTML = `<div class="error">Error ${editSessionId ? 'updating' : 'saving'} session: ${error.message} (Status: ${status} ${statusText})</div>`;
                            return;
                        }

                        if (!data || data.length === 0) {
                            console.error('No rows affected by the operation', { data, status, statusText, count });
                            messageDiv.innerHTML = `<div class="error">Failed to ${editSessionId ? 'update' : 'save'} session: No rows were affected. Check permissions or data (Status: ${status} ${statusText}).</div>`;
                            return;
                        }

                        console.log('Data operation successful in Supabase', { data, count });
                        messageDiv.innerHTML = `<div class="message">${editSessionId ? 'Session updated' : 'Data saved'} successfully!</div>`;
                        form.reset();
                        editSessionId = null;
                        document.getElementById('cancelEditButton').style.display = 'none';
                        toggleForm();

                        const sessionId = data[0].id;
                        const { data: session, error: fetchError } = await supabase
                            .from('ballistic_sessions')
                            .select('*')
                            .eq('id', sessionId)
                            .eq('user_id', currentUser.id)
                            .single();
                        if (fetchError) {
                            console.error('Error fetching session:', fetchError);
                            messageDiv.innerHTML = `<div class="error">Error fetching session: ${fetchError.message}</div>`;
                        } else {
                            console.log('Fetched session after operation:', session);
                            window.displaySingleSession(session);
                        }
                    }
                })();
            };

            window.calculateAndSave = function() {
                console.warn('calculateAndSave function started');
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = '';

                const form = document.getElementById('ballisticForm');
                const inputs = {
                    shooter_name: form.shooter_name.value,
                    firearm_type: form.firearm_type.value,
                    firearm_name: form.firearm_name.value,
                    optic_name: form.optic_name.value,
                    caliber: form.caliber.value,
                    barrel_length: parseFloat(form.barrel_length.value) || null,
                    barrel_twist_rate: form.barrel_twist_rate.value || null,
                    bullet_grain: parseInt(form.bullet_grain.value),
                    muzzle_velocity: parseFloat(form.muzzle_velocity.value),
                    ballistic_coefficient: parseFloat(form.ballistic_coefficient.value),
                    zero_distance: parseFloat(form.zero_distance.value),
                    height_over_bore: parseFloat(form.height_over_bore.value),
                    drag_model: form.drag_model.value,
                    step_interval_yards: parseInt(form.step_interval_yards.value),
                    max_distance_yards: parseInt(form.max_distance_yards.value),
                    wind_speed: parseFloat(form.wind_speed.value) || 0,
                    wind_angle: parseFloat(form.wind_angle.value) || 0
                };

                if (!inputs.shooter_name || !inputs.firearm_name || !inputs.caliber ||
                    isNaN(inputs.bullet_grain) || isNaN(inputs.muzzle_velocity) || isNaN(inputs.ballistic_coefficient) ||
                    isNaN(inputs.zero_distance) || isNaN(inputs.height_over_bore) || isNaN(inputs.step_interval_yards) ||
                    isNaN(inputs.max_distance_yards) || inputs.step_interval_yards <= 0 || inputs.max_distance_yards <= 0) {
                    console.error('Input validation failed', inputs);
                    messageDiv.innerHTML = '<div class="error">Please fill all required fields with valid positive values.</div>';
                    return;
                }

                if (!inputs.firearm_type || inputs.firearm_type === '') {
                    console.error('Firearm type not selected');
                    messageDiv.innerHTML = '<div class="error">Please select a firearm type (Rifle or Pistol).</div>';
                    return;
                }

                if (!inputs.drag_model || inputs.drag_model === '') {
                    console.error('Drag model not selected');
                    messageDiv.innerHTML = '<div class="error">Please select a drag model (G1 or G7).</div>';
                    return;
                }

                inputs.muzzle_velocity = adjustMuzzleVelocity(inputs.caliber, inputs.barrel_length, inputs.muzzle_velocity);
                console.log('Adjusted inputs:', inputs);
                console.log('Barrel twist rate value:', inputs.barrel_twist_rate);
                worker.postMessage({ inputs });
            };

            window.loadSessionForEdit = async function(sessionId) {
                console.log(`Loading session for edit: ${sessionId}`);
                const { data, error } = await supabase
                    .from('ballistic_sessions')
                    .select('*')
                    .eq('id', sessionId)
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error loading session:', error);
                    document.getElementById('message').innerHTML = `<div class="error">Error loading session: ${error.message}</div>`;
                    return;
                }

                const session = data;
                console.log('Complete session data loaded from database:', session);
                const form = document.getElementById('ballisticForm');
                form.shooter_name.value = session.shooter_name || '';
                form.firearm_type.value = session.firearm_type || '';
                form.firearm_name.value = session.firearm_name || '';
                form.optic_name.value = session.optic_name || '';
                form.caliber.value = session.caliber || '';
                form.barrel_length.value = session.barrel_length || '';
                form.barrel_twist_rate.value = session.barrel_twist_rate || '';
                form.bullet_grain.value = session.bullet_grain || '';
                form.muzzle_velocity.value = session.muzzle_velocity || '';
                form.muzzle_energy.value = session.muzzle_energy || '';
                form.ballistic_coefficient.value = session.ballistic_coefficient || '';
                form.zero_distance.value = session.zero_distance || '';
                form.height_over_bore.value = session.height_over_bore || '';
                form.drag_model.value = session.drag_model || '';
                form.step_interval_yards.value = session.step_interval_yards || '';
                form.max_distance_yards.value = session.max_distance_yards || '';
                console.log('Wind data from database:', { wind_speed: session.wind_speed, wind_angle: session.wind_angle });
                form.wind_speed.value = session.wind_speed !== null && session.wind_speed !== undefined ? session.wind_speed : '';
                form.wind_angle.value = session.wind_angle !== null && session.wind_angle !== undefined ? session.wind_angle : '';

                editSessionId = sessionId;
                document.getElementById('cancelEditButton').style.display = 'inline-block';
                const formElement = document.getElementById('ballisticForm');
                formElement.style.display = 'block';
                document.querySelector('.add-session').textContent = 'Hide Form';
            };

            window.cancelEdit = function() {
                cancelEditWithoutToggle();
            };

            window.viewAll = async function() {
                console.warn('viewAll function started');
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = '';

                const { data, error } = await supabase.from('ballistic_sessions').select('*').eq('user_id', currentUser.id);
                if (error) {
                    console.error('Supabase select error:', error);
                    messageDiv.innerHTML = `<div class="error">Error fetching sessions: ${error.message}</div>`;
                    return;
                }

                if (!data || data.length === 0) {
                    console.log('No sessions found');
                    messageDiv.innerHTML = '<div class="message">No sessions found.</div>';
                }

                window.displaySessions(data);
            };

            window.displaySessions = function(sessions) {
                console.log('Displaying sessions:', sessions);
                const tbody = document.getElementById('sessionsBody');
                tbody.innerHTML = '';
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="select-session" data-id="${session.id}"></td>
                        <td>${session.shooter_name || ''}</td>
                        <td>${session.firearm_type || ''}</td>
                        <td>${session.firearm_name || ''}</td>
                        <td>${session.optic_name || ''}</td>
                        <td>${session.caliber || ''}</td>
                        <td>${session.barrel_length ? session.barrel_length.toFixed(1) : ''}</td>
                        <td>${session.barrel_twist_rate || ''}</td>
                        <td>${session.bullet_grain || ''}</td>
                        <td>${session.zero_distance || ''}</td>
                        <td>${session.max_distance_yards || ''}</td>
                        <td>${session.step_interval_yards || ''}</td>
                        <td>${session.height_over_bore || ''}</td>
                        <td>
                            <button class="view-session" onclick="window.viewTrajectory('${session.id}')">View</button>
                            <button class="edit-session" onclick="window.loadSessionForEdit('${session.id}')">Edit</button>
                        </td>
                    `;
                    row.dataset.resultsGrid = JSON.stringify(session.results_grid);
                    row.dataset.description = `${session.shooter_name || 'Unknown'} ${session.firearm_type || ''} ${session.firearm_name || ''} ${session.optic_name || ''} ${session.barrel_length ? session.barrel_length.toFixed(1) + 'in' : ''} - ${session.zero_distance || '0'}yd Zero`.trim();
                    tbody.appendChild(row);
                });
            };

            window.displaySingleSession = function(session) {
                console.log('Displaying single session:', session);
                const sessions = [session];
                window.displaySessions(sessions);
                window.viewTrajectory(session.id);
            };

            window.viewTrajectory = function(sessionId) {
                console.log(`Viewing trajectory for session ID: ${sessionId}`);
                const row = document.querySelector(`.select-session[data-id="${sessionId}"]`).closest('tr');
                let results_grid;
                try {
                    results_grid = JSON.parse(row.dataset.resultsGrid);
                    console.log('Parsed results_grid:', results_grid);
                } catch (e) {
                    console.error('Error parsing results_grid:', e);
                    document.getElementById('message').innerHTML = '<div class="error">Error loading trajectory data.</div>';
                    return;
                }

                if (!Array.isArray(results_grid) || results_grid.length === 0) {
                    console.error('Invalid or empty results_grid:', results_grid);
                    document.getElementById('message').innerHTML = '<div class="error">No trajectory data available.</div>';
                    return;
                }

                const tbody = document.getElementById('trajectoryBody');
                tbody.innerHTML = '';
                results_grid.forEach(point => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${point.distance_yd}</td>
                        <td>${formatHold(point.hold_in)}</td>
                        <td>${calculateMOA(parseFloat(point.hold_in), parseFloat(point.distance_yd))}</td>
                        <td>${point.velocity_fps}</td>
                        <td>${point.energy_ftlbs}</td>
                        <td>${point.drop_in}</td>
                    `;
                    tbody.appendChild(row);
                });

                const description = row.dataset.description || '';
                document.getElementById('trajectoryDescription').textContent = description ? `- ${description}` : '';

                // Hide comparison table when viewing a single session
                document.getElementById('comparisonTitle').style.display = 'none';
                document.getElementById('comparisonTable').style.display = 'none';
            };

            window.showCompareForm = function() {
                const checkboxes = document.querySelectorAll('.select-session:checked');
                if (checkboxes.length < 2) {
                    document.getElementById('message').innerHTML = '<div class="error">Please select at least two sessions to compare.</div>';
                    return;
                }
                const compareForm = document.getElementById('compareForm');
                compareForm.style.display = 'block';
            };

            window.hideCompareForm = function() {
                const compareForm = document.getElementById('compareForm');
                compareForm.style.display = 'none';
                document.getElementById('message').innerHTML = '';
            };

            window.compareSelected = function() {
                const checkboxes = document.querySelectorAll('.select-session:checked');
                if (checkboxes.length < 2) {
                    document.getElementById('message').innerHTML = '<div class="error">Please select at least two sessions to compare.</div>';
                    return;
                }

                const stepIntervalInput = document.getElementById('compare_step_interval').value;
                const maxDistanceInput = document.getElementById('compare_max_distance').value;

                if (!stepIntervalInput || stepIntervalInput === "Enter Value" || !maxDistanceInput || maxDistanceInput === "Enter Value") {
                    document.getElementById('message').innerHTML = '<div class="error">Please enter values for step interval and max distance.</div>';
                    return;
                }

                const stepInterval = parseInt(stepIntervalInput);
                const maxDistance = parseInt(maxDistanceInput);

                if (isNaN(stepInterval) || isNaN(maxDistance) || stepInterval <= 0 || maxDistance <= 0) {
                    document.getElementById('message').innerHTML = '<div class="error">Please enter valid positive values for step interval and max distance.</div>';
                    return;
                }

                const selectedRows = Array.from(checkboxes).map(cb => cb.closest('tr'));
                const selectedSessions = selectedRows.map(row => ({
                    results_grid: JSON.parse(row.dataset.resultsGrid),
                    description: row.dataset.description,
                    grain: row.cells[8].textContent // Get grain from the Gr column (index 8)
                }));

                const distances = Array.from(
                    { length: Math.floor(maxDistance / stepInterval) + 1 },
                    (_, i) => i * stepInterval
                );

                const comparisonData = selectedSessions.map(session => {
                    const grid = session.results_grid;
                    return {
                        description: session.description,
                        bullet_grain: session.grain,
                        trajectory: distances.map(distance => {
                            const point = grid.find(p => parseFloat(p.distance_yd) === distance);
                            if (point) {
                                return { distance_yd: distance, hold_in: parseFloat(point.hold_in) };
                            }
                            const before = grid.filter(p => parseFloat(p.distance_yd) < distance).pop();
                            const after = grid.find(p => parseFloat(p.distance_yd) > distance);
                            if (!before || !after) {
                                return { distance_yd: distance, hold_in: null };
                            }
                            const fraction = (distance - parseFloat(before.distance_yd)) / (parseFloat(after.distance_yd) - parseFloat(before.distance_yd));
                            const interpolatedHold = parseFloat(before.hold_in) + fraction * (parseFloat(after.hold_in) - parseFloat(before.hold_in));
                            return { distance_yd: distance, hold_in: interpolatedHold };
                        })
                    };
                });

                // Calculate the flattest trajectory by finding the session with the smallest hold range
                const trajectoryRanges = comparisonData.map(session => {
                    const holds = session.trajectory
                        .map(point => point.hold_in)
                        .filter(hold => hold !== null);
                    if (holds.length === 0) return Infinity;
                    const maxHold = Math.max(...holds);
                    const minHold = Math.min(...holds);
                    return maxHold - minHold;
                });

                const flattestIndex = trajectoryRanges.indexOf(Math.min(...trajectoryRanges));

                const comparisonTableHead = document.getElementById('comparisonTableHead');
                const comparisonTableBody = document.getElementById('comparisonTableBody');
                comparisonTableHead.innerHTML = '';
                comparisonTableBody.innerHTML = '';

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>Distance (yd)</th>';
                comparisonData.forEach((session, index) => {
                    const th = document.createElement('th');
                    th.textContent = `${session.description} - ${session.bullet_grain}gr`;
                    if (index === flattestIndex) {
                        th.classList.add('flattest-trajectory');
                    }
                    headerRow.appendChild(th);
                });
                comparisonTableHead.appendChild(headerRow);

                distances.forEach(distance => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${distance}</td>`;
                    comparisonData.forEach(session => {
                        const point = session.trajectory.find(p => p.distance_yd === distance);
                        const td = document.createElement('td');
                        td.textContent = point.hold_in !== null ? formatHold(point.hold_in) : '-';
                        row.appendChild(td);
                    });
                    comparisonTableBody.appendChild(row);
                });

                document.getElementById('comparisonTitle').style.display = 'block';
                document.getElementById('comparisonTable').style.display = 'table';
                hideCompareForm();
            };

            window.clearAll = function() {
                console.log('Clearing all UI data');
                const form = document.getElementById('ballisticForm');
                form.reset();
                editSessionId = null;
                document.getElementById('cancelEditButton').style.display = 'none';
                document.getElementById('sessionsBody').innerHTML = '';
                document.getElementById('trajectoryBody').innerHTML = '';
                document.getElementById('message').innerHTML = '';
                document.getElementById('search_shooter_name').value = '';
                document.getElementById('search_firearm_type').value = '';
                document.getElementById('search_firearm_name').value = '';
                document.getElementById('search_bullet_grain').value = '';
                document.getElementById('search_barrel_length').value = '';
                document.getElementById('trajectoryDescription').textContent = '';
                document.getElementById('comparisonTitle').style.display = 'none';
                document.getElementById('comparisonTable').style.display = 'none';
                
                // Reset the Select All checkbox
                const selectAllCheckbox = document.getElementById('selectAllSessions');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
                
                // Uncheck all individual session checkboxes
                const sessionCheckboxes = document.querySelectorAll('.select-session');
                sessionCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                const formElement = document.getElementById('ballisticForm');
                if (formElement.style.display === 'block') {
                    toggleForm();
                }
            };

            window.toggleSelectAllSessions = function() {
                const selectAllCheckbox = document.getElementById('selectAllSessions');
                const sessionCheckboxes = document.querySelectorAll('.select-session');
                
                sessionCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            };

            // DOPE Functions
            window.showDOPE = async function() {
                console.log('showDOPE function called');
                try {
                    // Hide all other sections
                    document.getElementById('homePage').style.display = 'none';
                    document.getElementById('shootingProfileSection').style.display = 'none';
                    document.getElementById('bulletLibrarySection').style.display = 'none';
                    
                    // Hide any active sections
                    const hideElement = (id) => {
                        const element = document.getElementById(id);
                        if (element) element.style.display = 'none';
                    };
                    hideElement('activeBulletLibrary');
                    hideElement('dopeSection');
                    hideElement('filterSection');
                    hideElement('ballisticForm');
                    hideElement('compareForm');
                    hideElement('compareResults');
                    
                    // Create DOPE content directly in the main app content (similar to bullet library)
                    const appContent = document.getElementById('appContent');
                    const dopeContent = document.createElement('div');
                    dopeContent.id = 'activeDopeSection';
                    dopeContent.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                                <h2 style="margin: 0;">DOPE - Data On Previous Engagements</h2>
                            </div>
                            <button onclick="showAddDopeFormDirect()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Log New Engagement</button>
                            <div id="dopeContent">Loading your engagements...</div>
                        </div>
                    `;
                    
                    // Remove any existing active DOPE section
                    const existing = document.getElementById('activeDopeSection');
                    if (existing) existing.remove();
                    
                    // Add the new DOPE content
                    appContent.appendChild(dopeContent);
                    console.log('DOPE content created and added to page');
                    
                    // Load the engagements after the content is added
                    setTimeout(() => loadDopeEngagementsDirect(), 200);
                    
                } catch (error) {
                    console.error('Error in showDOPE function:', error);
                }
            };

            window.showAddDopeForm = function() {
                document.getElementById('addDopeForm').style.display = 'block';
                
                // Set current date and time as defaults
                const now = new Date();
                document.getElementById('engagement_date').value = now.toISOString().split('T')[0];
                
                // Set current time (hours:minutes)
                const timeString = now.toTimeString().slice(0, 5);
                document.getElementById('engagement_time').value = timeString;
                
                // Load dropdowns with fresh data
                loadDopeDropdowns();
                
                clearDopeForm();
            };

            window.cancelAddDope = function() {
                document.getElementById('addDopeForm').style.display = 'none';
                clearDopeForm();
            };

            window.clearDopeForm = function() {
                const form = document.getElementById('addDopeForm');
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type !== 'date') {
                        input.value = '';
                    }
                });
            };

            window.loadDopeDropdowns = async function() {
                console.log('loadDopeDropdowns called');
                try {
                    if (!currentUser) {
                        console.log('No current user, skipping dropdown load');
                        return;
                    }

                    console.log('Loading shooting profiles...');
                    // Load shooting profiles
                    const { data: profiles, error: profileError } = await supabase
                        .from('ballistic_sessions')
                        .select('id, shooter_name, firearm_name, caliber')
                        .eq('user_id', currentUser.id)
                        .order('shooter_name', { ascending: true });

                    if (profileError) {
                        console.error('Profile error:', profileError);
                    } else {
                        console.log('Profiles loaded:', profiles);
                        const profileSelect = document.getElementById('dope_shooting_profile');
                        if (profileSelect) {
                            profileSelect.innerHTML = '<option value="">Select a shooting profile...</option>';
                            profiles.forEach(profile => {
                                const option = document.createElement('option');
                                option.value = profile.id;
                                option.textContent = `${profile.shooter_name} - ${profile.firearm_name} (${profile.caliber})`;
                                profileSelect.appendChild(option);
                            });
                        }
                    }

                    console.log('Loading bullet library for DOPE...');
                    // Load bullet library
                    const { data: bullets, error: bulletError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (bulletError) {
                        console.error('Bullet error:', bulletError);
                    } else {
                        console.log('Bullets loaded for DOPE:', bullets);
                        const bulletSelect = document.getElementById('dope_bullet_library');
                        if (bulletSelect) {
                            bulletSelect.innerHTML = '<option value="">Select a bullet...</option>';
                            
                            if (bullets && bullets.length > 0) {
                                bullets.forEach(bullet => {
                                    const option = document.createElement('option');
                                    option.value = bullet.id;
                                    option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr ${bullet.bullet_type || ''}`;
                                    bulletSelect.appendChild(option);
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading DOPE dropdowns:', error);
                }
            };

            window.saveDope = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to save engagement data.');
                        return;
                    }

                    const dopeData = {
                        user_id: currentUser.id,
                        shooting_profile_id: document.getElementById('dope_shooting_profile').value || null,
                        bullet_library_id: parseInt(document.getElementById('dope_bullet_library').value) || null,
                        engagement_date: document.getElementById('engagement_date').value,
                        engagement_time: document.getElementById('engagement_time').value || null,
                        range_to_target: parseFloat(document.getElementById('range_to_target').value),
                        range_unit: document.getElementById('range_unit').value,
                        wind_speed: parseFloat(document.getElementById('wind_speed').value) || null,
                        wind_direction: parseFloat(document.getElementById('wind_direction').value) || null,
                        wind_type: document.getElementById('wind_type').value || null,
                        temperature: parseFloat(document.getElementById('temperature').value) || null,
                        temperature_unit: document.getElementById('temperature_unit').value || null,
                        barometric_pressure: parseFloat(document.getElementById('barometric_pressure').value) || null,
                        pressure_unit: document.getElementById('pressure_unit').value || null,
                        humidity: parseFloat(document.getElementById('humidity').value) || null,
                        altitude: parseFloat(document.getElementById('altitude').value) || null,
                        altitude_reference: document.getElementById('altitude_reference').value || null,
                        angle_of_fire: parseFloat(document.getElementById('angle_of_fire').value) || null,
                        spin_drift: parseFloat(document.getElementById('spin_drift').value) || null,
                        coriolis_effect: parseFloat(document.getElementById('coriolis_effect').value) || null,
                        target_movement_speed: parseFloat(document.getElementById('target_movement_speed').value) || null,
                        target_movement_direction: parseFloat(document.getElementById('target_movement_direction').value) || null,
                        optic_magnification: parseFloat(document.getElementById('optic_magnification').value) || null,
                        optic_adjustment_units: document.getElementById('optic_adjustment_units').value || null,
                        parallax_setting: parseFloat(document.getElementById('parallax_setting').value) || null,
                        atmospheric_conditions: document.getElementById('atmospheric_conditions').value || null,
                        barrel_condition: document.getElementById('barrel_condition').value || null,
                        time_of_flight: parseFloat(document.getElementById('time_of_flight').value) || null,
                        light_conditions: document.getElementById('light_conditions').value || null,
                        engagement_outcome: document.getElementById('engagement_outcome').value || null,
                        notes: document.getElementById('engagement_notes').value || null
                    };

                    const { data, error } = await supabase
                        .from('dope_engagements')
                        .insert([dopeData])
                        .select();

                    if (error) {
                        console.error('Error saving DOPE engagement:', error);
                        alert('Error saving engagement. Please try again.');
                    } else {
                        alert('Engagement saved successfully!');
                        document.getElementById('addDopeForm').style.display = 'none';
                        clearDopeForm();
                        loadDopeEngagements();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving engagement. Please try again.');
                }
            };

            window.loadDopeEngagements = async function() {
                try {
                    if (!currentUser) return;

                    const { data, error } = await supabase
                        .from('dope_engagements')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('engagement_date', { ascending: false });

                    const tableBody = document.getElementById('dopeTableBody');
                    const noMessage = document.getElementById('noDopeMessage');
                    const table = document.getElementById('dopeEngagementsTable');

                    if (error) {
                        console.error('Error loading DOPE engagements:', error);
                        return;
                    }

                    tableBody.innerHTML = '';

                    if (data && data.length > 0) {
                        table.style.display = 'table';
                        noMessage.style.display = 'none';

                        data.forEach(engagement => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${engagement.engagement_date}</td>
                                <td>${engagement.range_to_target} ${engagement.range_unit}</td>
                                <td>${engagement.wind_speed ? `${engagement.wind_speed} ${engagement.wind_type || ''}` : 'N/A'}</td>
                                <td>${engagement.temperature ? `${engagement.temperature}°${engagement.temperature_unit}` : 'N/A'}</td>
                                <td>${engagement.engagement_outcome || 'N/A'}</td>
                                <td>
                                    <button onclick="viewDopeDetails('${engagement.id}')" class="view-session">View</button>
                                    <button onclick="deleteDope('${engagement.id}')" class="back-to-login">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        table.style.display = 'none';
                        noMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading DOPE engagements:', error);
                }
            };

            window.deleteDope = async function(engagementId) {
                if (!confirm('Are you sure you want to delete this engagement?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('dope_engagements')
                        .delete()
                        .eq('id', engagementId)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error deleting engagement:', error);
                        alert('Error deleting engagement. Please try again.');
                    } else {
                        loadDopeEngagements();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting engagement. Please try again.');
                }
            };

            window.viewDopeDetails = function(engagementId) {
                console.log('View DOPE details for:', engagementId);
                // TODO: Implement detailed view
                alert('Detailed view coming soon!');
            };

            window.showFirearmPicker = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to access firearm profiles.');
                        return;
                    }

                    // Load all firearm profiles for the current user
                    const { data: firearms, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error loading firearm profiles:', error);
                        alert('Error loading firearm profiles. Please ensure the firearm_profile table exists in your Supabase database.');
                        return;
                    }

                    if (!firearms || firearms.length === 0) {
                        alert('No firearm profiles found. Please create some firearm profiles first.');
                        return;
                    }

                    // Create a modal to select from available firearms
                    const firearmHTML = firearms.map(firearm => `
                        <div onclick="selectFirearm('${firearm.id}')" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 4px; background-color: #f9f9f9;">
                            <strong>${firearm.profile_name}</strong><br>
                            <span style="color: #666;">Shooter: ${firearm.shooter_name} | ${firearm.firearm_type}: ${firearm.firearm_name}</span><br>
                            <span style="color: #666;">Caliber: ${firearm.caliber} | Barrel: ${firearm.barrel_length}" | Zero: ${firearm.zero_distance}yds</span>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="firearmPickerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 70vh; overflow-y: auto; width: 90%;">
                                <h3>Select Firearm Profile</h3>
                                <div style="margin: 15px 0;">
                                    ${firearmHTML}
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="closeFirearmPicker()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } catch (error) {
                    console.error('Error in showFirearmPicker:', error);
                    alert('Error loading firearm profiles');
                }
            };

            window.selectFirearm = async function(firearmId) {
                try {
                    console.log('Selecting firearm with ID:', firearmId);
                    
                    // Load the selected firearm data
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) {
                        console.error('Error loading firearm:', error);
                        alert('Error loading firearm data');
                        return;
                    }

                    console.log('Firearm data loaded:', firearm);

                    // Close the picker first
                    closeFirearmPicker();

                    // Set the hidden field and display text
                    document.getElementById('dope_firearm_profile').value = firearmId;
                    document.getElementById('selected_firearm').textContent = `${firearm.profile_name} - ${firearm.firearm_name}`;

                    // Wait a moment for DOM to update, then populate fields
                    setTimeout(() => {
                        try {
                            const setFieldValue = (fieldId, value) => {
                                const field = document.getElementById(fieldId);
                                if (field) {
                                    field.value = value || '';
                                    console.log(`Set ${fieldId} to: ${value}`);
                                } else {
                                    console.warn(`Field ${fieldId} not found`);
                                }
                            };
                            
                            // Populate firearm-specific data from firearm_profile table
                            setFieldValue('shooter_name', firearm.shooter_name);
                            setFieldValue('firearm_type', firearm.firearm_type);
                            setFieldValue('firearm_name', firearm.firearm_name);
                            setFieldValue('rifle_caliber', firearm.caliber);
                            setFieldValue('optic_name', firearm.optic_name);
                            setFieldValue('barrel_length', firearm.barrel_length ? `${firearm.barrel_length} inches` : '');
                            setFieldValue('barrel_twist_rate', firearm.barrel_twist_rate);
                            setFieldValue('zero_distance', firearm.zero_distance ? `${firearm.zero_distance} yards` : '');
                            setFieldValue('height_over_bore', firearm.height_over_bore ? `${firearm.height_over_bore} inches` : '');

                            console.log('Firearm data populated successfully');
                        } catch (innerError) {
                            console.error('Error populating firearm fields:', innerError);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error selecting firearm:', error);
                    alert('Error selecting firearm');
                }
            };

            window.closeFirearmPicker = function() {
                const modal = document.getElementById('firearmPickerModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.showProfilePicker = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to access shooting profiles.');
                        return;
                    }

                    // Load all shooting profiles for the current user - use the same client as other functions
                    const { data: profiles, error } = await supabase
                        .from('ballistic_sessions')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error loading profiles:', error);
                        alert('Error loading shooting profiles');
                        return;
                    }

                    if (!profiles || profiles.length === 0) {
                        alert('No shooting profiles found. Please create a shooting profile first.');
                        return;
                    }

                    // Create a modal to select from available profiles with more details
                    const profileHTML = profiles.map(profile => `
                        <div onclick="selectProfile('${profile.id}')" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 4px; background-color: #f9f9f9;">
                            <strong>${profile.shooter_name}</strong><br>
                            <span style="color: #666;">${profile.firearm_type} - ${profile.firearm_name}</span><br>
                            <span style="color: #888; font-size: 0.9em;">Caliber: ${profile.caliber || 'N/A'} | Barrel: ${profile.barrel_length || 'N/A'} | Zero: ${profile.zero_distance || 'N/A'}yds</span>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="profilePickerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 70vh; overflow-y: auto; width: 90%;">
                                <h3>Select Shooting Profile</h3>
                                <div style="margin: 15px 0;">
                                    ${profileHTML}
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="closeProfilePicker()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } catch (error) {
                    console.error('Error in showProfilePicker:', error);
                    alert('Error loading profiles');
                }
            };

            window.selectProfile = async function(profileId) {
                try {
                    console.log('Selecting profile with ID:', profileId);
                    
                    // Load the selected profile data - use the same client as other functions
                    const { data: profile, error } = await supabase
                        .from('ballistic_sessions')
                        .select('*')
                        .eq('id', profileId)
                        .single();

                    if (error) {
                        console.error('Error loading profile:', error);
                        alert('Error loading profile data');
                        return;
                    }

                    console.log('Profile data loaded:', profile);

                    // Close the picker first to avoid any interference
                    closeProfilePicker();

                    // Wait a moment for the DOM to update
                    setTimeout(() => {
                        try {
                            // Set the hidden field and display text
                            const profileField = document.getElementById('dope_shooting_profile');
                            const selectedText = document.getElementById('selected_profile');
                            
                            if (profileField) {
                                profileField.value = profileId;
                                console.log('Set profile ID:', profileId);
                            }
                            
                            if (selectedText) {
                                selectedText.textContent = `${profile.shooter_name} - ${profile.firearm_name}`;
                                console.log('Set selected text');
                            }

                            // Populate all the ballistic fields with error checking
                            const setFieldValue = (fieldId, value) => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = value || '';
                                    console.log(`Set ${fieldId} to: ${value}`);
                                } else {
                                    console.warn(`Field ${fieldId} not found`);
                                }
                            };
                            
                            // Only rifle-specific data from ballistic_sessions table
                            setFieldValue('shooter_name', profile.shooter_name);
                            setFieldValue('firearm_type', profile.firearm_type);
                            setFieldValue('firearm_name', profile.firearm_name);
                            setFieldValue('rifle_caliber', profile.caliber);
                            setFieldValue('optic_name', profile.optic_name);
                            setFieldValue('barrel_length', profile.barrel_length ? `${profile.barrel_length} inches` : '');
                            setFieldValue('barrel_twist_rate', profile.barrel_twist_rate);
                            setFieldValue('zero_distance', profile.zero_distance ? `${profile.zero_distance} yards` : '');
                            setFieldValue('height_over_bore', profile.height_over_bore ? `${profile.height_over_bore} inches` : '');

                            console.log('Profile data populated successfully');
                        } catch (innerError) {
                            console.error('Error populating fields:', innerError);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error selecting profile:', error);
                    alert('Error selecting profile');
                }
            };

            window.closeProfilePicker = function() {
                const modal = document.getElementById('profilePickerModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.populateFromShootingProfile = function() {
                console.log('Populate from shooting profile');
                // This function is kept for backward compatibility
                // The actual population now happens through showProfilePicker
            };

            window.showBulletPicker = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to access bullet library.');
                        return;
                    }

                    // Load all bullets for the current user
                    const { data: bullets, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error loading bullets:', error);
                        alert('Error loading bullet library');
                        return;
                    }

                    if (!bullets || bullets.length === 0) {
                        alert('No bullets found. Please create some bullets in your library first.');
                        return;
                    }

                    // Create a modal to select from available bullets
                    const bulletHTML = bullets.map(bullet => `
                        <div onclick="selectBullet('${bullet.id}')" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 4px; background-color: #f9f9f9;">
                            <strong>${bullet.manufacturer_name} ${bullet.caliber}</strong><br>
                            <span style="color: #666;">${bullet.grain || 'Unknown'}gr ${bullet.bullet_type || 'Unknown'} - BC: ${bullet.ballistic_coefficient || 'Unknown'}</span>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="bulletPickerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 70vh; overflow-y: auto; width: 90%;">
                                <h3>Select Bullet</h3>
                                <div style="margin: 15px 0;">
                                    ${bulletHTML}
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="closeBulletPicker()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } catch (error) {
                    console.error('Error in showBulletPicker:', error);
                    alert('Error loading bullet library');
                }
            };

            window.selectBullet = async function(bulletId) {
                try {
                    console.log('Selecting bullet with ID:', bulletId);
                    
                    // Load the selected bullet data
                    const { data: bullet, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('id', bulletId)
                        .single();

                    if (error) {
                        console.error('Error loading bullet:', error);
                        alert('Error loading bullet data');
                        return;
                    }

                    console.log('Bullet data loaded:', bullet);

                    // Close the picker first
                    closeBulletPicker();

                    // Wait a moment for the DOM to update
                    setTimeout(() => {
                        try {
                            // Set the hidden field and display text
                            const bulletField = document.getElementById('dope_bullet_library');
                            const selectedText = document.getElementById('selected_bullet');
                            
                            if (bulletField) {
                                bulletField.value = bulletId;
                                console.log('Set bullet ID:', bulletId);
                            }
                            
                            if (selectedText) {
                                selectedText.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain_weight}gr`;
                                console.log('Set selected bullet text');
                            }

                            // Auto-populate bullet-specific fields from bullet_library
                            const setFieldValue = (fieldId, value) => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = value || '';
                                    console.log(`Set ${fieldId} to: ${value}`);
                                } else {
                                    console.warn(`Field ${fieldId} not found`);
                                }
                            };
                            
                            // Ammunition-specific data from bullet_library table
                            setFieldValue('manufacturer_name', bullet.manufacturer_name);
                            setFieldValue('caliber', bullet.caliber);
                            setFieldValue('grain_weight', bullet.grain ? `${bullet.grain}gr` : '');
                            setFieldValue('ballistic_coefficient', bullet.ballistic_coefficient);
                            setFieldValue('drag_model', bullet.drag_model);
                            setFieldValue('bullet_type', bullet.bullet_type);
                            
                            // Update bullet type div with text content
                            const bulletTypeField = document.getElementById('bullet_type');
                            if (bulletTypeField) {
                                // Set text content for div element
                                bulletTypeField.textContent = bullet.bullet_type;
                                bulletTypeField.innerHTML = bullet.bullet_type;
                                
                                // Add visual confirmation
                                bulletTypeField.style.cssText = 'background-color: #e8f5e8 !important; border: 2px solid #dc3545 !important; font-weight: bold !important; width: 100% !important; padding: 8px !important; color: #000000 !important; border-radius: 4px !important; min-height: 20px !important;';
                                
                                console.log('Bullet type div updated to:', bullet.bullet_type);
                                console.log('Div text content:', bulletTypeField.textContent);
                            }
                            
                            // Also update DOPE form bullet type field
                            const dopeBulletTypeField = document.getElementById('dope_bullet_type');
                            if (dopeBulletTypeField) {
                                dopeBulletTypeField.value = bullet.bullet_type;
                                console.log('DOPE bullet type field updated to:', bullet.bullet_type);
                            }
                            setFieldValue('lot_number', bullet.lot_number || '');
                            setFieldValue('muzzle_velocity', bullet.muzzle_velocity ? `${bullet.muzzle_velocity} fps` : '');
                            setFieldValue('muzzle_energy', bullet.muzzle_energy ? `${bullet.muzzle_energy} ft-lbs` : '');

                            console.log('Bullet data populated successfully');
                        } catch (innerError) {
                            console.error('Error populating bullet fields:', innerError);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error selecting bullet:', error);
                    alert('Error selecting bullet');
                }
            };

            window.closeBulletPicker = function() {
                const modal = document.getElementById('bulletPickerModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.populateFromBulletLibrary = function() {
                console.log('Populate from bullet library');
                // This function is kept for backward compatibility
                // The actual population now happens through showBulletPicker
            };

            window.showAddDopeFormDirect = function() {
                console.log('Show add DOPE form direct');
                const dopeContent = document.getElementById('dopeContent');
                if (dopeContent) {
                    // Get current date and time for embedding directly in HTML
                    const now = new Date();
                    const currentDate = now.toISOString().split('T')[0];
                    const currentTime = now.toTimeString().slice(0, 5);
                    
                    dopeContent.innerHTML = `
                        <div style="background-color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <h3>Log New Engagement</h3>
                            
                            <!-- Reference Data Selection -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Profile:</label>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="showFirearmPicker()" style="padding: 8px 15px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer;">Select Firearm</button>
                                    <span id="selected_firearm" style="padding: 8px; color: #666;">None selected</span>
                                </div>
                                <input type="hidden" id="dope_firearm_profile" value="">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Bullet Library:</label>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="showBulletPicker()" style="padding: 8px 15px; border: 1px solid #28a745; background-color: #28a745; color: white; border-radius: 4px; cursor: pointer;">Select Bullet</button>
                                    <span id="selected_bullet" style="padding: 8px; color: #666;">None selected</span>
                                </div>
                                <input type="hidden" id="dope_bullet_library" value="">
                            </div>
                            
                            <!-- Auto-populated fields from selected profile/bullet -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Shooter Name:</label>
                                <input type="text" id="shooter_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Type:</label>
                                <input type="text" id="firearm_type" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Name:</label>
                                <input type="text" id="firearm_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Rifle Caliber:</label>
                                <input type="text" id="rifle_caliber" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Length:</label>
                                <input type="text" id="barrel_length" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Twist Rate:</label>
                                <input type="text" id="barrel_twist_rate" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Name:</label>
                                <input type="text" id="optic_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Zero Distance:</label>
                                <input type="text" id="zero_distance" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Height Over Bore:</label>
                                <input type="text" id="height_over_bore" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <!-- Bullet-specific fields from bullet_library table -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Manufacturer Name:</label>
                                <input type="text" id="manufacturer_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Caliber:</label>
                                <input type="text" id="caliber" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Grain Weight:</label>
                                <input type="text" id="grain_weight" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ballistic Coefficient:</label>
                                <input type="text" id="ballistic_coefficient" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Drag Model:</label>
                                <input type="text" id="drag_model" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lot Number:</label>
                                <input type="text" id="lot_number" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Bullet Type:</label>
                                <input type="text" id="dope_bullet_type" readonly value="Not selected" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Muzzle Velocity:</label>
                                <input type="text" id="muzzle_velocity" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Muzzle Energy:</label>
                                <input type="text" id="muzzle_energy" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <!-- Date and Time -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Engagement Date:</label>
                                <input type="date" id="engagement_date" required value="${currentDate}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Engagement Time:</label>
                                <input type="time" id="engagement_time" value="${currentTime}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Range Data -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Range to Target:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="range_to_target" step="0.01" placeholder="Distance" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="range_unit" required style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Unit</option>
                                        <option value="meters">Meters</option>
                                        <option value="yards">Yards</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Wind Conditions -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Wind Speed:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="wind_speed" step="0.1" placeholder="Speed" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="wind_speed_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="mph" selected>mph</option>
                                        <option value="kph">kph</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Wind Direction (degrees):</label>
                                <input type="number" id="wind_direction" min="0" max="360" step="0.1" placeholder="0-360" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Wind Type:</label>
                                <select id="wind_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Type</option>
                                    <option value="Crosswind">Crosswind</option>
                                    <option value="Headwind">Headwind</option>
                                    <option value="Tailwind">Tailwind</option>
                                </select>
                            </div>
                            
                            <!-- Temperature -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Temperature:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="temperature" step="0.1" placeholder="Temperature" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="temperature_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Unit</option>
                                        <option value="C">Celsius</option>
                                        <option value="F" selected>Fahrenheit</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Additional Environmental Fields -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Humidity (%):</label>
                                <input type="number" id="humidity" min="0" max="100" step="0.1" placeholder="Relative humidity percentage" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barometric Pressure:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="barometric_pressure" step="0.01" placeholder="Pressure" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="pressure_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Unit</option>
                                        <option value="inHg" selected>inHg</option>
                                        <option value="mb">mb</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Altitude:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="altitude" step="0.1" placeholder="Elevation" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="altitude_reference" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Reference</option>
                                        <option value="Above Sea Level" selected>Above Sea Level</option>
                                        <option value="Below Sea Level">Below Sea Level</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Angle of Fire (degrees):</label>
                                <input type="number" id="angle_of_fire" min="-90" max="90" step="0.1" placeholder="Uphill/downhill angle" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Ballistic Effects -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Coriolis Effect (mils/MOA):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="coriolis_effect" step="0.001" placeholder="Coriolis compensation" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="coriolis_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="MOA" selected>MOA</option>
                                        <option value="MILS">MILS</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Spin Drift (mils/MOA):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="spin_drift" step="0.001" placeholder="Spin drift compensation" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="spin_drift_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="MOA" selected>MOA</option>
                                        <option value="MILS">MILS</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Target Movement -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Speed (mph/kph):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="target_movement_speed" step="0.1" placeholder="Target movement speed" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="target_speed_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="mph" selected>mph</option>
                                        <option value="kph">kph</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Direction (degrees):</label>
                                <input type="number" id="target_movement_direction" min="0" max="360" step="0.1" placeholder="Direction of target movement" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Optic Settings -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Magnification:</label>
                                <input type="number" id="optic_magnification" step="0.1" placeholder="Scope magnification setting" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Adjustment Units:</label>
                                <select id="optic_adjustment_units" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="MOA" selected>MOA</option>
                                    <option value="MRAD">MRAD</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Parallax Setting (yards/meters):</label>
                                <input type="number" id="parallax_setting" step="0.1" placeholder="Parallax focus distance" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Time and Conditions -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Time of Flight (seconds):</label>
                                <input type="number" id="time_of_flight" step="0.001" placeholder="Bullet flight time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Atmospheric Conditions:</label>
                                <select id="atmospheric_conditions" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Conditions</option>
                                    <option value="Clear">Clear</option>
                                    <option value="Overcast">Overcast</option>
                                    <option value="Rain">Rain</option>
                                    <option value="Snow">Snow</option>
                                    <option value="Fog">Fog</option>
                                    <option value="Hazy">Hazy</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Light Conditions:</label>
                                <select id="light_conditions" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Lighting</option>
                                    <option value="Bright Sun">Bright Sun</option>
                                    <option value="Overcast">Overcast</option>
                                    <option value="Dawn">Dawn</option>
                                    <option value="Dusk">Dusk</option>
                                    <option value="Low Light">Low Light</option>
                                    <option value="Artificial Light">Artificial Light</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Condition:</label>
                                <select id="barrel_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Condition</option>
                                    <option value="Cold Bore">Cold Bore</option>
                                    <option value="Warm">Warm</option>
                                    <option value="Hot">Hot</option>
                                    <option value="Fouled">Fouled</option>
                                    <option value="Clean">Clean</option>
                                </select>
                            </div>
                            
                            <!-- Engagement Outcome -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Engagement Outcome:</label>
                                <input type="text" id="engagement_outcome" placeholder="e.g. Hit center, Miss high, First round hit" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Notes -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes:</label>
                                <textarea id="engagement_notes" placeholder="Additional notes about the engagement..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <button onclick="saveDopeEngagement()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Save Engagement</button>
                            <button onclick="cancelDopeForm()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        </div>
                    `;
                    
                    // Load dropdowns after form is created
                    setTimeout(() => {
                        loadDopeDropdownsDirect();
                        console.log('Date and time embedded directly in HTML');
                    }, 50);
                }
            };

            window.cancelDopeForm = function() {
                const dopeContent = document.getElementById('dopeContent');
                if (dopeContent) {
                    dopeContent.innerHTML = 'Loading your engagements...';
                    setTimeout(() => loadDopeEngagementsDirect(), 100);
                }
            };

            window.saveDopeEngagement = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to save engagement data.');
                        return;
                    }

                    // Capture values using event target approach - get the button that was clicked
                    const saveButton = event.target;
                    const formContainer = saveButton.closest('div');
                    
                    // Function to find field values within the form container
                    const getFieldValueDirect = (id) => {
                        const element = formContainer.querySelector(`#${id}`);
                        if (!element) {
                            console.warn(`Field ${id} not found in form container`);
                            return null;
                        }
                        
                        if (element.tagName === 'SELECT') {
                            return element.options[element.selectedIndex]?.value || null;
                        }
                        return element.value?.trim() || null;
                    };
                    
                    // Quick validation with direct field access
                    const engagementDate = getFieldValueDirect('engagement_date');
                    const rangeTarget = getFieldValueDirect('range_to_target');
                    const rangeUnit = getFieldValueDirect('range_unit');
                    
                    console.log('Direct field capture:', {
                        engagementDate,
                        rangeTarget,
                        rangeUnit
                    });

                    if (!engagementDate) {
                        alert('Please fill in the engagement date.');
                        return;
                    }
                    
                    if (!rangeTarget || parseFloat(rangeTarget) <= 0) {
                        alert('Please enter a valid range to target.');
                        return;
                    }
                    
                    if (!rangeUnit) {
                        alert('Please select a range unit.');
                        return;
                    }


                    const dopeData = {
                        user_id: currentUser.id,
                        shooting_profile_id: getFieldValueDirect('dope_shooting_profile'),
                        bullet_library_id: parseFloat(getFieldValueDirect('dope_bullet_library')) || null,
                        engagement_date: engagementDate,
                        engagement_time: getFieldValueDirect('engagement_time'),
                        range_to_target: parseFloat(rangeTarget),
                        range_unit: rangeUnit,
                        // Wind conditions
                        wind_speed: parseFloat(getFieldValueDirect('wind_speed')) || null,
                        wind_direction: parseFloat(getFieldValueDirect('wind_direction')) || null,
                        wind_type: getFieldValueDirect('wind_type'),
                        // Temperature
                        temperature: parseFloat(getFieldValueDirect('temperature')) || null,
                        temperature_unit: getFieldValueDirect('temperature_unit'),
                        // Environmental data
                        humidity: parseFloat(getFieldValueDirect('humidity')) || null,
                        barometric_pressure: parseFloat(getFieldValueDirect('barometric_pressure')) || null,
                        pressure_unit: getFieldValueDirect('pressure_unit'),
                        altitude: parseFloat(getFieldValueDirect('altitude')) || null,
                        altitude_reference: getFieldValueDirect('altitude_reference'),
                        angle_of_fire: parseFloat(getFieldValueDirect('angle_of_fire')) || null,
                        // Ballistic effects
                        coriolis_effect: parseFloat(getFieldValueDirect('coriolis_effect')) || null,
                        spin_drift: parseFloat(getFieldValueDirect('spin_drift')) || null,
                        // Target movement
                        target_movement_speed: parseFloat(getFieldValueDirect('target_movement_speed')) || null,
                        target_movement_direction: parseFloat(getFieldValueDirect('target_movement_direction')) || null,
                        // Optic settings
                        optic_magnification: parseFloat(getFieldValueDirect('optic_magnification')) || null,
                        optic_adjustment_units: getFieldValueDirect('optic_adjustment_units'),
                        parallax_setting: parseFloat(getFieldValueDirect('parallax_setting')) || null,
                        // Time and conditions
                        time_of_flight: parseFloat(getFieldValueDirect('time_of_flight')) || null,
                        atmospheric_conditions: getFieldValueDirect('atmospheric_conditions'),
                        light_conditions: getFieldValueDirect('light_conditions'),
                        barrel_condition: getFieldValueDirect('barrel_condition'),
                        // Outcome and notes
                        engagement_outcome: getFieldValueDirect('engagement_outcome'),
                        notes: getFieldValueDirect('engagement_notes')
                    };

                    console.log('About to save DOPE data:', dopeData);

                    let data, error;
                    
                    // Check if we're editing an existing engagement
                    if (window.editingEngagementId) {
                        const result = await supabase
                            .from('dope_engagements')
                            .update(dopeData)
                            .eq('id', window.editingEngagementId)
                            .select();
                        data = result.data;
                        error = result.error;
                        window.editingEngagementId = null; // Clear editing mode
                    } else {
                        const result = await supabase
                            .from('dope_engagements')
                            .insert([dopeData])
                            .select();
                        data = result.data;
                        error = result.error;
                    }

                    if (error) {
                        console.error('Error saving DOPE engagement:', error);
                        console.error('Full error details:', error);
                        alert(`Error saving engagement: ${error.message || 'Unknown error'}. Please try again.`);
                    } else {
                        console.log('DOPE engagement saved successfully:', data);
                        alert('Engagement saved successfully!');
                        setTimeout(() => loadDopeEngagementsDirect(), 200);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving engagement. Please try again.');
                }
            };

            window.loadDopeEngagementsDirect = async function() {
                try {
                    console.log('loadDopeEngagementsDirect called');
                    
                    if (!currentUser) {
                        console.log('No current user, skipping load');
                        return;
                    }

                    // Use the same supabase constant as other working functions
                    const { data, error } = await supabase
                        .from('dope_engagements')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('engagement_date', { ascending: false });

                    const dopeContent = document.getElementById('dopeContent');
                    if (!dopeContent) return;

                    if (error) {
                        console.error('Error loading DOPE engagements:', error);
                        dopeContent.innerHTML = '<p>Error loading engagements. Please try again.</p>';
                        return;
                    }

                    if (data && data.length > 0) {
                        let tableHTML = `
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Range</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Wind</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Temperature</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Outcome</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.forEach(engagement => {
                            tableHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.engagement_date}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.range_to_target} ${engagement.range_unit}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.wind_speed !== null && engagement.wind_speed !== undefined ? `${engagement.wind_speed} ${engagement.wind_type || ''}` : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.temperature !== null && engagement.temperature !== undefined ? `${engagement.temperature}°${engagement.temperature_unit || 'F'}` : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.engagement_outcome && engagement.engagement_outcome.trim() !== '' ? engagement.engagement_outcome : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <button onclick="viewDopeEngagement('${engagement.id}')" style="background-color: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">View</button>
                                        <button onclick="editDopeEngagement('${engagement.id}')" style="background-color: #17a2b8; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteDopeEngagement('${engagement.id}')" style="background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });

                        tableHTML += '</tbody></table>';
                        dopeContent.innerHTML = tableHTML;
                    } else {
                        dopeContent.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No engagements logged yet. Click "Log New Engagement" to get started!</p>';
                    }
                } catch (error) {
                    console.error('Error loading DOPE engagements:', error);
                }
            };

            window.deleteDopeEngagement = async function(engagementId) {
                if (!confirm('Are you sure you want to delete this engagement?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('dope_engagements')
                        .delete()
                        .eq('id', engagementId)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error deleting engagement:', error);
                        alert('Error deleting engagement. Please try again.');
                    } else {
                        loadDopeEngagementsDirect();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting engagement. Please try again.');
                }
            };

            window.loadDopeDropdownsDirect = async function() {
                console.log('loadDopeDropdownsDirect called');
                try {
                    const currentUser = (await supabase.auth.getUser()).data.user;
                    if (!currentUser) {
                        console.log('No current user for dropdowns');
                        alert('Please log in to access your shooting profiles and bullets.');
                        return;
                    }

                    console.log('Loading shooting profiles for DOPE...');
                    // Load shooting profiles
                    const { data: profiles, error: profileError } = await supabase
                        .from('ballistic_sessions')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('shooter_name', { ascending: true });

                    if (profileError) {
                        console.error('Profile error:', profileError);
                        window.loadedProfiles = [];
                    } else {
                        console.log('Profiles loaded for DOPE:', profiles);
                        console.log('Number of profiles found:', profiles?.length || 0);
                        // Store profiles for picker button
                        window.loadedProfiles = profiles || [];
                        const profileSelect = document.getElementById('dope_shooting_profile');
                        console.log('Profile select element:', profileSelect);
                        if (profileSelect) {
                            console.log('About to populate profiles...');
                            // Test with simple static options first to confirm dropdown works
                            profileSelect.innerHTML = `
                                <option value="">Select a shooting profile...</option>
                                <option value="test1">Test Profile 1</option>
                                <option value="test2">Test Profile 2</option>
                            `;
                            
                            // Then add real data immediately after
                            setTimeout(() => {
                                let html = '<option value="">Select a shooting profile...</option>';
                                profiles.forEach(profile => {
                                    html += `<option value="${profile.id}">${profile.shooter_name} - ${profile.firearm_name} (${profile.caliber})</option>`;
                                });
                                profileSelect.innerHTML = html;
                                console.log('Final profile HTML:', profileSelect.innerHTML.length, 'characters');
                            }, 100);
                            console.log('Profile dropdown HTML set:', profileSelect.innerHTML.substring(0, 200));
                            console.log('Profile dropdown now has', profileSelect.children.length, 'total options');
                        } else {
                            console.log('Profile select element not found - checking page...');
                            console.log('All selects on page:', document.querySelectorAll('select'));
                        }
                    }

                    console.log('Loading bullet library for DOPE...');
                    // Load bullet library
                    const { data: bullets, error: bulletError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (bulletError) {
                        console.error('Bullet error:', bulletError);
                    } else {
                        console.log('Bullets loaded for DOPE:', bullets);
                        // Store bullets for picker button
                        window.loadedBullets = bullets;
                        const bulletSelect = document.getElementById('dope_bullet_library');
                        if (bulletSelect) {
                            bulletSelect.innerHTML = '<option value="">Select a bullet...</option>';
                            
                            if (bullets && bullets.length > 0) {
                                bullets.forEach(bullet => {
                                    const option = document.createElement('option');
                                    option.value = bullet.id;
                                    option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr`;
                                    option.style.color = 'black';
                                    option.style.backgroundColor = 'white';
                                    bulletSelect.appendChild(option);
                                });
                            }
                            
                            console.log('Bullet dropdown populated with', bullets ? bullets.length : 0, 'items');
                            console.log('Bullet dropdown now has', bulletSelect.children.length, 'total options');
                        } else {
                            console.log('Bullet select element not found');
                        }
                    }
                } catch (error) {
                    console.error('Error loading DOPE dropdowns:', error);
                }
            };

            // Store loaded data for picker buttons
            window.loadedProfiles = [];
            window.loadedBullets = [];

            // Zero Profile dropdown functions
            window.loadZeroProfileDropdowns = async function() {
                console.log('Loading Zero Profile dropdowns...');
                try {
                    if (!currentUser) {
                        console.log('No current user, skipping dropdown load');
                        return;
                    }

                    console.log('Current user:', currentUser.id);

                    // Load firearm library data
                    console.log('Loading firearms...');
                    const { data: firearms, error: firearmError } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('profile_name', { ascending: true });

                    console.log('Firearms loaded:', firearms, 'Error:', firearmError);

                    if (!firearmError && firearms) {
                        const firearmSelect = document.getElementById('zeroFirearmSelect');
                        console.log('Firearm select element:', firearmSelect);
                        if (firearmSelect) {
                            firearmSelect.innerHTML = '<option value="">Optional</option>';
                            firearms.forEach(firearm => {
                                const option = document.createElement('option');
                                option.value = firearm.id;
                                option.textContent = `${firearm.firearm_name} ${firearm.barrel_length}" ${firearm.caliber} ${firearm.barrel_twist_rate} ${firearm.optic_name} ${firearm.zero_distance}yds`;
                                firearmSelect.appendChild(option);
                            });
                            console.log('Populated firearm dropdown with', firearms.length, 'items');
                        }
                    }

                    // Load bullet library data
                    console.log('Loading bullets...');
                    const { data: bullets, error: bulletError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    console.log('Bullets loaded:', bullets, 'Error:', bulletError);

                    if (!bulletError && bullets) {
                        const bulletSelect = document.getElementById('zeroBulletSelect');
                        console.log('Bullet select element:', bulletSelect);
                        if (bulletSelect) {
                            bulletSelect.innerHTML = '<option value="">Optional</option>';
                            bullets.forEach(bullet => {
                                const option = document.createElement('option');
                                option.value = bullet.id;
                                option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr - BC: ${bullet.ballistic_coefficient}`;
                                bulletSelect.appendChild(option);
                            });
                            console.log('Populated bullet dropdown with', bullets.length, 'items');
                        }
                    }
                } catch (error) {
                    console.error('Error loading Zero Profile dropdowns:', error);
                }
            };

            window.loadZeroFirearmData = async function() {
                const firearmSelect = document.getElementById('zeroFirearmSelect');
                const firearmId = firearmSelect.value;
                
                if (!firearmId) return;

                try {
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) throw error;

                    // Populate firearm fields
                    const form = document.getElementById('ballisticForm');
                    if (firearm.shooter_name) form.querySelector('[name="shooter_name"]').value = firearm.shooter_name;
                    if (firearm.firearm_type) form.querySelector('[name="firearm_type"]').value = firearm.firearm_type;
                    if (firearm.firearm_name) form.querySelector('[name="firearm_name"]').value = firearm.firearm_name;
                    if (firearm.optic_name) form.querySelector('[name="optic_name"]').value = firearm.optic_name;
                    if (firearm.caliber) form.querySelector('[name="caliber"]').value = firearm.caliber;
                    if (firearm.barrel_length) form.querySelector('[name="barrel_length"]').value = firearm.barrel_length;
                    if (firearm.barrel_twist_rate) form.querySelector('[name="barrel_twist_rate"]').value = firearm.barrel_twist_rate;
                    if (firearm.zero_distance) form.querySelector('[name="zero_distance"]').value = firearm.zero_distance;
                    if (firearm.height_over_bore) form.querySelector('[name="height_over_bore"]').value = firearm.height_over_bore;

                } catch (error) {
                    console.error('Error loading firearm data:', error);
                    alert('Error loading firearm data. Please try again.');
                }
            };

            window.loadZeroBulletData = async function() {
                const bulletSelect = document.getElementById('zeroBulletSelect');
                const bulletId = bulletSelect.value;
                
                if (!bulletId) return;

                try {
                    const { data: bullet, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('id', bulletId)
                        .single();

                    if (error) throw error;

                    // Populate bullet fields
                    const form = document.getElementById('ballisticForm');
                    if (bullet.grain) form.querySelector('[name="bullet_grain"]').value = bullet.grain;
                    if (bullet.ballistic_coefficient) form.querySelector('[name="ballistic_coefficient"]').value = bullet.ballistic_coefficient;
                    if (bullet.drag_model) form.querySelector('[name="drag_model"]').value = bullet.drag_model;
                    if (bullet.muzzle_velocity) form.querySelector('[name="muzzle_velocity"]').value = bullet.muzzle_velocity;
                    if (bullet.muzzle_energy) form.querySelector('[name="muzzle_energy"]').value = bullet.muzzle_energy;

                } catch (error) {
                    console.error('Error loading bullet data:', error);
                    alert('Error loading bullet data. Please try again.');
                }
            };
            
            // This old function has been replaced by the new showProfilePicker above
            
            // Old duplicate functions have been removed

            // Zero Profile Functions
            window.showZeroProfile = function() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('shootingProfileSection').style.display = 'block';
                
                // Hide other sections
                const hideElement = (id) => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                };
                hideElement('firearmLibrarySection');
                hideElement('bulletLibrarySection');
                hideElement('activeDopeSection');
                
                // Load the dropdowns with a slight delay to ensure DOM is ready
                setTimeout(() => {
                    loadZeroProfileDropdowns();
                }, 100);
            };

            // Firearm Library Functions
            window.showFirearmLibrary = function() {
                console.log('showFirearmLibrary function called');
                
                // Hide all other sections
                const hideElement = (id) => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                };
                hideElement('homePage');
                hideElement('shootingProfileSection');
                hideElement('bulletLibrarySection');
                hideElement('ballisticForm');
                hideElement('addBulletForm');
                hideElement('filterSection');
                hideElement('activeBulletLibrary');
                hideElement('activeDopeSection');
                
                // Create Firearm Library content
                const appContent = document.getElementById('appContent');
                const firearmContent = document.createElement('div');
                firearmContent.id = 'activeFirearmLibrary';
                firearmContent.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                        <h2 style="margin: 0;">Firearm Library</h2>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="showAddFirearmForm()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Add New Firearm</button>
                    </div>

                    <div id="addFirearmForm" style="display: none; background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <h3>Add New Firearm Profile</h3>
                        <form id="firearmForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Profile Name:</label>
                                    <input type="text" name="profile_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Shooter Name:</label>
                                    <input type="text" name="shooter_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Type:</label>
                                    <select name="firearm_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                        <option value="">Select</option>
                                        <option value="Rifle">Rifle</option>
                                        <option value="Pistol">Pistol</option>
                                        <option value="Shotgun">Shotgun</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Name:</label>
                                    <input type="text" name="firearm_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Caliber:</label>
                                    <select name="caliber" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                        <option value="">Select Caliber</option>
                                        <option value=".223 Rem">.223 Rem</option>
                                        <option value="5.56 NATO">5.56 NATO</option>
                                        <option value=".308 Win">.308 Win</option>
                                        <option value="7.62 NATO">7.62 NATO</option>
                                        <option value="6.5 Creedmoor">6.5 Creedmoor</option>
                                        <option value=".300 Blackout">.300 Blackout</option>
                                        <option value=".30-06 Springfield">.30-06 Springfield</option>
                                        <option value=".22 LR">.22 LR</option>
                                        <option value=".243 Win">.243 Win</option>
                                        <option value="7.62x39mm">7.62x39mm</option>
                                        <option value="6.8 SPC">6.8 SPC</option>
                                        <option value=".338 Lapua Magnum">.338 Lapua Magnum</option>
                                        <option value="9mm Luger">9mm Luger</option>
                                        <option value=".45 ACP">.45 ACP</option>
                                        <option value=".40 S&W">.40 S&W</option>
                                        <option value=".380 ACP">.380 ACP</option>
                                        <option value=".357 Magnum">.357 Magnum</option>
                                        <option value=".38 Special">.38 Special</option>
                                        <option value="10mm Auto">10mm Auto</option>
                                        <option value=".44 Magnum">.44 Magnum</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Length (inches):</label>
                                    <input type="number" name="barrel_length" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Twist Rate:</label>
                                    <select name="barrel_twist_rate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select Twist Rate</option>
                                        <option value="1:7">1:7</option>
                                        <option value="1:8">1:8</option>
                                        <option value="1:9">1:9</option>
                                        <option value="1:9.25">1:9.25</option>
                                        <option value="1:10">1:10</option>
                                        <option value="1:10.5">1:10.5</option>
                                        <option value="1:11">1:11</option>
                                        <option value="1:12">1:12</option>
                                        <option value="1:14">1:14</option>
                                        <option value="1:16">1:16</option>
                                        <option value="1:18.75">1:18.75</option>
                                        <option value="1:20">1:20</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Name:</label>
                                    <input type="text" name="optic_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Zero Distance (yards):</label>
                                    <input type="number" name="zero_distance" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Height Over Bore (inches):</label>
                                    <input type="number" name="height_over_bore" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button type="button" onclick="saveFirearm()" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Save Firearm</button>
                                <button type="button" onclick="cancelFirearmForm()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Edit Firearm Form -->
                    <div id="editFirearmSection" style="display: none; background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <h3>Edit Firearm Profile</h3>
                        <form id="editFirearmForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Profile Name:</label>
                                    <input type="text" id="edit_firearm_profile_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Shooter Name:</label>
                                    <input type="text" id="edit_firearm_shooter_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Type:</label>
                                    <select id="edit_firearm_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select</option>
                                        <option value="Rifle">Rifle</option>
                                        <option value="Pistol">Pistol</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Name:</label>
                                    <input type="text" id="edit_firearm_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Caliber:</label>
                                    <select id="edit_firearm_caliber" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select Caliber</option>
                                        <option value=".223 Rem">.223 Rem</option>
                                        <option value="5.56 NATO">5.56 NATO</option>
                                        <option value=".308 Win">.308 Win</option>
                                        <option value="7.62 NATO">7.62 NATO</option>
                                        <option value="6.5 Creedmoor">6.5 Creedmoor</option>
                                        <option value=".300 Blackout">.300 Blackout</option>
                                        <option value=".30-06 Springfield">.30-06 Springfield</option>
                                        <option value=".22 LR">.22 LR</option>
                                        <option value=".243 Win">.243 Win</option>
                                        <option value="7.62x39mm">7.62x39mm</option>
                                        <option value="6.8 SPC">6.8 SPC</option>
                                        <option value=".338 Lapua Magnum">.338 Lapua Magnum</option>
                                        <option value="9mm Luger">9mm Luger</option>
                                        <option value=".45 ACP">.45 ACP</option>
                                        <option value=".40 S&W">.40 S&W</option>
                                        <option value=".380 ACP">.380 ACP</option>
                                        <option value=".357 Magnum">.357 Magnum</option>
                                        <option value=".38 Special">.38 Special</option>
                                        <option value="10mm Auto">10mm Auto</option>
                                        <option value=".44 Magnum">.44 Magnum</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Length (inches):</label>
                                    <input type="number" id="edit_firearm_barrel_length" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Twist Rate:</label>
                                    <select id="edit_firearm_barrel_twist_rate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select Twist Rate</option>
                                        <option value="1:7">1:7</option>
                                        <option value="1:8">1:8</option>
                                        <option value="1:9">1:9</option>
                                        <option value="1:9.25">1:9.25</option>
                                        <option value="1:10">1:10</option>
                                        <option value="1:10.5">1:10.5</option>
                                        <option value="1:11">1:11</option>
                                        <option value="1:12">1:12</option>
                                        <option value="1:14">1:14</option>
                                        <option value="1:16">1:16</option>
                                        <option value="1:18.75">1:18.75</option>
                                        <option value="1:20">1:20</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Name:</label>
                                    <input type="text" id="edit_firearm_optic_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Zero Distance (yards):</label>
                                    <input type="number" id="edit_firearm_zero_distance" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Height Over Bore (inches):</label>
                                    <input type="number" id="edit_firearm_height_over_bore" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button type="button" onclick="updateFirearmDirect()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Update Firearm</button>
                                <button type="button" onclick="cancelFirearmEdit()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div id="firearmList" style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h3>Your Firearm Profiles</h3>
                        <div id="firearmResults">
                            <p>Loading firearm profiles...</p>
                        </div>
                    </div>
                `;
                
                appContent.appendChild(firearmContent);
                
                // Load existing firearm profiles
                loadFirearmProfiles();
            };

            window.showAddFirearmForm = function() {
                document.getElementById('addFirearmForm').style.display = 'block';
            };

            window.cancelFirearmForm = function() {
                document.getElementById('addFirearmForm').style.display = 'none';
                document.getElementById('firearmForm').reset();
            };

            window.saveFirearm = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to save firearm profiles.');
                        return;
                    }

                    const form = document.getElementById('firearmForm');
                    const formData = new FormData(form);
                    
                    const firearmData = {
                        user_id: currentUser.id,
                        profile_name: formData.get('profile_name'),
                        shooter_name: formData.get('shooter_name'),
                        firearm_type: formData.get('firearm_type'),
                        firearm_name: formData.get('firearm_name'),
                        caliber: formData.get('caliber'),
                        barrel_length: formData.get('barrel_length') ? parseFloat(formData.get('barrel_length')) : null,
                        barrel_twist_rate: formData.get('barrel_twist_rate'),
                        optic_name: formData.get('optic_name'),
                        zero_distance: formData.get('zero_distance') ? parseFloat(formData.get('zero_distance')) : null,
                        height_over_bore: formData.get('height_over_bore') ? parseFloat(formData.get('height_over_bore')) : null
                    };

                    const { data, error } = await supabase
                        .from('firearm_profile')
                        .insert([firearmData]);

                    if (error) {
                        console.error('Error saving firearm profile:', error);
                        alert('Error saving firearm profile: ' + error.message);
                        return;
                    }

                    alert('Firearm profile saved successfully!');
                    cancelFirearmForm();
                    loadFirearmProfiles();
                } catch (error) {
                    console.error('Error saving firearm:', error);
                    alert('Error saving firearm profile');
                }
            };

            window.loadFirearmProfiles = async function() {
                try {
                    if (!currentUser) {
                        document.getElementById('firearmResults').innerHTML = '<p>Please log in to view your firearm profiles.</p>';
                        return;
                    }

                    const { data: firearms, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('profile_name', { ascending: true });

                    if (error) {
                        console.error('Error loading firearm profiles:', error);
                        document.getElementById('firearmResults').innerHTML = '<p>Error loading firearm profiles. Please ensure the firearm_profile table exists in your database.</p>';
                        return;
                    }

                    if (!firearms || firearms.length === 0) {
                        document.getElementById('firearmResults').innerHTML = '<p>No firearm profiles found. Click "Add New Firearm" to create your first profile.</p>';
                        return;
                    }

                    // Create table header
                    let firearmHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Profile</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Shooter</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Type</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Firearm</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Caliber</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Barrel</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Twist</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Optic</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Zero</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">HOB</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    // Add table rows
                    firearmHTML += firearms.map((firearm, index) => `
                        <tr style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;'}">
                            <td style="padding: 12px; color: #007bff; font-weight: 500;">${firearm.profile_name}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.shooter_name}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.firearm_type}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.firearm_name}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.caliber}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.barrel_length ? firearm.barrel_length + '"' : '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.barrel_twist_rate || '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.optic_name || '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.zero_distance ? firearm.zero_distance + 'yds' : '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.height_over_bore ? firearm.height_over_bore + '"' : '-'}</td>
                            <td style="padding: 12px;">
                                <button onclick="editFirearm('${firearm.id}')" style="background-color: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.875rem;">Edit</button>
                                <button onclick="deleteFirearm('${firearm.id}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">Delete</button>
                            </td>
                        </tr>
                    `).join('');

                    // Close table
                    firearmHTML += `
                            </tbody>
                        </table>
                    `;

                    document.getElementById('firearmResults').innerHTML = firearmHTML;
                } catch (error) {
                    console.error('Error loading firearms:', error);
                    document.getElementById('firearmResults').innerHTML = '<p>Error loading firearm profiles.</p>';
                }
            };

            window.editFirearm = async function(firearmId) {
                try {
                    // Fetch the existing firearm data
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) {
                        alert('Error loading firearm data. Please try again.');
                        return;
                    }

                    // Hide the firearm list and show edit form
                    document.getElementById('firearmList').style.display = 'none';
                    document.getElementById('editFirearmSection').style.display = 'block';

                    // Populate the edit form
                    document.getElementById('edit_firearm_profile_name').value = firearm.profile_name || '';
                    document.getElementById('edit_firearm_shooter_name').value = firearm.shooter_name || '';
                    document.getElementById('edit_firearm_type').value = firearm.firearm_type || '';
                    document.getElementById('edit_firearm_name').value = firearm.firearm_name || '';
                    document.getElementById('edit_firearm_caliber').value = firearm.caliber || '';
                    document.getElementById('edit_firearm_barrel_length').value = firearm.barrel_length || '';
                    document.getElementById('edit_firearm_barrel_twist_rate').value = firearm.barrel_twist_rate || '';
                    document.getElementById('edit_firearm_optic_name').value = firearm.optic_name || '';
                    document.getElementById('edit_firearm_zero_distance').value = firearm.zero_distance || '';
                    document.getElementById('edit_firearm_height_over_bore').value = firearm.height_over_bore || '';
                    
                    // Store the firearm ID for updating
                    window.currentEditingFirearmId = firearmId;

                } catch (error) {
                    console.error('Error in editFirearm:', error);
                    alert('Error loading firearm data. Please try again.');
                }
            };

            // Update firearm function
            window.updateFirearmDirect = async function() {
                try {
                    const updateData = {
                        profile_name: document.getElementById('edit_firearm_profile_name').value,
                        shooter_name: document.getElementById('edit_firearm_shooter_name').value,
                        firearm_type: document.getElementById('edit_firearm_type').value,
                        firearm_name: document.getElementById('edit_firearm_name').value,
                        caliber: document.getElementById('edit_firearm_caliber').value,
                        barrel_length: document.getElementById('edit_firearm_barrel_length').value ? parseFloat(document.getElementById('edit_firearm_barrel_length').value) : null,
                        barrel_twist_rate: document.getElementById('edit_firearm_barrel_twist_rate').value,
                        optic_name: document.getElementById('edit_firearm_optic_name').value,
                        zero_distance: document.getElementById('edit_firearm_zero_distance').value ? parseFloat(document.getElementById('edit_firearm_zero_distance').value) : null,
                        height_over_bore: document.getElementById('edit_firearm_height_over_bore').value ? parseFloat(document.getElementById('edit_firearm_height_over_bore').value) : null
                    };

                    const { error } = await supabase
                        .from('firearm_profile')
                        .update(updateData)
                        .eq('id', window.currentEditingFirearmId);

                    if (error) {
                        alert('Error updating firearm profile. Please try again.');
                    } else {
                        alert('Firearm profile updated successfully!');
                        cancelFirearmEdit();
                        await loadFirearmProfiles();
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error updating firearm profile. Please try again.');
                }
            };

            // Cancel firearm edit function
            window.cancelFirearmEdit = function() {
                document.getElementById('editFirearmSection').style.display = 'none';
                document.getElementById('firearmList').style.display = 'block';
            };



            window.deleteFirearm = async function(firearmId) {
                if (!confirm('Are you sure you want to delete this firearm profile?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('firearm_profile')
                        .delete()
                        .eq('id', firearmId);

                    if (error) {
                        console.error('Error deleting firearm:', error);
                        alert('Error deleting firearm profile');
                        return;
                    }

                    alert('Firearm profile deleted successfully!');
                    loadFirearmProfiles();
                } catch (error) {
                    console.error('Error deleting firearm:', error);
                    alert('Error deleting firearm profile');
                }
            };



            window.searchSessions = async function() {
                console.warn('searchSessions function started');
                const shooterName = document.getElementById('search_shooter_name').value.trim().toLowerCase();
                const firearmType = document.getElementById('search_firearm_type').value.trim();
                const firearmName = document.getElementById('search_firearm_name').value.trim().toLowerCase();
                const bulletGrainInput = document.getElementById('search_bullet_grain').value.trim();
                const barrelLengthInput = document.getElementById('search_barrel_length').value.trim();
                const zeroDistanceInput = document.getElementById('search_zero_distance').value.trim();

                // Parse numeric inputs
                const bulletGrain = bulletGrainInput ? parseInt(bulletGrainInput) : null;
                const barrelLength = barrelLengthInput ? parseFloat(barrelLengthInput) : null;
                const zeroDistance = zeroDistanceInput ? parseInt(zeroDistanceInput) : null;

                const { data, error } = await supabase.from('ballistic_sessions').select('*').eq('user_id', currentUser.id);
                if (error) {
                    console.error('Supabase search error:', error);
                    document.getElementById('message').innerHTML = `<div class="error">Error searching sessions: ${error.message}</div>`;
                    return;
                }

                const filtered = data.filter(session =>
                    (shooterName === '' || (session.shooter_name && session.shooter_name.trim().toLowerCase().includes(shooterName))) &&
                    (firearmType === '' || (session.firearm_type && session.firearm_type.trim() === firearmType)) &&
                    (firearmName === '' || (session.firearm_name && session.firearm_name.trim().toLowerCase().includes(firearmName))) &&
                    (bulletGrain === null || (session.bullet_grain && session.bullet_grain === bulletGrain)) &&
                    (barrelLength === null || (session.barrel_length && session.barrel_length === barrelLength)) &&
                    (zeroDistance === null || (session.zero_distance && session.zero_distance === zeroDistance))
                );
                window.displaySessions(filtered);
            };

            window.clearSearch = function() {
                console.log('Clearing search');
                document.getElementById('search_shooter_name').value = '';
                document.getElementById('search_firearm_type').value = '';
                document.getElementById('search_firearm_name').value = '';
                document.getElementById('search_bullet_grain').value = '';
                document.getElementById('search_barrel_length').value = '';
                document.getElementById('search_zero_distance').value = '';
                document.getElementById('sessionsBody').innerHTML = '';
                document.getElementById('message').innerHTML = '';
                document.getElementById('trajectoryDescription').textContent = '';
                document.getElementById('comparisonTitle').style.display = 'none';
                document.getElementById('comparisonTable').style.display = 'none';
            };

            window.deleteSelected = async function() {
                console.warn('deleteSelected function started');
                const checkboxes = document.querySelectorAll('.select-session:checked');
                if (checkboxes.length === 0) {
                    console.error('No sessions selected for deletion');
                    document.getElementById('message').innerHTML = '<div class="error">No sessions selected for deletion.</div>';
                    return;
                }

                if (!confirm('Are you sure you want to delete the selected sessions?')) {
                    return;
                }

                const ids = Array.from(checkboxes).map(cb => cb.dataset.id);
                const { error } = await supabase.from('ballistic_sessions').delete().in('id', ids).eq('user_id', currentUser.id);
                if (error) {
                    console.error('Supabase delete error:', error);
                    document.getElementById('message').innerHTML = `<div class="error">Error deleting sessions: ${error.message}</div>`;
                } else {
                    console.log('Selected sessions deleted successfully');
                    document.getElementById('message').innerHTML = '<div class="message">Selected sessions deleted successfully!</div>';
                    document.getElementById('trajectoryDescription').textContent = '';
                    document.getElementById('comparisonTitle').style.display = 'none';
                    document.getElementById('comparisonTable').style.display = 'none';
                    window.viewAll();
                }
            };

            window.hideBulletLibrary = function() {
                document.getElementById('bulletLibrarySection').style.display = 'none';
                document.getElementById('addBulletForm').style.display = 'none';
            };

            window.showAddBulletForm = function() {
                document.getElementById('addBulletForm').style.display = 'block';
                document.getElementById('bullet_manufacturer').value = '';
                document.getElementById('bullet_caliber').value = '';
                document.getElementById('bullet_grain').value = '';
                document.getElementById('bullet_bc').value = '';
                document.getElementById('bullet_drag_model').value = '';
                document.getElementById('bullet_type').value = '';
            };

            window.cancelAddBullet = function() {
                document.getElementById('addBulletForm').style.display = 'none';
            };

            window.saveBullet = async function() {
                const manufacturer = document.getElementById('bullet_manufacturer').value.trim();
                const caliber = document.getElementById('bullet_caliber').value.trim();
                const grain = parseInt(document.getElementById('bullet_grain').value);
                const bc = parseFloat(document.getElementById('bullet_bc').value);
                const dragModel = document.getElementById('bullet_drag_model').value;
                const bulletType = document.getElementById('bullet_type').value;

                if (!manufacturer || !caliber || !grain || !bc || !dragModel || !bulletType) {
                    alert('Please fill in all fields');
                    return;
                }

                if (bc < 0.1 || bc > 1.0) {
                    alert('Ballistic coefficient must be between 0.1 and 1.0');
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('bullet_library')
                        .insert([{
                            user_id: currentUser.id,
                            manufacturer_name: manufacturer,
                            caliber: caliber,
                            grain: grain,
                            ballistic_coefficient: bc,
                            drag_model: dragModel,
                            bullet_type: bulletType
                        }]);

                    if (error) {
                        console.error('Error saving bullet:', error);
                        alert('Error saving bullet. Please try again.');
                    } else {
                        console.log('Bullet saved successfully');
                        document.getElementById('addBulletForm').style.display = 'none';
                        await loadBulletLibrary();
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error saving bullet. Please try again.');
                }
            };

            window.loadBulletLibraryDirect = async function() {
                try {
                    if (!currentUser) {
                        document.getElementById('bulletLibraryContent').innerHTML = '<p>Please log in to view your bullets.</p>';
                        return;
                    }

                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (error) {
                        document.getElementById('bulletLibraryContent').innerHTML = '<p>Error loading bullets. Please try again.</p>';
                        return;
                    }

                    const content = document.getElementById('bulletLibraryContent');
                    
                    if (data && data.length > 0) {
                        let tableHTML = `
                            <div style="margin-bottom: 15px;">
                                <button onclick="deleteSelectedBullets()" style="background-color: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Delete Selected</button>
                                <button onclick="selectAllBullets()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Select All</button>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">
                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                        </th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Manufacturer</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Caliber</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Grain</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">BC</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Drag</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Lot Number</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Production Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Purchase Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Muzzle Velocity (fps)</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Muzzle Energy (ft-lbs)</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.forEach(bullet => {
                            tableHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <input type="checkbox" class="bullet-checkbox" value="${bullet.id}">
                                    </td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.manufacturer_name}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.caliber}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.grain}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.ballistic_coefficient}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.drag_model}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.bullet_type}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.lot_number || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.production_date || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.purchase_date || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.muzzle_velocity || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.muzzle_energy || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <button onclick="editBulletDirect(${bullet.id})" style="background-color: #17a2b8; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteBulletDirect(${bullet.id})" style="background-color: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table>';
                        content.innerHTML = tableHTML;
                    } else {
                        content.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No bullets in your library yet. Click "Add New Bullet" to get started!</p>';
                    }
                } catch (e) {
                    document.getElementById('bulletLibraryContent').innerHTML = '<p>Error loading bullets. Please try again.</p>';
                }
            };

            window.showAddBulletFormDirect = function() {
                const content = document.getElementById('bulletLibraryContent');
                content.innerHTML = `
                    <div style="background-color: white; padding: 20px; border-radius: 5px; border: 1px solid #ddd; margin-top: 15px;">
                        <h3>Add New Bullet</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Manufacturer Name:</label>
                            <input type="text" id="bullet_manufacturer_direct" placeholder="e.g. Federal, Hornady, Barnes" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Caliber:</label>
                            <input type="text" id="bullet_caliber_direct" placeholder="e.g. .308 Win, 6.5 Creedmoor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Grain Weight:</label>
                            <input type="number" id="bullet_grain_direct" placeholder="e.g. 168" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Ballistic Coefficient:</label>
                            <input type="number" step="0.001" id="bullet_bc_direct" placeholder="e.g. 0.462" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Drag Model:</label>
                            <select id="bullet_drag_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="G1">G1</option>
                                <option value="G7">G7</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Bullet Type:</label>
                            <select id="bullet_type_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select bullet type...</option>
                                <option value="FMJ">FMJ</option>
                                <option value="JHP">JHP</option>
                                <option value="Soft Point">Soft Point</option>
                                <option value="TMJ">TMJ</option>
                                <option value="Frangible">Frangible</option>
                                <option value="WC">WC</option>
                                <option value="SWC">SWC</option>
                                <option value="AP">AP</option>
                                <option value="Subsonic">Subsonic</option>
                                <option value="GT">GT</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Lot Number:</label>
                            <input type="text" id="bullet_lot_direct" placeholder="e.g. LOT123456" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Production Date:</label>
                            <input type="date" id="bullet_production_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Purchase Date:</label>
                            <input type="date" id="bullet_purchase_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Muzzle Velocity (fps):</label>
                            <input type="number" id="bullet_velocity_direct" placeholder="e.g. 3020" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Muzzle Energy (ft-lbs):</label>
                            <input type="number" id="bullet_energy_direct" placeholder="e.g. 1255" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveBulletDirect()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Save Bullet</button>
                            <button onclick="loadBulletLibraryDirect()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                `;
            };

            window.saveBulletDirect = async function() {
                try {
                    const bulletData = {
                        user_id: currentUser.id,
                        manufacturer_name: document.getElementById('bullet_manufacturer_direct').value,
                        caliber: document.getElementById('bullet_caliber_direct').value,
                        grain: parseInt(document.getElementById('bullet_grain_direct').value),
                        ballistic_coefficient: parseFloat(document.getElementById('bullet_bc_direct').value),
                        drag_model: document.getElementById('bullet_drag_direct').value,
                        bullet_type: document.getElementById('bullet_type_direct').value,
                        lot_number: document.getElementById('bullet_lot_direct').value,
                        production_date: document.getElementById('bullet_production_direct').value || null,
                        purchase_date: document.getElementById('bullet_purchase_direct').value || null,
                        muzzle_velocity: parseFloat(document.getElementById('bullet_velocity_direct').value) || null,
                        muzzle_energy: parseFloat(document.getElementById('bullet_energy_direct').value) || null
                    };

                    const { error } = await supabase
                        .from('bullet_library')
                        .insert([bulletData]);

                    if (error) {
                        alert('Error saving bullet: ' + error.message);
                        return;
                    }

                    alert('Bullet saved successfully!');
                    await loadBulletLibraryDirect();
                } catch (e) {
                    alert('Error saving bullet. Please try again.');
                }
            };

            window.deleteBulletDirect = async function(bulletId) {
                if (confirm('Are you sure you want to delete this bullet?')) {
                    try {
                        const { error } = await supabase
                            .from('bullet_library')
                            .delete()
                            .eq('id', bulletId);

                        if (error) {
                            alert('Error deleting bullet: ' + error.message);
                            return;
                        }

                        alert('Bullet deleted successfully!');
                        await loadBulletLibraryDirect();
                    } catch (e) {
                        alert('Error deleting bullet. Please try again.');
                    }
                }
            };

            window.editBulletDirect = async function(bulletId) {
                try {
                    // Get the bullet data
                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('id', bulletId)
                        .single();

                    if (error) {
                        alert('Error loading bullet data: ' + error.message);
                        return;
                    }

                    const content = document.getElementById('bulletLibraryContent');
                    content.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 5px; border: 1px solid #ddd; margin-top: 15px;">
                            <h3>Edit Bullet</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Manufacturer Name:</label>
                                <input type="text" id="edit_bullet_manufacturer" value="${data.manufacturer_name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Caliber:</label>
                                <input type="text" id="edit_bullet_caliber" value="${data.caliber}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Grain Weight:</label>
                                <input type="number" id="edit_bullet_grain" value="${data.grain}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Ballistic Coefficient:</label>
                                <input type="number" step="0.001" id="edit_bullet_bc" value="${data.ballistic_coefficient}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Drag Model:</label>
                                <select id="edit_bullet_drag" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="G1" ${data.drag_model === 'G1' ? 'selected' : ''}>G1</option>
                                    <option value="G7" ${data.drag_model === 'G7' ? 'selected' : ''}>G7</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Bullet Type:</label>
                                <select id="edit_bullet_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select bullet type...</option>
                                    <option value="FMJ" ${data.bullet_type === 'FMJ' ? 'selected' : ''}>FMJ</option>
                                    <option value="JHP" ${data.bullet_type === 'JHP' ? 'selected' : ''}>JHP</option>
                                    <option value="Soft Point" ${data.bullet_type === 'Soft Point' ? 'selected' : ''}>Soft Point</option>
                                    <option value="TMJ" ${data.bullet_type === 'TMJ' ? 'selected' : ''}>TMJ</option>
                                    <option value="Frangible" ${data.bullet_type === 'Frangible' ? 'selected' : ''}>Frangible</option>
                                    <option value="WC" ${data.bullet_type === 'WC' ? 'selected' : ''}>WC</option>
                                    <option value="SWC" ${data.bullet_type === 'SWC' ? 'selected' : ''}>SWC</option>
                                    <option value="AP" ${data.bullet_type === 'AP' ? 'selected' : ''}>AP</option>
                                    <option value="Subsonic" ${data.bullet_type === 'Subsonic' ? 'selected' : ''}>Subsonic</option>
                                    <option value="GT" ${data.bullet_type === 'GT' ? 'selected' : ''}>GT</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Lot Number:</label>
                                <input type="text" id="edit_bullet_lot" value="${data.lot_number || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Production Date:</label>
                                <input type="date" id="edit_bullet_production" value="${data.production_date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Purchase Date:</label>
                                <input type="date" id="edit_bullet_purchase" value="${data.purchase_date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Muzzle Velocity (fps):</label>
                                <input type="number" id="edit_bullet_velocity" value="${data.muzzle_velocity || ''}" placeholder="e.g. 3020" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Muzzle Energy (ft-lbs):</label>
                                <input type="number" id="edit_bullet_energy" value="${data.muzzle_energy || ''}" placeholder="e.g. 1255" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="updateBulletDirect(${bulletId})" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Update Bullet</button>
                                <button onclick="loadBulletLibraryDirect()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    alert('Error loading bullet data. Please try again.');
                }
            };

            window.updateBulletDirect = async function(bulletId) {
                try {
                    const bulletData = {
                        manufacturer_name: document.getElementById('edit_bullet_manufacturer').value,
                        caliber: document.getElementById('edit_bullet_caliber').value,
                        grain: parseInt(document.getElementById('edit_bullet_grain').value),
                        ballistic_coefficient: parseFloat(document.getElementById('edit_bullet_bc').value),
                        drag_model: document.getElementById('edit_bullet_drag').value,
                        bullet_type: document.getElementById('edit_bullet_type').value,
                        lot_number: document.getElementById('edit_bullet_lot').value,
                        production_date: document.getElementById('edit_bullet_production').value || null,
                        purchase_date: document.getElementById('edit_bullet_purchase').value || null,
                        muzzle_velocity: parseFloat(document.getElementById('edit_bullet_velocity').value) || null,
                        muzzle_energy: parseFloat(document.getElementById('edit_bullet_energy').value) || null
                    };

                    const { error } = await supabase
                        .from('bullet_library')
                        .update(bulletData)
                        .eq('id', bulletId);

                    if (error) {
                        alert('Error updating bullet: ' + error.message);
                        return;
                    }

                    alert('Bullet updated successfully!');
                    await loadBulletLibraryDirect();
                } catch (e) {
                    alert('Error updating bullet. Please try again.');
                }
            };

            window.toggleSelectAll = function() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const bulletCheckboxes = document.querySelectorAll('.bullet-checkbox');
                
                bulletCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            };

            window.selectAllBullets = function() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const bulletCheckboxes = document.querySelectorAll('.bullet-checkbox');
                
                const allChecked = Array.from(bulletCheckboxes).every(cb => cb.checked);
                
                bulletCheckboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                
                selectAllCheckbox.checked = !allChecked;
            };

            window.deleteSelectedBullets = async function() {
                const selectedCheckboxes = document.querySelectorAll('.bullet-checkbox:checked');
                
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one bullet to delete.');
                    return;
                }

                const bulletCount = selectedCheckboxes.length;
                const confirmMessage = bulletCount === 1 
                    ? 'Are you sure you want to delete the selected bullet?' 
                    : `Are you sure you want to delete ${bulletCount} selected bullets?`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    const bulletIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                    
                    const { error } = await supabase
                        .from('bullet_library')
                        .delete()
                        .in('id', bulletIds);

                    if (error) {
                        alert('Error deleting bullets: ' + error.message);
                        return;
                    }

                    const successMessage = bulletCount === 1 
                        ? 'Bullet deleted successfully!' 
                        : `${bulletCount} bullets deleted successfully!`;
                    
                    alert(successMessage);
                    await loadBulletLibraryDirect();
                } catch (e) {
                    alert('Error deleting bullets. Please try again.');
                }
            };

            window.loadBulletLibrary = async function() {
                try {
                    console.log('Loading bullet library, currentUser:', currentUser);
                    
                    if (!currentUser) {
                        console.log('No current user available');
                        return;
                    }

                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    console.log('Bullet library query result:', { data, error });

                    if (error) {
                        console.error('Error loading bullets:', error);
                        return;
                    }

                    const tableBody = document.getElementById('bulletTableBody');
                    const table = document.getElementById('bulletTable');
                    const noMessage = document.getElementById('noBulletsMessage');

                    console.log('Found', data ? data.length : 0, 'bullets');
                    console.log('Table element:', table);
                    console.log('NoMessage element:', noMessage);

                    if (data && data.length > 0) {
                        console.log('Showing table and hiding no-message');
                        table.style.display = 'table';
                        noMessage.style.display = 'none';
                        
                        tableBody.innerHTML = '';
                        data.forEach(bullet => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${bullet.manufacturer_name}</td>
                                <td>${bullet.caliber}</td>
                                <td>${bullet.grain}</td>
                                <td>${bullet.ballistic_coefficient}</td>
                                <td>${bullet.drag_model}</td>
                                <td>${bullet.bullet_type}</td>
                                <td>
                                    <button onclick="deleteBullet(${bullet.id})" class="back-to-login" style="padding: 4px 8px; margin: 2px;">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        table.style.display = 'none';
                        noMessage.style.display = 'block';
                    }
                } catch (e) {
                    console.error('Error loading bullet library:', e);
                }
            };

            window.deleteBullet = async function(bulletId) {
                if (!confirm('Are you sure you want to delete this bullet?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('bullet_library')
                        .delete()
                        .eq('id', bulletId)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error deleting bullet:', error);
                        alert('Error deleting bullet. Please try again.');
                    } else {
                        await loadBulletLibrary();
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error deleting bullet. Please try again.');
                }
            };
        });

        // DOPE Engagement View and Edit Functions
        window.viewDopeEngagement = async function(engagementId) {
            try {
                console.log('Loading engagement:', engagementId);
                
                // Use the globally accessible supabase client
                const { data, error } = await window.supabaseClient
                    .from('dope_engagements')
                    .select('*')
                    .eq('id', engagementId)
                    .single();

                if (error) {
                    console.error('Error loading engagement:', error);
                    alert('Error loading engagement details: ' + error.message);
                    return;
                }

                console.log('Engagement data loaded:', data);

                const modalHTML = `
                    <div id="viewEngagementModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 90vh; overflow-y: auto; width: 90%;">
                            <h3>DOPE Engagement Details</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div><strong>Date:</strong> ${data.engagement_date}</div>
                                <div><strong>Time:</strong> ${data.engagement_time || 'N/A'}</div>
                                <div><strong>Range:</strong> ${data.range_to_target} ${data.range_unit}</div>
                                <div><strong>Wind Speed:</strong> ${data.wind_speed || 'N/A'}</div>
                                <div><strong>Wind Direction:</strong> ${data.wind_direction || 'N/A'}°</div>
                                <div><strong>Wind Type:</strong> ${data.wind_type || 'N/A'}</div>
                                <div><strong>Temperature:</strong> ${data.temperature !== null ? `${data.temperature}°${data.temperature_unit}` : 'N/A'}</div>
                                <div><strong>Pressure:</strong> ${data.barometric_pressure || 'N/A'}</div>
                                <div><strong>Humidity:</strong> ${data.humidity ? `${data.humidity}%` : 'N/A'}</div>
                                <div><strong>Altitude:</strong> ${data.altitude || 'N/A'}</div>
                                <div><strong>Angle of Fire:</strong> ${data.angle_of_fire || 'N/A'}°</div>
                                <div><strong>Spin Drift:</strong> ${data.spin_drift || 'N/A'}</div>
                                <div><strong>Coriolis Effect:</strong> ${data.coriolis_effect || 'N/A'}</div>
                                <div><strong>Target Speed:</strong> ${data.target_movement_speed || 'N/A'}</div>
                                <div><strong>Target Direction:</strong> ${data.target_movement_direction || 'N/A'}°</div>
                                <div><strong>Optic Magnification:</strong> ${data.optic_magnification ? `${data.optic_magnification}x` : 'N/A'}</div>
                                <div><strong>Adjustment Units:</strong> ${data.optic_adjustment_units || 'N/A'}</div>
                                <div><strong>Parallax Setting:</strong> ${data.parallax_setting || 'N/A'}</div>
                                <div><strong>Time of Flight:</strong> ${data.time_of_flight || 'N/A'}s</div>
                                <div><strong>Barrel Condition:</strong> ${data.barrel_condition || 'N/A'}</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Atmospheric Conditions:</strong><br>
                                ${data.atmospheric_conditions || 'N/A'}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Light Conditions:</strong><br>
                                ${data.light_conditions || 'N/A'}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Engagement Outcome:</strong><br>
                                ${data.engagement_outcome || 'N/A'}
                            </div>
                            <div style="margin-bottom: 20px;">
                                <strong>Notes:</strong><br>
                                ${data.notes || 'N/A'}
                            </div>
                            <div style="text-align: center;">
                                <button onclick="closeViewModal()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            } catch (error) {
                console.error('Error in viewDopeEngagement:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error loading engagement details: ' + (error.message || 'Unknown error'));
            }
        };

        window.editDopeEngagement = async function(engagementId) {
            try {
                // Use the globally accessible supabase client
                const { data, error } = await window.supabaseClient
                    .from('dope_engagements')
                    .select('*')
                    .eq('id', engagementId)
                    .single();

                if (error) {
                    console.error('Error loading engagement:', error);
                    alert('Error loading engagement for editing.');
                    return;
                }

                // Store the editing ID
                window.editingEngagementId = engagementId;
                
                // Show the form
                showAddDopeFormDirect();
                
                // Pre-fill the form with existing data
                setTimeout(() => {
                    if (document.getElementById('engagement_date')) document.getElementById('engagement_date').value = data.engagement_date || '';
                    if (document.getElementById('engagement_time')) document.getElementById('engagement_time').value = data.engagement_time || '';
                    if (document.getElementById('range_to_target')) document.getElementById('range_to_target').value = data.range_to_target || '';
                    if (document.getElementById('range_unit')) document.getElementById('range_unit').value = data.range_unit || 'yards';
                    if (document.getElementById('wind_speed')) document.getElementById('wind_speed').value = data.wind_speed || '';
                    if (document.getElementById('wind_direction')) document.getElementById('wind_direction').value = data.wind_direction || '';
                    if (document.getElementById('wind_type')) document.getElementById('wind_type').value = data.wind_type || '';
                    if (document.getElementById('temperature')) document.getElementById('temperature').value = data.temperature || '';
                    if (document.getElementById('temperature_unit')) document.getElementById('temperature_unit').value = data.temperature_unit || 'F';
                    if (document.getElementById('engagement_outcome')) document.getElementById('engagement_outcome').value = data.engagement_outcome || '';
                    if (document.getElementById('engagement_notes')) document.getElementById('engagement_notes').value = data.notes || '';
                    
                    // Update save button for editing
                    const saveButton = document.querySelector('button[onclick="saveDopeEngagement()"]');
                    if (saveButton) {
                        saveButton.textContent = 'Update Engagement';
                        saveButton.style.backgroundColor = '#ffc107';
                    }
                }, 100);

            } catch (error) {
                console.error('Error:', error);
                alert('Error loading engagement for editing.');
            }
        };

        window.closeViewModal = function() {
            const modal = document.getElementById('viewEngagementModal');
            if (modal) {
                modal.remove();
            }
        };

        
        // Fix button text and form carryover issues
        function fixButtonTextAndCleanup() {
            // Fix question mark characters in ALL home buttons across the site
            const allHomeButtons = document.querySelectorAll('button');
            allHomeButtons.forEach(button => {
                let text = button.innerHTML;
                
                // Fix Home buttons specifically (look for the 🏠 icon and ? patterns)
                if (text.includes('🏠') && text.includes('?')) {
                    button.innerHTML = text.replace(/\?\s*/g, '🏠 ');
                }
                if (text.includes('Home') && text.includes('?')) {
                    button.innerHTML = text.replace(/\?\s*Home/g, '🏠 Home');
                }
                
                // Fix main navigation buttons
                if (text.includes('Shooting Profile') || text.includes('? Shooting')) {
                    button.innerHTML = text.replace(/\?\s*Shooting Profile/g, '📊 Zero Profile').replace(/\?\s*Shooting/g, '📊 Zero');
                }
                if (text.includes('Bullet Library') || text.includes('? Bullet')) {
                    button.innerHTML = text.replace(/\?\s*Bullet Library/g, '🎯 Bullet Library').replace(/\?\s*Bullet/g, '🎯 Bullet');
                }
                if (text.includes('DOPE') && text.includes('?')) {
                    button.innerHTML = text.replace(/\?\s*DOPE/g, '📋 DOPE');
                }
                
                // Force specific onclick-based replacements
                if (button.onclick) {
                    const onclickStr = button.onclick.toString();
                    if (onclickStr.includes('showZeroProfile')) {
                        button.innerHTML = button.innerHTML.replace(/^[^a-zA-Z]*/, '📊 ').replace('Shooting Profile', 'Zero Profile');
                    }
                    if (onclickStr.includes('showBulletLibrary')) {
                        button.innerHTML = button.innerHTML.replace(/^[^a-zA-Z]*/, '🎯 ');
                    }
                    if (onclickStr.includes('showDOPE')) {
                        button.innerHTML = button.innerHTML.replace(/^[^a-zA-Z]*/, '📋 ');
                    }
                    if (onclickStr.includes('showHomePage')) {
                        button.innerHTML = button.innerHTML.replace(/\?\s*/g, '🏠 ');
                    }
                }
            });
        }
        
        // Reliable showHomePage function
        window.showHomePage = function() {
            // Hide all other sections first
            const sections = ['shootingProfileSection', 'firearmLibrarySection', 'dopeSection', 'bulletLibrarySection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Remove the specific dynamic content that gets added by library functions
            const dynamicIds = ['activeFirearmLibrary', 'activeBulletLibrary', 'activeDopeSection'];
            dynamicIds.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            
            // Show home page
            const homePage = document.getElementById('homePage');
            if (homePage) {
                homePage.style.display = 'block';
            }
            
            // Fix button text after a brief delay
            setTimeout(fixButtonTextAndCleanup, 50);
        };
        
        // Reorganize home page buttons in the requested order
        function reorganizeHomeButtons() {
            const buttonContainer = document.querySelector('#homePage .home-nav-button').parentElement;
            const buttons = Array.from(buttonContainer.querySelectorAll('.home-nav-button'));
            
            // Find buttons by their onclick functions
            let firearmBtn, bulletBtn, zeroBtn, dopeBtn;
            
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes('showFirearmLibrary')) firearmBtn = btn;
                else if (onclick && onclick.includes('showBulletLibrary')) bulletBtn = btn;
                else if (onclick && onclick.includes('showZeroProfile')) zeroBtn = btn;
                else if (onclick && onclick.includes('showDOPE')) dopeBtn = btn;
            });
            
            // Remove all buttons
            buttons.forEach(btn => btn.remove());
            
            // Add them back in the correct order: Firearm, Bullet, Zero, DOPE
            if (firearmBtn) buttonContainer.appendChild(firearmBtn);
            if (bulletBtn) buttonContainer.appendChild(bulletBtn);
            if (zeroBtn) buttonContainer.appendChild(zeroBtn);
            if (dopeBtn) buttonContainer.appendChild(dopeBtn);
        }
        
        // Run fixes on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                fixButtonTextAndCleanup();
                reorganizeHomeButtons();
            }, 100);
        });
        
        // Also run when page becomes visible (for navigation)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(fixButtonTextAndCleanup, 100);
            }
        });
        
        // Run periodically to catch any missed updates
        setInterval(fixButtonTextAndCleanup, 2000);
        
    </script>
</body>
</html>