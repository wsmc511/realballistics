<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ballistic Calculator</title>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ballistic Calculator">
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#f5f5f5">
    <!-- Icons for PWA -->
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="icon" href="/icons/icon-192.png">
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 15px;
            background-color: #f5f5f5;
            padding-bottom: 20px;
        }
        h2 { 
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #333;
        }
        .form-group { 
            margin-bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        label { 
            display: inline-block;
            width: 100%;
            max-width: 180px;
            color: #555;
            font-size: 0.9rem;
        }
        input, select { 
            width: 100%;
            max-width: 200px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        button { 
            margin: 5px 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            min-width: 80px;
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        button.add-session { 
            background-color: #28a745; 
            color: white; 
        }
        button.add-session:hover { 
            background-color: #218838; 
        }
        button.calculate-save { 
            background-color: #28a745; 
            color: white; 
        }
        button.calculate-save:hover { 
            background-color: #218838; 
        }
        button.cancel-edit { 
            background-color: #ffc107; 
            color: white; 
        }
        button.cancel-edit:hover { 
            background-color: #e0a800; 
        }
        button.view-all { 
            background-color: #007bff; 
            color: white; 
        }
        button.view-all:hover { 
            background-color: #0056b3; 
        }
        button.clear-all { 
            background-color: #6c757d; 
            color: white; 
        }
        button.clear-all:hover { 
            background-color: #5a6268; 
        }
        button.search { 
            background-color: #17a2b8; 
            color: white; 
        }
        button.search:hover { 
            background-color: #138496; 
        }
        button.clear-search { 
            background-color: #dc3545; 
            color: white; 
        }
        button.clear-search:hover { 
            background-color: #c82333; 
        }
        button.delete-selected { 
            background-color: #ff6f61; 
            color: white; 
        }
        button.delete-selected:hover { 
            background-color: #ff4d3d; 
        }
        button.compare-selected { 
            background-color: #20c997; 
            color: white; 
        }
        button.compare-selected:hover { 
            background-color: #1ba87e; 
        }
        button.view-session, button.edit-session { 
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
        button.view-session { 
            background-color: #007bff; 
            color: white; 
        }
        button.view-session:hover { 
            background-color: #0056b3; 
        }
        button.edit-session { 
            background-color: #17a2b8; 
            color: white; 
        }
        button.edit-session:hover { 
            background-color: #138496; 
        }
        button.login, button.logout, button.reset-password { 
            background-color: #007bff; 
            color: white; 
        }
        button.login:hover, button.logout:hover, button.reset-password:hover { 
            background-color: #0056b3; 
        }
        button.back-to-login { 
            background-color: #6c757d; 
            color: white; 
        }
        button.back-to-login:hover { 
            background-color: #5a6268; 
        }
        table { 
            border-collapse: collapse;
            margin-top: 10px;
            width: 100%;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd;
            padding: 6px;
            text-align: right;
            font-size: 0.85rem;
        }
        th { 
            background-color: #f2f2f2;
            color: #333;
        }
        td:first-child, th:first-child { 
            text-align: center;
        }
        .message { 
            color: green;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        .error { 
            color: red;
            font-size: 0.9rem;
        }
        .session-controls { 
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .search-group { 
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
        }
        #ballisticForm { 
            display: none;
            margin-top: 10px;
        }
        .filter-section {
            display: none !important;
        }
        .filter-section.active {
            display: block !important;
        }
        .toggle-filter {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .toggle-filter:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        .forgot-password {
            display: block;
            margin: 5px 0;
            font-size: 0.9rem;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .forgot-password:hover {
            text-decoration: underline;
        }
        #resetPasswordForm {
            display: none;
            margin-top: 10px;
        }
        @media (max-width: 576px) {
            body {
                margin: 10px;
                padding-bottom: 15px;
            }
            h2 {
                font-size: 1.1rem;
            }
            label {
                font-size: 0.85rem;
                max-width: 100%;
            }
            input, select {
                font-size: 0.85rem;
                max-width: 100%;
            }
            button {
                font-size: 0.85rem;
                padding: 6px 10px;
                min-width: 70px;
            }
            button.view-session, button.edit-session {
                font-size: 0.75rem;
                padding: 3px 6px;
            }
            th, td {
                font-size: 0.75rem;
                padding: 4px;
            }
            .trajectory-table th, .trajectory-table td {
                font-size: 0.7rem;
                padding: 3px;
            }
            .trajectory-table th:nth-child(1), .trajectory-table td:nth-child(1),
            .trajectory-table th:nth-child(2), .trajectory-table td:nth-child(2),
            .trajectory-table th:nth-child(3), .trajectory-table td:nth-child(3) {
                font-weight: bold;
            }
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .session-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .search-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-section {
                display: none !important;
            }
            .filter-section.active {
                display: block !important;
            }
            .forgot-password {
                font-size: 0.85rem;
            }
        }
        .trajectory-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #trajectoryTitle {
            display: inline-block;
        }
        #trajectoryDescription {
            font-size: 0.9rem;
            color: #555;
            font-style: italic;
        }
        #compareForm {
            display: none;
            margin-top: 10px;
        }
        .flattest-trajectory {
            background-color: #28a745 !important;
            color: white;
        }
        #loginForm {
            margin-top: 20px;
            display: none;
        }
        #appContent {
            display: none;
        }
        .user-info {
            margin-bottom: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Sticky header for trajectory table */
        .trajectory-table {
            position: relative;
        }
        .trajectory-table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Sticky header for comparison table */
        #comparisonTable {
            position: relative;
        }
        #comparisonTable thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
</head>
<body>
    <div id="loginForm">
        <h2>Login to Ballistic Calculator</h2>
        <form id="authForm">
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="login_email" autocomplete="email">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="login_password" autocomplete="current-password">
            </div>
            <button type="button" class="login" onclick="login()">Login</button>
            <button type="button" class="login" onclick="signup()">Sign Up</button>
        </form>
        <a class="forgot-password" onclick="showResetPasswordForm()">Forgot Password?</a>
        <form id="resetPasswordForm">
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="reset_email" autocomplete="email">
            </div>
            <button type="button" class="reset-password" onclick="resetPassword()">Reset Password</button>
            <button type="button" class="back-to-login" onclick="showLoginForm()">Back to Login</button>
        </form>

        <form id="newPasswordForm" style="display: none;">
            <h3>Set New Password</h3>
            <div class="form-group">
                <label>New Password:</label>
                <input type="password" id="new_password" autocomplete="new-password" placeholder="Enter your new password">
            </div>
            <div class="form-group">
                <label>Confirm Password:</label>
                <input type="password" id="confirm_password" autocomplete="new-password" placeholder="Confirm your new password">
            </div>
            <button type="button" class="reset-password" onclick="updatePassword()">Update Password</button>
            <button type="button" class="back-to-login" onclick="showLoginForm()">Back to Login</button>
        </form>
        <div id="authMessage"></div>
    </div>

    <div id="appContent">
        <!-- Home Page Section -->
        <div id="homePage" style="display: block;">
            <div style="text-align: center; padding: 40px 20px;">
                <h1 style="color: #333; margin-bottom: 10px;">Welcome to Real Ballistics</h1>
                <p style="color: #666; margin-bottom: 40px; font-size: 1.1em;">Professional ballistic calculation and ammunition management system</p>
                
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <button class="home-nav-button" onclick="showZeroProfile()" style="background-color: #007BFF; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ?  Shooting Profile
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Calculate trajectories, manage sessions</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showFirearmLibrary()" style="background-color: #17a2b8; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        🔫 Firearm Library
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Manage firearm profiles</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showBulletLibrary()" style="background-color: #28a745; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ?  Bullet Library
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Manage ammunition database</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showDOPE()" style="background-color: #dc3545; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ?  DOPE
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Data On Previous Engagements</div>
                    </button>
                    
                    <button class="home-nav-button" onclick="showSetup()" style="background-color: #6c757d; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px;">
                        ⚙️ Setup
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Account, sharing, and preferences</div>
                    </button>
                    
                    <button id="adminPanelButton" class="home-nav-button" onclick="showAdminPanel()" style="background-color: #dc3545; color: white; padding: 20px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; min-width: 200px; display: none;">
                        🛡️ Admin Panel
                        <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">User management and approval</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Shooting Profile Section -->
        <div id="shootingProfileSection" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                <h2 style="margin: 0;">Zero Profile</h2>
            </div>
            <button class="add-session" onclick="toggleForm()">Add New</button>
        <form id="ballisticForm">
            <div class="form-group">
                <label>Load from Firearm Library:</label>
                <select id="zeroFirearmSelect" onchange="loadZeroFirearmData()">
                    <option value="">Select a saved firearm (optional)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Load from Bullet Library:</label>
                <select id="zeroBulletSelect" onchange="loadZeroBulletData()">
                    <option value="">Select a saved bullet (optional)</option>
                </select>
            </div>
            <hr style="margin: 20px 0; border: 1px solid #ddd;">
            <div class="form-group">
                <label>Shooter Name:</label>
                <input type="text" name="shooter_name">
            </div>
            <div class="form-group">
                <label>Firearm Type:</label>
                <select name="firearm_type">
                    <option value="">Select</option>
                    <option value="Rifle">Rifle</option>
                    <option value="Pistol">Pistol</option>
                </select>
            </div>
            <div class="form-group">
                <label>Firearm Name:</label>
                <input type="text" name="firearm_name">
            </div>
            <div class="form-group">
                <label>Optic Name:</label>
                <input type="text" name="optic_name">
            </div>
            <div class="form-group">
                <label>Caliber:</label>
                <input type="text" name="caliber">
            </div>
            <div class="form-group">
                <label>Bullet Caliber:</label>
                <input type="text" name="bullet_caliber">
            </div>
            <div class="form-group">
                <label>Barrel Length (inches):</label>
                <input type="number" step="0.1" name="barrel_length">
            </div>
            <div class="form-group">
                <label>Barrel Twist Rate:</label>
                <select name="barrel_twist_rate">
                    <option value="">Select Twist Rate</option>
                    <option value="1:7">1:7</option>
                    <option value="1:8">1:8</option>
                    <option value="1:9">1:9</option>
                    <option value="1:9.25">1:9.25</option>
                    <option value="1:10">1:10</option>
                    <option value="1:10.5">1:10.5</option>
                    <option value="1:11">1:11</option>
                    <option value="1:12">1:12</option>
                    <option value="1:14">1:14</option>
                    <option value="1:16">1:16</option>
                    <option value="1:18.75">1:18.75</option>
                    <option value="1:20">1:20</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bullet Grain (gr):</label>
                <input type="number" name="bullet_grain">
            </div>
            <div class="form-group">
                <label>Muzzle Velocity (fps):</label>
                <input type="number" name="muzzle_velocity">
            </div>
            <div class="form-group">
                <label>Muzzle Energy (ft-lbs):</label>
                <input type="number" name="muzzle_energy">
            </div>
            <div class="form-group">
                <label>Ballistic Coefficient:</label>
                <input type="number" step="0.001" name="ballistic_coefficient">
            </div>
            <div class="form-group">
                <label>Zero Distance (yards):</label>
                <input type="number" name="zero_distance">
            </div>
            <div class="form-group">
                <label>Height Over Bore (inches):</label>
                <input type="number" step="0.01" name="height_over_bore">
            </div>
            <div class="form-group">
                <label>Drag Model:</label>
                <select name="drag_model">
                    <option value="">Select</option>
                    <option value="G1">G1</option>
                    <option value="G7">G7</option>
                </select>
            </div>
            <div class="form-group">
                <label>Step Interval (yards):</label>
                <input type="number" name="step_interval_yards">
            </div>
            <div class="form-group">
                <label>Max Distance (yards):</label>
                <input type="number" name="max_distance_yards">
            </div>
            <div class="form-group">
                <label>Wind Speed (mph):</label>
                <input type="number" name="wind_speed">
            </div>
            <div class="form-group">
                <label>Wind Angle (degrees):</label>
                <input type="number" name="wind_angle">
            </div>
            <button type="button" class="calculate-save" onclick="calculateAndSave()">Calculate & Save</button>
            <button type="button" class="cancel-edit" onclick="cancelEdit()" style="display: none;" id="cancelEditButton">Cancel Edit</button>
        </form>

        <!-- Bullet Library Section -->
        <div id="bulletLibrarySection" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                <h2 style="margin: 0;">Bullet Library</h2>
            </div>
            <button class="add-session" onclick="showAddBulletForm()">Add New Bullet</button>
            
            <!-- Add Bullet Form -->
            <form id="addBulletForm" style="display: none; margin-top: 15px; background-color: white; padding: 15px; border-radius: 5px;">
                <h3>Add New Bullet</h3>
                <div class="form-group">
                    <label>Manufacturer Name:</label>
                    <input type="text" id="bullet_manufacturer" placeholder="e.g. Federal, Hornady, Barnes" required>
                </div>
                <div class="form-group">
                    <label>Caliber:</label>
                    <input type="text" id="bullet_caliber" placeholder="e.g. .308 Win, 6.5 Creedmoor" required>
                </div>
                <div class="form-group">
                    <label>Grain:</label>
                    <input type="number" id="bullet_grain" min="10" max="1000" placeholder="e.g. 168" required>
                </div>
                <div class="form-group">
                    <label>Ballistic Coefficient:</label>
                    <input type="number" id="bullet_bc" step="0.001" min="0.100" max="1.000" placeholder="e.g. 0.462" required>
                </div>
                <div class="form-group">
                    <label>Drag Model:</label>
                    <select id="bullet_drag_model" required>
                        <option value="">Select Drag Model</option>
                        <option value="G1">G1</option>
                        <option value="G7">G7</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bullet Type:</label>
                    <select id="bullet_type" required>
                        <option value="">Select Type</option>
                        <option value="FMJ">FMJ (Full Metal Jacket)</option>
                        <option value="HP">HP (Hollow Point)</option>
                        <option value="SP">SP (Soft Point)</option>
                        <option value="JHP">JHP (Jacketed Hollow Point)</option>
                        <option value="OTM">OTM (Open Tip Match)</option>
                        <option value="AP">AP (Armor Piercing)</option>
                    </select>
                </div>
                <button type="button" onclick="saveBullet()" class="add-session">Save Bullet</button>
                <button type="button" onclick="cancelAddBullet()" class="back-to-login">Cancel</button>
            </form>

            <!-- Bullet Library Table -->
            <div id="bulletLibraryTable" style="margin-top: 15px;">
                <table id="bulletTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Manufacturer</th>
                            <th>Caliber</th>
                            <th>Grain</th>
                            <th>BC</th>
                            <th>Drag</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulletTableBody">
                    </tbody>
                </table>
                <div id="noBulletsMessage" style="text-align: center; padding: 20px; color: #666;">
                    No bullets in your library yet. Click "Add New Bullet" to get started!
                </div>
            </div>
        </div>

        <!-- DOPE Section -->
        <div id="dopeSection" style="display: none; padding: 20px; background-color: white; min-height: 400px; position: relative; z-index: 1000;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                <h2 style="margin: 0;">DOPE - Data On Previous Engagements</h2>
            </div>
            <button class="add-session" onclick="showAddDopeForm()">Log New Engagement</button>
            
            <!-- Add DOPE Form -->
            <form id="addDopeForm" style="display: none; margin-top: 15px; background-color: white; padding: 15px; border-radius: 5px;">
                <h3>Log New Engagement</h3>
                
                <!-- Reference Data Selection -->
                <div class="form-group">
                    <label>Shooting Profile (Optional):</label>
                    <select id="dope_shooting_profile" onchange="populateFromShootingProfile()">
                        <option value="">Select a shooting profile...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Bullet Library (Optional):</label>
                    <select id="dope_bullet_library" onchange="populateFromBulletLibrary()">
                        <option value="">Select a bullet...</option>
                    </select>
                </div>
                
                <!-- Date and Time -->
                <div class="form-group">
                    <label>Engagement Date:</label>
                    <input type="date" id="engagement_date" required>
                </div>
                
                <div class="form-group">
                    <label>Engagement Time:</label>
                    <input type="time" id="engagement_time">
                </div>
                
                <!-- Range Data -->
                <div class="form-group">
                    <label>Range to Target:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="range_to_target" step="0.01" placeholder="Distance" required>
                        <select id="range_unit" required>
                            <option value="">Unit</option>
                            <option value="meters">Meters</option>
                            <option value="yards">Yards</option>
                        </select>
                    </div>
                </div>
                
                <!-- Wind Conditions -->
                <div class="form-group">
                    <label>Wind Speed:</label>
                    <input type="number" id="wind_speed" step="0.1" placeholder="Speed (mph/kph)">
                </div>
                
                <div class="form-group">
                    <label>Wind Direction (degrees):</label>
                    <input type="number" id="wind_direction" min="0" max="360" step="0.1" placeholder="0-360">
                </div>
                
                <div class="form-group">
                    <label>Wind Type:</label>
                    <select id="wind_type">
                        <option value="">Select Type</option>
                        <option value="Crosswind">Crosswind</option>
                        <option value="Headwind">Headwind</option>
                        <option value="Tailwind">Tailwind</option>
                    </select>
                </div>
                
                <!-- Environmental Conditions -->
                <div class="form-group">
                    <label>Temperature:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="temperature" step="0.1" placeholder="Temperature">
                        <select id="temperature_unit">
                            <option value="">Unit</option>
                            <option value="C">Celsius</option>
                            <option value="F" selected>Fahrenheit</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Barometric Pressure:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="barometric_pressure" step="0.01" placeholder="Pressure">
                        <select id="pressure_unit">
                            <option value="">Unit</option>
                            <option value="inHg" selected>inHg</option>
                            <option value="mb">mb</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Humidity (%):</label>
                    <input type="number" id="humidity" min="0" max="100" step="0.1" placeholder="0-100">
                </div>
                
                <div class="form-group">
                    <label>Altitude:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="altitude" step="0.1" placeholder="Meters">
                        <select id="altitude_reference">
                            <option value="">Reference</option>
                            <option value="Above Sea Level" selected>Above Sea Level</option>
                            <option value="Below Sea Level">Below Sea Level</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ballistic Factors -->
                <div class="form-group">
                    <label>Angle of Fire (degrees):</label>
                    <input type="number" id="angle_of_fire" min="-90" max="90" step="0.01" placeholder="-90 to 90">
                </div>
                
                <div class="form-group">
                    <label>Spin Drift:</label>
                    <input type="number" id="spin_drift" step="0.0001" placeholder="Drift value">
                </div>
                
                <div class="form-group">
                    <label>Coriolis Effect:</label>
                    <input type="number" id="coriolis_effect" step="0.0001" placeholder="Effect value">
                </div>
                
                <!-- Target Movement -->
                <div class="form-group">
                    <label>Target Movement Speed:</label>
                    <input type="number" id="target_movement_speed" step="0.01" placeholder="Speed">
                </div>
                
                <div class="form-group">
                    <label>Target Movement Direction (degrees):</label>
                    <input type="number" id="target_movement_direction" min="0" max="360" step="0.1" placeholder="0-360">
                </div>
                
                <!-- Equipment Settings -->
                <div class="form-group">
                    <label>Optic Magnification:</label>
                    <input type="number" id="optic_magnification" step="0.1" placeholder="e.g. 4.5">
                </div>
                
                <div class="form-group">
                    <label>Optic Adjustment Units:</label>
                    <select id="optic_adjustment_units">
                        <option value="">Select Units</option>
                        <option value="MOA">MOA</option>
                        <option value="MRAD">MRAD</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Parallax Setting (meters):</label>
                    <input type="number" id="parallax_setting" step="0.1" placeholder="Distance">
                </div>
                
                <!-- Conditions and Outcome -->
                <div class="form-group">
                    <label>Atmospheric Conditions:</label>
                    <textarea id="atmospheric_conditions" placeholder="Describe atmospheric conditions..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Barrel Condition:</label>
                    <input type="text" id="barrel_condition" placeholder="e.g. Clean, Fouled, Hot">
                </div>
                
                <div class="form-group">
                    <label>Time of Flight (seconds):</label>
                    <input type="number" id="time_of_flight" step="0.001" placeholder="Flight time">
                </div>
                
                <div class="form-group">
                    <label>Light Conditions:</label>
                    <input type="text" id="light_conditions" placeholder="e.g. Bright sun, Overcast, Dawn">
                </div>
                
                <div class="form-group">
                    <label>Engagement Outcome:</label>
                    <input type="text" id="engagement_outcome" placeholder="e.g. Hit center, Miss high, First round hit">
                </div>
                
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="engagement_notes" placeholder="Additional notes about the engagement..."></textarea>
                </div>
                
                <button type="button" onclick="saveDope()" class="add-session">Save Engagement</button>
                <button type="button" onclick="cancelAddDope()" class="back-to-login">Cancel</button>
            </form>

            <!-- DOPE Table -->
            <div id="dopeTable" style="margin-top: 15px;">
                <h3>Previous Engagements</h3>
                <table id="dopeEngagementsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Range</th>
                            <th>Wind</th>
                            <th>Temperature</th>
                            <th>Outcome</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dopeTableBody">
                    </tbody>
                </table>
                <div id="noDopeMessage" style="text-align: center; padding: 20px; color: #666;">
                    No engagements logged yet. Click "Log New Engagement" to get started!
                </div>
            </div>
        </div>

        <!-- Admin Panel Section -->
        <div id="adminPanel" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                <h2 style="margin: 0;">Admin Panel - User Management</h2>
            </div>
            
            <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                <h3>User Approval Management</h3>
                <div style="margin-bottom: 15px;">
                    <button onclick="loadAllUsers()" style="background-color: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Refresh Users</button>
                    <span id="userCount" style="color: #666; font-size: 14px;"></span>
                </div>
                <div id="userApprovalContent">
                    <p>Loading user approval data...</p>
                </div>
            </div>
        </div>

        <!-- Setup Page Section -->
        <div id="setupSection" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="back-to-home" onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                <h2 style="margin: 0;">Setup & Preferences</h2>
            </div>

            <!-- Tab Navigation -->
            <div class="setup-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
                <button class="setup-tab active" onclick="showSetupTab('account')" data-tab="account" style="flex: 1; padding: 10px; border: none; background: #007BFF; color: white; cursor: pointer;">Account</button>
                <button class="setup-tab" onclick="showSetupTab('sharing')" data-tab="sharing" style="flex: 1; padding: 10px; border: none; background: #f8f9fa; color: #333; cursor: pointer;">Sharing</button>
            </div>

            <!-- Account Management Tab -->
            <div id="accountTab" class="setup-tab-content" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Account Information</h3>
                
                <form id="profileForm" style="margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Display Name:</label>
                        <input type="text" id="profileDisplayName" placeholder="Enter your display name">
                    </div>
                    
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="profileEmail" placeholder="Your email address" readonly style="background-color: #f8f9fa;">
                        <small style="color: #666; display: block; margin-top: 5px;">Email changes require verification</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Profile Picture:</label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <img id="currentProfilePic" src="" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #ddd; display: none;">
                            <div id="profilePicPlaceholder" style="width: 60px; height: 60px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; color: #666; font-size: 24px;">👤</div>
                            <input type="file" id="profilePicUpload" accept="image/*" style="display: none;">
                            <button type="button" onclick="document.getElementById('profilePicUpload').click()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Upload New</button>
                        </div>
                    </div>
                    
                    <button type="button" onclick="saveProfile()" style="background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Save Changes</button>
                </form>

                <hr style="margin: 30px 0; border: 1px solid #eee;">

                <h3>Account Security</h3>
                <div style="margin-bottom: 20px;">
                    <button onclick="showChangePasswordForm()" style="background: #ffc107; color: #333; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Change Password</button>
                    <button onclick="confirmDeleteAccount()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Delete Account</button>
                </div>

                <!-- Change Password Form -->
                <div id="changePasswordForm" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>Change Password</h4>
                    <div class="form-group">
                        <label>Current Password:</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label>New Password:</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password:</label>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                    </div>
                    <button type="button" onclick="changePassword()" style="background: #007BFF; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Update Password</button>
                    <button type="button" onclick="cancelChangePassword()" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            </div>

            <!-- Preferences Tab -->
            <div id="preferencesTab" class="setup-tab-content" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Application Preferences</h3>
                
                <!-- Theme Settings -->
                <div style="margin-bottom: 30px;">
                    <h4>Appearance</h4>
                    <div class="form-group">
                        <label>Theme:</label>
                        <select id="themeSelect" onchange="changeTheme()">
                            <option value="light">Light Mode</option>
                            <option value="dark">Dark Mode</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>
                </div>

                <!-- Default Values -->
                <div style="margin-bottom: 30px;">
                    <h4>Default Calculation Settings</h4>
                    <div class="form-group">
                        <label>Default Units:</label>
                        <select id="defaultUnits">
                            <option value="imperial">Imperial (yards, feet, inches)</option>
                            <option value="metric">Metric (meters, centimeters)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Default Temperature (°F):</label>
                        <input type="number" id="defaultTemp" value="59" placeholder="59">
                    </div>
                    
                    <div class="form-group">
                        <label>Default Humidity (%):</label>
                        <input type="number" id="defaultHumidity" value="78" placeholder="78">
                    </div>
                    
                    <div class="form-group">
                        <label>Default Barometric Pressure (inHg):</label>
                        <input type="number" id="defaultPressure" value="29.92" step="0.01" placeholder="29.92">
                    </div>
                    
                    <div class="form-group">
                        <label>Default Altitude (feet):</label>
                        <input type="number" id="defaultAltitude" value="0" placeholder="0">
                    </div>
                </div>

                <button type="button" onclick="savePreferences()" style="background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Save Preferences</button>
            </div>

            <!-- Sharing Tab -->
            <div id="sharingTab" class="setup-tab-content" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Library Sharing</h3>
                
                <!-- Share Your Libraries -->
                <div style="margin-bottom: 30px;">
                    <h4>Share Your Libraries</h4>
                    <p style="color: #666; margin-bottom: 15px;">Invite other users to view and copy items from your firearm and bullet libraries.</p>
                    
                    <div class="form-group">
                        <label>Invite User by Email:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="email" id="inviteEmail" placeholder="Enter user email address" style="flex: 1;">
                            <button type="button" onclick="sendLibraryInvite()" style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Send Invite</button>
                        </div>
                    </div>
                </div>

                <!-- Request Access -->
                <div style="margin-bottom: 30px;">
                    <h4>Request Library Access</h4>
                    <p style="color: #666; margin-bottom: 15px;">Request access to another user's libraries.</p>
                    
                    <div class="form-group">
                        <label>Request Access from User:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="email" id="requestEmail" placeholder="Enter user email address" style="flex: 1;">
                            <button type="button" onclick="requestLibraryAccess()" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Send Request</button>
                        </div>
                    </div>
                </div>

                <!-- Current Shares -->
                <div style="margin-bottom: 30px;">
                    <h4>Active Shares</h4>
                    <div id="activeShares" style="border: 1px solid #ddd; border-radius: 5px; min-height: 100px; padding: 15px;">
                        <div style="text-align: center; color: #666;">No active shares. Invite users above to start sharing.</div>
                    </div>
                </div>

                <!-- Pending Share Requests -->
                <div style="margin-bottom: 30px;">
                    <h4>Pending Share Requests</h4>
                    <p style="color: #666; margin-bottom: 10px;">Requests from other users to access your libraries.</p>
                    <div id="pendingRequests" style="border: 1px solid #ddd; border-radius: 5px; min-height: 80px; padding: 15px;">
                        <div style="text-align: center; color: #666;">Loading...</div>
                    </div>
                </div>

                <!-- Shared With You -->
                <div style="margin-bottom: 30px;">
                    <h4>Libraries Shared With You</h4>
                    <p style="color: #666; margin-bottom: 10px;">Libraries you have access to and pending invitations.</p>
                    <div id="sharedWithYou" style="border: 1px solid #ddd; border-radius: 5px; min-height: 80px; padding: 15px;">
                        <div style="text-align: center; color: #666;">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

            <div id="message"></div>

            <h2>Filter</h2>
            <button class="toggle-filter" onclick="toggleFilters()">Show Filters</button>
            <div class="filter-section" id="filterSection">
            <div class="session-controls">
                <button class="view-all" onclick="viewAll()">View All</button>
                <button class="clear-all" onclick="clearAll()">Clear All</button>
                <div class="search-group">
                    <label>Shooter Name:</label>
                    <input type="text" id="search_shooter_name">
                </div>
                <div class="search-group">
                    <label>Firearm Type:</label>
                    <select id="search_firearm_type">
                        <option value="">All</option>
                        <option value="Rifle">Rifle</option>
                        <option value="Pistol">Pistol</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>Firearm Name:</label>
                    <input type="text" id="search_firearm_name">
                </div>
                <div class="search-group">
                    <label>Bullet Grain (gr):</label>
                    <input type="number" id="search_bullet_grain">
                </div>
                <div class="search-group">
                    <label>Barrel Length (in):</label>
                    <input type="number" step="0.1" id="search_barrel_length">
                </div>
                <div class="search-group">
                    <label>Zero Distance (yd):</label>
                    <input type="number" id="search_zero_distance">
                </div>
                <button class="search" onclick="searchSessions()">Search</button>
                <button class="clear-search" onclick="clearSearch()">Clear Search</button>
                <button class="delete-selected" onclick="deleteSelected()">Delete Selected</button>
                <button class="compare-selected" onclick="showCompareForm()">Compare Selected</button>
            </div>
        </div>

        <form id="compareForm">
            <div class="form-group">
                <label>Step Interval (yards):</label>
                <input type="number" id="compare_step_interval" name="compare_step_interval" placeholder="Enter Value">
            </div>
            <div class="form-group">
                <label>Max Distance (yards):</label>
                <input type="number" id="compare_max_distance" name="compare_max_distance" placeholder="Enter Value">
            </div>
            <button type="button" class="calculate-save" onclick="compareSelected()">Compare</button>
            <button type="button" class="cancel-edit" onclick="hideCompareForm()">Cancel</button>
        </form>

        <h2>Saved</h2>
        <table id="sessionsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllSessions" onchange="toggleSelectAllSessions()"> Select</th>
                    <th>Shooter</th>
                    <th>Firearm Type</th>
                    <th>Firearm</th>
                    <th>Optic</th>
                    <th>Caliber</th>
                    <th>Barrel</th>
                    <th>Twist</th>
                    <th>Gr</th>
                    <th>Zero</th>
                    <th>Range</th>
                    <th>Step</th>
                    <th>HOB</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sessionsBody"></tbody>
        </table>

        <div class="trajectory-header">
            <h2 id="trajectoryTitle">Trajectory Grid</h2>
            <span id="trajectoryDescription"></span>
            <button id="showGraphButton" onclick="showTrajectoryGraph()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 15px; display: none;">View Graph</button>
        </div>
        <table id="trajectoryTable" class="trajectory-table">
            <thead>
                <tr>
                    <th>Distance (yd)</th>
                    <th>Hold (in)</th>
                    <th>Hold (MOA)</th>
                    <th>Velocity (fps)</th>
                    <th>Energy (ft-lbs)</th>
                    <th>Drop (in)</th>
                </tr>
            </thead>
            <tbody id="trajectoryBody"></tbody>
        </table>

            <h2 id="comparisonTitle" style="display: none;">Trajectory Comparison</h2>
            <table id="comparisonTable" style="display: none;">
                <thead id="comparisonTableHead"></thead>
                <tbody id="comparisonTableBody"></tbody>
            </table>
        </div>
        <!-- End Shooting Profile Section -->
    </div>

    <!-- Caliber Picker Modal -->
    <div id="caliberPickerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="caliberPickerTitle">Select Caliber</h3>
                <button onclick="closeCaliberPicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <!-- Filter by type -->
            <div style="margin-bottom: 15px;">
                <label>Filter by Type:</label>
                <select id="caliberTypeFilter" onchange="filterCalibersByType()" style="margin-left: 10px; padding: 5px;">
                    <option value="">All Types</option>
                    <option value="Pistol">Pistol</option>
                    <option value="Rifle">Rifle</option>
                    <option value="Revolver">Revolver</option>
                    <option value="Pistol/SMG">Pistol/SMG</option>
                </select>
            </div>
            
            <!-- Caliber selection table -->
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background-color: #f8f9fa; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Type</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Caliber</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Metric</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Notes</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Select</th>
                        </tr>
                    </thead>
                    <tbody id="caliberTableBody">
                        <!-- Caliber rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // Navigation Functions
        window.showHomePage = function() {
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('shootingProfileSection').style.display = 'none';
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('ballisticForm').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
            const filterSection = document.getElementById('filterSection');
            if (filterSection) filterSection.style.display = 'none';
            
            // Remove the active bullet library content to fix display issue
            const activeBulletLibrary = document.getElementById('activeBulletLibrary');
            if (activeBulletLibrary) {
                activeBulletLibrary.remove();
            }
        };

        window.showShootingProfile = function() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('shootingProfileSection').style.display = 'block';
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('ballisticForm').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
            
            // Remove any active bullet library content to prevent interference
            const activeBulletLibrary = document.getElementById('activeBulletLibrary');
            if (activeBulletLibrary) {
                activeBulletLibrary.remove();
            }
            
            // Reset filter section state properly using CSS classes
            const filterSection = document.getElementById('filterSection');
            const filterButton = document.querySelector('button[onclick="toggleFilters()"]');
            if (filterSection && filterButton) {
                filterSection.classList.remove('active');
                filterButton.textContent = 'Show Filters';
            }
            
            // Ensure toggleFilters function is properly bound after section switch
            setTimeout(() => {
                const toggleButton = document.querySelector('.toggle-filter');
                console.log('Rebinding toggle button:', !!toggleButton);
                if (toggleButton) {
                    // Remove any existing event listeners and re-add
                    toggleButton.onclick = null;
                    toggleButton.onclick = function() { 
                        console.log('Button clicked, calling toggleFilters');
                        window.toggleFilters(); 
                    };
                    console.log('Toggle button rebound successfully');
                }
            }, 100);
            
            viewAll(); // Load the shooting sessions
            loadBulletLibraryDropdown(); // Load bullet library options
        };

        // Define bullet library functions first for immediate button access
        window.showBulletLibrary = async function() {
            // Simple, direct approach - create bullet library content in the main content area
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('shootingProfileSection').style.display = 'none';
            
            // Hide all other sections first
            const hideElement = (id) => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            };
            hideElement('bulletLibrarySection');
            hideElement('filterSection');
            hideElement('ballisticForm');
            hideElement('compareForm');
            hideElement('compareResults');
            hideElement('addBulletForm');
            
            // Create bullet library directly in the main app content
            const appContent = document.getElementById('appContent');
            const bulletContent = document.createElement('div');
            bulletContent.id = 'activeBulletLibrary';
            bulletContent.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                        <h2 style="margin: 0;">Bullet Library</h2>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="showAddBulletFormDirect()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Add New Bullet</button>
                        <button onclick="loadSharedLibraries()" style="background-color: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Load Shared Library</button>
                    </div>
                    <div id="bulletLibraryContent">Loading your bullets...</div>
                </div>
            `;
            
            // Remove any existing active bullet library
            const existing = document.getElementById('activeBulletLibrary');
            if (existing) existing.remove();
            
            // Add the new bullet library
            appContent.appendChild(bulletContent);
            
            // Load the bullets
            await loadBulletLibraryDirect();
        };

        window.hideBulletLibrary = function() {
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.showAddBulletForm = function() {
            document.getElementById('addBulletForm').style.display = 'block';
            document.getElementById('bullet_manufacturer').value = '';
            document.getElementById('bullet_caliber').value = '';
            document.getElementById('bullet_grain').value = '';
            document.getElementById('bullet_bc').value = '';
            document.getElementById('bullet_drag_model').value = '';
            document.getElementById('bullet_type').value = '';
        };

        window.cancelAddBullet = function() {
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.saveBullet = async function() {
            const manufacturer = document.getElementById('bullet_manufacturer').value.trim();
            const caliber = document.getElementById('bullet_caliber').value.trim();
            const grain = parseInt(document.getElementById('bullet_grain').value);
            const bc = parseFloat(document.getElementById('bullet_bc').value);
            const dragModel = document.getElementById('bullet_drag_model').value;
            const bulletType = document.getElementById('bullet_type').value;

            if (!manufacturer || !caliber || !grain || !bc || !dragModel || !bulletType) {
                alert('Please fill in all fields');
                return;
            }

            if (bc < 0.1 || bc > 1.0) {
                alert('Ballistic coefficient must be between 0.1 and 1.0');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .insert([{
                        user_id: currentUser.id,
                        manufacturer_name: manufacturer,
                        caliber: caliber,
                        grain: grain,
                        ballistic_coefficient: bc,
                        drag_model: dragModel,
                        bullet_type: bulletType
                    }]);

                if (error) {
                    console.error('Error saving bullet:', error);
                    alert('Error saving bullet. Please try again.');
                } else {
                    console.log('Bullet saved successfully');
                    document.getElementById('addBulletForm').style.display = 'none';
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error saving bullet. Please try again.');
            }
        };

        window.loadBulletLibrary = async function() {
            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('manufacturer_name', { ascending: true });

                if (error) {
                    console.error('Error loading bullets:', error);
                    return;
                }

                const tableBody = document.getElementById('bulletTableBody');
                const table = document.getElementById('bulletTable');
                const noMessage = document.getElementById('noBulletsMessage');

                if (data && data.length > 0) {
                    table.style.display = 'table';
                    noMessage.style.display = 'none';
                    
                    tableBody.innerHTML = '';
                    data.forEach(bullet => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${bullet.manufacturer_name}</td>
                            <td>${bullet.caliber}</td>
                            <td>${bullet.grain}</td>
                            <td>${bullet.ballistic_coefficient}</td>
                            <td>${bullet.drag_model}</td>
                            <td>${bullet.bullet_type}</td>
                            <td>
                                <button onclick="deleteBullet(${bullet.id})" class="back-to-login" style="padding: 4px 8px; margin: 2px;">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    table.style.display = 'none';
                    noMessage.style.display = 'block';
                }
            } catch (e) {
                console.error('Error loading bullet library:', e);
            }
        };

        window.deleteBullet = async function(bulletId) {
            if (!confirm('Are you sure you want to delete this bullet?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('bullet_library')
                    .delete()
                    .eq('id', bulletId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error deleting bullet:', error);
                    alert('Error deleting bullet. Please try again.');
                } else {
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error deleting bullet. Please try again.');
            }
        };

        // Load bullet library for management page (includes shared bullets)
        window.loadBulletLibraryDirect = async function() {
            try {
                const content = document.getElementById('bulletLibraryContent');
                if (!content || !currentUser) {
                    console.error('Content element or currentUser not found');
                    return;
                }

                // Check and accept pending shares first
                await checkAndAcceptPendingShares();
                
                // Load user's own bullets
                const { data: ownBullets, error: ownError } = await supabase
                    .from('bullet_library')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('manufacturer_name', { ascending: true });

                if (ownError) {
                    console.error('Error loading own bullets:', ownError);
                    content.innerHTML = '<p>Error loading bullets. Please try again.</p>';
                    return;
                }

                // Load shared bullets from accepted shares
                const { data: acceptedShares } = await supabase
                    .from('library_shares')
                    .select('owner_id, share_type')
                    .eq('shared_with_user_id', currentUser.id)
                    .eq('status', 'accepted')
                    .in('share_type', ['bullets', 'both']);

                let sharedBullets = [];
                if (acceptedShares && acceptedShares.length > 0) {
                    const ownerIds = acceptedShares.map(share => share.owner_id);
                    
                    const { data: bullets } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .in('user_id', ownerIds)
                        .order('manufacturer_name', { ascending: true });

                    if (bullets) {
                        sharedBullets = bullets;
                    }
                }

                // Build the HTML content
                let html = '';
                
                // My bullets section
                if (ownBullets && ownBullets.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px;">My Bullets</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Manufacturer</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Caliber</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Grain</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">BC</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Drag</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    ownBullets.forEach(bullet => {
                        html += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.manufacturer_name}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.caliber}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.grain}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.ballistic_coefficient}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.drag_model}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.bullet_type}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">
                                    <button onclick="deleteBullet(${bullet.id})" style="background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                                </td>
                            </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                }

                // Shared bullets section
                if (sharedBullets && sharedBullets.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #333; border-bottom: 2px solid #28a745; padding-bottom: 5px;">Shared Bullets (View Only)</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Manufacturer</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Caliber</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Grain</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">BC</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Drag</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Type</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    sharedBullets.forEach(bullet => {
                        html += `
                            <tr style="background-color: #f0f8f0;">
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.manufacturer_name}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.caliber}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.grain}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.ballistic_coefficient}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.drag_model}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${bullet.bullet_type}</td>
                            </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                }

                // If no bullets at all
                if ((!ownBullets || ownBullets.length === 0) && (!sharedBullets || sharedBullets.length === 0)) {
                    html = '<p style="text-align: center; padding: 20px; color: #666;">No bullets in your library yet. Click "Add New Bullet" to get started!</p>';
                }

                content.innerHTML = html;

            } catch (error) {
                console.error('Error loading bullet library:', error);
                const content = document.getElementById('bulletLibraryContent');
                if (content) {
                    content.innerHTML = '<p>Error loading bullets. Please try again.</p>';
                }
            }
        };

        // Check if user is admin and show admin panel button
        function checkAdminAccess() {
            console.log('checkAdminAccess called');
            console.log('currentUser:', currentUser);
            console.log('currentUser.id:', currentUser?.id);
            
            const adminButton = document.getElementById('adminPanelButton');
            console.log('Admin button element found:', adminButton);
            
            if (currentUser && currentUser.id === '5df728ad-7154-4744-994a-d89bd3040946') {
                console.log('Admin access granted - showing admin button');
                if (adminButton) {
                    adminButton.style.display = 'block';
                    console.log('Admin button is now visible');
                } else {
                    console.log('ERROR: Admin button element not found in DOM');
                }
            } else {
                console.log('Admin access denied - hiding admin button');
                if (adminButton) {
                    adminButton.style.display = 'none';
                }
            }
        }

        // Admin Panel Functions
        window.showAdminPanel = async function() {
            console.log('showAdminPanel function called');
            
            // Check if current user is admin
            if (!currentUser || currentUser.id !== '5df728ad-7154-4744-994a-d89bd3040946') {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            // Hide all other sections
            const hideElement = (id) => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            };
            hideElement('homePage');
            hideElement('shootingProfileSection');
            hideElement('bulletLibrarySection');
            hideElement('firearmLibrary');
            hideElement('dopeSection');
            hideElement('setupSection');
            hideElement('activeBulletLibrary');
            hideElement('activeFirearmLibrary');
            hideElement('activeDopeSection');
            hideElement('activeSetupSection');
            
            // Show admin panel - remove existing one first and create fresh
            const existingAdminPanel = document.getElementById('adminPanel');
            console.log('Existing admin panel found:', !!existingAdminPanel);
            
            if (existingAdminPanel) {
                existingAdminPanel.remove();
                console.log('Removed existing admin panel');
            }
            
            // Always create a fresh admin panel
            console.log('Creating fresh admin panel');
            const adminPanelHTML = `
                    <div id="adminPanel" style="display: block !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; background: white; z-index: 10000; overflow-y: auto;">
                        <div style="max-width: 1200px; margin: 0 auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #dc3545; padding-bottom: 15px;">
                                <h1 style="margin: 0; color: #dc3545;">🛡️ Admin Panel</h1>
                                <button onclick="hideAdminPanel()" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">✕ Close</button>
                            </div>
                            
                            <div style="margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h2 style="margin-top: 0; color: #333;">User Management Dashboard</h2>
                                <p id="userCount" style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">Loading user data...</p>
                            </div>
                            
                            <div id="userApprovalContent" style="margin-top: 20px;">
                                <p style="text-align: center; color: #666; font-style: italic;">Loading user activity data...</p>
                            </div>
                        </div>
                    </div>
                `;
                
            document.body.insertAdjacentHTML('beforeend', adminPanelHTML);
            console.log('Admin panel HTML created and added to body');
            
            // Load user data
            await loadAllUsers();
        };

        window.hideAdminPanel = function() {
            const adminPanel = document.getElementById('adminPanel');
            if (adminPanel) {
                adminPanel.remove();
            }
            // Show the home page
            const homePage = document.getElementById('homePage');
            if (homePage) {
                homePage.style.display = 'block';
            }
        };

        window.updateUserNotes = async function(userId, notes) {
            try {
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({ notes: notes })
                    .eq('user_id', userId);

                if (error) {
                    console.error('Error updating user notes:', error);
                    alert('Failed to update notes. Please try again.');
                } else {
                    console.log('User notes updated successfully for user:', userId);
                }
            } catch (error) {
                console.error('Error updating user notes:', error);
                alert('Failed to update notes. Please try again.');
            }
        };

        // Helper function to check access and run a function
        window.checkAccessAndRun = async function(fn) {
            if (await checkUserAccess()) {
                fn();
            }
        };

        // Protect data operations - add access check to all save functions
        const originalFunctions = {};

        // Store original functions and wrap with access checks
        function protectFunction(functionName) {
            if (window[functionName]) {
                originalFunctions[functionName] = window[functionName];
                window[functionName] = async function(...args) {
                    if (await checkUserAccess()) {
                        return originalFunctions[functionName].apply(this, args);
                    }
                };
            }
        }

        // Apply protection when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Protect all major data operations
                protectFunction('saveBulletToLibrary');
                protectFunction('saveFirearmProfile');
                protectFunction('saveDOPERecord');
                protectFunction('saveZeroProfile');
                protectFunction('calculateTrajectory');
                protectFunction('addBulletToLibrary');
                protectFunction('addFirearmToLibrary');
                protectFunction('loadBulletLibrary');
                protectFunction('loadFirearmLibrary');
                protectFunction('showBulletLibrary');
                protectFunction('showFirearmLibrary');
                protectFunction('showDOPE');
                protectFunction('showShootingProfile');
                protectFunction('showSetup');
                protectFunction('updateProfile');
                protectFunction('changePassword');
                protectFunction('deleteAccount');
                console.log('Access protection applied to major functions');
            }, 1000);
        });

        // Check if user has access to the application
        async function checkUserAccess() {
            if (!currentUser) {
                alert('Please log in to access this feature.');
                return false;
            }
            
            try {
                const { data: profile } = await window.supabase
                    .from('user_profile')
                    .select('status, subscription_status, subscription_expires_at')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!profile) {
                    alert('Account profile not found. Access denied. Please contact support.');
                    await window.supabase.auth.signOut();
                    return false;
                }
                
                // Block access for pending accounts
                if (profile.status === 'pending') {
                    alert('Your account is pending approval. Please wait for administrator approval.');
                    return false;
                }
                
                // Block access for revoked accounts
                if (profile.status === 'revoked') {
                    alert('Your account access has been revoked. Please contact support.');
                    await window.supabase.auth.signOut();
                    return false;
                }
                
                // Block access for deleted accounts
                if (profile.status === 'deletion_requested') {
                    alert('Your account deletion is pending. You cannot access the application.');
                    await window.supabase.auth.signOut();
                    return false;
                }
                
                // Only allow approved accounts to continue
                if (profile.status !== 'approved') {
                    alert('Your account is not approved for access.');
                    return false;
                }
                
                // Check subscription status
                if (profile.subscription_status === 'expired') {
                    alert('Your subscription has expired. Please renew to continue using the application.');
                    return false;
                }
                
                if (profile.subscription_status === 'cancelled') {
                    alert('Your subscription has been cancelled. Please subscribe to continue using the application.');
                    return false;
                }
                
                if (profile.subscription_status === 'suspended') {
                    alert('Your subscription has been suspended. Please contact support.');
                    return false;
                }
                
                // Check trial expiration
                if (profile.subscription_status === 'trial' && profile.subscription_expires_at) {
                    const expirationDate = new Date(profile.subscription_expires_at);
                    if (expirationDate < new Date()) {
                        alert('Your free trial has expired. Please subscribe to continue using the application.');
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('Error checking user access:', error);
                alert('Unable to verify account access. Please try again.');
                return false;
            }
        }

        window.completeDeletion = async function(userId) {
            if (!confirm('Are you sure you want to permanently delete this user account? This action cannot be undone and will:\n\n• Remove all user data from application tables\n• Delete the user from authentication\n• Permanently remove their account\n\nContinue?')) {
                return;
            }
            
            try {
                console.log('Starting complete user deletion for:', userId);
                
                // Delete all user data from all tables
                const deletions = [
                    window.supabase.from('ballistic_sessions').delete().eq('user_id', userId),
                    window.supabase.from('bullet_library').delete().eq('user_id', userId),
                    window.supabase.from('dope_engagements').delete().eq('user_id', userId),
                    window.supabase.from('firearm_profile').delete().eq('user_id', userId),
                    window.supabase.from('library_shares').delete().eq('user_id', userId),
                    window.supabase.from('library_shares').delete().eq('shared_with_user_id', userId),
                    window.supabase.from('user_preferences').delete().eq('user_id', userId),
                    window.supabase.from('user_profile').delete().eq('user_id', userId)
                ];
                
                // Execute all data deletions
                await Promise.allSettled(deletions);
                
                // Delete user from Supabase auth (admin function)
                const { error } = await window.supabase.auth.admin.deleteUser(userId);
                
                if (error) {
                    console.error('Error deleting auth user:', error);
                    alert('User data deleted but could not remove from authentication. Please check admin permissions.');
                } else {
                    alert('User account completely deleted successfully.');
                }
                
                await loadAllUsers(); // Refresh the list
                
            } catch (error) {
                console.error('Error in completeDeletion:', error);
                alert('Error deleting user account. Please try again.');
            }
        };

        window.cancelDeletion = async function(userId) {
            if (!confirm('Cancel the deletion request for this user? They will be restored to approved status.')) {
                return;
            }
            
            try {
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({ 
                        status: 'approved',
                        notes: 'Deletion request cancelled by admin on ' + new Date().toLocaleDateString()
                    })
                    .eq('user_id', userId);
                
                if (error) {
                    console.error('Error cancelling deletion request:', error);
                    alert('Error cancelling deletion request. Please try again.');
                    return;
                }
                
                alert('Deletion request cancelled. User restored to approved status.');
                await loadAllUsers(); // Refresh the list
                
            } catch (error) {
                console.error('Error in cancelDeletion:', error);
                alert('Error cancelling deletion request. Please try again.');
            }
        };

        // Track user login for admin visibility
        async function trackUserLogin(user) {
            try {
                // Create a simple tracking entry using the bullet_library table
                // This ensures all logged-in users appear in the admin panel
                const trackingEntry = {
                    user_id: user.id,
                    bullet_name: '__USER_LOGIN_TRACKING__',
                    manufacturer: 'SYSTEM',
                    caliber: 'TRACKING',
                    grain_weight: 0,
                    ballistic_coefficient: 0,
                    drag_model: 'SYSTEM',
                    bullet_type: 'LOGIN_TRACKER'
                };

                // Check if tracking entry already exists
                const { data: existing } = await window.supabase
                    .from('bullet_library')
                    .select('id')
                    .eq('user_id', user.id)
                    .eq('bullet_name', '__USER_LOGIN_TRACKING__')
                    .limit(1);

                // Only create if doesn't exist
                if (!existing || existing.length === 0) {
                    await window.supabase
                        .from('bullet_library')
                        .insert(trackingEntry);
                    console.log('User login tracked for admin visibility');
                }
            } catch (error) {
                console.log('Login tracking failed (non-critical):', error);
            }
        }

        window.loadAllUsers = async function() {
            try {
                console.log('Loading user data from application tables');
                
                const userApprovalContent = document.getElementById('userApprovalContent');
                const userCount = document.getElementById('userCount');
                
                // Get user profiles and activity data
                const [
                    { data: userProfiles, error: profileError },
                    { data: bullets, error: bulletsError },
                    { data: firearms, error: firearmsError },
                    { data: dopeData, error: dopeError },
                    { data: zeroProfiles, error: zeroError }
                ] = await Promise.all([
                    window.supabase.from('user_profile').select('*').limit(1000),
                    window.supabase.from('bullet_library').select('user_id, created_at').limit(1000),
                    window.supabase.from('firearm_profile').select('user_id, created_at').limit(1000),
                    window.supabase.from('dope_sessions').select('user_id, created_at').limit(1000),
                    window.supabase.from('zero_profiles').select('user_id, created_at').limit(1000)
                ]);

                console.log('User profiles loaded:', userProfiles);
                console.log('Profile error:', profileError);

                if (profileError) {
                    console.error('Error loading user profiles:', profileError);
                    userApprovalContent.innerHTML = '<p style="color: red;">Error loading user profiles. Please ensure the user_profile table exists in your database.</p>';
                    return;
                }
                
                // Build comprehensive user data from profiles and activity
                const allUsers = {};
                
                // Start with all user profiles (this shows pending, approved, and revoked users)
                userProfiles?.forEach(profile => {
                    allUsers[profile.user_id] = {
                        profile: profile,
                        bullets: 0,
                        firearms: 0,
                        dope: 0,
                        zeros: 0,
                        firstActivity: null
                    };
                });
                
                // Count bullets per user (exclude tracking entries)
                bullets?.forEach(item => {
                    if (item.bullet_name !== '__USER_LOGIN_TRACKING__' && allUsers[item.user_id]) {
                        allUsers[item.user_id].bullets++;
                        if (!allUsers[item.user_id].firstActivity || item.created_at < allUsers[item.user_id].firstActivity) {
                            allUsers[item.user_id].firstActivity = item.created_at;
                        }
                    }
                });
                
                // Count firearms per user
                firearms?.forEach(item => {
                    if (allUsers[item.user_id]) {
                        allUsers[item.user_id].firearms++;
                        if (!allUsers[item.user_id].firstActivity || item.created_at < allUsers[item.user_id].firstActivity) {
                            allUsers[item.user_id].firstActivity = item.created_at;
                        }
                    }
                });
                
                // Count DOPE sessions per user
                dopeData?.forEach(item => {
                    if (allUsers[item.user_id]) {
                        allUsers[item.user_id].dope++;
                        if (!allUsers[item.user_id].firstActivity || item.created_at < allUsers[item.user_id].firstActivity) {
                            allUsers[item.user_id].firstActivity = item.created_at;
                        }
                    }
                });
                
                // Count zero profiles per user
                zeroProfiles?.forEach(item => {
                    if (allUsers[item.user_id]) {
                        allUsers[item.user_id].zeros++;
                        if (!allUsers[item.user_id].firstActivity || item.created_at < allUsers[item.user_id].firstActivity) {
                            allUsers[item.user_id].firstActivity = item.created_at;
                        }
                    }
                });
                
                const userIds = Object.keys(allUsers);
                const pendingCount = userIds.filter(id => allUsers[id].profile.status === 'pending').length;
                const approvedCount = userIds.filter(id => allUsers[id].profile.status === 'approved').length;
                const revokedCount = userIds.filter(id => allUsers[id].profile.status === 'revoked').length;
                const deletionCount = userIds.filter(id => allUsers[id].profile.status === 'deletion_requested').length;
                
                userCount.textContent = `Total users: ${userIds.length} (${pendingCount} pending, ${approvedCount} approved, ${revokedCount} revoked, ${deletionCount} deletion requests)`;
                
                if (userIds.length === 0) {
                    userApprovalContent.innerHTML = '<p>No users found.</p>';
                    return;
                }
                
                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Name</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Email</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Role</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Status</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Notes</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Activity</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Registered</th>
                                <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: bold;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Sort users: pending first, then approved, then revoked
                const sortedUserIds = userIds.sort((a, b) => {
                    const statusOrder = { 'pending': 0, 'approved': 1, 'revoked': 2 };
                    const statusA = allUsers[a].profile.status;
                    const statusB = allUsers[b].profile.status;
                    if (statusA !== statusB) {
                        return statusOrder[statusA] - statusOrder[statusB];
                    }
                    return new Date(allUsers[b].profile.created_at) - new Date(allUsers[a].profile.created_at);
                });
                
                sortedUserIds.forEach(userId => {
                    const user = allUsers[userId];
                    const profile = user.profile;
                    const isAdmin = userId === '5df728ad-7154-4744-994a-d89bd3040946' || profile.role === 'Admin';
                    const fullName = [profile.first_name, profile.last_name].filter(n => n).join(' ') || 'N/A';
                    const registeredDate = new Date(profile.created_at).toLocaleDateString();
                    const totalActivity = user.bullets + user.firearms + user.dope + user.zeros;
                    
                    let statusColor = '#28a745'; // approved - green
                    let statusText = profile.status;
                    let roleDisplay = profile.role || 'User';
                    
                    if (isAdmin || profile.role === 'Admin') {
                        statusColor = '#dc3545'; // admin - red
                        statusText = 'Admin';
                        roleDisplay = 'Admin';
                    } else if (profile.status === 'pending') {
                        statusColor = '#ffc107'; // pending - yellow
                    } else if (profile.status === 'revoked') {
                        statusColor = '#6c757d'; // revoked - gray
                    } else if (profile.status === 'deletion_requested') {
                        statusColor = '#e74c3c'; // deletion requested - red
                        statusText = 'Deletion Requested';
                    }
                    
                    const notesValue = profile.notes || '';
                    tableHTML += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="border: 1px solid #dee2e6; padding: 10px;">${fullName}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px; font-size: 13px;">${profile.email}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background-color: ${isAdmin ? '#dc3545' : '#007bff'}; color: white;">${roleDisplay}</span>
                            </td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background-color: ${statusColor}; color: white;">${profile.status}</span>
                            </td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">
                                <input type="text" value="${notesValue}" 
                                       onblur="updateUserNotes('${userId}', this.value)"
                                       style="width: 100%; border: none; background: transparent; font-size: 12px; padding: 4px;"
                                       placeholder="Add notes...">
                            </td>
                            <td style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">${totalActivity} items</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">${registeredDate}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">
                                ${isAdmin ? 
                                    '<span style="color: #666; font-size: 12px;">Admin Account</span>' : 
                                    (function(status) {
                                        if (status === 'pending') {
                                            return `
                                                <button onclick="approveUser('${userId}')" style="background: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Approve</button>
                                                <button onclick="revokeUserAccess('${userId}')" style="background: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Deny</button>
                                            `;
                                        } else if (status === 'approved') {
                                            return `
                                                <button onclick="revokeUserAccess('${userId}')" style="background: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Revoke</button>
                                                <button onclick="viewUserData('${userId}')" style="background: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View Data</button>
                                            `;
                                        } else if (status === 'revoked') {
                                            return `<button onclick="approveUser('${userId}')" style="background: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Re-approve</button>`;
                                        } else if (status === 'deletion_requested') {
                                            return `
                                                <button onclick="completeDeletion('${userId}')" style="background: #e74c3c; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Complete Deletion</button>
                                                <button onclick="cancelDeletion('${userId}')" style="background: #6c757d; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Cancel Request</button>
                                            `;
                                        }
                                        return '<span style="color: #666; font-size: 12px;">No actions</span>';
                                    })(profile.status)
                                }
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                userApprovalContent.innerHTML = tableHTML;
                
                console.log('User activity table rendered successfully');
                
            } catch (error) {
                console.error('Error in loadAllUsers:', error);
                document.getElementById('userApprovalContent').innerHTML = '<p style="color: red;">Error loading user data. Please check console for details.</p>';
            }
        };

        window.viewUserData = async function(userId) {
            try {
                console.log('Loading detailed data for user:', userId);
                
                // Get detailed user data from all tables
                const [
                    { data: bullets },
                    { data: firearms },
                    { data: dopeData },
                    { data: zeroProfiles }
                ] = await Promise.all([
                    window.supabase.from('bullet_library').select('*').eq('user_id', userId),
                    window.supabase.from('firearm_profile').select('*').eq('user_id', userId),
                    window.supabase.from('dope_sessions').select('*').eq('user_id', userId),
                    window.supabase.from('zero_profiles').select('*').eq('user_id', userId)
                ]);
                
                const modalHTML = `
                    <div id="userDetailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10000;">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 80%; max-height: 80%; overflow-y: auto; width: 800px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                                <h2 style="margin: 0; color: #333;">User Details</h2>
                                <button onclick="closeUserDetailModal()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">✕</button>
                            </div>
                            
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <h3 style="margin-top: 0;">User ID: ${userId.substring(0, 16)}...</h3>
                                <p><strong>Full ID:</strong> <span style="font-family: monospace; font-size: 12px; word-break: break-all;">${userId}</span></p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 5px;">📋 Bullet Library (${bullets?.length || 0})</h4>
                                    ${bullets?.length ? bullets.slice(0, 3).map(b => `<p style="margin: 5px 0; padding: 8px; background: #f0f8f0; border-radius: 4px; font-size: 13px;">${b.bullet_name || 'Unnamed'} - ${b.caliber || 'N/A'}</p>`).join('') + (bullets.length > 3 ? `<p style="font-style: italic; color: #666;">... and ${bullets.length - 3} more</p>` : '') : '<p style="color: #666; font-style: italic;">No bullets saved</p>'}
                                </div>
                                
                                <div>
                                    <h4 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px;">🔫 Firearm Profiles (${firearms?.length || 0})</h4>
                                    ${firearms?.length ? firearms.slice(0, 3).map(f => `<p style="margin: 5px 0; padding: 8px; background: #f0f4ff; border-radius: 4px; font-size: 13px;">${f.firearm_name || 'Unnamed'} - ${f.caliber || 'N/A'}</p>`).join('') + (firearms.length > 3 ? `<p style="font-style: italic; color: #666;">... and ${firearms.length - 3} more</p>` : '') : '<p style="color: #666; font-style: italic;">No firearms saved</p>'}
                                </div>
                                
                                <div>
                                    <h4 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 5px;">🎯 DOPE Sessions (${dopeData?.length || 0})</h4>
                                    ${dopeData?.length ? dopeData.slice(0, 3).map(d => `<p style="margin: 5px 0; padding: 8px; background: #fff0f0; border-radius: 4px; font-size: 13px;">${d.range_yards || 'N/A'}yd - ${new Date(d.created_at).toLocaleDateString()}</p>`).join('') + (dopeData.length > 3 ? `<p style="font-style: italic; color: #666;">... and ${dopeData.length - 3} more</p>` : '') : '<p style="color: #666; font-style: italic;">No DOPE data</p>'}
                                </div>
                                
                                <div>
                                    <h4 style="color: #6c757d; border-bottom: 2px solid #6c757d; padding-bottom: 5px;">⚙️ Zero Profiles (${zeroProfiles?.length || 0})</h4>
                                    ${zeroProfiles?.length ? zeroProfiles.slice(0, 3).map(z => `<p style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">${z.zero_range || 'N/A'}yd zero - ${new Date(z.created_at).toLocaleDateString()}</p>`).join('') + (zeroProfiles.length > 3 ? `<p style="font-style: italic; color: #666;">... and ${zeroProfiles.length - 3} more</p>` : '') : '<p style="color: #666; font-style: italic;">No zero profiles</p>'}
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee; text-align: center;">
                                <button onclick="closeUserDetailModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Close</button>
                                <button onclick="exportUserData('${userId}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Export Data</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Error loading user details. Please check console for details.');
            }
        };

        window.closeUserDetailModal = function() {
            const modal = document.getElementById('userDetailModal');
            if (modal) {
                modal.remove();
            }
        };

        window.exportUserData = async function(userId) {
            try {
                // Get all user data for export
                const [
                    { data: bullets },
                    { data: firearms },
                    { data: dopeData },
                    { data: zeroProfiles }
                ] = await Promise.all([
                    window.supabase.from('bullet_library').select('*').eq('user_id', userId),
                    window.supabase.from('firearm_profile').select('*').eq('user_id', userId),
                    window.supabase.from('dope_sessions').select('*').eq('user_id', userId),
                    window.supabase.from('zero_profiles').select('*').eq('user_id', userId)
                ]);

                const exportData = {
                    user_id: userId,
                    export_date: new Date().toISOString(),
                    data: {
                        bullets: bullets || [],
                        firearms: firearms || [],
                        dope_sessions: dopeData || [],
                        zero_profiles: zeroProfiles || []
                    }
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `user_data_${userId.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('User data exported successfully');
                
            } catch (error) {
                console.error('Error exporting user data:', error);
                alert('Error exporting user data. Please check console for details.');
            }
        };

        // Generate action buttons based on user status
        function generateUserActionButtons(userId, status) {
            let buttons = '';
            
            if (status === 'pending') {
                buttons = `
                    <button onclick="approveUser('${userId}')" style="background-color: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Approve</button>
                    <button onclick="denyUser('${userId}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Deny</button>
                `;
            } else if (status === 'approved') {
                buttons = `
                    <button onclick="revokeUser('${userId}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Revoke</button>
                    <button onclick="viewUserData('${userId}')" style="background-color: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">View Data</button>
                `;
            } else if (status === 'revoked') {
                buttons = `
                    <button onclick="reapproveUser('${userId}')" style="background-color: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Re-approve</button>
                `;
            }
            
            return buttons;
        }

        // User management functions
        window.approveUser = async function(userId) {
            if (!confirm('Approve this user for access to the application?')) return;
            
            try {
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: currentUser.id
                    })
                    .eq('user_id', userId);

                if (error) throw error;
                
                console.log('User approved successfully');
                await loadAllUsers(); // Refresh the table
            } catch (error) {
                console.error('Error approving user:', error);
                alert('Error approving user. Please check console for details.');
            }
        };

        window.denyUser = async function(userId) {
            if (!confirm('Deny this user access? This will set their status to revoked.')) return;
            
            try {
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({
                        status: 'revoked',
                        revoked_at: new Date().toISOString(),
                        revoked_by: currentUser.id
                    })
                    .eq('user_id', userId);

                if (error) throw error;
                
                console.log('User denied successfully');
                await loadAllUsers(); // Refresh the table
            } catch (error) {
                console.error('Error denying user:', error);
                alert('Error denying user. Please check console for details.');
            }
        };

        window.revokeUser = async function(userId) {
            if (!confirm('Revoke access for this user? They will no longer be able to use the application.')) return;
            
            try {
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({
                        status: 'revoked',
                        revoked_at: new Date().toISOString(),
                        revoked_by: currentUser.id
                    })
                    .eq('user_id', userId);

                if (error) throw error;
                
                console.log('User access revoked successfully');
                await loadAllUsers(); // Refresh the table
            } catch (error) {
                console.error('Error revoking user:', error);
                alert('Error revoking user. Please check console for details.');
            }
        };

        window.reapproveUser = async function(userId) {
            if (!confirm('Re-approve this user for access to the application?')) return;
            
            try {
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: currentUser.id,
                        revoked_at: null,
                        revoked_by: null
                    })
                    .eq('user_id', userId);

                if (error) throw error;
                
                console.log('User re-approved successfully');
                await loadAllUsers(); // Refresh the table
            } catch (error) {
                console.error('Error re-approving user:', error);
                alert('Error re-approving user. Please check console for details.');
            }
        };

        window.revokeUserAccess = async function(userId) {
            if (!confirm('Are you sure you want to revoke access for this user? This will prevent them from logging in.')) {
                return;
            }
            
            try {
                // Delete user from Supabase auth
                const { error } = await supabase.auth.admin.deleteUser(userId);
                
                if (error) {
                    console.error('Error revoking user access:', error);
                    alert('Error revoking user access. Admin API permissions may be required.');
                    return;
                }
                
                alert('User access revoked successfully.');
                await loadAllUsers(); // Refresh the list
                
            } catch (error) {
                console.error('Error in revokeUserAccess:', error);
                alert('Error revoking user access. Please try again.');
            }
        };

        window.viewUserData = async function(userId) {
            try {
                // Get user's data from various tables
                const [
                    { data: bullets },
                    { data: firearms },
                    { data: dopeData },
                    { data: zeroProfiles }
                ] = await Promise.all([
                    supabase.from('bullet_library').select('*').eq('user_id', userId),
                    supabase.from('firearm_profile').select('*').eq('user_id', userId),
                    supabase.from('dope_sessions').select('*').eq('user_id', userId),
                    supabase.from('zero_profiles').select('*').eq('user_id', userId)
                ]);
                
                const summary = `
User Data Summary:
• Bullets: ${bullets?.length || 0}
• Firearms: ${firearms?.length || 0} 
• DOPE Sessions: ${dopeData?.length || 0}
• Zero Profiles: ${zeroProfiles?.length || 0}
                `;
                
                alert(summary);
                
            } catch (error) {
                console.error('Error viewing user data:', error);
                alert('Error loading user data.');
            }
        };

        // Setup Page Functions
        window.showSetup = async function() {
            console.log('showSetup function called');
            
            // Hide all other sections
            const hideElement = (id) => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            };
            hideElement('homePage');
            hideElement('shootingProfileSection');
            hideElement('firearmLibrarySection');
            hideElement('bulletLibrarySection'); 
            hideElement('activeDopeSection');
            hideElement('filterSection');
            hideElement('ballisticForm');
            hideElement('compareForm');
            hideElement('compareResults');
            hideElement('activeBulletLibrary');
            hideElement('activeFirearmLibrary');
            hideElement('dopeSection');
            
            // Create setup content dynamically (like DOPE section)
            const appContent = document.getElementById('appContent');
            const setupContent = document.createElement('div');
            setupContent.id = 'activeSetupSection';
            setupContent.style.cssText = `
                display: block;
                width: 100%;
                min-height: 500px;
                padding: 20px;
                background-color: #f5f5f5;
                position: relative;
            `;
            
            // Add setup HTML content
            setupContent.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                        <h2 style="margin: 0; color: #333;">Setup</h2>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div style="border-bottom: 2px solid #ddd; margin-bottom: 20px;">
                        <button onclick="showSetupTab('account')" id="accountTabBtn" class="setup-tab-btn" style="padding: 10px 20px; margin-right: 10px; border: none; background: #007bff; color: white; border-radius: 4px 4px 0 0; cursor: pointer;">Account</button>
                        <button onclick="showSetupTab('sharing')" id="sharingTabBtn" class="setup-tab-btn" style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 4px 4px 0 0; cursor: pointer;">Sharing</button>
                    </div>
                    
                    <!-- Tab Content Areas -->
                    <div id="setupTabContent"></div>
                </div>
            `;
            
            // Remove any existing active setup section
            const existing = document.getElementById('activeSetupSection');
            if (existing) existing.remove();
            
            // Add the new setup content
            appContent.appendChild(setupContent);
            console.log('Setup content created and added to page');
            
            // Get current user and load profile data
            try {
                if (!window.supabaseClient) {
                    console.error('Supabase client not available, setup page will show with limited functionality');
                    showSetupTab('account');
                    return;
                }
                
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (user && !error) {
                    window.currentUser = user;
                    loadUserProfile();
                } else {
                    console.error('No user found for setup page:', error);
                }
                
                // Show the default Account tab
                showSetupTab('account');
                
            } catch (error) {
                console.error('Error getting user for setup:', error);
                showSetupTab('account');
            }
        };

        window.showSetupTab = function(tabName) {
            console.log('showSetupTab called with:', tabName);
            
            // Update tab button styles
            document.querySelectorAll('.setup-tab-btn').forEach(btn => {
                btn.style.background = '#6c757d';
                btn.style.color = 'white';
            });
            
            // Highlight active tab
            const activeTabBtn = document.getElementById(`${tabName}TabBtn`);
            if (activeTabBtn) {
                activeTabBtn.style.background = '#007bff';
                activeTabBtn.style.color = 'white';
                console.log('Active tab button updated:', tabName);
            }
            
            // Create tab content based on selected tab
            const tabContentDiv = document.getElementById('setupTabContent');
            if (!tabContentDiv) {
                console.error('Tab content container not found');
                return;
            }
            
            let content = '';
            
            if (tabName === 'account') {
                content = `
                    <div id="accountTab">
                        <h3 style="margin-top: 0;">Account Management</h3>
                        
                        <div style="background-color: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #2196f3;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div>
                                    <strong>Logged in as:</strong> <span id="currentUserEmail" style="color: #1976d2;"></span>
                                </div>
                                <button onclick="logout()" style="background-color: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email Address:</label>
                            <input type="email" id="profileEmail" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Display Name:</label>
                            <input type="text" id="profileDisplayName" placeholder="Enter your display name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button onclick="updateProfile()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Update Profile</button>
                            <button onclick="showChangePassword()" style="background-color: #ffc107; color: black; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Change Password</button>
                            <button onclick="confirmDeleteAccount()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Delete Account</button>
                        </div>
                        
                        <div id="changePasswordSection" style="display: none; background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 20px;">
                            <h4>Change Password</h4>
                            <div style="margin-bottom: 10px;">
                                <input type="password" id="currentPassword" placeholder="Current password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="password" id="newPassword" placeholder="New password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="password" id="confirmNewPassword" placeholder="Confirm new password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <button onclick="changePassword()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Update Password</button>
                            <button onclick="cancelChangePassword()" style="background-color: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                `;
            } else if (tabName === 'sharing') {
                content = `
                    <div id="sharingTab">
                        <h3 style="margin-top: 0;">Library Sharing</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>Share Your Libraries</h4>
                            <p style="margin-bottom: 10px;">Enter email addresses to share your firearm and bullet libraries:</p>
                            <input type="email" id="shareEmail" placeholder="Enter email address" style="width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button onclick="shareLibraries()" style="background-color: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Share</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>Request Library Access</h4>
                            <p style="margin-bottom: 10px;">Request access to another user's libraries:</p>
                            <input type="email" id="requestEmail" placeholder="Enter email address" style="width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button onclick="requestLibraryAccess()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Request Access</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>Pending Share Requests</h4>
                            <p style="margin-bottom: 10px; font-size: 14px; color: #666;">Requests from others to access your libraries:</p>
                            <div id="pendingRequestsList" style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 60px;">
                                Loading pending requests...
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>Currently Shared With</h4>
                            <div id="sharedWithList" style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 60px;">
                                Loading shared users...
                            </div>
                        </div>
                        
                        <div>
                            <h4>Libraries Shared With You</h4>
                            <div id="sharedFromList" style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; min-height: 60px;">
                                Loading shared libraries...
                            </div>
                        </div>
                    </div>
                `;
            }
            
            tabContentDiv.innerHTML = content;
            console.log('Tab content loaded for:', tabName);
            
            // Load user data for account tab
            if (tabName === 'account') {
                loadUserProfile();
                // Also populate the current user email display
                if (window.currentUser && window.currentUser.email) {
                    const currentUserEmailSpan = document.getElementById('currentUserEmail');
                    if (currentUserEmailSpan) {
                        currentUserEmailSpan.textContent = window.currentUser.email;
                    }
                }
            } else if (tabName === 'sharing') {
                loadSharingData();
            }
        };

        window.loadUserProfile = async function() {
            try {
                if (!window.currentUser) return;
                
                // Set email (readonly)
                document.getElementById('profileEmail').value = window.currentUser.email || '';
                
                // Load user metadata from Supabase auth
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error) {
                    console.error('Error loading user profile:', error);
                    return;
                }
                
                // Set display name if available
                const displayName = user?.user_metadata?.display_name || user?.user_metadata?.full_name || '';
                document.getElementById('profileDisplayName').value = displayName;
                
                // Load profile picture if available
                const profilePicUrl = user?.user_metadata?.avatar_url || user?.user_metadata?.picture;
                if (profilePicUrl) {
                    document.getElementById('currentProfilePic').src = profilePicUrl;
                    document.getElementById('currentProfilePic').style.display = 'block';
                    document.getElementById('profilePicPlaceholder').style.display = 'none';
                }
                
                // Load preferences from localStorage
                const savedTheme = localStorage.getItem('ballistic_theme') || 'light';
                document.getElementById('themeSelect').value = savedTheme;
                
                document.getElementById('defaultUnits').value = localStorage.getItem('ballistic_units') || 'imperial';
                document.getElementById('defaultTemp').value = localStorage.getItem('ballistic_temp') || '59';
                document.getElementById('defaultHumidity').value = localStorage.getItem('ballistic_humidity') || '78';
                document.getElementById('defaultPressure').value = localStorage.getItem('ballistic_pressure') || '29.92';
                document.getElementById('defaultAltitude').value = localStorage.getItem('ballistic_altitude') || '0';
                
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        };

        window.saveProfile = async function() {
            try {
                const displayName = document.getElementById('profileDisplayName').value.trim();
                
                // Update user metadata
                const { error } = await window.supabaseClient.auth.updateUser({
                    data: { display_name: displayName }
                });
                
                if (error) {
                    alert('Error updating profile: ' + error.message);
                    return;
                }
                
                alert('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
            }
        };

        window.showChangePasswordForm = function() {
            document.getElementById('changePasswordForm').style.display = 'block';
        };

        window.cancelChangePassword = function() {
            document.getElementById('changePasswordForm').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        };

        window.changePassword = async function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    alert('Error changing password: ' + error.message);
                    return;
                }
                
                alert('Password changed successfully!');
                cancelChangePassword();
                
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password. Please try again.');
            }
        };

        window.confirmDeleteAccount = function() {
            const confirmed = confirm('⚠️ WARNING: This will permanently delete your account and ALL associated data including:\n\n• All bullet library entries\n• All firearm profiles\n• All DOPE records\n• All shared library access\n\nThis action CANNOT be undone.\n\nAre you absolutely sure you want to delete your account?');
            
            if (confirmed) {
                const doubleConfirm = confirm('FINAL WARNING: You are about to permanently delete your account.\n\nClick OK to proceed to final confirmation.');
                if (doubleConfirm) {
                    const userInput = prompt('Type "DELETE" (in capital letters) to confirm account deletion:');
                    if (userInput === 'DELETE') {
                        deleteAccount();
                    } else {
                        alert('Account deletion cancelled - incorrect confirmation text.');
                    }
                }
            }
        };

        window.deleteAccount = async function() {
            try {
                console.log('Requesting account deletion...');
                
                // Set user status to deletion_requested
                const { error } = await window.supabase
                    .from('user_profile')
                    .update({ 
                        status: 'deletion_requested',
                        notes: 'User requested account deletion on ' + new Date().toLocaleDateString()
                    })
                    .eq('user_id', window.currentUser.id);
                
                if (error) {
                    console.error('Error requesting account deletion:', error);
                    alert('Error requesting account deletion. Please try again or contact support.');
                    return;
                }
                
                alert('Account deletion requested successfully. Your request has been sent to administrators for review. You will be contacted once the deletion is processed.');
                
                // Log out the user
                await window.supabase.auth.signOut();
                
                // Redirect to home
                window.location.href = '/';
                
            } catch (error) {
                console.error('Error requesting account deletion:', error);
                alert('Error requesting account deletion. Please try again or contact support.');
            }
        };

        // Missing functions for setup page functionality
        window.updateProfile = async function() {
            try {
                const displayName = document.getElementById('profileDisplayName').value.trim();
                
                const { error } = await window.supabaseClient.auth.updateUser({
                    data: { display_name: displayName }
                });
                
                if (error) {
                    alert('Error updating profile: ' + error.message);
                    return;
                }
                
                alert('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        };

        window.showChangePassword = function() {
            document.getElementById('changePasswordSection').style.display = 'block';
        };

        window.cancelChangePassword = function() {
            document.getElementById('changePasswordSection').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        };

        window.loadUserPreferences = async function() {
            try {
                if (!window.currentUser) {
                    console.log('No current user, skipping preferences load');
                    return;
                }
                
                console.log('loadUserPreferences() called - checking if user is editing:', window.userEditingPreferences);
                if (window.userEditingPreferences) {
                    console.log('User is editing preferences - skipping load to preserve form values');
                    return;
                }
                
                console.log('Loading preferences for user:', window.currentUser.id);
                
                const { data, error } = await window.supabaseClient
                    .from('user_preferences')
                    .select('*')
                    .eq('user_id', window.currentUser.id)
                    .single();
                
                console.log('Preferences query result:', { data, error });
                
                // Handle the case where no preferences exist yet (PGRST116) or other acceptable errors
                if (error && error.code !== 'PGRST116' && error.code !== 'PGRST301') {
                    console.error('Error loading preferences:', error);
                    return;
                }
                
                // If no data found, use defaults
                if (!data) {
                    console.log('No existing preferences found, using defaults');
                }
                
                // Map the database values back to the form controls
                const darkMode = data?.theme === 'dark';
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) darkModeToggle.checked = darkMode;
                
                const isMetric = data?.default_units === 'metric';
                const distanceUnit = isMetric ? 'meters' : 'yards';
                const distanceUnitSelect = document.getElementById('defaultDistanceUnit');
                if (distanceUnitSelect) distanceUnitSelect.value = distanceUnit;
                
                const velocityUnit = data?.default_velocity_unit || 'fps';
                const velocityUnitSelect = document.getElementById('defaultVelocityUnit');
                if (velocityUnitSelect) velocityUnitSelect.value = velocityUnit;
                
                // Load environmental defaults from database if they exist, but only if fields are empty
                if (data?.default_temperature) {
                    const temperatureInput = document.getElementById('defaultTemperature');
                    if (temperatureInput && !temperatureInput.value) {
                        console.log('Loading temperature from DB:', data.default_temperature);
                        temperatureInput.value = data.default_temperature;
                    }
                }
                
                if (data?.default_humidity) {
                    const humidityInput = document.getElementById('defaultHumidity');
                    console.log('Humidity field check:', {
                        hasData: !!data?.default_humidity,
                        currentValue: humidityInput?.value,
                        willLoad: !!(humidityInput && !humidityInput.value),
                        dbValue: data.default_humidity
                    });
                    if (humidityInput && !humidityInput.value) {
                        console.log('Loading humidity from DB:', data.default_humidity);
                        humidityInput.value = data.default_humidity;
                    }
                }
                
                if (data?.default_pressure) {
                    const pressureInput = document.getElementById('defaultPressure');
                    if (pressureInput && !pressureInput.value) {
                        console.log('Loading pressure from DB:', data.default_pressure);
                        pressureInput.value = data.default_pressure;
                    }
                }
                
                if (data?.default_altitude) {
                    const altitudeInput = document.getElementById('defaultAltitude');
                    if (altitudeInput && !altitudeInput.value) {
                        console.log('Loading altitude from DB:', data.default_altitude);
                        altitudeInput.value = data.default_altitude;
                    }
                }
                
                // Always load unit selectors
                const temperatureUnit = data?.default_temperature_unit || 'F';
                const temperatureUnitSelect = document.getElementById('defaultTemperatureUnit');
                if (temperatureUnitSelect) temperatureUnitSelect.value = temperatureUnit;
                
                const pressureUnit = data?.default_pressure_unit || 'inHg';
                const pressureUnitSelect = document.getElementById('defaultPressureUnit');
                if (pressureUnitSelect) pressureUnitSelect.value = pressureUnit;
                
                const altitudeReference = data?.default_altitude_reference || 'ASL';
                const altitudeReferenceSelect = document.getElementById('defaultAltitudeReference');
                if (altitudeReferenceSelect) altitudeReferenceSelect.value = altitudeReference;
                
            } catch (error) {
                console.error('Error loading user preferences:', error);
            }
        };

        window.savePreferences = async function() {
            try {
                if (!window.currentUser) {
                    alert('Please log in to save preferences.');
                    return;
                }
                
                console.log('Save button clicked - preventing preference loading');
                window.userEditingPreferences = true;
                
                console.log('Saving preferences for user:', window.currentUser.id);
                
                // Capture values immediately when save is clicked, before anything can reset them
                const humidityElement = document.getElementById('defaultHumidity');
                const pressureElement = document.getElementById('defaultPressure');
                const altitudeElement = document.getElementById('defaultAltitude');
                
                // Use stored values from input handlers or fall back to DOM
                const humidityValue = window.lastHumidityValue || humidityElement?.value || '';
                const pressureValue = window.lastPressureValue || pressureElement?.value || '';
                const altitudeValue = window.lastAltitudeValue || altitudeElement?.value || '';
                
                console.log('Using stored values from input handlers:', {
                    storedHumidity: window.lastHumidityValue,
                    storedPressure: window.lastPressureValue,
                    storedAltitude: window.lastAltitudeValue,
                    finalHumidity: humidityValue,
                    finalPressure: pressureValue,
                    finalAltitude: altitudeValue
                });
                
                const darkMode = document.getElementById('darkModeToggle').checked;
                const distanceUnit = document.getElementById('defaultDistanceUnit').value;
                const velocityUnit = document.getElementById('defaultVelocityUnit').value;
                const temperatureValue = document.getElementById('defaultTemperature').value;
                const temperature = temperatureValue ? parseFloat(temperatureValue) : null;
                const temperatureUnit = document.getElementById('defaultTemperatureUnit').value;
                
                console.log('DOM elements debug:', {
                    humidityElement: humidityElement,
                    humidityElementValue: humidityElement?.value,
                    pressureElement: pressureElement,
                    pressureElementValue: pressureElement?.value,
                    altitudeElement: altitudeElement,
                    altitudeElementValue: altitudeElement?.value
                });
                
                // Use the captured values instead of re-reading from DOM
                const humidity = humidityValue !== '' ? parseFloat(humidityValue) : null;
                const pressure = pressureValue !== '' ? parseFloat(pressureValue) : null;
                const altitude = altitudeValue !== '' ? parseFloat(altitudeValue) : null;
                const pressureUnit = document.getElementById('defaultPressureUnit').value;
                
                console.log('Form field debug:', {
                    humidityValue, humidityParsed: humidity,
                    pressureValue, pressureParsed: pressure,
                    altitudeValue, altitudeParsed: altitude
                });
                const altitudeReference = document.getElementById('defaultAltitudeReference').value;
                
                console.log('Environmental values:', {
                    temperature, temperatureUnit,
                    humidity,
                    pressure, pressureUnit,
                    altitude, altitudeReference
                });
                
                // Map the form values to the existing database schema
                const theme = darkMode ? 'dark' : 'light';
                const defaultUnits = (distanceUnit === 'meters' || velocityUnit === 'mps') ? 'metric' : 'imperial';
                
                console.log('Preferences data to save:', {
                    user_id: window.currentUser.id,
                    theme: theme,
                    default_units: defaultUnits,
                    darkMode,
                    distanceUnit,
                    velocityUnit
                });
                
                const { data, error } = await window.supabaseClient
                    .from('user_preferences')
                    .upsert({
                        user_id: window.currentUser.id,
                        theme: theme,
                        default_units: defaultUnits,
                        default_velocity_unit: velocityUnit,
                        default_temperature: temperature,
                        default_temperature_unit: temperatureUnit,
                        default_humidity: humidity,
                        default_pressure: pressure,
                        default_pressure_unit: pressureUnit,
                        default_altitude: altitude,
                        default_altitude_reference: altitudeReference,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                
                console.log('Save preferences result:', { data, error });
                
                if (error) {
                    console.error('Error saving preferences:', error);
                    alert('Error saving preferences: ' + error.message);
                    return;
                }
                
                alert('Preferences saved successfully!');
                
                // Reset the editing flag after successful save
                window.userEditingPreferences = false;
                
            } catch (error) {
                console.error('Error saving preferences:', error);
                alert('Error saving preferences. Please try again.');
            }
        };

        window.shareLibraries = async function() {
            try {
                if (!window.currentUser) {
                    alert('Please log in to share libraries.');
                    return;
                }
                
                const email = document.getElementById('shareEmail').value.trim();
                if (!email) {
                    alert('Please enter an email address.');
                    return;
                }
                
                const shareData = {
                    owner_id: window.currentUser.id,
                    shared_with_email: email,
                    shared_from_email: window.currentUser.email,
                    share_type: 'both',
                    permissions: 'view'
                };
                
                const { error } = await window.supabaseClient
                    .from('library_shares')
                    .insert(shareData);
                
                if (error) {
                    console.error('Error sharing libraries:', error);
                    alert('Error sharing libraries: ' + error.message);
                    return;
                }
                
                alert(`Libraries shared with ${email} successfully!`);
                document.getElementById('shareEmail').value = '';
                loadSharingData();
                
            } catch (error) {
                console.error('Error sharing libraries:', error);
                alert('Error sharing libraries. Please try again.');
            }
        };

        window.loadSharingData = async function() {
            try {
                if (!window.currentUser) return;
                
                // Load users I'm sharing with
                const { data: sharedWith, error: sharedWithError } = await window.supabaseClient
                    .from('library_shares')
                    .select('*')
                    .eq('owner_id', window.currentUser.id);
                
                // Load libraries shared with me
                const { data: sharedFrom, error: sharedFromError } = await window.supabaseClient
                    .from('library_shares')
                    .select('*')
                    .eq('shared_with_user_id', window.currentUser.id);
                
                const sharedWithList = document.getElementById('sharedWithList');
                const sharedFromList = document.getElementById('sharedFromList');
                
                if (sharedWithList) {
                    if (sharedWith && sharedWith.length > 0) {
                        sharedWithList.innerHTML = sharedWith.map(share => 
                            `<div style="margin-bottom: 10px; padding: 10px; background-color: white; border-radius: 4px;">
                                Email: ${share.shared_with_email}
                                <br>Type: ${share.share_type} | Status: ${share.status}
                                <button onclick="removeShare('${share.id}')" style="background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; float: right;">Remove</button>
                            </div>`
                        ).join('');
                    } else {
                        sharedWithList.innerHTML = 'No libraries currently shared.';
                    }
                }
                
                if (sharedFromList) {
                    if (sharedFrom && sharedFrom.length > 0) {
                        sharedFromList.innerHTML = sharedFrom.map(share => 
                            `<div style="margin-bottom: 10px; padding: 10px; background-color: white; border-radius: 4px;">
                                Owner: ${share.shared_from_email || 'Unknown user'}
                                <br>Type: ${share.share_type} | Status: ${share.status}
                            </div>`
                        ).join('');
                    } else {
                        sharedFromList.innerHTML = 'No libraries shared with you.';
                    }
                }
                
            } catch (error) {
                console.error('Error loading sharing data:', error);
            }
        };

        window.removeShare = async function(shareId) {
            try {
                const { error } = await window.supabaseClient
                    .from('library_shares')
                    .delete()
                    .eq('id', shareId);
                
                if (error) {
                    console.error('Error removing share:', error);
                    alert('Error removing share: ' + error.message);
                    return;
                }
                
                alert('Share removed successfully!');
                loadSharingData();
                
            } catch (error) {
                console.error('Error removing share:', error);
                alert('Error removing share. Please try again.');
            }
        };

        // Function to check and accept pending shares for current user
        window.checkAndAcceptPendingShares = async function() {
            try {
                if (!window.currentUser || !window.currentUser.email) return;
                
                // Find pending shares for this user's email
                const { data: pendingShares, error } = await window.supabaseClient
                    .from('library_shares')
                    .select('*')
                    .eq('shared_with_email', window.currentUser.email)
                    .eq('status', 'pending');
                
                if (error) {
                    console.error('Error checking pending shares:', error);
                    return;
                }
                
                if (pendingShares && pendingShares.length > 0) {
                    // Update pending shares to accepted and add user ID
                    const { error: updateError } = await window.supabaseClient
                        .from('library_shares')
                        .update({
                            shared_with_user_id: window.currentUser.id,
                            status: 'accepted',
                            accepted_at: new Date().toISOString()
                        })
                        .eq('shared_with_email', window.currentUser.email)
                        .eq('status', 'pending');
                    
                    if (updateError) {
                        console.error('Error accepting pending shares:', updateError);
                    } else {
                        console.log(`Accepted ${pendingShares.length} pending shares for ${window.currentUser.email}`);
                    }
                }
                
            } catch (error) {
                console.error('Error in checkAndAcceptPendingShares:', error);
            }
        };

        window.changeTheme = function() {
            const theme = document.getElementById('themeSelect').value;
            localStorage.setItem('ballistic_theme', theme);
            applyTheme(theme);
        };

        window.applyTheme = function(theme) {
            const body = document.body;
            
            if (theme === 'dark') {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                // Add more dark theme styles as needed
            } else if (theme === 'auto') {
                // Check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
                return;
            } else {
                // Light theme (default)
                body.style.backgroundColor = '#f5f5f5';
                body.style.color = '#333';
            }
        };

        // Removed conflicting localStorage-only savePreferences function
        // The database version is defined earlier in the file

        window.sendLibraryInvite = async function() {
            const email = document.getElementById('inviteEmail').value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            try {
                // For now, we'll create a simple sharing record
                // In a full implementation, you'd want to send an actual email invitation
                const { data, error } = await window.supabaseClient
                    .from('library_shares')
                    .insert([{
                        owner_id: window.currentUser.id,
                        shared_with_email: email,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('Error creating share:', error);
                    alert('Error sending invitation. Please try again.');
                    return;
                }
                
                document.getElementById('inviteEmail').value = '';
                alert('Invitation sent successfully!');
                loadSharingData();
                
            } catch (error) {
                console.error('Error sending invite:', error);
                alert('Error sending invitation. Please try again.');
            }
        };

        window.loadSharingData = async function() {
            try {
                // Load active shares (who you've shared with)
                const { data: shares, error: sharesError } = await window.supabaseClient
                    .from('library_shares')
                    .select('*')
                    .eq('owner_id', window.currentUser.id);
                
                if (sharesError) {
                    console.error('Error loading shares:', sharesError);
                    return;
                }
                
                // Load libraries shared with you
                const { data: sharedWithMe, error: sharedError } = await window.supabaseClient
                    .from('library_shares')
                    .select('*')
                    .eq('shared_with_email', window.currentUser.email);
                
                if (sharedError) {
                    console.error('Error loading shared libraries:', sharedError);
                    return;
                }
                
                // Update UI
                updateActiveShares(shares || []);
                updateSharedWithYou(sharedWithMe || []);
                
            } catch (error) {
                console.error('Error loading sharing data:', error);
            }
        };

        window.updateActiveShares = function(shares) {
            const container = document.getElementById('activeShares');
            
            if (shares.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No active shares. Invite users above to start sharing.</div>';
                return;
            }
            
            const sharesHTML = shares.map(share => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;">
                    <div>
                        <strong>${share.shared_with_email}</strong><br>
                        <small style="color: #666;">Shared on ${new Date(share.created_at).toLocaleDateString()}</small>
                    </div>
                    <button onclick="revokeShare('${share.id}')" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Revoke</button>
                </div>
            `).join('');
            
            container.innerHTML = sharesHTML;
        };

        window.updateSharedWithYou = function(shared) {
            const container = document.getElementById('sharedWithYou');
            
            if (shared.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No libraries shared with you yet.</div>';
                return;
            }
            
            const sharedHTML = shared.map(share => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;">
                    <div>
                        <strong>Library from ${share.owner_email || 'User'}</strong><br>
                        <small style="color: #666;">Shared on ${new Date(share.created_at).toLocaleDateString()}</small>
                    </div>
                    <button onclick="viewSharedLibrary('${share.id}')" style="background: #007BFF; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">View</button>
                </div>
            `).join('');
            
            container.innerHTML = sharedHTML;
        };

        window.revokeShare = async function(shareId) {
            if (!confirm('Are you sure you want to revoke this share?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('library_shares')
                    .delete()
                    .eq('id', shareId)
                    .eq('owner_id', currentUser.id);
                
                if (error) {
                    alert('Error revoking share. Please try again.');
                    return;
                }
                
                loadSharingData();
                
            } catch (error) {
                console.error('Error revoking share:', error);
                alert('Error revoking share. Please try again.');
            }
        };

        window.viewSharedLibrary = function(shareId) {
            alert('Shared library viewing feature will be implemented next. This will allow you to browse and copy items from shared libraries.');
        };

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('ballistic_theme') || 'light';
            applyTheme(savedTheme);
        });

        // Temporarily disable Service Worker to fix caching issues
        // Will re-enable after filter functionality is working
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js?v=4')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                        registration.update();
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        */

        // Bullet Library Functions - Global scope for button access (using the first definition above)

        window.hideBulletLibrary = function() {
            document.getElementById('bulletLibrarySection').style.display = 'none';
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.showAddBulletForm = function() {
            document.getElementById('addBulletForm').style.display = 'block';
            document.getElementById('bullet_manufacturer').value = '';
            document.getElementById('bullet_caliber').value = '';
            document.getElementById('bullet_grain').value = '';
            document.getElementById('bullet_bc').value = '';
            document.getElementById('bullet_drag_model').value = '';
            document.getElementById('bullet_type').value = '';
        };

        window.cancelAddBullet = function() {
            document.getElementById('addBulletForm').style.display = 'none';
        };

        window.saveBullet = async function() {
            const manufacturer = document.getElementById('bullet_manufacturer').value.trim();
            const caliber = document.getElementById('bullet_caliber').value.trim();
            const grain = parseInt(document.getElementById('bullet_grain').value);
            const bc = parseFloat(document.getElementById('bullet_bc').value);
            const dragModel = document.getElementById('bullet_drag_model').value;
            const bulletType = document.getElementById('bullet_type').value;

            if (!manufacturer || !caliber || !grain || !bc || !dragModel || !bulletType) {
                alert('Please fill in all fields');
                return;
            }

            if (bc < 0.1 || bc > 1.0) {
                alert('Ballistic coefficient must be between 0.1 and 1.0');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .insert([{
                        user_id: currentUser.id,
                        manufacturer_name: manufacturer,
                        caliber: caliber,
                        grain: grain,
                        ballistic_coefficient: bc,
                        drag_model: dragModel,
                        bullet_type: bulletType
                    }]);

                if (error) {
                    console.error('Error saving bullet:', error);
                    alert('Error saving bullet. Please try again.');
                } else {
                    console.log('Bullet saved successfully');
                    document.getElementById('addBulletForm').style.display = 'none';
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error saving bullet. Please try again.');
            }
        };

        window.loadBulletLibrary = async function() {
            try {
                const { data, error } = await supabase
                    .from('bullet_library')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('manufacturer_name', { ascending: true });

                if (error) {
                    console.error('Error loading bullets:', error);
                    return;
                }

                const tableBody = document.getElementById('bulletTableBody');
                const table = document.getElementById('bulletTable');
                const noMessage = document.getElementById('noBulletsMessage');

                if (data && data.length > 0) {
                    table.style.display = 'table';
                    noMessage.style.display = 'none';
                    
                    tableBody.innerHTML = '';
                    data.forEach(bullet => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${bullet.manufacturer_name}</td>
                            <td>${bullet.caliber}</td>
                            <td>${bullet.grain}</td>
                            <td>${bullet.ballistic_coefficient}</td>
                            <td>${bullet.drag_model}</td>
                            <td>${bullet.bullet_type}</td>
                            <td>
                                <button onclick="deleteBullet(${bullet.id})" class="back-to-login" style="padding: 4px 8px; margin: 2px;">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    table.style.display = 'none';
                    noMessage.style.display = 'block';
                }
            } catch (e) {
                console.error('Error loading bullet library:', e);
            }
        };

        window.deleteBullet = async function(bulletId) {
            if (!confirm('Are you sure you want to delete this bullet?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('bullet_library')
                    .delete()
                    .eq('id', bulletId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error deleting bullet:', error);
                    alert('Error deleting bullet. Please try again.');
                } else {
                    await loadBulletLibrary();
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Error deleting bullet. Please try again.');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.warn('Starting Ballistic Calculator script execution');

            if (!window.supabase) {
                console.error('Supabase client not loaded');
                document.getElementById('authMessage').innerHTML = '<div class="error">Error: Supabase client failed to load. Please check your network or CDN.</div>';
                return;
            }

            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnaXFvamNvaG92b2d1d3hsZWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMjkzMjEsImV4cCI6MjA2MjkwNTMyMX0.a8XUU4QuxHIS5oUpSyvx0EyxtmwFXOxnH9Mq-5bzGck';
            const supabase = window.supabase.createClient(
                'https://pgiqojcohovoguwxleij.supabase.co',
                supabaseKey
            );
            
            // Make supabase globally accessible for all functions
            window.supabaseClient = supabase;
            window.supabase = supabase;

            let editSessionId = null;
            let currentUser = null;

            // Check user session on load
            async function checkSession() {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    window.currentUser = session.user; // Ensure global access
                    
                    // Track user login for admin visibility
                    await trackUserLogin(session.user);
                    
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    
                    // Check admin access immediately and also after a delay
                    checkAdminAccess(); // Show admin panel button if user is admin
                    setTimeout(() => {
                        checkAdminAccess(); // Double-check to ensure button appears
                    }, 1000);
                } else {
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('appContent').style.display = 'none';
                }
                
                // Check if user came from password reset email
                checkPasswordResetURL();
            }

            // Check if URL contains password reset parameters
            async function checkPasswordResetURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const hashFragment = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hashFragment);
                const isReset = urlParams.get('reset');
                const token = urlParams.get('access_token') || hashParams.get('access_token');
                const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
                const type = urlParams.get('type') || hashParams.get('type');
                const pathname = window.location.pathname;
                
                console.log('Hash parsing debug:', {
                    rawHash: window.location.hash,
                    hashFragment: hashFragment,
                    hashToken: hashParams.get('access_token'),
                    hashRefresh: hashParams.get('refresh_token'),
                    hashType: hashParams.get('type')
                });
                
                console.log('URL check:', { 
                    pathname, 
                    isReset, 
                    token: token ? 'FOUND' : null, 
                    refreshToken: refreshToken ? 'FOUND' : null, 
                    type, 
                    hashFragment: window.location.hash,
                    fullURL: window.location.href 
                });
                
                if (isReset === 'true' || token || type === 'recovery' || pathname === '/password-reset') {
                    console.log('Password reset detected - waiting for Supabase to process tokens');
                    
                    // Wait a moment for Supabase to process the authentication tokens
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check if Supabase has automatically established a session after processing the tokens
                    const { data: { session } } = await supabase.auth.getSession();
                    console.log('Session check result after delay:', session ? 'SESSION FOUND' : 'NO SESSION');
                    
                    if (session && session.user) {
                        console.log('Found active session for password reset - user can update password');
                        // Don't log out - user is authenticated and can update password
                        currentUser = session.user;
                        
                        // Show login form with password reset form
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('appContent').style.display = 'none';
                        showNewPasswordForm();
                        document.getElementById('authMessage').innerHTML = '<div class="message">Please enter your new password below.</div>';
                    } else {
                        console.log('No active session - showing email form');
                        // Log out current user and show email form
                        await supabase.auth.signOut();
                        currentUser = null;
                        
                        // Show login form and email reset form
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('appContent').style.display = 'none';
                        showResetPasswordForm();
                        document.getElementById('authMessage').innerHTML = '<div class="message">Please enter your email address below to reset your password.</div>';
                    }
                }
            }

            // Handle password reset token from URL
            async function handlePasswordResetToken(token) {
                console.log('Handling password reset token:', token);
                try {
                    // For Supabase, the token handling is often automatic
                    // Let's check if we're already authenticated after the redirect
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session && session.user) {
                        console.log('User session found after reset redirect:', session.user);
                        document.getElementById('authMessage').innerHTML = `<div class="message">Reset link verified! Please enter your new password below.</div>`;
                    } else {
                        // Try to exchange the token
                        const { data, error } = await supabase.auth.getUser(token);
                        
                        if (error) {
                            console.error('Token verification error:', error);
                            document.getElementById('authMessage').innerHTML = `<div class="error">Invalid or expired reset link. Please request a new password reset.</div>`;
                        } else {
                            console.log('Token verified successfully:', data);
                            document.getElementById('authMessage').innerHTML = `<div class="message">Reset link verified! Please enter your new password below.</div>`;
                        }
                    }
                } catch (e) {
                    console.error('Token handling error:', e);
                    document.getElementById('authMessage').innerHTML = `<div class="error">Error processing reset link. Please try again.</div>`;
                }
            }

            // Handle login
            window.login = async function() {
                const email = document.getElementById('login_email').value;
                const password = document.getElementById('login_password').value;
                const authMessage = document.getElementById('authMessage');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    authMessage.innerHTML = `<div class="error">Login failed: ${error.message}</div>`;
                    return;
                }

                currentUser = data.user;
                window.currentUser = data.user; // Ensure global access
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                authMessage.innerHTML = '';
                
                // Check if user is admin and show admin button
                checkAdminAccess();
            };

            // Handle sign-up
            window.signup = async function() {
                const email = document.getElementById('login_email').value.trim();
                const password = document.getElementById('login_password').value.trim();
                const authMessage = document.getElementById('authMessage');

                // Validate email and password before attempting sign-up
                if (!email || !password) {
                    authMessage.innerHTML = '<div class="error">Please enter an Email Address and Password, then click the Sign Up button. A confirmation email will be sent to the email address provided.</div>';
                    return;
                }

                console.log('Attempting to sign up with email:', email);
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });

                console.log('Sign-up response:', { data, error });

                if (error) {
                    console.log('Sign-up error:', error);
                    if (error.message.toLowerCase().includes('already registered') || error.message.toLowerCase().includes('user already exists')) {
                        authMessage.innerHTML = '<div class="error">This email is already registered. Please log in or use a different email.</div>';
                    } else {
                        authMessage.innerHTML = `<div class="error">Sign-up failed: ${error.message}</div>`;
                    }
                    return;
                }

                // Check if the user already exists by examining the response
                if (data.user) {
                    // If the user has a last_sign_in_at, they are an existing user
                    if (data.user.last_sign_in_at) {
                        console.log('Existing user detected (last_sign_in_at exists):', data.user);
                        authMessage.innerHTML = '<div class="error">This email is already registered. Please log in or use a different email.</div>';
                        return;
                    }
                    // Check identities array; if empty or indicates existing user, they are already registered
                    if (!data.user.identities || data.user.identities.length === 0) {
                        console.log('Existing user detected (no new identities):', data.user);
                        authMessage.innerHTML = '<div class="error">This email is already registered. Please log in or use a different email.</div>';
                        return;
                    }
                }

                // If we reach here, the sign-up is successful
                authMessage.innerHTML = '<div class="message">Sign-up successful! A confirmation email has been sent to your email address. Please confirm your email, then log in.</div>';
                document.getElementById('login_email').value = '';
                document.getElementById('login_password').value = '';
            };

            // Show the reset password form
            window.showResetPasswordForm = function() {
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'block';
                document.getElementById('newPasswordForm').style.display = 'none';
                document.querySelector('.forgot-password').style.display = 'none';
                
                // Only clear the message if not coming from password reset email
                const urlParams = new URLSearchParams(window.location.search);
                const isReset = urlParams.get('reset');
                if (isReset !== 'true') {
                    document.getElementById('authMessage').innerHTML = '';
                }
            };

            // Show the new password form
            window.showNewPasswordForm = function() {
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'none';
                document.getElementById('newPasswordForm').style.display = 'block';
                document.querySelector('.forgot-password').style.display = 'none';
            };

            // Handle password update
            window.updatePassword = async function() {
                const newPassword = document.getElementById('new_password').value.trim();
                const confirmPassword = document.getElementById('confirm_password').value.trim();
                const authMessage = document.getElementById('authMessage');

                if (!newPassword || !confirmPassword) {
                    authMessage.innerHTML = '<div class="error">Please enter both password fields.</div>';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    authMessage.innerHTML = '<div class="error">Passwords do not match.</div>';
                    return;
                }

                if (newPassword.length < 6) {
                    authMessage.innerHTML = '<div class="error">Password must be at least 6 characters long.</div>';
                    return;
                }

                try {
                    const { data, error } = await supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (error) {
                        authMessage.innerHTML = `<div class="error">Failed to update password: ${error.message}</div>`;
                        return;
                    }

                    authMessage.innerHTML = '<div class="message">Password updated successfully! You can now log in with your new password.</div>';
                    
                    // Clear form and show login
                    document.getElementById('new_password').value = '';
                    document.getElementById('confirm_password').value = '';
                    
                    setTimeout(() => {
                        showLoginForm();
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 2000);
                    
                } catch (e) {
                    authMessage.innerHTML = '<div class="error">An error occurred while updating your password. Please try again.</div>';
                }
            };

            // Show the login form
            window.showLoginForm = function() {
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('resetPasswordForm').style.display = 'none';
                document.getElementById('authMessage').innerHTML = '';
                document.querySelector('.forgot-password').style.display = 'block';
                document.getElementById('reset_email').value = '';
            };

            // Handle password reset
window.resetPassword = async function() {
        const email = document.getElementById('reset_email').value.trim();
        const authMessage = document.getElementById('authMessage');

        if (!email) {
            authMessage.innerHTML = '<div class="error">Please enter your email address to reset your password.</div>';
            return;
        }

        console.log('Attempting to reset password for email:', email);
        const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: 'https://realballistics.com/?reset=true'
        });

        console.log('Password reset response:', { data, error });

        if (error) {
            console.log('Password reset error:', error);
            authMessage.innerHTML = `<div class="error">Failed to send password reset email: ${error.message}</div>`;
            return;
        }

        authMessage.innerHTML = '<div class="message">A password reset link has been sent to your email address. Please check your inbox (and spam/junk folder) to reset your password.</div>';
        document.getElementById('reset_email').value = '';
    };

            // Handle logout
            window.logout = async function() {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    document.getElementById('authMessage').innerHTML = `<div class="error">Logout failed: ${error.message}</div>`;
                    return;
                }

                currentUser = null;
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('authMessage').innerHTML = '<div class="message">Logged out successfully.</div>';
                document.getElementById('login_email').value = '';
                document.getElementById('login_password').value = '';
            };

            // Initialize session check
            checkSession();

            function adjustMuzzleVelocity(caliber, barrelLength, muzzleVelocity) {
                if (!barrelLength || isNaN(barrelLength) || !muzzleVelocity || isNaN(muzzleVelocity)) {
                    return muzzleVelocity;
                }
                let standardLength, fpsPerInch;
                if (caliber && (caliber.toLowerCase().includes('5.56') || caliber.toLowerCase().includes('.223'))) {
                    standardLength = 20;
                    fpsPerInch = 27.5; // Average of 25-30 fps per inch
                } else if (caliber && caliber.toLowerCase().includes('9mm')) {
                    standardLength = 4;
                    fpsPerInch = 30;
                } else {
                    standardLength = 20; // Default to 20" baseline for rifle cartridges
                    fpsPerInch = 27.5; // Use same average for other rifle cartridges
                }
                const lengthDifference = barrelLength - standardLength;
                const velocityAdjustment = lengthDifference * fpsPerInch;
                return Math.max(muzzleVelocity + velocityAdjustment, 0);
            }

            window.toggleForm = function() {
                const form = document.getElementById('ballisticForm');
                const addButton = document.querySelector('.add-session');
                if (form.style.display === 'none' || form.style.display === '') {
                    form.style.display = 'block';
                    addButton.textContent = 'Hide Form';
                    loadBulletLibraryDropdown(); // Load bullet library options when form opens
                } else {
                    form.style.display = 'none';
                    addButton.textContent = 'Add New';
                    cancelEditWithoutToggle();
                }
            };

            window.toggleFilters = function() {
                console.log('toggleFilters called');
                const filterSection = document.getElementById('filterSection');
                const toggleButton = document.querySelector('.toggle-filter');
                
                console.log('Filter elements found:', { filterSection: !!filterSection, toggleButton: !!toggleButton });
                
                if (!filterSection || !toggleButton) {
                    console.error('Filter elements not found');
                    return;
                }
                
                filterSection.classList.toggle('active');
                toggleButton.textContent = filterSection.classList.contains('active') ? 'Hide Filters' : 'Show Filters';
                console.log('Filter toggled, active:', filterSection.classList.contains('active'));
            };

            // Load bullet library entries into dropdown
            window.loadBulletLibraryDropdown = async function() {
                const select = document.getElementById('bulletLibrarySelect');
                if (!select || !currentUser) return;

                try {
                    // Check and accept pending shares first
                    await checkAndAcceptPendingShares();
                    
                    // Load user's own bullets
                    const { data: ownBullets, error: ownError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (ownError) {
                        console.error('Error loading own bullet library:', ownError);
                        return;
                    }

                    // Load shared bullets from accepted shares
                    const { data: acceptedShares, error: shareError } = await supabase
                        .from('library_shares')
                        .select('owner_id, share_type')
                        .eq('shared_with_user_id', currentUser.id)
                        .eq('status', 'accepted')
                        .in('share_type', ['bullets', 'both']);

                    let sharedBullets = [];
                    if (acceptedShares && acceptedShares.length > 0) {
                        const ownerIds = acceptedShares.map(share => share.owner_id);
                        
                        const { data: bullets, error: bulletsError } = await supabase
                            .from('bullet_library')
                            .select('*, owner_email:user_id')
                            .in('user_id', ownerIds)
                            .order('manufacturer_name', { ascending: true });

                        if (!bulletsError && bullets) {
                            sharedBullets = bullets;
                        }
                    }

                    // Clear existing options except the default
                    select.innerHTML = '<option value="">Select a saved bullet (optional)</option>';

                    // Add user's own bullets
                    if (ownBullets && ownBullets.length > 0) {
                        const ownGroup = document.createElement('optgroup');
                        ownGroup.label = 'My Bullets';
                        
                        ownBullets.forEach(bullet => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(bullet);
                            option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr ${bullet.bullet_type} (BC: ${bullet.ballistic_coefficient})`;
                            ownGroup.appendChild(option);
                        });
                        
                        select.appendChild(ownGroup);
                    }

                    // Add shared bullets
                    if (sharedBullets && sharedBullets.length > 0) {
                        const sharedGroup = document.createElement('optgroup');
                        sharedGroup.label = 'Shared Bullets';
                        
                        sharedBullets.forEach(bullet => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(bullet);
                            option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr ${bullet.bullet_type} (BC: ${bullet.ballistic_coefficient}) [Shared]`;
                            sharedGroup.appendChild(option);
                        });
                        
                        select.appendChild(sharedGroup);
                    }

                } catch (error) {
                    console.error('Error loading bullet library dropdown:', error);
                }
            };

            // Load selected bullet data into form
            window.loadBulletData = function() {
                const select = document.getElementById('bulletLibrarySelect');
                const form = document.getElementById('ballisticForm');
                
                if (!select.value || !form) return;

                try {
                    const bulletData = JSON.parse(select.value);
                    
                    // Populate only the specified fields from bullet library
                    form.caliber.value = bulletData.caliber || '';
                    form.bullet_grain.value = bulletData.grain || '';
                    form.muzzle_velocity.value = bulletData.muzzle_velocity || '';
                    form.muzzle_energy.value = bulletData.muzzle_energy || '';
                    form.ballistic_coefficient.value = bulletData.ballistic_coefficient || '';
                    form.drag_model.value = bulletData.drag_model || '';
                    
                    console.log('Loaded bullet data:', bulletData.manufacturer_name, bulletData.caliber, bulletData.grain + 'gr');
                } catch (error) {
                    console.error('Error loading bullet data:', error);
                }
            };

            function cancelEditWithoutToggle() {
                console.log('Canceling edit without toggling form');
                const form = document.getElementById('ballisticForm');
                form.reset();
                editSessionId = null;
                document.getElementById('cancelEditButton').style.display = 'none';
                document.getElementById('message').innerHTML = '';
            }

            function formatHold(hold) {
                const holdValue = parseFloat(hold);
                if (holdValue >= 0) {
                    return `+${holdValue.toFixed(2)}`;
                } else {
                    return holdValue.toFixed(2);
                }
            }

            function calculateMOA(holdInInches, distanceYards) {
                if (distanceYards === 0) return '0.00'; // Avoid division by zero at 0 yards
                const moa = holdInInches / (distanceYards * 1.047 / 100);
                return moa >= 0 ? `+${moa.toFixed(2)}` : moa.toFixed(2);
            }

            const workerScript = `
                self.onmessage = function(e) {
                    const { inputs } = e.data;

                    const GRAVITY = 32.174; // ft/s²
                    const STD_AIR_DENSITY = 0.0765; // lb/ft³ at sea level, 59°F
                    const DT = 0.001;

                    const bulletMass = inputs.bullet_grain / 7000; // Convert grains to pounds
                    
                    function getBulletDiameter(caliber, bulletCaliber) {
                        // Return bullet diameter in inches based on caliber
                        const caliberStr = (caliber || bulletCaliber || '').toLowerCase();
                        
                        // Common caliber diameters in inches
                        if (caliberStr.includes('5.56') || caliberStr.includes('223')) return 0.224;
                        if (caliberStr.includes('7.62') || caliberStr.includes('308')) return 0.308;
                        if (caliberStr.includes('6.5') && caliberStr.includes('creedmoor')) return 0.264;
                        if (caliberStr.includes('270')) return 0.277;
                        if (caliberStr.includes('30-06') || caliberStr.includes('3006')) return 0.308;
                        if (caliberStr.includes('300') && caliberStr.includes('win')) return 0.308;
                        if (caliberStr.includes('243')) return 0.243;
                        if (caliberStr.includes('6mm')) return 0.243;
                        if (caliberStr.includes('22-250')) return 0.224;
                        if (caliberStr.includes('204')) return 0.204;
                        if (caliberStr.includes('17')) return 0.172;
                        if (caliberStr.includes('50') && caliberStr.includes('bmg')) return 0.510;
                        if (caliberStr.includes('338')) return 0.338;
                        if (caliberStr.includes('375')) return 0.375;
                        if (caliberStr.includes('458')) return 0.458;
                        if (caliberStr.includes('416')) return 0.416;
                        if (caliberStr.includes('45-70')) return 0.458;
                        if (caliberStr.includes('30-30')) return 0.308;
                        if (caliberStr.includes('357')) return 0.357;
                        if (caliberStr.includes('44')) return 0.429;
                        if (caliberStr.includes('40')) return 0.400;
                        if (caliberStr.includes('38')) return 0.357;
                        if (caliberStr.includes('9mm')) return 0.355;
                        if (caliberStr.includes('45') && caliberStr.includes('acp')) return 0.451;
                        if (caliberStr.includes('380')) return 0.355;
                        
                        // Default fallback - estimate from caliber number
                        const numMatch = caliberStr.match(/(\\d+(?:\\.\\d+)?)/);
                        if (numMatch) {
                            const num = parseFloat(numMatch[1]);
                            if (num > 50) return num / 1000; // Assume caliber in thousandths (e.g., 223 = 0.223)
                            return num / 25.4; // Assume metric mm, convert to inches
                        }
                        
                        return 0.308; // Default to .30 caliber if unknown
                    }
                    
                    // Use pre-adjusted muzzle velocity (main function already applied barrel length adjustment)
                    let muzzleVelocity = inputs.muzzle_velocity;
                    self.postMessage({ log: 'Using muzzle velocity: ' + muzzleVelocity + ' fps (already adjusted for ' + inputs.barrel_length + '" barrel)' });
                    const zeroDistance = inputs.zero_distance * 3; // Convert yards to feet
                    const heightOverBore = inputs.height_over_bore / 12; // Convert inches to feet
                    const stepIntervalFeet = inputs.step_interval_yards * 3;
                    // Ensure trajectory runs far enough for zeroing calculation
                    const requiredDistance = Math.max(inputs.zero_distance * 3, inputs.max_distance_yards * 3, 1200);
                    const maxDistanceFeet = requiredDistance;
                    self.postMessage({ log: 'Trajectory will simulate to: ' + maxDistanceFeet + ' feet (required for ' + inputs.zero_distance + ' yard zero)' });
                    
                    // Extract twist rate for spin drift calculations
                    let twistRateValue = 7; // Default for 5.56/.223
                    if (inputs.barrel_twist_rate) {
                        const extracted = parseFloat(inputs.barrel_twist_rate.replace(/[^\d.]/g, ''));
                        twistRateValue = extracted || 7;
                    }
                    
                    // Wind components
                    const windSpeed = inputs.wind_speed || 0; // mph
                    const windAngle = (inputs.wind_angle || 0) * Math.PI / 180; // Convert to radians

                    const targetDistances = Array.from(
                        { length: Math.floor(inputs.max_distance_yards / inputs.step_interval_yards) + 1 },
                        (_, i) => i * stepIntervalFeet
                    );



                    // Professional G1 drag coefficient table (Mach vs Cd)
                    function getG1DragCoefficient(mach) {
                        if (mach >= 4.0) return 0.1198;
                        if (mach >= 3.0) return 0.1629;
                        if (mach >= 2.5) return 0.1659;
                        if (mach >= 2.0) return 0.1629;
                        if (mach >= 1.8) return 0.1659;
                        if (mach >= 1.5) return 0.2031;
                        if (mach >= 1.2) return 0.2597;
                        if (mach >= 1.0) return 0.3010;
                        if (mach >= 0.9) return 0.3287;
                        if (mach >= 0.8) return 0.3629;
                        return 0.4068;
                    }

                    // Professional G7 drag coefficient table (Mach vs Cd)
                    function getG7DragCoefficient(mach) {
                        if (mach >= 4.0) return 0.1198;
                        if (mach >= 3.0) return 0.1270;
                        if (mach >= 2.5) return 0.1348;
                        if (mach >= 2.0) return 0.1431;
                        if (mach >= 1.5) return 0.1618;
                        if (mach >= 1.2) return 0.1825;
                        if (mach >= 1.0) return 0.2066;
                        if (mach >= 0.9) return 0.2365;
                        if (mach >= 0.8) return 0.2748;
                        return 0.3238;
                    }

                    function computeDerivatives(state) {
                        const [x, y, vx, vy] = state;
                        const speed = Math.sqrt(vx * vx + vy * vy) || 0.0001;
                        
                        // Check for invalid ballistic coefficient
                        if (!inputs.ballistic_coefficient || inputs.ballistic_coefficient <= 0) {
                            self.postMessage({ log: 'Invalid BC=' + inputs.ballistic_coefficient });
                            return [vx, vy, 0, -GRAVITY, 0, speed]; // Fallback to gravity only
                        }
                        
                        // Wind effects (convert mph to ft/s)
                        const windVx = windSpeed * 1.467 * Math.cos(windAngle);
                        const windVy = windSpeed * 1.467 * Math.sin(windAngle);
                        const relativeVx = vx - windVx;
                        const relativeVy = vy - windVy;
                        const relativeSpeed = Math.sqrt(relativeVx * relativeVx + relativeVy * relativeVy) || 0.0001;
                        
                        // Professional ballistic drag calculation using proper Cd tables
                        const mach = relativeSpeed / 1116; // Speed of sound at sea level
                        const dragCoeff = inputs.drag_model === 'G7' ? getG7DragCoefficient(mach) : getG1DragCoefficient(mach);
                        
                        // Implement Grok's proven Pejsa model for accurate trajectory calculation
                        // V(x) = V0 * (1 + F*x/V0)^(-1/F) where F is retardation coefficient
                        
                        const F = 0.6; // Pejsa retardation coefficient for G1 drag model
                        const V0 = inputs.muzzle_velocity;
                        const distanceFeet = x;
                        
                        // Calculate expected velocity at this distance using Pejsa model
                        const expectedVelocity = V0 * Math.pow(1 + (F * distanceFeet / V0), -1/F);
                        
                        // Apply ballistic coefficient scaling to adjust retardation
                        // Higher BC = less retardation (bullet retains velocity better)
                        const bcAdjustedF = F * (0.248 / inputs.ballistic_coefficient); // Scale F based on BC
                        const actualExpectedVelocity = V0 * Math.pow(1 + (bcAdjustedF * distanceFeet / V0), -1/bcAdjustedF);
                        
                        // Calculate drag based on difference between current and expected velocity
                        const currentSpeed = Math.sqrt(vx*vx + vy*vy);
                        const velocityDifference = currentSpeed - actualExpectedVelocity;
                        
                        // Convert velocity difference to drag acceleration
                        const bulletMassLbs = inputs.bullet_grain / 7000;
                        const dragAcceleration = Math.abs(velocityDifference) * 50; // Reasonable drag scaling factor
                        
                        // Apply drag in velocity direction
                        const ax = -dragAcceleration * (relativeVx / relativeSpeed);
                        const ay = -GRAVITY - (dragAcceleration * (relativeVy / relativeSpeed));
                        
                        // Add spin drift effect from barrel twist rate
                        let spinDriftAccelX = 0;
                        if (twistRateValue && x > 300) {
                            const timeOfFlight = x / (vx || 1);
                            const spinDriftFactor = 0.000001;
                            const isRightHandTwist = !inputs.barrel_twist_rate || !inputs.barrel_twist_rate.toLowerCase().includes('left');
                            spinDriftAccelX = (isRightHandTwist ? 1 : -1) * spinDriftFactor * timeOfFlight / twistRateValue;
                        }
                        
                        // Debug logging for first calculation
                        if (x === 0) {
                            self.postMessage({ log: 'Pejsa model: F=' + F + ', BC=' + inputs.ballistic_coefficient + ', V0=' + V0 + ' fps, dragAccel=' + dragAcceleration.toFixed(2) });
                        }
                        
                        // Check for NaN in accelerations
                        if (isNaN(ax) || isNaN(ay)) {
                            self.postMessage({ log: 'NaN detected: ax=' + ax + ', ay=' + ay + ', dragAccel=' + dragAcceleration + ', BC=' + inputs.ballistic_coefficient });
                            return [vx, vy, 0, -GRAVITY, 0, speed]; // Fallback
                        }
                        
                        return [vx, vy, ax + spinDriftAccelX, ay, dragAcceleration, speed];
                    }

                    function rk4Step(state, dt) {
                        const k1 = computeDerivatives(state);
                        const k2 = computeDerivatives([
                            state[0] + 0.5 * dt * k1[0],
                            state[1] + 0.5 * dt * k1[1],
                            state[2] + 0.5 * dt * k1[2],
                            state[3] + 0.5 * dt * k1[3]
                        ]);
                        const k3 = computeDerivatives([
                            state[0] + 0.5 * dt * k2[0],
                            state[1] + 0.5 * dt * k2[1],
                            state[2] + 0.5 * dt * k2[2],
                            state[3] + 0.5 * dt * k2[3]
                        ]);
                        const k4 = computeDerivatives([
                            state[0] + dt * k3[0],
                            state[1] + dt * k3[1],
                            state[2] + dt * k3[2],
                            state[3] + dt * k3[3]
                        ]);

                        return [
                            state[0] + (dt / 6) * (k1[0] + 2 * k2[0] + 2 * k3[0] + k4[0]),
                            state[1] + (dt / 6) * (k1[1] + 2 * k2[1] + 2 * k3[1] + k4[1]),
                            state[2] + (dt / 6) * (k1[2] + 2 * k2[2] + 2 * k3[2] + k4[2]),
                            state[3] + (dt / 6) * (k1[3] + 2 * k2[3] + 2 * k3[3] + k4[3])
                        ];
                    }

                    function simulateTrajectory(initialAngle) {
                        let state = [0, -heightOverBore, muzzleVelocity * Math.cos(initialAngle), muzzleVelocity * Math.sin(initialAngle)];
                        let t = 0;
                        const trajectory = [];

                        // Debug initial conditions
                        self.postMessage({ log: 'Initial state: x=' + state[0] + ', y=' + state[1] + ', vx=' + state[2] + ', vy=' + state[3] });
                        self.postMessage({ log: 'Max distance: ' + maxDistanceFeet + ' ft, Height over bore: ' + heightOverBore + ' ft' });

                        let lastState = [...state, t];
                        trajectory.push({ x: state[0], y: state[1], v: Math.sqrt(state[2] * state[2] + state[3] * state[3]), t });

                        const keyDistances = [0, 75, 150];
                        let closestPoints = keyDistances.map(dist => ({ dist: dist, closestX: null, drag: null, speed: null, minDiff: Infinity }));

                        let iterations = 0;
                        while (state[0] <= maxDistanceFeet && iterations < 100000) {
                            const derivatives = computeDerivatives(state);
                            state = rk4Step(state, DT);
                            t += DT;
                            iterations++;

                            if (iterations === 1) {
                                self.postMessage({ log: 'First iteration - state after step: x=' + state[0] + ', y=' + state[1] + ', vx=' + state[2] + ', vy=' + state[3] });
                            }

                            if (state[0] - lastState[0] >= 0.001) {
                                const fraction = (state[0] - lastState[0]) / (state[0] - lastState[0] || 0.0001);
                                const interpX = state[0];
                                const interpY = lastState[1] + fraction * (state[1] - lastState[1]);
                                const interpVx = lastState[2] + fraction * (state[2] - lastState[2]);
                                const interpVy = lastState[3] + fraction * (state[3] - lastState[3]);
                                const interpT = lastState[4] + fraction * (t - lastState[4]);
                                const interpV = Math.sqrt(interpVx * interpVx + interpVy * interpVy);
                                trajectory.push({ x: interpX, y: interpY, v: interpV, t: interpT });

                                keyDistances.forEach((keyDist, index) => {
                                    const diff = Math.abs(interpX - keyDist);
                                    if (diff < closestPoints[index].minDiff) {
                                        closestPoints[index] = {
                                            dist: keyDist,
                                            closestX: interpX,
                                            drag: derivatives[4],
                                            speed: derivatives[5],
                                            minDiff: diff
                                        };
                                    }
                                });

                                targetDistances.forEach(target => {
                                    if (state[0] >= target && lastState[0] < target) {
                                        const fractionTarget = (target - lastState[0]) / (state[0] - lastState[0] || 0.0001);
                                        const interpYTarget = lastState[1] + fractionTarget * (state[1] - lastState[1]);
                                        const interpVxTarget = lastState[2] + fractionTarget * (state[2] - lastState[2]);
                                        const interpVyTarget = lastState[3] + fractionTarget * (state[3] - lastState[3]);
                                        const interpTTarget = lastState[4] + fractionTarget * (t - lastState[4]);
                                        const interpVTarget = Math.sqrt(interpVxTarget * interpVxTarget + interpVyTarget * interpVyTarget);
                                        trajectory.push({ x: target, y: interpYTarget, v: interpVTarget, t: interpTTarget });
                                    }
                                });

                                lastState = [...state, t];
                            }
                        }

                        self.postMessage({ log: 'Simulated trajectory points: ' + trajectory.length });
                        return { trajectory: trajectory.sort((a, b) => a.x - b.x), closestPoints };
                    }

                    function zeroTrajectory(inputs) {
                        const zeroDistance = inputs.zero_distance * 3; // Convert yards to feet
                        self.postMessage({ log: 'Starting professional zeroing for distance: ' + inputs.zero_distance + ' yards (' + zeroDistance + ' feet)' });
                        
                        // Use wider angle range to accommodate high drag scenarios
                        let angleLow = -0.02;   // About -1.15 degrees  
                        let angleHigh = 0.08;   // About +4.6 degrees (much more positive for high drag)
                        
                        // Test if we need to expand the search range
                        self.postMessage({ log: 'Testing initial angle bounds...' });
                        let trajectoryLow = simulateTrajectory(angleLow);
                        let yLow = trajectoryLow.trajectory.reduce((closest, point) => {
                            return Math.abs(point.x - zeroDistance) < Math.abs(closest.x - zeroDistance) ? point : closest;
                        }, trajectoryLow.trajectory[0]).y;
                        
                        let trajectoryHigh = simulateTrajectory(angleHigh);
                        let yHigh = trajectoryHigh.trajectory.reduce((closest, point) => {
                            return Math.abs(point.x - zeroDistance) < Math.abs(closest.x - zeroDistance) ? point : closest;
                        }, trajectoryHigh.trajectory[0]).y;
                        
                        self.postMessage({ log: 'Initial bounds: angle ' + angleLow.toFixed(6) + ' gives y=' + yLow.toFixed(3) + ', angle ' + angleHigh.toFixed(6) + ' gives y=' + yHigh.toFixed(3) });
                        
                        // Check if zero is bracketed, if not expand the search
                        let iterations = 0;
                        while ((yLow > 0 && yHigh > 0) || (yLow < 0 && yHigh < 0)) {
                            iterations++;
                            if (iterations > 20) {
                                self.postMessage({ error: 'Cannot bracket zero after expanding search range' });
                                return;
                            }
                            
                            if (yLow > 0 && yHigh > 0) {
                                // Both positive, need more negative angle
                                angleLow -= 0.005;
                                angleHigh -= 0.005;
                            } else {
                                // Both negative, need more positive angle  
                                angleLow += 0.005;
                                angleHigh += 0.005;
                            }
                            
                            trajectoryLow = simulateTrajectory(angleLow);
                            yLow = trajectoryLow.trajectory.reduce((closest, point) => {
                                return Math.abs(point.x - zeroDistance) < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, trajectoryLow.trajectory[0]).y;
                            
                            trajectoryHigh = simulateTrajectory(angleHigh);
                            yHigh = trajectoryHigh.trajectory.reduce((closest, point) => {
                                return Math.abs(point.x - zeroDistance) < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, trajectoryHigh.trajectory[0]).y;
                            
                            self.postMessage({ log: 'Expanded bounds iteration ' + iterations + ': angle ' + angleLow.toFixed(6) + ' gives y=' + yLow.toFixed(3) + ', angle ' + angleHigh.toFixed(6) + ' gives y=' + yHigh.toFixed(3) });
                        }
                        
                        self.postMessage({ log: 'Zero successfully bracketed, starting Newton-Raphson...' });
                        
                        // Improved Newton-Raphson method with better convergence
                        let angle = (angleLow + angleHigh) / 2; // Start with midpoint
                        const tolerance = 0.01; // 0.01 feet = 0.12 inches tolerance
                        const maxIterations = 25;
                        
                        for (let i = 0; i < maxIterations; i++) {
                            // Calculate function value at current angle
                            let trajectory = simulateTrajectory(angle);
                            let targetPoint = trajectory.trajectory.reduce((closest, point) => {
                                return Math.abs(point.x - zeroDistance) < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, trajectory.trajectory[0]);
                            let f = targetPoint.y;
                            
                            self.postMessage({ log: 'Newton iteration ' + (i + 1) + ': angle=' + angle.toFixed(6) + ', y=' + f.toFixed(3) });
                            
                            if (Math.abs(f) < tolerance) {
                                self.postMessage({ log: 'Converged in ' + (i + 1) + ' iterations with angle ' + angle.toFixed(6) + ' radians' });
                                
                                // Generate final trajectory with converged angle
                                let finalTrajectory = simulateTrajectory(angle);
                                
                                // Create results grid
                                const targetDistances = [];
                                for (let dist = 0; dist <= inputs.max_distance_yards; dist += inputs.step_interval_yards) {
                                    targetDistances.push(dist * 3); // Convert to feet
                                }
                                
                                const results_grid = [];
                                for (let targetDist of targetDistances) {
                                    let closestPoint = finalTrajectory.trajectory.reduce((closest, point) => {
                                        return Math.abs(point.x - targetDist) < Math.abs(closest.x - targetDist) ? point : closest;
                                    }, finalTrajectory.trajectory[0]);
                                    
                                    const distanceYards = targetDist / 3;
                                    const dropInches = closestPoint.y * 12;
                                    const holdInches = -dropInches;
                                    // Debug log to check available properties
                                    if (distanceYards === 0) {
                                        self.postMessage({ log: 'Debug trajectory point properties: ' + Object.keys(closestPoint).join(', ') });
                                    }
                                    
                                    const velocity = closestPoint.vx || closestPoint.v || Math.sqrt((closestPoint.vx || 0) * (closestPoint.vx || 0) + (closestPoint.vy || 0) * (closestPoint.vy || 0)) || inputs.muzzle_velocity;
                                    const energy = 0.5 * (inputs.bullet_grain / 7000) * velocity * velocity / 32.174;
                                    
                                    results_grid.push({
                                        distance_yd: distanceYards.toFixed(0),
                                        drop_in: dropInches.toFixed(2),
                                        hold_in: holdInches.toFixed(2),
                                        velocity_fps: velocity.toFixed(0),
                                        energy_ftlbs: energy.toFixed(1)
                                    });
                                }
                                
                                self.postMessage({ results_grid, converged: true });
                                return;
                            }
                            
                            // Calculate numerical derivative
                            const h = 0.0001; // Small perturbation
                            let trajectoryPlus = simulateTrajectory(angle + h);
                            let targetPointPlus = trajectoryPlus.trajectory.reduce((closest, point) => {
                                return Math.abs(point.x - zeroDistance) < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, trajectoryPlus.trajectory[0]);
                            let fPlus = targetPointPlus.y;
                            
                            let derivative = (fPlus - f) / h;
                            
                            if (Math.abs(derivative) < 1e-10) {
                                self.postMessage({ log: 'Derivative too small at iteration ' + (i + 1) + ', switching to bisection' });
                                // Fall back to bisection method
                                if (f > 0) {
                                    angleHigh = angle;
                                } else {
                                    angleLow = angle;
                                }
                                angle = (angleLow + angleHigh) / 2;
                            } else {
                                // Newton-Raphson step
                                let newAngle = angle - f / derivative;
                                
                                // Keep within reasonable bounds
                                if (newAngle < -0.1 || newAngle > 0.1) {
                                    self.postMessage({ log: 'Newton step out of bounds, using bisection' });
                                    if (f > 0) {
                                        angleHigh = angle;
                                    } else {
                                        angleLow = angle;
                                    }
                                    angle = (angleLow + angleHigh) / 2;
                                } else {
                                    angle = newAngle;
                                }
                            }
                        }
                        
                        self.postMessage({ error: 'Zeroing failed to converge after ' + maxIterations + ' iterations' });
                    }
                    
                    function originalZeroTrajectory(inputs) {
                        const zeroDistance = inputs.zero_distance * 3; // Convert yards to feet
                        self.postMessage({ log: 'Starting zeroing for distance: ' + inputs.zero_distance + ' yards (' + zeroDistance + ' feet)' });
                        
                        // Use realistic angle range for rifle zeroing (typically -0.1 to +0.1 radians)
                        // Most rifle zeros require very small angular adjustments
                        let angleLow = -0.05;  // About -2.9 degrees  
                        let angleHigh = 0.05;  // About +2.9 degrees
                        
                        self.postMessage({ log: 'Calculating initial bounds...' });
                        let trajectoryLow = simulateTrajectory(angleLow);
                        let yLow = trajectoryLow.trajectory.reduce((closest, point) => {
                            const dist = Math.abs(point.x - zeroDistance);
                            return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                        }, { x: 0, y: 0 }).y;
                        
                        let trajectoryHigh = simulateTrajectory(angleHigh);
                        let yHigh = trajectoryHigh.trajectory.reduce((closest, point) => {
                            const dist = Math.abs(point.x - zeroDistance);
                            return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                        }, { x: 0, y: 0 }).y;
                        
                        self.postMessage({ log: 'Initial bounds: angleLow=' + angleLow + ' (y=' + yLow.toFixed(3) + '), angleHigh=' + angleHigh + ' (y=' + yHigh.toFixed(3) + ')' });
                        
                        // Check if we have a valid bracket (opposite signs)
                        if (yLow * yHigh > 0) {
                            self.postMessage({ log: 'Warning: Initial bounds do not bracket zero! Both y values have same sign.' });
                        }

                        let trajectory, closestPoints;
                        let converged = false;
                        for (let i = 0; i < 1000; i++) {
                            const angle = (angleLow + angleHigh) / 2;
                            const result = simulateTrajectory(angle);
                            trajectory = result.trajectory;
                            closestPoints = result.closestPoints;
                            const zeroPoint = trajectory.reduce((closest, point) => {
                                const dist = Math.abs(point.x - zeroDistance);
                                return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, trajectory[0]);
                            const y = zeroPoint.y;

                            if (i % 500 === 0) {
                                self.postMessage({ log: 'Iteration ' + i + ': Angle=' + angle.toFixed(12) + ', y at ' + inputs.zero_distance + 'yd=' + y.toFixed(12) });
                                self.postMessage({ log: 'Debug: zeroDistance=' + zeroDistance + 'ft, zeroPoint.x=' + zeroPoint.x.toFixed(2) + 'ft, closest trajectory points around target:' });
                                const nearbyPoints = trajectory.filter(p => Math.abs(p.x - zeroDistance) < 10).slice(0, 5);
                                nearbyPoints.forEach(p => {
                                    self.postMessage({ log: '  x=' + p.x.toFixed(2) + 'ft, y=' + p.y.toFixed(2) + 'ft' });
                                });
                            }

                            if (Math.abs(y) < 0.001) {
                                converged = true;
                                break;
                            }

                            if (y > 0) {
                                angleHigh = angle;
                                yHigh = y;
                            } else {
                                angleLow = angle;
                                yLow = y;
                            }

                            if (Math.abs(yHigh - yLow) < 1e-6) {
                                self.postMessage({ log: 'Zeroing stagnating' });
                                break;
                            }
                        }

                        if (!converged) {
                            self.postMessage({ log: 'Zeroing failed to converge within tolerance' });
                            angleLow = -0.3;
                            angleHigh = 0.3;
                            yLow = simulateTrajectory(angleLow).trajectory.reduce((closest, point) => {
                                const dist = Math.abs(point.x - zeroDistance);
                                return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, { x: 0, y: 0 }).y;
                            yHigh = simulateTrajectory(angleHigh).trajectory.reduce((closest, point) => {
                                const dist = Math.abs(point.x - zeroDistance);
                                return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                            }, { x: 0, y: 0 }).y;

                            for (let i = 0; i < 2000; i++) {
                                const angle = (angleLow + angleHigh) / 2;
                                const result = simulateTrajectory(angle);
                                trajectory = result.trajectory;
                                closestPoints = result.closestPoints;
                                const zeroPoint = trajectory.reduce((closest, point) => {
                                    const dist = Math.abs(point.x - zeroDistance);
                                    return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                                }, trajectory[0]);
                                const y = zeroPoint.y;

                                if (i % 500 === 0) {
                                    self.postMessage({ log: 'Fallback Iteration ' + i + ': Angle=' + angle.toFixed(12) + ', y at ' + inputs.zero_distance + 'yd=' + y.toFixed(12) });
                                }

                                if (Math.abs(y) < 0.001) {
                                    converged = true;
                                    break;
                                }

                                if (y > 0) {
                                    angleHigh = angle;
                                    yHigh = y;
                                } else {
                                    angleLow = angle;
                                    yLow = y;
                                }

                                if (Math.abs(yHigh - yLow) < 1e-6) {
                                    self.postMessage({ log: 'Fallback zeroing stagnating' });
                                    break;
                                }
                            }
                        }

                        if (!converged) {
                            // Try Newton's method for more robust convergence
                            self.postMessage({ log: 'Attempting Newton method for precise zeroing' });
                            let angle = 0.01; // Start with a reasonable guess
                            const h = 1e-8; // Small step for numerical derivative
                            
                            for (let i = 0; i < 100; i++) {
                                // Calculate function value at current angle
                                const result1 = simulateTrajectory(angle);
                                const y1 = result1.trajectory.reduce((closest, point) => {
                                    const dist = Math.abs(point.x - zeroDistance);
                                    return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                                }, result1.trajectory[0]).y;
                                
                                // Calculate function value at angle + h for derivative
                                const result2 = simulateTrajectory(angle + h);
                                const y2 = result2.trajectory.reduce((closest, point) => {
                                    const dist = Math.abs(point.x - zeroDistance);
                                    return dist < Math.abs(closest.x - zeroDistance) ? point : closest;
                                }, result2.trajectory[0]).y;
                                
                                // Calculate numerical derivative
                                const derivative = (y2 - y1) / h;
                                
                                if (i % 20 === 0) {
                                    self.postMessage({ log: 'Newton Iteration ' + i + ': Angle=' + angle.toFixed(12) + ', y=' + y1.toFixed(12) + ', dy/da=' + derivative.toFixed(6) });
                                }
                                
                                // Check for convergence with high precision
                                if (Math.abs(y1) < 0.001) { // 0.001 feet = 0.012 inches
                                    trajectory = result1.trajectory;
                                    closestPoints = result1.closestPoints;
                                    converged = true;
                                    self.postMessage({ log: 'Newton method converged to high precision' });
                                    break;
                                }
                                
                                // Check for zero derivative (problematic)
                                if (Math.abs(derivative) < 1e-10) {
                                    self.postMessage({ log: 'Newton method: derivative too small, switching to final binary search' });
                                    break;
                                }
                                
                                // Newton's method update
                                const newAngle = angle - y1 / derivative;
                                
                                // Prevent wild jumps
                                if (Math.abs(newAngle - angle) > 0.01) {
                                    angle = angle + (newAngle > angle ? 0.01 : -0.01);
                                } else {
                                    angle = newAngle;
                                }
                                
                                // Keep angle within realistic rifle zeroing bounds
                                angle = Math.max(-0.05, Math.min(0.05, angle));
                            }
                        }

                        if (!converged) {
                            self.postMessage({ error: 'Zeroing failed after all attempts' });
                            return;
                        }

                        self.postMessage({ log: 'Drag at key points (0, 75, 150 ft): ' + JSON.stringify(closestPoints) });
                        self.postMessage({ log: 'Final trajectory at zero distance: ' + JSON.stringify(trajectory.find(p => Math.abs(p.x - zeroDistance) < 0.001)) });

                        const results_grid = trajectory.filter(point => targetDistances.includes(point.x)).map(point => ({
                            distance_yd: (point.x / 3).toFixed(0),
                            drop_in: (point.y * 12).toFixed(2),
                            hold_in: (-point.y * 12).toFixed(2),
                            velocity_fps: point.v.toFixed(0),
                            energy_ftlbs: (0.5 * bulletMass * point.v * point.v / 32.174).toFixed(1)
                        }));

                        self.postMessage({ log: 'Ballistic Coefficient used: ' + inputs.ballistic_coefficient });
                        self.postMessage({ log: 'Muzzle velocity: ' + muzzleVelocity + ' fps' });
                        self.postMessage({ log: 'First 5 trajectory points with velocity: ' + JSON.stringify(trajectory.slice(0, 5).map(p => ({x: p.x, v: p.v}))) });
                        self.postMessage({ log: 'Sample velocity at 100yd: ' + JSON.stringify(trajectory.filter(p => Math.abs(p.x - 300) < 1).map(p => ({x: p.x, v: p.v}))) });
                        self.postMessage({ log: 'Results Grid first 3 points: ' + JSON.stringify(results_grid.slice(0, 3)) });
                        self.postMessage({ results_grid, converged });
                    }

                    zeroTrajectory(inputs);
                };
            `;

            const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
            const workerURL = URL.createObjectURL(workerBlob);
            const worker = new Worker(workerURL);

            worker.onmessage = function(e) {
                (async () => {
                    if (e.data.log) {
                        console.log(e.data.log);
                    } else if (e.data.error) {
                        console.error(e.data.error);
                        const messageDiv = document.getElementById('message');
                        messageDiv.innerHTML = `<div class="error">Error: ${e.data.error}</div>`;
                    } else {
                        const { results_grid, converged } = e.data;
                        const messageDiv = document.getElementById('message');
                        if (!converged) {
                            messageDiv.innerHTML = `<div class="error">Error: Zeroing failed completely.</div>`;
                            return;
                        }

                        const tbody = document.getElementById('trajectoryBody');
                        tbody.innerHTML = '';
                        results_grid.forEach(point => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${point.distance_yd}</td>
                                <td>${formatHold(point.hold_in)}</td>
                                <td>${calculateMOA(parseFloat(point.hold_in), parseFloat(point.distance_yd))}</td>
                                <td>${point.velocity_fps}</td>
                                <td>${point.energy_ftlbs}</td>
                                <td>${point.drop_in}</td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        const form = document.getElementById('ballisticForm');
                        const inputs = {
                            shooter_name: form.shooter_name.value,
                            firearm_type: form.firearm_type.value,
                            firearm_name: form.firearm_name.value,
                            optic_name: form.optic_name.value,
                            caliber: form.caliber.value,
                            bullet_caliber: form.bullet_caliber.value,
                            barrel_length: parseFloat(form.barrel_length.value) || null,
                            barrel_twist_rate: form.barrel_twist_rate.value || null,
                            bullet_grain: parseInt(form.bullet_grain.value),
                            muzzle_velocity: parseFloat(form.muzzle_velocity.value),
                            muzzle_energy: parseFloat(form.muzzle_energy.value) || null,
                            ballistic_coefficient: parseFloat(form.ballistic_coefficient.value),
                            zero_distance: parseFloat(form.zero_distance.value),
                            height_over_bore: parseFloat(form.height_over_bore.value),
                            drag_model: form.drag_model.value,
                            step_interval_yards: parseInt(form.step_interval_yards.value),
                            max_distance_yards: parseInt(form.max_distance_yards.value),
                            wind_speed: form.wind_speed.value !== '' ? parseFloat(form.wind_speed.value) : null,
                            wind_angle: form.wind_angle.value !== '' ? parseFloat(form.wind_angle.value) : null
                        };

                        const sessionData = {
                            shooter_name: inputs.shooter_name,
                            firearm_type: inputs.firearm_type,
                            firearm_name: inputs.firearm_name,
                            optic_name: inputs.optic_name,
                            caliber: inputs.caliber,
                            bullet_caliber: inputs.bullet_caliber,
                            barrel_length: inputs.barrel_length,
                            barrel_twist_rate: inputs.barrel_twist_rate,
                            bullet_grain: inputs.bullet_grain,
                            muzzle_velocity: inputs.muzzle_velocity,
                            muzzle_energy: inputs.muzzle_energy,
                            ballistic_coefficient: inputs.ballistic_coefficient,
                            zero_distance: inputs.zero_distance,
                            height_over_bore: inputs.height_over_bore,
                            drag_model: inputs.drag_model,
                            step_interval_yards: inputs.step_interval_yards,
                            max_distance_yards: inputs.max_distance_yards,
                            wind_speed: inputs.wind_speed,
                            wind_angle: inputs.wind_angle,
                            environment: {
                                wind_speed: inputs.wind_speed,
                                wind_angle: inputs.wind_angle
                            },
                            results_grid: results_grid,
                            user_id: currentUser.id // Tie the session to the logged-in user
                        };
                        
                        // Store data for graphing and show graph button
                        currentTrajectoryData = results_grid.map(point => ({
                            ...point,
                            sessionInfo: inputs
                        }));
                        currentComparisonData = null;
                        document.getElementById('showGraphButton').style.display = 'inline-block';

                        let operation;
                        if (editSessionId) {
                            const { data: existingRecord, error: fetchError } = await supabase
                                .from('ballistic_sessions')
                                .select('*')
                                .eq('id', editSessionId)
                                .eq('user_id', currentUser.id)
                                .single();

                            if (fetchError || !existingRecord) {
                                console.error('Error verifying session before update:', fetchError || 'Record not found');
                                messageDiv.innerHTML = `<div class="error">Error: Session with ID ${editSessionId} not found before update. ${fetchError ? fetchError.message : ''}</div>`;
                                return;
                            }
                            console.log(`Verified session exists before update:`, existingRecord);
                            console.log(`Comparing IDs - editSessionId: ${editSessionId}, record ID: ${existingRecord.id}, match: ${editSessionId === existingRecord.id}`);
                            console.log(`Session data to update:`, sessionData);
                            console.log(`Barrel twist rate in sessionData:`, sessionData.barrel_twist_rate);

                            console.log(`Updating session with ID: ${editSessionId}`);
                            operation = supabase.from('ballistic_sessions').update(sessionData).eq('id', editSessionId).eq('user_id', currentUser.id).select();
                        } else {
                            console.log('Inserting new session', sessionData);
                            operation = supabase.from('ballistic_sessions').insert([sessionData]).select();
                        }

                        const { data, error, status, statusText, count } = await operation;
                        if (error) {
                            console.error('Supabase operation error:', { error, status, statusText, count });
                            messageDiv.innerHTML = `<div class="error">Error ${editSessionId ? 'updating' : 'saving'} session: ${error.message} (Status: ${status} ${statusText})</div>`;
                            return;
                        }

                        if (!data || data.length === 0) {
                            console.error('No rows affected by the operation', { data, status, statusText, count });
                            messageDiv.innerHTML = `<div class="error">Failed to ${editSessionId ? 'update' : 'save'} session: No rows were affected. Check permissions or data (Status: ${status} ${statusText}).</div>`;
                            return;
                        }

                        console.log('Data operation successful in Supabase', { data, count });
                        messageDiv.innerHTML = `<div class="message">${editSessionId ? 'Session updated' : 'Data saved'} successfully!</div>`;
                        form.reset();
                        editSessionId = null;
                        document.getElementById('cancelEditButton').style.display = 'none';
                        toggleForm();

                        const sessionId = data[0].id;
                        const { data: session, error: fetchError } = await supabase
                            .from('ballistic_sessions')
                            .select('*')
                            .eq('id', sessionId)
                            .eq('user_id', currentUser.id)
                            .single();
                        if (fetchError) {
                            console.error('Error fetching session:', fetchError);
                            messageDiv.innerHTML = `<div class="error">Error fetching session: ${fetchError.message}</div>`;
                        } else {
                            console.log('Fetched session after operation:', session);
                            window.displaySingleSession(session);
                        }
                    }
                })();
            };

            window.calculateAndSave = function() {
                console.warn('calculateAndSave function started');
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = '';

                const form = document.getElementById('ballisticForm');
                const inputs = {
                    shooter_name: form.shooter_name.value,
                    firearm_type: form.firearm_type.value,
                    firearm_name: form.firearm_name.value,
                    optic_name: form.optic_name.value,
                    caliber: form.caliber.value,
                    bullet_caliber: form.bullet_caliber.value,
                    barrel_length: parseFloat(form.barrel_length.value) || null,
                    barrel_twist_rate: form.barrel_twist_rate.value || null,
                    bullet_grain: parseInt(form.bullet_grain.value),
                    muzzle_velocity: parseFloat(form.muzzle_velocity.value),
                    ballistic_coefficient: parseFloat(form.ballistic_coefficient.value),
                    zero_distance: parseFloat(form.zero_distance.value),
                    height_over_bore: parseFloat(form.height_over_bore.value),
                    drag_model: form.drag_model.value,
                    step_interval_yards: parseInt(form.step_interval_yards.value),
                    max_distance_yards: parseInt(form.max_distance_yards.value),
                    wind_speed: parseFloat(form.wind_speed.value) || 0,
                    wind_angle: parseFloat(form.wind_angle.value) || 0
                };

                if (!inputs.shooter_name || !inputs.firearm_name || !inputs.caliber || !inputs.bullet_caliber ||
                    isNaN(inputs.bullet_grain) || isNaN(inputs.muzzle_velocity) || isNaN(inputs.ballistic_coefficient) ||
                    isNaN(inputs.zero_distance) || isNaN(inputs.height_over_bore) || isNaN(inputs.step_interval_yards) ||
                    isNaN(inputs.max_distance_yards) || inputs.step_interval_yards <= 0 || inputs.max_distance_yards <= 0) {
                    console.error('Input validation failed', inputs);
                    messageDiv.innerHTML = '<div class="error">Please fill all required fields with valid positive values.</div>';
                    return;
                }

                if (!inputs.firearm_type || inputs.firearm_type === '') {
                    console.error('Firearm type not selected');
                    messageDiv.innerHTML = '<div class="error">Please select a firearm type (Rifle or Pistol).</div>';
                    return;
                }

                if (!inputs.drag_model || inputs.drag_model === '') {
                    console.error('Drag model not selected');
                    messageDiv.innerHTML = '<div class="error">Please select a drag model (G1 or G7).</div>';
                    return;
                }

                inputs.muzzle_velocity = adjustMuzzleVelocity(inputs.caliber, inputs.barrel_length, inputs.muzzle_velocity);
                console.log('Adjusted inputs:', inputs);
                console.log('Barrel twist rate value:', inputs.barrel_twist_rate);
                worker.postMessage({ inputs });
            };

            window.loadSessionForEdit = async function(sessionId) {
                console.log(`Loading session for edit: ${sessionId}`);
                const { data, error } = await supabase
                    .from('ballistic_sessions')
                    .select('*')
                    .eq('id', sessionId)
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error loading session:', error);
                    document.getElementById('message').innerHTML = `<div class="error">Error loading session: ${error.message}</div>`;
                    return;
                }

                const session = data;
                console.log('Complete session data loaded from database:', session);
                const form = document.getElementById('ballisticForm');
                form.shooter_name.value = session.shooter_name || '';
                form.firearm_type.value = session.firearm_type || '';
                form.firearm_name.value = session.firearm_name || '';
                form.optic_name.value = session.optic_name || '';
                form.caliber.value = session.caliber || '';
                form.barrel_length.value = session.barrel_length || '';
                form.barrel_twist_rate.value = session.barrel_twist_rate || '';
                form.bullet_grain.value = session.bullet_grain || '';
                form.muzzle_velocity.value = session.muzzle_velocity || '';
                form.muzzle_energy.value = session.muzzle_energy || '';
                form.ballistic_coefficient.value = session.ballistic_coefficient || '';
                form.zero_distance.value = session.zero_distance || '';
                form.height_over_bore.value = session.height_over_bore || '';
                form.drag_model.value = session.drag_model || '';
                form.step_interval_yards.value = session.step_interval_yards || '';
                form.max_distance_yards.value = session.max_distance_yards || '';
                console.log('Wind data from database:', { wind_speed: session.wind_speed, wind_angle: session.wind_angle });
                form.wind_speed.value = session.wind_speed !== null && session.wind_speed !== undefined ? session.wind_speed : '';
                form.wind_angle.value = session.wind_angle !== null && session.wind_angle !== undefined ? session.wind_angle : '';

                editSessionId = sessionId;
                document.getElementById('cancelEditButton').style.display = 'inline-block';
                const formElement = document.getElementById('ballisticForm');
                formElement.style.display = 'block';
                document.querySelector('.add-session').textContent = 'Hide Form';
            };

            window.cancelEdit = function() {
                cancelEditWithoutToggle();
            };

            window.viewAll = async function() {
                console.warn('viewAll function started');
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = '';

                const { data, error } = await supabase.from('ballistic_sessions').select('*').eq('user_id', currentUser.id);
                if (error) {
                    console.error('Supabase select error:', error);
                    messageDiv.innerHTML = `<div class="error">Error fetching sessions: ${error.message}</div>`;
                    return;
                }

                if (!data || data.length === 0) {
                    console.log('No sessions found');
                    messageDiv.innerHTML = '<div class="message">No sessions found.</div>';
                }

                window.displaySessions(data);
            };

            window.displaySessions = function(sessions) {
                console.log('Displaying sessions:', sessions);
                const tbody = document.getElementById('sessionsBody');
                tbody.innerHTML = '';
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="select-session" data-id="${session.id}"></td>
                        <td>${session.shooter_name || ''}</td>
                        <td>${session.firearm_type || ''}</td>
                        <td>${session.firearm_name || ''}</td>
                        <td>${session.optic_name || ''}</td>
                        <td>${session.caliber || ''}</td>
                        <td>${session.barrel_length ? session.barrel_length.toFixed(1) : ''}</td>
                        <td>${session.barrel_twist_rate || ''}</td>
                        <td>${session.bullet_grain || ''}</td>
                        <td>${session.zero_distance || ''}</td>
                        <td>${session.max_distance_yards || ''}</td>
                        <td>${session.step_interval_yards || ''}</td>
                        <td>${session.height_over_bore || ''}</td>
                        <td>
                            <button class="view-session" onclick="window.viewTrajectory('${session.id}')">View</button>
                            <button class="edit-session" onclick="window.loadSessionForEdit('${session.id}')">Edit</button>
                        </td>
                    `;
                    row.dataset.resultsGrid = JSON.stringify(session.results_grid);
                    row.dataset.description = `${session.shooter_name || 'Unknown'} ${session.firearm_type || ''} ${session.firearm_name || ''} ${session.optic_name || ''} ${session.barrel_length ? session.barrel_length.toFixed(1) + 'in' : ''} - ${session.zero_distance || '0'}yd Zero`.trim();
                    tbody.appendChild(row);
                });
            };

            window.displaySingleSession = function(session) {
                console.log('Displaying single session:', session);
                const sessions = [session];
                window.displaySessions(sessions);
                window.viewTrajectory(session.id);
            };

            window.viewTrajectory = async function(sessionId) {
                console.log(`Viewing trajectory for session ID: ${sessionId}`);
                const row = document.querySelector(`.select-session[data-id="${sessionId}"]`).closest('tr');
                let results_grid;
                try {
                    results_grid = JSON.parse(row.dataset.resultsGrid);
                    console.log('Parsed results_grid:', results_grid);
                } catch (e) {
                    console.error('Error parsing results_grid:', e);
                    document.getElementById('message').innerHTML = '<div class="error">Error loading trajectory data.</div>';
                    return;
                }

                if (!Array.isArray(results_grid) || results_grid.length === 0) {
                    console.error('Invalid or empty results_grid:', results_grid);
                    document.getElementById('message').innerHTML = '<div class="error">No trajectory data available.</div>';
                    return;
                }

                const tbody = document.getElementById('trajectoryBody');
                tbody.innerHTML = '';
                results_grid.forEach(point => {
                    const tableRow = document.createElement('tr');
                    tableRow.innerHTML = `
                        <td>${point.distance_yd}</td>
                        <td>${formatHold(point.hold_in)}</td>
                        <td>${calculateMOA(parseFloat(point.hold_in), parseFloat(point.distance_yd))}</td>
                        <td>${point.velocity_fps}</td>
                        <td>${point.energy_ftlbs}</td>
                        <td>${point.drop_in}</td>
                    `;
                    tbody.appendChild(tableRow);
                });

                const description = row.dataset.description || '';
                document.getElementById('trajectoryDescription').textContent = description ? `- ${description}` : '';

                // Store data for graphing and show graph button
                const sessionData = JSON.parse(row.dataset.resultsGrid);
                
                try {
                    // Fetch complete session data to get BC and muzzle velocity
                    const { data: sessionDetails } = await window.supabase.from('ballistic_sessions')
                        .select('ballistic_coefficient, muzzle_velocity')
                        .eq('id', sessionId)
                        .single();
                    
                    console.log('Session details fetched:', sessionDetails);
                    
                    currentTrajectoryData = sessionData.map(point => ({
                        ...point,
                        sessionInfo: {
                            firearm_name: row.cells[3].textContent,
                            caliber: row.cells[5].textContent,
                            bullet_grain: row.cells[8].textContent,
                            zero_distance: row.cells[9].textContent,
                            ballistic_coefficient: sessionDetails?.ballistic_coefficient || 'N/A',
                            muzzle_velocity: sessionDetails?.muzzle_velocity || 'N/A'
                        }
                    }));
                } catch (error) {
                    console.error('Error fetching session details:', error);
                    currentTrajectoryData = sessionData.map(point => ({
                        ...point,
                        sessionInfo: {
                            firearm_name: row.cells[3].textContent,
                            caliber: row.cells[5].textContent,
                            bullet_grain: row.cells[8].textContent,
                            zero_distance: row.cells[9].textContent,
                            ballistic_coefficient: 'N/A',
                            muzzle_velocity: 'N/A'
                        }
                    }));
                }
                
                currentComparisonData = null;
                document.getElementById('showGraphButton').style.display = 'inline-block';

                // Hide comparison table when viewing a single session
                document.getElementById('comparisonTitle').style.display = 'none';
                document.getElementById('comparisonTable').style.display = 'none';
            };

            window.showCompareForm = function() {
                const checkboxes = document.querySelectorAll('.select-session:checked');
                if (checkboxes.length < 2) {
                    document.getElementById('message').innerHTML = '<div class="error">Please select at least two sessions to compare.</div>';
                    return;
                }
                const compareForm = document.getElementById('compareForm');
                compareForm.style.display = 'block';
            };

            window.hideCompareForm = function() {
                const compareForm = document.getElementById('compareForm');
                compareForm.style.display = 'none';
                document.getElementById('message').innerHTML = '';
            };

            window.compareSelected = function() {
                const checkboxes = document.querySelectorAll('.select-session:checked');
                if (checkboxes.length < 2) {
                    document.getElementById('message').innerHTML = '<div class="error">Please select at least two sessions to compare.</div>';
                    return;
                }

                const stepIntervalInput = document.getElementById('compare_step_interval').value;
                const maxDistanceInput = document.getElementById('compare_max_distance').value;

                if (!stepIntervalInput || stepIntervalInput === "Enter Value" || !maxDistanceInput || maxDistanceInput === "Enter Value") {
                    document.getElementById('message').innerHTML = '<div class="error">Please enter values for step interval and max distance.</div>';
                    return;
                }

                const stepInterval = parseInt(stepIntervalInput);
                const maxDistance = parseInt(maxDistanceInput);

                if (isNaN(stepInterval) || isNaN(maxDistance) || stepInterval <= 0 || maxDistance <= 0) {
                    document.getElementById('message').innerHTML = '<div class="error">Please enter valid positive values for step interval and max distance.</div>';
                    return;
                }

                const selectedRows = Array.from(checkboxes).map(cb => cb.closest('tr'));
                const selectedSessions = selectedRows.map(row => ({
                    results_grid: JSON.parse(row.dataset.resultsGrid),
                    description: row.dataset.description,
                    grain: row.cells[8].textContent // Get grain from the Gr column (index 8)
                }));

                const distances = Array.from(
                    { length: Math.floor(maxDistance / stepInterval) + 1 },
                    (_, i) => i * stepInterval
                );

                const comparisonData = selectedSessions.map(session => {
                    const grid = session.results_grid;
                    return {
                        description: session.description,
                        bullet_grain: session.grain,
                        trajectory: distances.map(distance => {
                            const point = grid.find(p => parseFloat(p.distance_yd) === distance);
                            if (point) {
                                return { distance_yd: distance, hold_in: parseFloat(point.hold_in) };
                            }
                            const before = grid.filter(p => parseFloat(p.distance_yd) < distance).pop();
                            const after = grid.find(p => parseFloat(p.distance_yd) > distance);
                            if (!before || !after) {
                                return { distance_yd: distance, hold_in: null };
                            }
                            const fraction = (distance - parseFloat(before.distance_yd)) / (parseFloat(after.distance_yd) - parseFloat(before.distance_yd));
                            const interpolatedHold = parseFloat(before.hold_in) + fraction * (parseFloat(after.hold_in) - parseFloat(before.hold_in));
                            return { distance_yd: distance, hold_in: interpolatedHold };
                        })
                    };
                });

                // Calculate the flattest trajectory by finding the session with the smallest hold range
                const trajectoryRanges = comparisonData.map(session => {
                    const holds = session.trajectory
                        .map(point => point.hold_in)
                        .filter(hold => hold !== null);
                    if (holds.length === 0) return Infinity;
                    const maxHold = Math.max(...holds);
                    const minHold = Math.min(...holds);
                    return maxHold - minHold;
                });

                const flattestIndex = trajectoryRanges.indexOf(Math.min(...trajectoryRanges));

                const comparisonTableHead = document.getElementById('comparisonTableHead');
                const comparisonTableBody = document.getElementById('comparisonTableBody');
                comparisonTableHead.innerHTML = '';
                comparisonTableBody.innerHTML = '';

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>Distance (yd)</th>';
                comparisonData.forEach((session, index) => {
                    const th = document.createElement('th');
                    th.textContent = `${session.description} - ${session.bullet_grain}gr`;
                    if (index === flattestIndex) {
                        th.classList.add('flattest-trajectory');
                    }
                    headerRow.appendChild(th);
                });
                comparisonTableHead.appendChild(headerRow);

                distances.forEach(distance => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${distance}</td>`;
                    comparisonData.forEach(session => {
                        const point = session.trajectory.find(p => p.distance_yd === distance);
                        const td = document.createElement('td');
                        td.textContent = point.hold_in !== null ? formatHold(point.hold_in) : '-';
                        row.appendChild(td);
                    });
                    comparisonTableBody.appendChild(row);
                });

                // Store comparison data for graphing and show graph button
                const selectedRowData = selectedRows.map(row => ({
                    firearm_name: row.cells[3].textContent,
                    caliber: row.cells[5].textContent,
                    bullet_grain: row.cells[8].textContent,
                    zero_distance: row.cells[9].textContent,
                    results_grid: JSON.parse(row.dataset.resultsGrid)
                }));
                currentComparisonData = selectedRowData;
                currentTrajectoryData = null;
                document.getElementById('showGraphButton').style.display = 'inline-block';

                document.getElementById('comparisonTitle').style.display = 'block';
                document.getElementById('comparisonTable').style.display = 'table';
                hideCompareForm();
            };

            window.clearAll = function() {
                console.log('Clearing all UI data');
                const form = document.getElementById('ballisticForm');
                form.reset();
                editSessionId = null;
                document.getElementById('cancelEditButton').style.display = 'none';
                document.getElementById('sessionsBody').innerHTML = '';
                document.getElementById('trajectoryBody').innerHTML = '';
                document.getElementById('message').innerHTML = '';
                document.getElementById('search_shooter_name').value = '';
                document.getElementById('search_firearm_type').value = '';
                document.getElementById('search_firearm_name').value = '';
                document.getElementById('search_bullet_grain').value = '';
                document.getElementById('search_barrel_length').value = '';
                document.getElementById('trajectoryDescription').textContent = '';
                document.getElementById('comparisonTitle').style.display = 'none';
                document.getElementById('comparisonTable').style.display = 'none';
                document.getElementById('showGraphButton').style.display = 'none';
                
                // Clear trajectory data
                currentTrajectoryData = null;
                currentComparisonData = null;
                
                // Reset the Select All checkbox
                const selectAllCheckbox = document.getElementById('selectAllSessions');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
                
                // Uncheck all individual session checkboxes
                const sessionCheckboxes = document.querySelectorAll('.select-session');
                sessionCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                const formElement = document.getElementById('ballisticForm');
                if (formElement.style.display === 'block') {
                    toggleForm();
                }
            };

            window.toggleSelectAllSessions = function() {
                const selectAllCheckbox = document.getElementById('selectAllSessions');
                const sessionCheckboxes = document.querySelectorAll('.select-session');
                
                sessionCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            };

            // DOPE Functions
            window.showDOPE = async function() {
                console.log('showDOPE function called');
                try {
                    // Hide all other sections
                    document.getElementById('homePage').style.display = 'none';
                    document.getElementById('shootingProfileSection').style.display = 'none';
                    document.getElementById('bulletLibrarySection').style.display = 'none';
                    
                    // Hide any active sections
                    const hideElement = (id) => {
                        const element = document.getElementById(id);
                        if (element) element.style.display = 'none';
                    };
                    hideElement('activeBulletLibrary');
                    hideElement('dopeSection');
                    hideElement('filterSection');
                    hideElement('ballisticForm');
                    hideElement('compareForm');
                    hideElement('compareResults');
                    
                    // Create DOPE content directly in the main app content (similar to bullet library)
                    const appContent = document.getElementById('appContent');
                    const dopeContent = document.createElement('div');
                    dopeContent.id = 'activeDopeSection';
                    dopeContent.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">? Home</button>
                                <h2 style="margin: 0;">DOPE - Data On Previous Engagements</h2>
                            </div>
                            <button onclick="showAddDopeFormDirect()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Log New Engagement</button>
                            <div id="dopeContent">Loading your engagements...</div>
                        </div>
                    `;
                    
                    // Remove any existing active DOPE section
                    const existing = document.getElementById('activeDopeSection');
                    if (existing) existing.remove();
                    
                    // Add the new DOPE content
                    appContent.appendChild(dopeContent);
                    console.log('DOPE content created and added to page');
                    
                    // Load the engagements after the content is added
                    setTimeout(() => loadDopeEngagementsDirect(), 200);
                    
                } catch (error) {
                    console.error('Error in showDOPE function:', error);
                }
            };

            window.showAddDopeForm = function() {
                document.getElementById('addDopeForm').style.display = 'block';
                
                // Set current date and time as defaults
                const now = new Date();
                document.getElementById('engagement_date').value = now.toISOString().split('T')[0];
                
                // Set current time (hours:minutes)
                const timeString = now.toTimeString().slice(0, 5);
                document.getElementById('engagement_time').value = timeString;
                
                // Load dropdowns with fresh data
                loadDopeDropdowns();
                
                clearDopeForm();
            };

            window.cancelAddDope = function() {
                document.getElementById('addDopeForm').style.display = 'none';
                clearDopeForm();
            };

            window.clearDopeForm = function() {
                const form = document.getElementById('addDopeForm');
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type !== 'date') {
                        input.value = '';
                    }
                });
            };

            window.loadDopeDropdowns = async function() {
                console.log('loadDopeDropdowns called');
                try {
                    if (!currentUser) {
                        console.log('No current user, skipping dropdown load');
                        return;
                    }

                    console.log('Loading firearm profiles...');
                    // Load firearm profiles
                    const { data: profiles, error: profileError } = await supabase
                        .from('firearm_profile')
                        .select('id, shooter_name, firearm_name, caliber')
                        .eq('user_id', currentUser.id)
                        .order('shooter_name', { ascending: true });

                    if (profileError) {
                        console.error('Profile error:', profileError);
                    } else {
                        console.log('Profiles loaded:', profiles);
                        const profileSelect = document.getElementById('dope_shooting_profile');
                        if (profileSelect) {
                            profileSelect.innerHTML = '<option value="">Select a shooting profile...</option>';
                            profiles.forEach(profile => {
                                const option = document.createElement('option');
                                option.value = profile.id;
                                option.textContent = `${profile.shooter_name} - ${profile.firearm_name} (${profile.caliber})`;
                                profileSelect.appendChild(option);
                            });
                        }
                    }

                    console.log('Loading bullet library for DOPE...');
                    // Load bullet library
                    const { data: bullets, error: bulletError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (bulletError) {
                        console.error('Bullet error:', bulletError);
                    } else {
                        console.log('Bullets loaded for DOPE:', bullets);
                        const bulletSelect = document.getElementById('dope_bullet_library');
                        if (bulletSelect) {
                            bulletSelect.innerHTML = '<option value="">Select a bullet...</option>';
                            
                            if (bullets && bullets.length > 0) {
                                bullets.forEach(bullet => {
                                    const option = document.createElement('option');
                                    option.value = bullet.id;
                                    option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr ${bullet.bullet_type || ''}`;
                                    bulletSelect.appendChild(option);
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading DOPE dropdowns:', error);
                }
            };

            window.saveDope = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to save engagement data.');
                        return;
                    }

                    const dopeData = {
                        user_id: currentUser.id,
                        shooting_profile_id: document.getElementById('dope_shooting_profile').value || null,
                        bullet_library_id: parseInt(document.getElementById('dope_bullet_library').value) || null,
                        engagement_date: document.getElementById('engagement_date').value,
                        engagement_time: document.getElementById('engagement_time').value || null,
                        range_to_target: parseFloat(document.getElementById('range_to_target').value),
                        range_unit: document.getElementById('range_unit').value,
                        wind_speed: parseFloat(document.getElementById('wind_speed').value) || null,
                        wind_direction: parseFloat(document.getElementById('wind_direction').value) || null,
                        wind_type: document.getElementById('wind_type').value || null,
                        temperature: parseFloat(document.getElementById('temperature').value) || null,
                        temperature_unit: document.getElementById('temperature_unit').value || null,
                        barometric_pressure: parseFloat(document.getElementById('barometric_pressure').value) || null,
                        pressure_unit: document.getElementById('pressure_unit').value || null,
                        humidity: parseFloat(document.getElementById('humidity').value) || null,
                        altitude: parseFloat(document.getElementById('altitude').value) || null,
                        altitude_reference: document.getElementById('altitude_reference').value || null,
                        angle_of_fire: parseFloat(document.getElementById('angle_of_fire').value) || null,
                        spin_drift: parseFloat(document.getElementById('spin_drift').value) || null,
                        coriolis_effect: parseFloat(document.getElementById('coriolis_effect').value) || null,
                        target_movement_speed: parseFloat(document.getElementById('target_movement_speed').value) || null,
                        target_movement_direction: parseFloat(document.getElementById('target_movement_direction').value) || null,
                        optic_magnification: parseFloat(document.getElementById('optic_magnification').value) || null,
                        optic_adjustment_units: document.getElementById('optic_adjustment_units').value || null,
                        parallax_setting: parseFloat(document.getElementById('parallax_setting').value) || null,
                        atmospheric_conditions: document.getElementById('atmospheric_conditions').value || null,
                        barrel_condition: document.getElementById('barrel_condition').value || null,
                        time_of_flight: parseFloat(document.getElementById('time_of_flight').value) || null,
                        light_conditions: document.getElementById('light_conditions').value || null,
                        engagement_outcome: document.getElementById('engagement_outcome').value || null,
                        notes: document.getElementById('engagement_notes').value || null
                    };

                    const { data, error } = await supabase
                        .from('dope_engagements')
                        .insert([dopeData])
                        .select();

                    if (error) {
                        console.error('Error saving DOPE engagement:', error);
                        alert('Error saving engagement. Please try again.');
                    } else {
                        alert('Engagement saved successfully!');
                        document.getElementById('addDopeForm').style.display = 'none';
                        clearDopeForm();
                        loadDopeEngagements();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving engagement. Please try again.');
                }
            };

            window.loadDopeEngagements = async function() {
                try {
                    if (!currentUser) return;

                    const { data, error } = await supabase
                        .from('dope_engagements')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('engagement_date', { ascending: false });

                    const tableBody = document.getElementById('dopeTableBody');
                    const noMessage = document.getElementById('noDopeMessage');
                    const table = document.getElementById('dopeEngagementsTable');

                    if (error) {
                        console.error('Error loading DOPE engagements:', error);
                        return;
                    }

                    tableBody.innerHTML = '';

                    if (data && data.length > 0) {
                        table.style.display = 'table';
                        noMessage.style.display = 'none';

                        data.forEach(engagement => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${engagement.engagement_date}</td>
                                <td>${engagement.range_to_target} ${engagement.range_unit}</td>
                                <td>${engagement.wind_speed ? `${engagement.wind_speed} ${engagement.wind_type || ''}` : 'N/A'}</td>
                                <td>${engagement.temperature ? `${engagement.temperature}°${engagement.temperature_unit}` : 'N/A'}</td>
                                <td>${engagement.engagement_outcome || 'N/A'}</td>
                                <td>
                                    <button onclick="viewDopeDetails('${engagement.id}')" class="view-session">View</button>
                                    <button onclick="deleteDope('${engagement.id}')" class="back-to-login">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        table.style.display = 'none';
                        noMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading DOPE engagements:', error);
                }
            };

            window.deleteDope = async function(engagementId) {
                if (!confirm('Are you sure you want to delete this engagement?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('dope_engagements')
                        .delete()
                        .eq('id', engagementId)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error deleting engagement:', error);
                        alert('Error deleting engagement. Please try again.');
                    } else {
                        loadDopeEngagements();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting engagement. Please try again.');
                }
            };

            window.viewDopeDetails = function(engagementId) {
                console.log('View DOPE details for:', engagementId);
                // TODO: Implement detailed view
                alert('Detailed view coming soon!');
            };

            window.showFirearmPicker = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to access firearm profiles.');
                        return;
                    }

                    // Load all firearm profiles for the current user
                    const { data: firearms, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error loading firearm profiles:', error);
                        alert('Error loading firearm profiles. Please ensure the firearm_profile table exists in your Supabase database.');
                        return;
                    }

                    if (!firearms || firearms.length === 0) {
                        alert('No firearm profiles found. Please create some firearm profiles first.');
                        return;
                    }

                    // Create a modal to select from available firearms
                    const firearmHTML = firearms.map(firearm => `
                        <div onclick="selectFirearm('${firearm.id}')" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 4px; background-color: #f9f9f9;">
                            <strong>${firearm.profile_name}</strong><br>
                            <span style="color: #666;">Shooter: ${firearm.shooter_name} | ${firearm.firearm_type}: ${firearm.firearm_name}</span><br>
                            <span style="color: #666;">Caliber: ${firearm.caliber} | Barrel: ${firearm.barrel_length}" | Zero: ${firearm.zero_distance}yds</span>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="firearmPickerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 70vh; overflow-y: auto; width: 90%;">
                                <h3>Select Firearm Profile</h3>
                                <div style="margin: 15px 0;">
                                    ${firearmHTML}
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="closeFirearmPicker()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } catch (error) {
                    console.error('Error in showFirearmPicker:', error);
                    alert('Error loading firearm profiles');
                }
            };

            window.selectFirearm = async function(firearmId) {
                try {
                    console.log('Selecting firearm with ID:', firearmId);
                    
                    // Load the selected firearm data
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) {
                        console.error('Error loading firearm:', error);
                        alert('Error loading firearm data');
                        return;
                    }

                    console.log('Firearm data loaded:', firearm);

                    // Close the picker first
                    closeFirearmPicker();

                    // Set the hidden field and display text
                    document.getElementById('firearm_profile_id').value = firearmId;
                    document.getElementById('selected_firearm').textContent = `${firearm.profile_name} - ${firearm.firearm_name}`;

                    // Wait a moment for DOM to update, then populate fields
                    setTimeout(() => {
                        try {
                            const setFieldValue = (fieldId, value) => {
                                const field = document.getElementById(fieldId);
                                if (field) {
                                    field.value = value || '';
                                    console.log(`Set ${fieldId} to: ${value}`);
                                } else {
                                    console.warn(`Field ${fieldId} not found`);
                                }
                            };
                            
                            // Populate firearm-specific data from firearm_profile table
                            setFieldValue('shooter_name', firearm.shooter_name);
                            setFieldValue('firearm_type', firearm.firearm_type);
                            setFieldValue('firearm_name', firearm.firearm_name);
                            setFieldValue('rifle_caliber', firearm.caliber);
                            setFieldValue('optic_name', firearm.optic_name);
                            setFieldValue('barrel_length', firearm.barrel_length ? `${firearm.barrel_length} inches` : '');
                            setFieldValue('barrel_twist_rate', firearm.barrel_twist_rate);
                            setFieldValue('zero_distance', firearm.zero_distance ? `${firearm.zero_distance} yards` : '');
                            setFieldValue('height_over_bore', firearm.height_over_bore ? `${firearm.height_over_bore} inches` : '');

                            console.log('Firearm data populated successfully');
                        } catch (innerError) {
                            console.error('Error populating firearm fields:', innerError);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error selecting firearm:', error);
                    alert('Error selecting firearm');
                }
            };

            window.closeFirearmPicker = function() {
                const modal = document.getElementById('firearmPickerModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.showProfilePicker = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to access shooting profiles.');
                        return;
                    }

                    // Load all shooting profiles for the current user - use the same client as other functions
                    const { data: profiles, error } = await supabase
                        .from('ballistic_sessions')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error loading profiles:', error);
                        alert('Error loading shooting profiles');
                        return;
                    }

                    if (!profiles || profiles.length === 0) {
                        alert('No shooting profiles found. Please create a shooting profile first.');
                        return;
                    }

                    // Create a modal to select from available profiles with more details
                    const profileHTML = profiles.map(profile => `
                        <div onclick="selectProfile('${profile.id}')" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 4px; background-color: #f9f9f9;">
                            <strong>${profile.shooter_name}</strong><br>
                            <span style="color: #666;">${profile.firearm_type} - ${profile.firearm_name}</span><br>
                            <span style="color: #888; font-size: 0.9em;">Caliber: ${profile.caliber || 'N/A'} | Barrel: ${profile.barrel_length || 'N/A'} | Zero: ${profile.zero_distance || 'N/A'}yds</span>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="profilePickerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 70vh; overflow-y: auto; width: 90%;">
                                <h3>Select Shooting Profile</h3>
                                <div style="margin: 15px 0;">
                                    ${profileHTML}
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="closeProfilePicker()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } catch (error) {
                    console.error('Error in showProfilePicker:', error);
                    alert('Error loading profiles');
                }
            };

            window.selectProfile = async function(profileId) {
                try {
                    console.log('Selecting profile with ID:', profileId);
                    
                    // Load the selected profile data - use the same client as other functions
                    const { data: profile, error } = await supabase
                        .from('ballistic_sessions')
                        .select('*')
                        .eq('id', profileId)
                        .single();

                    if (error) {
                        console.error('Error loading profile:', error);
                        alert('Error loading profile data');
                        return;
                    }

                    console.log('Profile data loaded:', profile);

                    // Close the picker first to avoid any interference
                    closeProfilePicker();

                    // Wait a moment for the DOM to update
                    setTimeout(() => {
                        try {
                            // Set the hidden field and display text
                            const profileField = document.getElementById('dope_shooting_profile');
                            const selectedText = document.getElementById('selected_profile');
                            
                            if (profileField) {
                                profileField.value = profileId;
                                console.log('Set profile ID:', profileId);
                            }
                            
                            if (selectedText) {
                                selectedText.textContent = `${profile.shooter_name} - ${profile.firearm_name}`;
                                console.log('Set selected text');
                            }

                            // Populate all the ballistic fields with error checking
                            const setFieldValue = (fieldId, value) => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = value || '';
                                    console.log(`Set ${fieldId} to: ${value}`);
                                } else {
                                    console.warn(`Field ${fieldId} not found`);
                                }
                            };
                            
                            // Only rifle-specific data from ballistic_sessions table
                            setFieldValue('shooter_name', profile.shooter_name);
                            setFieldValue('firearm_type', profile.firearm_type);
                            setFieldValue('firearm_name', profile.firearm_name);
                            setFieldValue('rifle_caliber', profile.caliber);
                            setFieldValue('optic_name', profile.optic_name);
                            setFieldValue('barrel_length', profile.barrel_length ? `${profile.barrel_length} inches` : '');
                            setFieldValue('barrel_twist_rate', profile.barrel_twist_rate);
                            setFieldValue('zero_distance', profile.zero_distance ? `${profile.zero_distance} yards` : '');
                            setFieldValue('height_over_bore', profile.height_over_bore ? `${profile.height_over_bore} inches` : '');

                            console.log('Profile data populated successfully');
                        } catch (innerError) {
                            console.error('Error populating fields:', innerError);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error selecting profile:', error);
                    alert('Error selecting profile');
                }
            };

            window.closeProfilePicker = function() {
                const modal = document.getElementById('profilePickerModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.populateFromShootingProfile = function() {
                console.log('Populate from shooting profile');
                // This function is kept for backward compatibility
                // The actual population now happens through showProfilePicker
            };

            window.showBulletPicker = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to access bullet library.');
                        return;
                    }

                    // Load all bullets for the current user
                    const { data: bullets, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error loading bullets:', error);
                        alert('Error loading bullet library');
                        return;
                    }

                    if (!bullets || bullets.length === 0) {
                        alert('No bullets found. Please create some bullets in your library first.');
                        return;
                    }

                    // Create a modal to select from available bullets
                    const bulletHTML = bullets.map(bullet => `
                        <div onclick="selectBullet('${bullet.id}')" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; border-radius: 4px; background-color: #f9f9f9;">
                            <strong>${bullet.manufacturer_name} ${bullet.caliber}</strong><br>
                            <span style="color: #666;">${bullet.grain || 'Unknown'}gr ${bullet.bullet_type || 'Unknown'} - BC: ${bullet.ballistic_coefficient || 'Unknown'}</span>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="bulletPickerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 70vh; overflow-y: auto; width: 90%;">
                                <h3>Select Bullet</h3>
                                <div style="margin: 15px 0;">
                                    ${bulletHTML}
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="closeBulletPicker()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                } catch (error) {
                    console.error('Error in showBulletPicker:', error);
                    alert('Error loading bullet library');
                }
            };

            window.selectBullet = async function(bulletId) {
                try {
                    console.log('Selecting bullet with ID:', bulletId);
                    
                    // Load the selected bullet data
                    const { data: bullet, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('id', bulletId)
                        .single();

                    if (error) {
                        console.error('Error loading bullet:', error);
                        alert('Error loading bullet data');
                        return;
                    }

                    console.log('Bullet data loaded:', bullet);

                    // Close the picker first
                    closeBulletPicker();

                    // Wait a moment for the DOM to update
                    setTimeout(() => {
                        try {
                            // Set the hidden field and display text
                            const bulletField = document.getElementById('bullet_library_id');
                            const selectedText = document.getElementById('selected_bullet');
                            
                            if (bulletField) {
                                bulletField.value = bulletId;
                                console.log('Set bullet ID:', bulletId);
                            }
                            
                            if (selectedText) {
                                selectedText.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain_weight}gr`;
                                console.log('Set selected bullet text');
                            }

                            // Auto-populate bullet-specific fields from bullet_library
                            const setFieldValue = (fieldId, value) => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = value || '';
                                    console.log(`Set ${fieldId} to: ${value}`);
                                } else {
                                    console.warn(`Field ${fieldId} not found`);
                                }
                            };
                            
                            // Ammunition-specific data from bullet_library table
                            setFieldValue('manufacturer_name', bullet.manufacturer_name);
                            setFieldValue('caliber', bullet.caliber);
                            setFieldValue('grain_weight', bullet.grain ? `${bullet.grain}gr` : '');
                            setFieldValue('ballistic_coefficient', bullet.ballistic_coefficient);
                            setFieldValue('drag_model', bullet.drag_model);
                            setFieldValue('bullet_type', bullet.bullet_type);
                            
                            // Update bullet type div with text content
                            const bulletTypeField = document.getElementById('bullet_type');
                            if (bulletTypeField) {
                                // Set text content for div element
                                bulletTypeField.textContent = bullet.bullet_type;
                                bulletTypeField.innerHTML = bullet.bullet_type;
                                
                                // Add visual confirmation
                                bulletTypeField.style.cssText = 'background-color: #e8f5e8 !important; border: 2px solid #dc3545 !important; font-weight: bold !important; width: 100% !important; padding: 8px !important; color: #000000 !important; border-radius: 4px !important; min-height: 20px !important;';
                                
                                console.log('Bullet type div updated to:', bullet.bullet_type);
                                console.log('Div text content:', bulletTypeField.textContent);
                            }
                            
                            // Also update DOPE form bullet type field
                            const dopeBulletTypeField = document.getElementById('dope_bullet_type');
                            if (dopeBulletTypeField) {
                                dopeBulletTypeField.value = bullet.bullet_type;
                                console.log('DOPE bullet type field updated to:', bullet.bullet_type);
                            }
                            setFieldValue('lot_number', bullet.lot_number || '');
                            setFieldValue('muzzle_velocity', bullet.muzzle_velocity ? `${bullet.muzzle_velocity} fps` : '');
                            setFieldValue('muzzle_energy', bullet.muzzle_energy ? `${bullet.muzzle_energy} ft-lbs` : '');

                            console.log('Bullet data populated successfully');
                        } catch (innerError) {
                            console.error('Error populating bullet fields:', innerError);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error selecting bullet:', error);
                    alert('Error selecting bullet');
                }
            };

            window.closeBulletPicker = function() {
                const modal = document.getElementById('bulletPickerModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.populateFromBulletLibrary = function() {
                console.log('Populate from bullet library');
                // This function is kept for backward compatibility
                // The actual population now happens through showBulletPicker
            };

            window.showAddDopeFormDirect = function() {
                console.log('Show add DOPE form direct');
                const dopeContent = document.getElementById('dopeContent');
                if (dopeContent) {
                    // Get current date and time for embedding directly in HTML
                    const now = new Date();
                    const currentDate = now.toISOString().split('T')[0];
                    const currentTime = now.toTimeString().slice(0, 5);
                    
                    dopeContent.innerHTML = `
                        <div style="background-color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <h3>Log New Engagement</h3>
                            
                            <!-- Reference Data Selection -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Profile:</label>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="showFirearmPicker()" style="padding: 8px 15px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer;">Select Firearm</button>
                                    <span id="selected_firearm" style="padding: 8px; color: #666;">None selected</span>
                                </div>
                                <input type="hidden" id="firearm_profile_id" value="">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Bullet Library:</label>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="showBulletPicker()" style="padding: 8px 15px; border: 1px solid #28a745; background-color: #28a745; color: white; border-radius: 4px; cursor: pointer;">Select Bullet</button>
                                    <span id="selected_bullet" style="padding: 8px; color: #666;">None selected</span>
                                </div>
                                <input type="hidden" id="bullet_library_id" value="">
                            </div>
                            
                            <!-- Primary Engagement Data -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Engagement Date:</label>
                                <input type="date" id="engagement_date" required value="${currentDate}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Engagement Time:</label>
                                <input type="time" id="engagement_time" value="${currentTime}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Location Data -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location Name:</label>
                                <input type="text" id="location_name" placeholder="Shooting location name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Latitude:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="latitude" step="0.000001" placeholder="e.g., 40.7128" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="latitude_direction" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="N" selected>N</option>
                                        <option value="S">S</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Longitude:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="longitude" step="0.000001" placeholder="e.g., -74.0060" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="longitude_direction" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="E">E</option>
                                        <option value="W" selected>W</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Auto-populated fields from selected profile/bullet -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Shooter Name:</label>
                                <input type="text" id="shooter_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            

                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Type:</label>
                                <input type="text" id="firearm_type" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Name:</label>
                                <input type="text" id="firearm_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Rifle Caliber:</label>
                                <input type="text" id="rifle_caliber" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Length:</label>
                                <input type="text" id="barrel_length" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Twist Rate:</label>
                                <input type="text" id="barrel_twist_rate" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Name:</label>
                                <input type="text" id="optic_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Zero Distance:</label>
                                <input type="text" id="zero_distance" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Height Over Bore:</label>
                                <input type="text" id="height_over_bore" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <!-- Bullet-specific fields from bullet_library table -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Manufacturer Name:</label>
                                <input type="text" id="manufacturer_name" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Caliber:</label>
                                <input type="text" id="caliber" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Grain Weight:</label>
                                <input type="text" id="grain_weight" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ballistic Coefficient:</label>
                                <input type="text" id="ballistic_coefficient" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Drag Model:</label>
                                <input type="text" id="drag_model" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lot Number:</label>
                                <input type="text" id="lot_number" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Bullet Type:</label>
                                <input type="text" id="dope_bullet_type" readonly value="Not selected" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Muzzle Velocity:</label>
                                <input type="text" id="muzzle_velocity" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Muzzle Energy:</label>
                                <input type="text" id="muzzle_energy" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;">
                            </div>
                            
                            <!-- Range Data -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Range to Target:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="range_to_target" step="0.01" placeholder="Distance" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="range_unit" required style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="yards" selected>Yards</option>
                                        <option value="meters">Meters</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Wind Conditions -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Wind Speed:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="wind_speed" step="0.1" placeholder="Speed" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="wind_speed_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="mph" selected>mph</option>
                                        <option value="kph">kph</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Wind Direction (degrees):</label>
                                <input type="number" id="wind_direction" min="0" max="360" step="0.1" placeholder="0-360" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Wind Type:</label>
                                <select id="wind_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Type</option>
                                    <option value="Crosswind">Crosswind</option>
                                    <option value="Headwind">Headwind</option>
                                    <option value="Tailwind">Tailwind</option>
                                </select>
                            </div>
                            


                            <!-- Temperature -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Temperature:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="temperature" step="0.1" placeholder="Temperature" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="temperature_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Unit</option>
                                        <option value="C">Celsius</option>
                                        <option value="F" selected>Fahrenheit</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Additional Environmental Fields -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Humidity (%):</label>
                                <input type="number" id="humidity" min="0" max="100" step="0.1" placeholder="Relative humidity percentage" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barometric Pressure:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="barometric_pressure" step="0.01" placeholder="Pressure" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="pressure_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Unit</option>
                                        <option value="inHg" selected>inHg</option>
                                        <option value="mb">mb</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Altitude:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="altitude" step="0.1" placeholder="Elevation" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="altitude_reference" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Reference</option>
                                        <option value="ASL" selected>Above Sea Level</option>
                                        <option value="BSL">Below Sea Level</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Angle of Fire (degrees):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="angle_of_fire" min="-90" max="90" step="0.1" placeholder="Uphill/downhill angle" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="angle_direction" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Direction</option>
                                        <option value="Uphill">Uphill</option>
                                        <option value="Downhill">Downhill</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Ballistic Effects -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Coriolis Effect (mils/MOA):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="coriolis_effect" step="0.001" placeholder="Coriolis compensation" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="coriolis_direction" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Direction</option>
                                        <option value="Left">Left</option>
                                        <option value="Right">Right</option>
                                    </select>
                                    <select id="coriolis_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="MOA" selected>MOA</option>
                                        <option value="MILS">MILS</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Spin Drift (mils/MOA):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="spin_drift" step="0.001" placeholder="Spin drift compensation" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="spin_drift_direction" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Direction</option>
                                        <option value="Left">Left</option>
                                        <option value="Right">Right</option>
                                    </select>
                                    <select id="spin_drift_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="MOA" selected>MOA</option>
                                        <option value="MILS">MILS</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Target Movement -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Speed (mph/kph):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="target_movement_speed" step="0.1" placeholder="Target movement speed" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="target_speed_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="mph" selected>mph</option>
                                        <option value="kph">kph</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Direction (degrees):</label>
                                <input type="number" id="target_movement_direction" min="0" max="360" step="0.1" placeholder="Direction of target movement" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Optic Settings -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Magnification:</label>
                                <input type="number" id="optic_magnification" step="0.1" placeholder="Scope magnification setting" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Adjustment Units:</label>
                                <select id="optic_adjustment_units" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="MOA" selected>MOA</option>
                                    <option value="MRAD">MRAD</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Parallax Setting (yards/meters):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="parallax_setting" step="0.1" placeholder="Parallax focus distance" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <select id="parallax_unit" style="width: auto; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="Yards" selected>Yards</option>
                                        <option value="Meters">Meters</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Time and Conditions -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Time of Flight (seconds):</label>
                                <input type="number" id="time_of_flight" step="0.001" placeholder="Bullet flight time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Atmospheric Conditions:</label>
                                <select id="atmospheric_conditions" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Conditions</option>
                                    <option value="Clear">Clear</option>
                                    <option value="Overcast">Overcast</option>
                                    <option value="Rain">Rain</option>
                                    <option value="Snow">Snow</option>
                                    <option value="Fog">Fog</option>
                                    <option value="Hazy">Hazy</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Light Conditions:</label>
                                <select id="light_conditions" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Lighting</option>
                                    <option value="Bright Sun">Bright Sun</option>
                                    <option value="Overcast">Overcast</option>
                                    <option value="Dawn">Dawn</option>
                                    <option value="Dusk">Dusk</option>
                                    <option value="Low Light">Low Light</option>
                                    <option value="Artificial Light">Artificial Light</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Condition:</label>
                                <select id="barrel_condition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select Condition</option>
                                    <option value="Cold Bore">Cold Bore</option>
                                    <option value="Warm">Warm</option>
                                    <option value="Hot">Hot</option>
                                    <option value="Fouled">Fouled</option>
                                    <option value="Clean">Clean</option>
                                </select>
                            </div>
                            
                            <!-- Engagement Outcome -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Engagement Outcome:</label>
                                <input type="text" id="engagement_outcome" placeholder="e.g. Hit center, Miss high, First round hit" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Notes -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes:</label>
                                <textarea id="engagement_notes" placeholder="Additional notes about the engagement..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <button onclick="saveDopeEngagement()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Save Engagement</button>
                            <button onclick="cancelDopeForm()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        </div>
                    `;
                    
                    // Load dropdowns and prepare form
                    setTimeout(() => {
                        loadDopeDropdownsDirect();
                        console.log('Date and time embedded directly in HTML');
                    }, 50);
                }
            };



            // Caliber picker functionality
            let currentCaliberData = [];
            let currentPickerTarget = null;

            window.showCaliberPicker = async function(targetType) {
                currentPickerTarget = targetType;
                
                if (targetType === 'bullet') {
                    document.getElementById('caliberPickerTitle').textContent = 'Select Bullet Caliber';
                } else if (targetType === 'firearm') {
                    document.getElementById('caliberPickerTitle').textContent = 'Select Firearm Caliber';
                }
                
                document.getElementById('caliberPickerModal').style.display = 'block';
                document.getElementById('caliberTypeFilter').value = '';
                
                await loadCaliberData(targetType);
            };

            window.closeCaliberPicker = function() {
                document.getElementById('caliberPickerModal').style.display = 'none';
                currentPickerTarget = null;
                currentCaliberData = [];
            };

            window.loadCaliberData = async function(targetType) {
                try {
                    const tableName = targetType === 'bullet' ? 'bullet_calibers' : 'firearm_calibers';
                    
                    const { data, error } = await supabase
                        .from(tableName)
                        .select('*')
                        .order(targetType === 'bullet' ? 'bullet_caliber_name' : 'caliber_imperial');
                    
                    if (error) {
                        console.error('Error loading caliber data:', error);
                        document.getElementById('caliberTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Error loading calibers</td></tr>';
                        return;
                    }
                    
                    currentCaliberData = data;
                    displayCaliberData(data);
                    
                    // Populate the type filter dropdown with actual types from the data
                    const typeFilter = document.getElementById('caliberTypeFilter');
                    const uniqueTypes = [...new Set(data.map(caliber => caliber.bullet_type || caliber.firearm_type))].sort();
                    
                    typeFilter.innerHTML = '<option value="">All Types</option>' + 
                        uniqueTypes.map(type => `<option value="${type}">${type}</option>`).join('');
                    
                } catch (error) {
                    console.error('Error in loadCaliberData:', error);
                    document.getElementById('caliberTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Error loading calibers</td></tr>';
                }
            };

            window.displayCaliberData = function(data) {
                const tbody = document.getElementById('caliberTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No calibers found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(caliber => {
                    const type = caliber.bullet_type || caliber.firearm_type;
                    const name = caliber.bullet_caliber_name || caliber.caliber_imperial;
                    const metric = caliber.metric_equivalent || caliber.metric_name || '-';
                    const notes = caliber.notes || '-';
                    
                    return `
                        <tr style="cursor: pointer;" onclick="selectCaliber('${name}')">
                            <td style="padding: 8px; border: 1px solid #ddd;">${type}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${name}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${metric}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.9em;">${notes}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                <button onclick="selectCaliber('${name}')" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Select</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            window.filterCalibersByType = function() {
                const selectedType = document.getElementById('caliberTypeFilter').value;
                
                if (!selectedType) {
                    displayCaliberData(currentCaliberData);
                    return;
                }
                
                const filtered = currentCaliberData.filter(caliber => {
                    const type = caliber.bullet_type || caliber.firearm_type;
                    return type === selectedType;
                });
                
                displayCaliberData(filtered);
            };

            window.selectCaliber = function(caliberName) {
                if (currentPickerTarget === 'bullet') {
                    document.getElementById('bullet_caliber_direct').value = caliberName;
                } else if (currentPickerTarget === 'firearm') {
                    // Handle both new and edit forms
                    const newFormField = document.getElementById('firearm_caliber');
                    const editFormField = document.getElementById('edit_firearm_caliber');
                    
                    if (newFormField) {
                        newFormField.value = caliberName;
                    }
                    if (editFormField) {
                        editFormField.value = caliberName;
                    }
                }
                
                closeCaliberPicker();
            };

            window.loadEnvironmentalDefaults = async function() {
                try {
                    // Get current user the same way other DOPE functions do
                    const currentUser = (await supabase.auth.getUser()).data.user;
                    if (!currentUser) {
                        console.log('No current user, skipping environmental defaults load');
                        return;
                    }
                    
                    console.log('Loading environmental defaults for DOPE form, user ID:', currentUser.id);
                    
                    const { data, error } = await supabase
                        .from('user_preferences')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') {
                        console.error('Error loading environmental defaults:', error);
                        return;
                    }
                    
                    if (data) {
                        console.log('Applying environmental defaults from user preferences:', data);
                        console.log('Exact values from database:');
                        console.log('- Temperature:', data.default_temperature);
                        console.log('- Temperature Unit:', data.default_temperature_unit);
                        console.log('- Humidity:', data.default_humidity);
                        console.log('- Pressure:', data.default_pressure);
                        console.log('- Pressure Unit:', data.default_pressure_unit);
                        console.log('- Altitude:', data.default_altitude);
                        console.log('- Altitude Reference:', data.default_altitude_reference);
                        
                        // Auto-populate temperature if available
                        if (data.default_temperature) {
                            const tempField = document.getElementById('temperature');
                            console.log('Temperature field found:', !!tempField, 'Setting value:', data.default_temperature);
                            if (tempField) {
                                tempField.removeAttribute('placeholder');
                                tempField.value = data.default_temperature;
                                tempField.setAttribute('value', data.default_temperature);
                                tempField.style.color = '#000';
                                tempField.style.fontWeight = 'bold';
                                tempField.dispatchEvent(new Event('input', { bubbles: true }));
                                tempField.dispatchEvent(new Event('change', { bubbles: true }));
                                console.log('Temperature field value after setting:', tempField.value);
                            }
                        }
                        
                        if (data.default_temperature_unit) {
                            const tempUnitField = document.getElementById('temperature_unit');
                            console.log('Temperature unit field found:', !!tempUnitField, 'Setting value:', data.default_temperature_unit);
                            if (tempUnitField) {
                                tempUnitField.value = data.default_temperature_unit;
                                console.log('Temperature unit field value after setting:', tempUnitField.value);
                            }
                        }
                        
                        // Auto-populate humidity if available
                        if (data.default_humidity) {
                            const humidityField = document.getElementById('humidity');
                            console.log('Humidity field found:', !!humidityField, 'Setting value:', data.default_humidity);
                            if (humidityField) {
                                humidityField.removeAttribute('placeholder');
                                humidityField.value = data.default_humidity;
                                humidityField.setAttribute('value', data.default_humidity);
                                humidityField.style.color = '#000';
                                humidityField.style.fontWeight = 'bold';
                                humidityField.dispatchEvent(new Event('input', { bubbles: true }));
                                humidityField.dispatchEvent(new Event('change', { bubbles: true }));
                                console.log('Humidity field value after setting:', humidityField.value);
                            }
                        }
                        
                        // Auto-populate pressure if available (note: user_preferences uses 'default_pressure', DOPE form uses 'barometric_pressure')
                        if (data.default_pressure) {
                            const pressureField = document.getElementById('barometric_pressure');
                            console.log('Pressure field found:', !!pressureField, 'Setting value:', data.default_pressure);
                            if (pressureField) {
                                pressureField.removeAttribute('placeholder');
                                pressureField.value = data.default_pressure;
                                pressureField.setAttribute('value', data.default_pressure);
                                pressureField.style.color = '#000';
                                pressureField.style.fontWeight = 'bold';
                                pressureField.dispatchEvent(new Event('input', { bubbles: true }));
                                pressureField.dispatchEvent(new Event('change', { bubbles: true }));
                                console.log('Pressure field value after setting:', pressureField.value);
                            }
                        }
                        
                        if (data.default_pressure_unit) {
                            const pressureUnitField = document.getElementById('pressure_unit');
                            console.log('Pressure unit field found:', !!pressureUnitField, 'Setting value:', data.default_pressure_unit);
                            if (pressureUnitField) {
                                pressureUnitField.value = data.default_pressure_unit;
                                console.log('Pressure unit field value after setting:', pressureUnitField.value);
                            }
                        }
                        
                        // Auto-populate altitude if available
                        if (data.default_altitude) {
                            const altitudeField = document.getElementById('altitude');
                            console.log('Altitude field found:', !!altitudeField, 'Setting value:', data.default_altitude);
                            if (altitudeField) {
                                altitudeField.removeAttribute('placeholder');
                                altitudeField.value = data.default_altitude;
                                altitudeField.setAttribute('value', data.default_altitude);
                                altitudeField.style.color = '#000';
                                altitudeField.style.fontWeight = 'bold';
                                altitudeField.dispatchEvent(new Event('input', { bubbles: true }));
                                altitudeField.dispatchEvent(new Event('change', { bubbles: true }));
                                console.log('Altitude field value after setting:', altitudeField.value);
                            }
                        }
                        
                        if (data.default_altitude_reference) {
                            const altitudeRefField = document.getElementById('altitude_reference');
                            console.log('Altitude reference field found:', !!altitudeRefField, 'Setting value:', data.default_altitude_reference);
                            if (altitudeRefField) {
                                altitudeRefField.value = data.default_altitude_reference;
                                console.log('Altitude reference field value after setting:', altitudeRefField.value);
                            }
                        }
                        
                        console.log('Environmental defaults applied successfully');
                        
                        // Verify the values are still there and try alternative display method
                        setTimeout(() => {
                            console.log('Verifying environmental values are still in form:');
                            console.log('- Temperature field value:', document.getElementById('temperature')?.value);
                            console.log('- Humidity field value:', document.getElementById('humidity')?.value);
                            console.log('- Pressure field value:', document.getElementById('barometric_pressure')?.value);
                            console.log('- Altitude field value:', document.getElementById('altitude')?.value);
                            
                            // Force visual update by temporarily focusing and blurring fields
                            const envFields = ['temperature', 'humidity', 'barometric_pressure', 'altitude'];
                            envFields.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field && field.value) {
                                    field.focus();
                                    field.select();
                                    field.blur();
                                    field.style.backgroundColor = '#e8f5e8';
                                    console.log(`Force-updated ${fieldId} display with value:`, field.value);
                                }
                            });
                        }, 500);
                    } else {
                        console.log('No user preferences found, using form defaults');
                    }
                    
                } catch (error) {
                    console.error('Error in loadEnvironmentalDefaults:', error);
                }
            };

            window.cancelDopeForm = function() {
                const dopeContent = document.getElementById('dopeContent');
                if (dopeContent) {
                    dopeContent.innerHTML = 'Loading your engagements...';
                    setTimeout(() => loadDopeEngagementsDirect(), 100);
                }
            };

            window.saveDopeEngagement = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to save engagement data.');
                        return;
                    }

                    // Capture values using event target approach - get the button that was clicked
                    const saveButton = event.target;
                    const formContainer = saveButton.closest('div');
                    
                    // Function to find field values within the form container
                    const getFieldValueDirect = (id) => {
                        const element = formContainer.querySelector(`#${id}`);
                        if (!element) {
                            console.warn(`Field ${id} not found in form container`);
                            return null;
                        }
                        
                        if (element.tagName === 'SELECT') {
                            return element.options[element.selectedIndex]?.value || null;
                        }
                        return element.value?.trim() || null;
                    };
                    
                    // Quick validation with direct field access
                    const engagementDate = getFieldValueDirect('engagement_date');
                    const rangeTarget = getFieldValueDirect('range_to_target');
                    const rangeUnit = getFieldValueDirect('range_unit');
                    
                    console.log('Direct field capture:', {
                        engagementDate,
                        rangeTarget,
                        rangeUnit
                    });

                    if (!engagementDate) {
                        alert('Please fill in the engagement date.');
                        return;
                    }
                    
                    if (!rangeTarget || parseFloat(rangeTarget) <= 0) {
                        alert('Please enter a valid range to target.');
                        return;
                    }
                    
                    if (!rangeUnit) {
                        alert('Please select a range unit.');
                        return;
                    }


                    // Debug the dropdown values  
                    const firearmlValue = getFieldValueDirect('firearm_profile_id');
                    const bulletValue = getFieldValueDirect('bullet_library_id');
                    
                    // Additional debugging - check if elements exist
                    const firearmElement = document.getElementById('firearm_profile_id');
                    const bulletElement = document.getElementById('bullet_library_id');
                    
                    console.log('Debug dropdown values:', {
                        firearm: firearmlValue,
                        firearmType: typeof firearmlValue,
                        bullet: bulletValue,
                        bulletType: typeof bulletValue,
                        firearmElementExists: !!firearmElement,
                        bulletElementExists: !!bulletElement,
                        firearmElementValue: firearmElement?.value,
                        bulletElementValue: bulletElement?.value
                    });

                    // Validate foreign key values
                    if (!firearmlValue) {
                        alert('Please select a firearm profile before saving.');
                        return;
                    }
                    if (!bulletValue) {
                        alert('Please select a bullet before saving.');
                        return;
                    }

                    const dopeData = {
                        user_id: currentUser.id,
                        firearm_profile_id: firearmlValue,
                        bullet_library_id: parseInt(bulletValue) || null,
                        engagement_date: engagementDate,
                        engagement_time: getFieldValueDirect('engagement_time'),
                        // Location data
                        location_name: getFieldValueDirect('location_name'),
                        longitude: parseFloat(getFieldValueDirect('longitude')) || null,
                        longitude_direction: getFieldValueDirect('longitude_direction'),
                        latitude: parseFloat(getFieldValueDirect('latitude')) || null,
                        latitude_direction: getFieldValueDirect('latitude_direction'),
                        range_to_target: parseFloat(rangeTarget),
                        range_unit: rangeUnit,
                        // Wind conditions
                        wind_speed: parseFloat(getFieldValueDirect('wind_speed')) || null,
                        wind_speed_direction: getFieldValueDirect('wind_speed_unit'),
                        wind_direction: parseFloat(getFieldValueDirect('wind_direction')) || null,
                        wind_type: getFieldValueDirect('wind_type'),
                        // Temperature
                        temperature: parseFloat(getFieldValueDirect('temperature')) || null,
                        temperature_unit: getFieldValueDirect('temperature_unit'),
                        // Environmental data
                        humidity: parseFloat(getFieldValueDirect('humidity')) || null,
                        barometric_pressure: parseFloat(getFieldValueDirect('barometric_pressure')) || null,
                        pressure_unit: getFieldValueDirect('pressure_unit'),
                        altitude: parseFloat(getFieldValueDirect('altitude')) || null,
                        altitude_reference: getFieldValueDirect('altitude_reference'),
                        angle_of_fire: parseFloat(getFieldValueDirect('angle_of_fire')) || null,
                        angle_direction: getFieldValueDirect('angle_direction'),
                        // Ballistic effects
                        coriolis_effect: parseFloat(getFieldValueDirect('coriolis_effect')) || null,
                        coriolis_direction: getFieldValueDirect('coriolis_direction'),
                        coriolis_unit: getFieldValueDirect('coriolis_unit'),
                        spin_drift: parseFloat(getFieldValueDirect('spin_drift')) || null,
                        spin_drift_direction: getFieldValueDirect('spin_drift_direction'),
                        spin_drift_unit: getFieldValueDirect('spin_drift_unit'),
                        // Target movement
                        target_movement_speed: parseFloat(getFieldValueDirect('target_movement_speed')) || null,
                        target_speed_unit: getFieldValueDirect('target_speed_unit'),
                        target_movement_direction: parseFloat(getFieldValueDirect('target_movement_direction')) || null,
                        // Optic settings
                        optic_magnification: parseFloat(getFieldValueDirect('optic_magnification')) || null,
                        optic_adjustment_units: getFieldValueDirect('optic_adjustment_units'),
                        parallax_setting: parseFloat(getFieldValueDirect('parallax_setting')) || null,
                        parallax_unit: getFieldValueDirect('parallax_unit'),
                        // Time and conditions
                        time_of_flight: parseFloat(getFieldValueDirect('time_of_flight')) || null,
                        atmospheric_conditions: getFieldValueDirect('atmospheric_conditions'),
                        light_conditions: getFieldValueDirect('light_conditions'),
                        barrel_condition: getFieldValueDirect('barrel_condition'),
                        // Outcome and notes
                        engagement_outcome: getFieldValueDirect('engagement_outcome'),
                        notes: getFieldValueDirect('engagement_notes')
                    };

                    console.log('About to save DOPE data:', dopeData);

                    let data, error;
                    
                    // Check if we're editing an existing engagement
                    if (window.editingEngagementId) {
                        const result = await supabase
                            .from('dope_engagements')
                            .update(dopeData)
                            .eq('id', window.editingEngagementId)
                            .select();
                        data = result.data;
                        error = result.error;
                        window.editingEngagementId = null; // Clear editing mode
                    } else {
                        const result = await supabase
                            .from('dope_engagements')
                            .insert([dopeData])
                            .select();
                        data = result.data;
                        error = result.error;
                    }

                    if (error) {
                        console.error('Error saving DOPE engagement:', error);
                        console.error('Full error details:', error);
                        alert(`Error saving engagement: ${error.message || 'Unknown error'}. Please try again.`);
                    } else {
                        console.log('DOPE engagement saved successfully:', data);
                        alert('Engagement saved successfully!');
                        setTimeout(() => loadDopeEngagementsDirect(), 200);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving engagement. Please try again.');
                }
            };

            window.loadDopeEngagementsDirect = async function() {
                try {
                    console.log('loadDopeEngagementsDirect called');
                    
                    if (!currentUser) {
                        console.log('No current user, skipping load');
                        return;
                    }

                    // Use the same supabase constant as other working functions
                    const { data, error } = await supabase
                        .from('dope_engagements')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('engagement_date', { ascending: false });

                    const dopeContent = document.getElementById('dopeContent');
                    if (!dopeContent) return;

                    if (error) {
                        console.error('Error loading DOPE engagements:', error);
                        dopeContent.innerHTML = '<p>Error loading engagements. Please try again.</p>';
                        return;
                    }

                    if (data && data.length > 0) {
                        let tableHTML = `
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Time</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Range</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Wind</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Altitude</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Humidity</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Barometric Pressure</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.forEach(engagement => {
                            tableHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.engagement_date}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.engagement_time || 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.range_to_target} ${engagement.range_unit}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.wind_speed !== null && engagement.wind_speed !== undefined ? `${engagement.wind_speed} ${engagement.wind_type || ''}` : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.altitude !== null && engagement.altitude !== undefined ? `${engagement.altitude} ${engagement.altitude_reference || 'ASL'}` : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.humidity !== null && engagement.humidity !== undefined ? `${engagement.humidity}%` : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${engagement.barometric_pressure !== null && engagement.barometric_pressure !== undefined ? `${engagement.barometric_pressure} ${engagement.pressure_unit || 'inHg'}` : 'N/A'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <button onclick="viewDopeEngagement('${engagement.id}')" style="background-color: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">View</button>
                                        <button onclick="editDopeEngagement('${engagement.id}')" style="background-color: #17a2b8; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteDopeEngagement('${engagement.id}')" style="background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });

                        tableHTML += '</tbody></table>';
                        dopeContent.innerHTML = tableHTML;
                    } else {
                        dopeContent.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No engagements logged yet. Click "Log New Engagement" to get started!</p>';
                    }
                } catch (error) {
                    console.error('Error loading DOPE engagements:', error);
                }
            };

            window.deleteDopeEngagement = async function(engagementId) {
                if (!confirm('Are you sure you want to delete this engagement?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('dope_engagements')
                        .delete()
                        .eq('id', engagementId)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error deleting engagement:', error);
                        alert('Error deleting engagement. Please try again.');
                    } else {
                        loadDopeEngagementsDirect();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting engagement. Please try again.');
                }
            };

            window.loadDopeDropdownsDirect = async function() {
                console.log('loadDopeDropdownsDirect called');
                try {
                    const currentUser = (await supabase.auth.getUser()).data.user;
                    if (!currentUser) {
                        console.log('No current user for dropdowns');
                        alert('Please log in to access your shooting profiles and bullets.');
                        return;
                    }

                    console.log('Loading firearm profiles for DOPE...');
                    // Load firearm profiles
                    const { data: profiles, error: profileError } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('shooter_name', { ascending: true });

                    if (profileError) {
                        console.error('Profile error:', profileError);
                        window.loadedProfiles = [];
                    } else {
                        console.log('Profiles loaded for DOPE:', profiles);
                        console.log('Number of profiles found:', profiles?.length || 0);
                        // Store profiles for picker button
                        window.loadedProfiles = profiles || [];
                        const profileSelect = document.getElementById('dope_shooting_profile');
                        console.log('Profile select element:', profileSelect);
                        if (profileSelect) {
                            console.log('About to populate profiles...');
                            // Test with simple static options first to confirm dropdown works
                            profileSelect.innerHTML = `
                                <option value="">Select a shooting profile...</option>
                                <option value="test1">Test Profile 1</option>
                                <option value="test2">Test Profile 2</option>
                            `;
                            
                            // Then add real data immediately after
                            setTimeout(() => {
                                let html = '<option value="">Select a shooting profile...</option>';
                                profiles.forEach(profile => {
                                    html += `<option value="${profile.id}">${profile.shooter_name} - ${profile.firearm_name} (${profile.caliber})</option>`;
                                });
                                profileSelect.innerHTML = html;
                                console.log('Final profile HTML:', profileSelect.innerHTML.length, 'characters');
                            }, 100);
                            console.log('Profile dropdown HTML set:', profileSelect.innerHTML.substring(0, 200));
                            console.log('Profile dropdown now has', profileSelect.children.length, 'total options');
                        } else {
                            console.log('Profile select element not found - checking page...');
                            console.log('All selects on page:', document.querySelectorAll('select'));
                        }
                    }

                    console.log('Loading bullet library for DOPE...');
                    // Load bullet library
                    const { data: bullets, error: bulletError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (bulletError) {
                        console.error('Bullet error:', bulletError);
                    } else {
                        console.log('Bullets loaded for DOPE:', bullets);
                        // Store bullets for picker button
                        window.loadedBullets = bullets;
                        const bulletSelect = document.getElementById('dope_bullet_library');
                        if (bulletSelect) {
                            bulletSelect.innerHTML = '<option value="">Select a bullet...</option>';
                            
                            if (bullets && bullets.length > 0) {
                                bullets.forEach(bullet => {
                                    const option = document.createElement('option');
                                    option.value = bullet.id;
                                    option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr`;
                                    option.style.color = 'black';
                                    option.style.backgroundColor = 'white';
                                    bulletSelect.appendChild(option);
                                });
                            }
                            
                            console.log('Bullet dropdown populated with', bullets ? bullets.length : 0, 'items');
                            console.log('Bullet dropdown now has', bulletSelect.children.length, 'total options');
                        } else {
                            console.log('Bullet select element not found');
                        }
                    }
                } catch (error) {
                    console.error('Error loading DOPE dropdowns:', error);
                }
            };

            // Store loaded data for picker buttons
            window.loadedProfiles = [];
            window.loadedBullets = [];

            // Zero Profile dropdown functions
            window.loadZeroProfileDropdowns = async function() {
                console.log('Loading Zero Profile dropdowns...');
                try {
                    if (!currentUser) {
                        console.log('No current user, skipping dropdown load');
                        return;
                    }

                    // Check user access before loading any data
                    const hasAccess = await checkUserAccess();
                    if (!hasAccess) {
                        return;
                    }

                    console.log('Current user:', currentUser.id);

                    // Load firearm library data
                    console.log('Loading firearms...');
                    const { data: firearms, error: firearmError } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('profile_name', { ascending: true });

                    console.log('Firearms loaded for dropdowns:', firearms, 'Error:', firearmError);

                    if (!firearmError && firearms) {
                        const firearmSelect = document.getElementById('zeroFirearmSelect');
                        console.log('Firearm select element:', firearmSelect);
                        if (firearmSelect) {
                            firearmSelect.innerHTML = '<option value="">Optional</option>';
                            firearms.forEach(firearm => {
                                const option = document.createElement('option');
                                option.value = firearm.id;
                                option.textContent = `${firearm.firearm_name} ${firearm.barrel_length}" ${firearm.caliber} ${firearm.barrel_twist_rate} ${firearm.optic_name} ${firearm.zero_distance}yds`;
                                firearmSelect.appendChild(option);
                            });
                            console.log('Populated firearm dropdown with', firearms.length, 'items');
                        }
                    }

                    // Load bullet library data
                    console.log('Loading bullets...');
                    const { data: bullets, error: bulletError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    console.log('Bullets loaded:', bullets, 'Error:', bulletError);

                    if (!bulletError && bullets) {
                        const bulletSelect = document.getElementById('zeroBulletSelect');
                        console.log('Bullet select element:', bulletSelect);
                        if (bulletSelect) {
                            bulletSelect.innerHTML = '<option value="">Optional</option>';
                            bullets.forEach(bullet => {
                                const option = document.createElement('option');
                                option.value = bullet.id;
                                option.textContent = `${bullet.manufacturer_name} ${bullet.caliber} ${bullet.grain}gr - BC: ${bullet.ballistic_coefficient}`;
                                bulletSelect.appendChild(option);
                            });
                            console.log('Populated bullet dropdown with', bullets.length, 'items');
                        }
                    }
                } catch (error) {
                    console.error('Error loading Zero Profile dropdowns:', error);
                }
            };

            window.loadZeroFirearmData = async function() {
                const firearmSelect = document.getElementById('zeroFirearmSelect');
                const firearmId = firearmSelect.value;
                
                if (!firearmId) return;

                try {
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) throw error;

                    // Populate firearm fields
                    const form = document.getElementById('ballisticForm');
                    if (firearm.shooter_name) form.querySelector('[name="shooter_name"]').value = firearm.shooter_name;
                    if (firearm.firearm_type) form.querySelector('[name="firearm_type"]').value = firearm.firearm_type;
                    if (firearm.firearm_name) form.querySelector('[name="firearm_name"]').value = firearm.firearm_name;
                    if (firearm.optic_name) form.querySelector('[name="optic_name"]').value = firearm.optic_name;
                    if (firearm.caliber) form.querySelector('[name="caliber"]').value = firearm.caliber;
                    if (firearm.barrel_length) form.querySelector('[name="barrel_length"]').value = firearm.barrel_length;
                    if (firearm.barrel_twist_rate) form.querySelector('[name="barrel_twist_rate"]').value = firearm.barrel_twist_rate;
                    if (firearm.muzzle_velocity) form.querySelector('[name="muzzle_velocity"]').value = firearm.muzzle_velocity;
                    if (firearm.muzzle_energy) form.querySelector('[name="muzzle_energy"]').value = firearm.muzzle_energy;
                    if (firearm.zero_distance) form.querySelector('[name="zero_distance"]').value = firearm.zero_distance;
                    if (firearm.height_over_bore) form.querySelector('[name="height_over_bore"]').value = firearm.height_over_bore;

                } catch (error) {
                    console.error('Error loading firearm data:', error);
                    alert('Error loading firearm data. Please try again.');
                }
            };

            window.loadZeroBulletData = async function() {
                const bulletSelect = document.getElementById('zeroBulletSelect');
                const bulletId = bulletSelect.value;
                
                if (!bulletId) return;

                try {
                    const { data: bullet, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('id', bulletId)
                        .single();

                    if (error) throw error;

                    console.log('Bullet data loaded:', bullet);

                    // Populate bullet fields
                    const form = document.getElementById('ballisticForm');
                    
                    // Set bullet caliber from the caliber field in the database
                    if (bullet.caliber) {
                        form.querySelector('[name="bullet_caliber"]').value = bullet.caliber;
                        console.log('Set bullet_caliber to:', bullet.caliber);
                    }
                    
                    if (bullet.grain) form.querySelector('[name="bullet_grain"]').value = bullet.grain;
                    if (bullet.ballistic_coefficient) form.querySelector('[name="ballistic_coefficient"]').value = bullet.ballistic_coefficient;
                    if (bullet.drag_model) form.querySelector('[name="drag_model"]').value = bullet.drag_model;
                    if (bullet.muzzle_velocity) form.querySelector('[name="muzzle_velocity"]').value = bullet.muzzle_velocity;
                    if (bullet.muzzle_energy) form.querySelector('[name="muzzle_energy"]').value = bullet.muzzle_energy;

                } catch (error) {
                    console.error('Error loading bullet data:', error);
                    alert('Error loading bullet data. Please try again.');
                }
            };
            
            // This old function has been replaced by the new showProfilePicker above
            
            // Old duplicate functions have been removed

            // Zero Profile Functions
            window.showZeroProfile = async function() {
                // Check user access before showing the page
                const hasAccess = await checkUserAccess();
                if (!hasAccess) {
                    return;
                }

                document.getElementById('homePage').style.display = 'none';
                document.getElementById('shootingProfileSection').style.display = 'block';
                
                // Hide other sections
                const hideElement = (id) => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                };
                hideElement('firearmLibrarySection');
                hideElement('bulletLibrarySection');
                hideElement('activeDopeSection');
                
                // Load the dropdowns with a slight delay to ensure DOM is ready
                setTimeout(() => {
                    loadZeroProfileDropdowns();
                }, 100);
            };

            // Firearm Library Functions - Following exact pattern from working bullet library
            window.showFirearmLibrary = function() {
                console.log('showFirearmLibrary function called');
                
                // Hide all other sections
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('shootingProfileSection').style.display = 'none';
                
                const hideElement = (id) => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                };
                hideElement('bulletLibrarySection');
                hideElement('filterSection');
                hideElement('ballisticForm');
                hideElement('compareForm');
                hideElement('compareResults');
                hideElement('addBulletForm');
                hideElement('activeBulletLibrary');
                hideElement('activeDopeSection');
                
                // Create firearm library directly in the main app content (exact pattern from bullet library)
                const appContent = document.getElementById('appContent');
                const firearmContent = document.createElement('div');
                firearmContent.id = 'activeFirearmLibrary';
                firearmContent.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button onclick="showHomePage()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">🏠 Home</button>
                        <h2 style="margin: 0;">Firearm Library</h2>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="showAddFirearmForm()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Add New Firearm</button>
                    </div>

                    <div id="addFirearmForm" style="display: none; background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <h3>Add New Firearm Profile</h3>
                        <form id="firearmForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Profile Name:</label>
                                    <input type="text" name="profile_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Shooter Name:</label>
                                    <input type="text" name="shooter_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Type:</label>
                                    <select name="firearm_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                        <option value="">Select</option>
                                        <option value="Rifle">Rifle</option>
                                        <option value="Pistol">Pistol</option>
                                        <option value="Shotgun">Shotgun</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Name:</label>
                                    <input type="text" name="firearm_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Caliber:</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="firearm_caliber" name="caliber" placeholder="Selected caliber will appear here" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;" required>
                                        <button type="button" onclick="showCaliberPicker('firearm')" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Select Caliber</button>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Length (inches):</label>
                                    <input type="number" name="barrel_length" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Twist Rate:</label>
                                    <select name="barrel_twist_rate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select Twist Rate</option>
                                        <option value="1:7">1:7</option>
                                        <option value="1:8">1:8</option>
                                        <option value="1:9">1:9</option>
                                        <option value="1:9.25">1:9.25</option>
                                        <option value="1:10">1:10</option>
                                        <option value="1:10.5">1:10.5</option>
                                        <option value="1:11">1:11</option>
                                        <option value="1:12">1:12</option>
                                        <option value="1:14">1:14</option>
                                        <option value="1:16">1:16</option>
                                        <option value="1:18.75">1:18.75</option>
                                        <option value="1:20">1:20</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Name:</label>
                                    <input type="text" name="optic_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Zero Distance (yards):</label>
                                    <input type="number" name="zero_distance" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Height Over Bore (inches):</label>
                                    <input type="number" name="height_over_bore" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button type="button" onclick="saveFirearm()" style="background-color: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;">Save Firearm</button>
                                <button type="button" onclick="cancelFirearmForm()" style="background-color: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            </div>
                        </form>
                    </div>


                    <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h3>Your Firearm Profiles</h3>
                        <div id="firearmLibraryContent">Loading your firearms...</div>
                    </div>
                `;
                
                // Remove any existing active firearm library (exact pattern from bullet library)
                const existing = document.getElementById('activeFirearmLibrary');
                if (existing) existing.remove();
                
                // Add the new firearm library (exact pattern from bullet library)
                appContent.appendChild(firearmContent);
                
                // Load the firearms (exact pattern from bullet library)
                loadFirearmLibraryDirect();
            };

            // Load firearm library for management page - exact copy of bullet library pattern
            window.loadFirearmLibraryDirect = async function() {
                try {
                    if (!currentUser) {
                        document.getElementById('firearmLibraryContent').innerHTML = 
                            '<p style="text-align: center; padding: 20px;">Please log in to view your firearms.</p>';
                        return;
                    }

                    console.log('Loading firearms for user:', currentUser.id);

                    const { data: firearms, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('profile_name', { ascending: true });

                    const firearmLibraryContent = document.getElementById('firearmLibraryContent');
                    console.log('firearmLibraryContent element found:', !!firearmLibraryContent);
                    if (!firearmLibraryContent) {
                        console.error('firearmLibraryContent element not found');
                        return;
                    }

                    if (error) {
                        console.error('Error loading firearms:', error);
                        firearmLibraryContent.innerHTML = '<p>Error loading firearms. Please try again.</p>';
                        return;
                    }

                    if (firearms && firearms.length > 0) {
                        let tableHTML = `
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Profile Name</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Shooter</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Type</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Firearm</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Caliber</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Barrel</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Zero</th>
                                        <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: bold;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        firearms.forEach(firearm => {
                            tableHTML += `
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.profile_name}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.shooter_name}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.firearm_type}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.firearm_name}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.caliber}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.barrel_length ? firearm.barrel_length + '"' : 'N/A'}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">${firearm.zero_distance ? firearm.zero_distance + ' yds' : 'N/A'}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">
                                        <button onclick="editFirearmDirect('${firearm.id}')" style="background-color: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteFirearmDirect('${firearm.id}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });

                        tableHTML += '</tbody></table>';
                        console.log('About to set innerHTML with table HTML, length:', tableHTML.length);
                        
                        // Clear any existing content first
                        firearmLibraryContent.innerHTML = '';
                        
                        // Force display styles before adding content
                        firearmLibraryContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: static !important; z-index: 999 !important;';
                        
                        // Insert the table HTML
                        firearmLibraryContent.innerHTML = tableHTML;
                        
                        // Force parent container to be visible
                        let parent = firearmLibraryContent.parentElement;
                        while (parent && parent !== document.body) {
                            parent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
                            parent = parent.parentElement;
                        }
                        
                        console.log('Firearm table rendered successfully, total firearms:', firearms.length);
                        console.log('Element innerHTML after setting:', firearmLibraryContent.innerHTML.length, 'characters');
                        console.log('Element computed style display:', window.getComputedStyle(firearmLibraryContent).display);
                        console.log('Element computed style visibility:', window.getComputedStyle(firearmLibraryContent).visibility);
                    } else {
                        firearmLibraryContent.innerHTML = '<p style="text-align: center; padding: 20px;">No firearms found. Click "Add New Firearm" to get started.</p>';
                    }
                } catch (error) {
                    console.error('Error in loadFirearmLibraryDirect:', error);
                    const firearmLibraryContent = document.getElementById('firearmLibraryContent');
                    if (firearmLibraryContent) {
                        firearmLibraryContent.innerHTML = '<p>Error loading firearms. Please try again.</p>';
                    }
                }
            };

            window.editFirearmDirect = async function(firearmId) {
                try {
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) {
                        alert('Error loading firearm data: ' + error.message);
                        return;
                    }

                    const firearmLibraryContent = document.getElementById('firearmLibraryContent');
                    firearmLibraryContent.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                            <h3>Edit Firearm Profile</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Profile Name:</label>
                                    <input type="text" id="edit_firearm_profile_name" value="${firearm.profile_name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Shooter Name:</label>
                                    <input type="text" id="edit_firearm_shooter_name" value="${firearm.shooter_name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Type:</label>
                                    <select id="edit_firearm_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                        <option value="">Select</option>
                                        <option value="Rifle" ${firearm.firearm_type === 'Rifle' ? 'selected' : ''}>Rifle</option>
                                        <option value="Pistol" ${firearm.firearm_type === 'Pistol' ? 'selected' : ''}>Pistol</option>
                                        <option value="Shotgun" ${firearm.firearm_type === 'Shotgun' ? 'selected' : ''}>Shotgun</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Firearm Name:</label>
                                    <input type="text" id="edit_firearm_name" value="${firearm.firearm_name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Caliber:</label>
                                    <input type="text" id="edit_firearm_caliber" value="${firearm.caliber}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Length (inches):</label>
                                    <input type="number" id="edit_firearm_barrel_length" value="${firearm.barrel_length || ''}" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Barrel Twist Rate:</label>
                                    <select id="edit_firearm_barrel_twist_rate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select</option>
                                        <option value="1:7" ${firearm.barrel_twist_rate === '1:7' ? 'selected' : ''}>1:7</option>
                                        <option value="1:8" ${firearm.barrel_twist_rate === '1:8' ? 'selected' : ''}>1:8</option>
                                        <option value="1:9" ${firearm.barrel_twist_rate === '1:9' ? 'selected' : ''}>1:9</option>
                                        <option value="1:9.25" ${firearm.barrel_twist_rate === '1:9.25' ? 'selected' : ''}>1:9.25</option>
                                        <option value="1:10" ${firearm.barrel_twist_rate === '1:10' ? 'selected' : ''}>1:10</option>
                                        <option value="1:11" ${firearm.barrel_twist_rate === '1:11' ? 'selected' : ''}>1:11</option>
                                        <option value="1:12" ${firearm.barrel_twist_rate === '1:12' ? 'selected' : ''}>1:12</option>
                                        <option value="1:14" ${firearm.barrel_twist_rate === '1:14' ? 'selected' : ''}>1:14</option>
                                        <option value="1:16" ${firearm.barrel_twist_rate === '1:16' ? 'selected' : ''}>1:16</option>
                                        <option value="1:18.75" ${firearm.barrel_twist_rate === '1:18.75' ? 'selected' : ''}>1:18.75</option>
                                        <option value="1:20" ${firearm.barrel_twist_rate === '1:20' ? 'selected' : ''}>1:20</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Optic Name:</label>
                                    <input type="text" id="edit_firearm_optic_name" value="${firearm.optic_name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Zero Distance (yards):</label>
                                    <input type="number" id="edit_firearm_zero_distance" value="${firearm.zero_distance || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Height Over Bore (inches):</label>
                                    <input type="number" id="edit_firearm_height_over_bore" value="${firearm.height_over_bore || ''}" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="updateFirearmDirect('${firearmId}')" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Update Firearm</button>
                                <button onclick="loadFirearmLibraryDirect()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    alert('Error loading firearm data. Please try again.');
                }
            };

            window.updateFirearmDirect = async function(firearmId) {
                try {
                    const firearmData = {
                        profile_name: document.getElementById('edit_firearm_profile_name').value,
                        shooter_name: document.getElementById('edit_firearm_shooter_name').value,
                        firearm_type: document.getElementById('edit_firearm_type').value,
                        firearm_name: document.getElementById('edit_firearm_name').value,
                        caliber: document.getElementById('edit_firearm_caliber').value,
                        barrel_length: parseFloat(document.getElementById('edit_firearm_barrel_length').value) || null,
                        barrel_twist_rate: document.getElementById('edit_firearm_barrel_twist_rate').value || null,
                        optic_name: document.getElementById('edit_firearm_optic_name').value || null,
                        zero_distance: parseInt(document.getElementById('edit_firearm_zero_distance').value) || null,
                        height_over_bore: parseFloat(document.getElementById('edit_firearm_height_over_bore').value) || null
                    };

                    const { error } = await supabase
                        .from('firearm_profile')
                        .update(firearmData)
                        .eq('id', firearmId);

                    if (error) {
                        alert('Error updating firearm: ' + error.message);
                        return;
                    }

                    alert('Firearm updated successfully!');
                    await loadFirearmLibraryDirect();
                } catch (e) {
                    alert('Error updating firearm. Please try again.');
                }
            };

            window.deleteFirearmDirect = async function(firearmId) {
                if (confirm('Are you sure you want to delete this firearm profile?')) {
                    try {
                        const { error } = await supabase
                            .from('firearm_profile')
                            .delete()
                            .eq('id', firearmId);

                        if (error) {
                            alert('Error deleting firearm: ' + error.message);
                            return;
                        }

                        alert('Firearm deleted successfully!');
                        await loadFirearmLibraryDirect();
                    } catch (error) {
                        console.error('Error deleting firearm:', error);
                        alert('Error deleting firearm: ' + error.message);
                    }
                }
            };

            window.showAddFirearmForm = function() {
                // Hide the firearm table and show the add form
                const firearmLibraryContent = document.getElementById('firearmLibraryContent');
                if (firearmLibraryContent) {
                    firearmLibraryContent.parentElement.style.display = 'none';
                }
                document.getElementById('addFirearmForm').style.display = 'block';
            };

            window.cancelFirearmForm = function() {
                document.getElementById('addFirearmForm').style.display = 'none';
                document.getElementById('firearmForm').reset();
                // Show the firearm table again
                const firearmLibraryContent = document.getElementById('firearmLibraryContent');
                if (firearmLibraryContent) {
                    firearmLibraryContent.parentElement.style.display = 'block';
                }
            };

            window.saveFirearm = async function() {
                try {
                    if (!currentUser) {
                        alert('Please log in to save firearm profiles.');
                        return;
                    }

                    const form = document.getElementById('firearmForm');
                    const formData = new FormData(form);
                    
                    const firearmData = {
                        user_id: currentUser.id,
                        profile_name: formData.get('profile_name'),
                        shooter_name: formData.get('shooter_name'),
                        firearm_type: formData.get('firearm_type'),
                        firearm_name: formData.get('firearm_name'),
                        caliber: formData.get('caliber'),
                        barrel_length: formData.get('barrel_length') ? parseFloat(formData.get('barrel_length')) : null,
                        barrel_twist_rate: formData.get('barrel_twist_rate'),
                        optic_name: formData.get('optic_name'),
                        zero_distance: formData.get('zero_distance') ? parseFloat(formData.get('zero_distance')) : null,
                        height_over_bore: formData.get('height_over_bore') ? parseFloat(formData.get('height_over_bore')) : null
                    };

                    const { data, error } = await supabase
                        .from('firearm_profile')
                        .insert([firearmData]);

                    if (error) {
                        console.error('Error saving firearm profile:', error);
                        alert('Error saving firearm profile: ' + error.message);
                        return;
                    }

                    alert('Firearm profile saved successfully!');
                    cancelFirearmForm();
                    loadFirearmProfiles();
                } catch (error) {
                    console.error('Error saving firearm:', error);
                    alert('Error saving firearm profile');
                }
            };

            window.loadFirearmProfiles = async function() {
                console.log('loadFirearmProfiles called, currentUser:', currentUser);
                try {
                    if (!currentUser) {
                        console.log('No currentUser found in loadFirearmProfiles');
                        document.getElementById('firearmResults').innerHTML = '<p>Please log in to view your firearm profiles.</p>';
                        return;
                    }

                    const { data: firearms, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('profile_name', { ascending: true });

                    console.log('Firearm query result:', { firearms, error, userID: currentUser.id });

                    if (error) {
                        console.error('Error loading firearm profiles:', error);
                        document.getElementById('firearmResults').innerHTML = '<p>Error loading firearm profiles. Please ensure the firearm_profile table exists in your database.</p>';
                        return;
                    }

                    if (!firearms || firearms.length === 0) {
                        console.log('No firearms found or empty array');
                        document.getElementById('firearmResults').innerHTML = '<p>No firearm profiles found. Click "Add New Firearm" to create your first profile.</p>';
                        return;
                    }

                    console.log('About to render', firearms.length, 'firearms');

                    // Create proper firearm table
                    let firearmHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Profile</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Shooter</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Type</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Firearm</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Caliber</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Barrel</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Twist</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Optic</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Zero</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">HOB</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    // Add table rows
                    firearmHTML += firearms.map((firearm, index) => `
                        <tr style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;'}">
                            <td style="padding: 12px; color: #007bff; font-weight: 500;">${firearm.profile_name}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.shooter_name}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.firearm_type}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.firearm_name}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.caliber}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.barrel_length ? firearm.barrel_length + '"' : '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.barrel_twist_rate || '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.optic_name || '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.zero_distance ? firearm.zero_distance + 'yds' : '-'}</td>
                            <td style="padding: 12px; color: #495057;">${firearm.height_over_bore ? firearm.height_over_bore + '"' : '-'}</td>
                            <td style="padding: 12px;">
                                <button onclick="editFirearm('${firearm.id}')" style="background-color: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.875rem;">Edit</button>
                                <button onclick="deleteFirearm('${firearm.id}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">Delete</button>
                            </td>
                        </tr>
                    `).join('');

                    // Close table
                    firearmHTML += `
                            </tbody>
                        </table>
                    `;

                    console.log('Setting innerHTML with firearm table');
                    const resultsElement = document.getElementById('firearmResults');
                    console.log('firearmResults element:', resultsElement);
                    console.log('firearmResults parent:', resultsElement?.parentElement);
                    
                    // Make sure the parent container is visible
                    const parentElement = resultsElement.parentElement;
                    if (parentElement) {
                        parentElement.style.display = 'block';
                        console.log('Fixed parent display to block');
                    }
                    
                    // Force clear any existing content and styles
                    resultsElement.innerHTML = '';
                    resultsElement.style.cssText = 'display: block !important; visibility: visible !important; position: static !important; z-index: 999 !important;';
                    
                    // Set the content
                    resultsElement.innerHTML = firearmHTML;
                    
                    // Force browser to render
                    resultsElement.offsetHeight;
                    console.log('Firearm table rendered successfully');
                    console.log('Element content length:', resultsElement?.innerHTML?.length);
                    console.log('Element display style:', getComputedStyle(resultsElement)?.display);
                    
                    // Check parent visibility
                    console.log('Parent display style:', getComputedStyle(parentElement)?.display);
                    console.log('Parent visibility:', getComputedStyle(parentElement)?.visibility);
                    console.log('Parent height:', getComputedStyle(parentElement)?.height);
                    
                    // Check if the activeFirearmLibrary section is visible
                    const activeSection = document.getElementById('activeFirearmLibrary');
                    console.log('activeFirearmLibrary section:', activeSection);
                    console.log('activeFirearmLibrary display:', getComputedStyle(activeSection)?.display);
                    
                    // Check positioning and z-index issues
                    console.log('Parent position:', getComputedStyle(parentElement)?.position);
                    console.log('Parent z-index:', getComputedStyle(parentElement)?.zIndex);
                    console.log('Parent overflow:', getComputedStyle(parentElement)?.overflow);
                    
                    // Check if content is actually in the DOM
                    console.log('firearmList children count:', parentElement.children.length);
                    console.log('First table in results:', resultsElement.querySelector('table'));
                    
                    // Force a style refresh
                    parentElement.style.display = 'none';
                    setTimeout(() => {
                        parentElement.style.display = 'block';
                        console.log('Forced style refresh completed');
                    }, 100);
                } catch (error) {
                    console.error('Error loading firearms:', error);
                    document.getElementById('firearmResults').innerHTML = '<p>Error loading firearm profiles.</p>';
                }
            };

            window.editFirearm = async function(firearmId) {
                try {
                    // Fetch the existing firearm data
                    const { data: firearm, error } = await supabase
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', firearmId)
                        .single();

                    if (error) {
                        alert('Error loading firearm data. Please try again.');
                        return;
                    }

                    // Hide the firearm list and show edit form
                    document.getElementById('firearmList').style.display = 'none';
                    document.getElementById('editFirearmSection').style.display = 'block';

                    // Populate the edit form
                    document.getElementById('edit_firearm_profile_name').value = firearm.profile_name || '';
                    document.getElementById('edit_firearm_shooter_name').value = firearm.shooter_name || '';
                    document.getElementById('edit_firearm_type').value = firearm.firearm_type || '';
                    document.getElementById('edit_firearm_name').value = firearm.firearm_name || '';
                    document.getElementById('edit_firearm_caliber').value = firearm.caliber || '';
                    document.getElementById('edit_firearm_barrel_length').value = firearm.barrel_length || '';
                    document.getElementById('edit_firearm_barrel_twist_rate').value = firearm.barrel_twist_rate || '';
                    document.getElementById('edit_firearm_optic_name').value = firearm.optic_name || '';
                    document.getElementById('edit_firearm_zero_distance').value = firearm.zero_distance || '';
                    document.getElementById('edit_firearm_height_over_bore').value = firearm.height_over_bore || '';
                    
                    // Store the firearm ID for updating
                    window.currentEditingFirearmId = firearmId;

                } catch (error) {
                    console.error('Error in editFirearm:', error);
                    alert('Error loading firearm data. Please try again.');
                }
            };

            // Update firearm function
            window.updateFirearmDirect = async function() {
                try {
                    const updateData = {
                        profile_name: document.getElementById('edit_firearm_profile_name').value,
                        shooter_name: document.getElementById('edit_firearm_shooter_name').value,
                        firearm_type: document.getElementById('edit_firearm_type').value,
                        firearm_name: document.getElementById('edit_firearm_name').value,
                        caliber: document.getElementById('edit_firearm_caliber').value,
                        barrel_length: document.getElementById('edit_firearm_barrel_length').value ? parseFloat(document.getElementById('edit_firearm_barrel_length').value) : null,
                        barrel_twist_rate: document.getElementById('edit_firearm_barrel_twist_rate').value,
                        optic_name: document.getElementById('edit_firearm_optic_name').value,
                        zero_distance: document.getElementById('edit_firearm_zero_distance').value ? parseFloat(document.getElementById('edit_firearm_zero_distance').value) : null,
                        height_over_bore: document.getElementById('edit_firearm_height_over_bore').value ? parseFloat(document.getElementById('edit_firearm_height_over_bore').value) : null
                    };

                    const { error } = await supabase
                        .from('firearm_profile')
                        .update(updateData)
                        .eq('id', window.currentEditingFirearmId);

                    if (error) {
                        alert('Error updating firearm profile. Please try again.');
                    } else {
                        alert('Firearm profile updated successfully!');
                        cancelFirearmEdit();
                        await loadFirearmProfiles();
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error updating firearm profile. Please try again.');
                }
            };

            // Cancel firearm edit function
            window.cancelFirearmEdit = function() {
                document.getElementById('editFirearmSection').style.display = 'none';
                document.getElementById('firearmList').style.display = 'block';
            };



            window.deleteFirearm = async function(firearmId) {
                if (!confirm('Are you sure you want to delete this firearm profile?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('firearm_profile')
                        .delete()
                        .eq('id', firearmId);

                    if (error) {
                        console.error('Error deleting firearm:', error);
                        alert('Error deleting firearm profile');
                        return;
                    }

                    alert('Firearm profile deleted successfully!');
                    loadFirearmProfiles();
                } catch (error) {
                    console.error('Error deleting firearm:', error);
                    alert('Error deleting firearm profile');
                }
            };



            window.searchSessions = async function() {
                console.warn('searchSessions function started');
                const shooterName = document.getElementById('search_shooter_name').value.trim().toLowerCase();
                const firearmType = document.getElementById('search_firearm_type').value.trim();
                const firearmName = document.getElementById('search_firearm_name').value.trim().toLowerCase();
                const bulletGrainInput = document.getElementById('search_bullet_grain').value.trim();
                const barrelLengthInput = document.getElementById('search_barrel_length').value.trim();
                const zeroDistanceInput = document.getElementById('search_zero_distance').value.trim();

                // Parse numeric inputs
                const bulletGrain = bulletGrainInput ? parseInt(bulletGrainInput) : null;
                const barrelLength = barrelLengthInput ? parseFloat(barrelLengthInput) : null;
                const zeroDistance = zeroDistanceInput ? parseInt(zeroDistanceInput) : null;

                const { data, error } = await supabase.from('ballistic_sessions').select('*').eq('user_id', currentUser.id);
                if (error) {
                    console.error('Supabase search error:', error);
                    document.getElementById('message').innerHTML = `<div class="error">Error searching sessions: ${error.message}</div>`;
                    return;
                }

                const filtered = data.filter(session =>
                    (shooterName === '' || (session.shooter_name && session.shooter_name.trim().toLowerCase().includes(shooterName))) &&
                    (firearmType === '' || (session.firearm_type && session.firearm_type.trim() === firearmType)) &&
                    (firearmName === '' || (session.firearm_name && session.firearm_name.trim().toLowerCase().includes(firearmName))) &&
                    (bulletGrain === null || (session.bullet_grain && session.bullet_grain === bulletGrain)) &&
                    (barrelLength === null || (session.barrel_length && session.barrel_length === barrelLength)) &&
                    (zeroDistance === null || (session.zero_distance && session.zero_distance === zeroDistance))
                );
                window.displaySessions(filtered);
            };

            window.clearSearch = function() {
                console.log('Clearing search');
                document.getElementById('search_shooter_name').value = '';
                document.getElementById('search_firearm_type').value = '';
                document.getElementById('search_firearm_name').value = '';
                document.getElementById('search_bullet_grain').value = '';
                document.getElementById('search_barrel_length').value = '';
                document.getElementById('search_zero_distance').value = '';
                document.getElementById('sessionsBody').innerHTML = '';
                document.getElementById('message').innerHTML = '';
                document.getElementById('trajectoryDescription').textContent = '';
                document.getElementById('comparisonTitle').style.display = 'none';
                document.getElementById('comparisonTable').style.display = 'none';
            };

            window.deleteSelected = async function() {
                console.warn('deleteSelected function started');
                const checkboxes = document.querySelectorAll('.select-session:checked');
                if (checkboxes.length === 0) {
                    console.error('No sessions selected for deletion');
                    document.getElementById('message').innerHTML = '<div class="error">No sessions selected for deletion.</div>';
                    return;
                }

                if (!confirm('Are you sure you want to delete the selected sessions?')) {
                    return;
                }

                const ids = Array.from(checkboxes).map(cb => cb.dataset.id);
                const { error } = await supabase.from('ballistic_sessions').delete().in('id', ids).eq('user_id', currentUser.id);
                if (error) {
                    console.error('Supabase delete error:', error);
                    document.getElementById('message').innerHTML = `<div class="error">Error deleting sessions: ${error.message}</div>`;
                } else {
                    console.log('Selected sessions deleted successfully');
                    document.getElementById('message').innerHTML = '<div class="message">Selected sessions deleted successfully!</div>';
                    document.getElementById('trajectoryDescription').textContent = '';
                    document.getElementById('comparisonTitle').style.display = 'none';
                    document.getElementById('comparisonTable').style.display = 'none';
                    window.viewAll();
                }
            };

            window.hideBulletLibrary = function() {
                document.getElementById('bulletLibrarySection').style.display = 'none';
                document.getElementById('addBulletForm').style.display = 'none';
            };

            window.showAddBulletForm = function() {
                document.getElementById('addBulletForm').style.display = 'block';
                document.getElementById('bullet_manufacturer').value = '';
                document.getElementById('bullet_caliber').value = '';
                document.getElementById('bullet_grain').value = '';
                document.getElementById('bullet_bc').value = '';
                document.getElementById('bullet_drag_model').value = '';
                document.getElementById('bullet_type').value = '';
            };

            window.cancelAddBullet = function() {
                document.getElementById('addBulletForm').style.display = 'none';
            };

            window.saveBullet = async function() {
                const manufacturer = document.getElementById('bullet_manufacturer').value.trim();
                const caliber = document.getElementById('bullet_caliber').value.trim();
                const grain = parseInt(document.getElementById('bullet_grain').value);
                const bc = parseFloat(document.getElementById('bullet_bc').value);
                const dragModel = document.getElementById('bullet_drag_model').value;
                const bulletType = document.getElementById('bullet_type').value;

                if (!manufacturer || !caliber || !grain || !bc || !dragModel || !bulletType) {
                    alert('Please fill in all fields');
                    return;
                }

                if (bc < 0.1 || bc > 1.0) {
                    alert('Ballistic coefficient must be between 0.1 and 1.0');
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('bullet_library')
                        .insert([{
                            user_id: currentUser.id,
                            manufacturer_name: manufacturer,
                            caliber: caliber,
                            grain: grain,
                            ballistic_coefficient: bc,
                            drag_model: dragModel,
                            bullet_type: bulletType
                        }]);

                    if (error) {
                        console.error('Error saving bullet:', error);
                        alert('Error saving bullet. Please try again.');
                    } else {
                        console.log('Bullet saved successfully');
                        document.getElementById('addBulletForm').style.display = 'none';
                        await loadBulletLibrary();
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error saving bullet. Please try again.');
                }
            };

            window.loadSharedLibraries = async function() {
                console.log('Loading shared libraries...');
                try {
                    if (!currentUser) {
                        alert('Please log in to access shared libraries.');
                        return;
                    }

                    // First, check and accept any pending shares
                    await checkAndAcceptPendingShares();

                    // Then show available shared libraries
                    await showSharedLibrarySelector();
                    
                } catch (error) {
                    console.error('Error loading shared libraries:', error);
                    alert('Error loading shared libraries: ' + error.message);
                }
            };

            window.showSharedLibrarySelector = async function() {
                try {
                    console.log('Checking for shared libraries for user:', currentUser.email);
                    
                    // First, let's see ALL shares for this email (for debugging)
                    const { data: allShares, error: allError } = await supabase
                        .from('library_shares')
                        .select('*')
                        .eq('shared_with_email', currentUser.email);
                    
                    console.log('All shares found for this email:', allShares);
                    console.log('Error (if any):', allError);

                    // Get all accepted shares for this user (without join)
                    const { data: shares, error } = await supabase
                        .from('library_shares')
                        .select('*')
                        .eq('shared_with_email', currentUser.email)
                        .eq('status', 'accepted')
                        .not('shared_with_user_id', 'is', null);

                    console.log('Accepted shares with user_id:', shares);

                    if (error) {
                        console.error('Error fetching shared libraries:', error);
                        alert('Error fetching shared libraries: ' + error.message);
                        return;
                    }

                    if (!shares || shares.length === 0) {
                        // Check if there are any shares at all, even pending ones
                        if (allShares && allShares.length > 0) {
                            const pendingShares = allShares.filter(s => s.status === 'pending');
                            const rejectedShares = allShares.filter(s => s.status === 'rejected');
                            const acceptedButNoUserId = allShares.filter(s => s.status === 'accepted' && !s.shared_with_user_id);
                            
                            let message = 'No ready-to-use shared libraries found.\n\n';
                            if (pendingShares.length > 0) {
                                message += `Found ${pendingShares.length} pending share(s). `;
                            }
                            if (acceptedButNoUserId.length > 0) {
                                message += `Found ${acceptedButNoUserId.length} accepted share(s) missing user ID. `;
                            }
                            if (rejectedShares.length > 0) {
                                message += `Found ${rejectedShares.length} rejected share(s). `;
                            }
                            message += '\n\nTrying to accept pending shares now...';
                            
                            alert(message);
                            await checkAndAcceptPendingShares();
                            alert('Please try "Load Shared Library" again.');
                            return;
                        } else {
                            alert('No shared libraries available. Ask other users to share their libraries with you first.');
                            return;
                        }
                    }

                    // We'll use the shared_by_email field that's already in the library_shares table

                    // Now that we have the shared_from_email field, we can use it directly
                    const sharesWithEmails = shares.map(share => ({
                        ...share,
                        ownerEmail: share.shared_from_email || `User ${share.owner_id.substring(0, 8)}...`
                    }));
                    
                    // Show modal with available shared libraries
                    const modalHTML = `
                        <div id="sharedLibraryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 95%;">
                                <h3 style="margin-top: 0;">Available Shared Libraries</h3>
                                <p style="color: #666; margin-bottom: 20px;">Select bullets from shared libraries to copy to your own library:</p>
                                
                                <div id="sharedLibrariesContent">
                                    ${sharesWithEmails.map((share, index) => `
                                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                                            <h4 style="margin: 0 0 10px 0; color: #007bff;">Library shared by: ${share.ownerEmail}</h4>
                                            <div id="bullets_${share.owner_id}" style="margin-top: 10px;">
                                                Loading bullets...
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                                    <button onclick="closeSharedLibraryModal()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHTML);

                    // Load bullets for each shared library
                    console.log('Loading bullets for shares:', shares);
                    for (const share of shares) {
                        console.log('Processing share:', share);
                        console.log('Owner ID:', share.owner_id);
                        await loadSharedBullets(share.owner_id);
                    }

                } catch (error) {
                    console.error('Error showing shared library selector:', error);
                    alert('Error showing shared libraries: ' + error.message);
                }
            };

            window.loadSharedBullets = async function(sharedByUserId) {
                try {
                    console.log('Loading shared bullets for user ID:', sharedByUserId);
                    
                    // First, let's verify that we have the right permissions by checking the share record
                    const { data: shareCheck, error: shareError } = await supabase
                        .from('library_shares')
                        .select('*')
                        .eq('owner_id', sharedByUserId)
                        .eq('shared_with_email', currentUser.email)
                        .eq('status', 'accepted')
                        .single();

                    console.log('Share verification:', { shareCheck, shareError });

                    if (shareError || !shareCheck) {
                        console.error('No valid share found for this user');
                        const container = document.getElementById(`bullets_${sharedByUserId}`);
                        if (container) {
                            container.innerHTML = '<p style="color: red;">Access denied - no valid share found.</p>';
                        }
                        return;
                    }

                    const { data: bullets, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', sharedByUserId)
                        .order('manufacturer_name', { ascending: true });

                    console.log('Shared bullets query result:', { bullets, error, sharedByUserId });

                    if (error) {
                        console.error('Error loading shared bullets:', error);
                        const container = document.getElementById(`bullets_${sharedByUserId}`);
                        if (container) {
                            container.innerHTML = `<p style="color: red;">Database error: ${error.message}</p>`;
                        }
                        return;
                    }

                    const container = document.getElementById(`bullets_${sharedByUserId}`);
                    if (!container) {
                        console.error('Container not found for user ID:', sharedByUserId);
                        return;
                    }

                    console.log(`Found ${bullets ? bullets.length : 0} bullets for user ${sharedByUserId}`);

                    if (!bullets || bullets.length === 0) {
                        container.innerHTML = '<p style="color: #666;">No bullets in this library.</p>';
                        return;
                    }

                    container.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <button onclick="selectAllSharedBullets('${sharedByUserId}')" style="background: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Select All</button>
                            <button onclick="copySelectedBullets('${sharedByUserId}')" style="background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 5px;">Copy Selected</button>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px;">
                            ${bullets.map(bullet => `
                                <div style="margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 3px; display: flex; align-items: center;">
                                    <input type="checkbox" id="bullet_${bullet.id}" value="${bullet.id}" style="margin-right: 8px;">
                                    <label for="bullet_${bullet.id}" style="flex: 1; cursor: pointer; font-size: 14px;">
                                        <strong>${bullet.manufacturer_name}</strong> ${bullet.caliber} ${bullet.grain}gr 
                                        (BC: ${bullet.ballistic_coefficient}, ${bullet.drag_model})
                                        ${bullet.bullet_type ? `- ${bullet.bullet_type}` : ''}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `;

                } catch (error) {
                    console.error('Error loading shared bullets:', error);
                }
            };

            window.selectAllSharedBullets = function(userId) {
                const container = document.getElementById(`bullets_${userId}`);
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                });
            };

            window.copySelectedBullets = async function(userId) {
                try {
                    const container = document.getElementById(`bullets_${userId}`);
                    const selectedCheckboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                    
                    if (selectedCheckboxes.length === 0) {
                        alert('Please select at least one bullet to copy.');
                        return;
                    }

                    const bulletIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                    
                    // Get the full bullet data
                    const { data: bulletsData, error: fetchError } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .in('id', bulletIds);

                    if (fetchError) {
                        alert('Error fetching bullet data: ' + fetchError.message);
                        return;
                    }

                    // Copy bullets to current user's library
                    const newBullets = bulletsData.map(bullet => ({
                        user_id: currentUser.id,
                        manufacturer_name: bullet.manufacturer_name,
                        caliber: bullet.caliber,
                        grain: bullet.grain,
                        ballistic_coefficient: bullet.ballistic_coefficient,
                        drag_model: bullet.drag_model,
                        bullet_type: bullet.bullet_type,
                        lot_number: bullet.lot_number,
                        production_date: bullet.production_date,
                        purchase_date: bullet.purchase_date,
                        muzzle_velocity: bullet.muzzle_velocity,
                        muzzle_energy: bullet.muzzle_energy
                    }));

                    const { error: insertError } = await supabase
                        .from('bullet_library')
                        .insert(newBullets);

                    if (insertError) {
                        alert('Error copying bullets: ' + insertError.message);
                        return;
                    }

                    alert(`Successfully copied ${bulletIds.length} bullet${bulletIds.length > 1 ? 's' : ''} to your library!`);
                    closeSharedLibraryModal();
                    await loadBulletLibraryDirect();

                } catch (error) {
                    console.error('Error copying bullets:', error);
                    alert('Error copying bullets: ' + error.message);
                }
            };

            window.closeSharedLibraryModal = function() {
                const modal = document.getElementById('sharedLibraryModal');
                if (modal) {
                    modal.remove();
                }
            };

            // Request library access from another user
            window.requestLibraryAccess = async function() {
                const email = document.getElementById('requestEmail').value.trim();
                
                if (!email) {
                    alert('Please enter an email address.');
                    return;
                }

                if (email === currentUser.email) {
                    alert('You cannot request access from yourself.');
                    return;
                }

                alert('To request access from ' + email + ', please contact them directly and ask them to share their library with you using the "Share Your Libraries" section above.');
                document.getElementById('requestEmail').value = '';
            };

            // Load and display sharing data
            window.loadSharingData = async function() {
                try {
                    if (!currentUser) {
                        console.log('No current user, skipping sharing data load');
                        return;
                    }

                    console.log('Loading sharing data for user:', currentUser.email, 'ID:', currentUser.id);

                    // Load pending requests TO approve (requests from others to access your library)
                    const { data: pendingRequests, error: pendingError } = await supabase
                        .from('library_shares')
                        .select('id, shared_with_email, shared_with_user_id, share_type, permissions, created_at, status')
                        .eq('owner_id', currentUser.id)
                        .eq('status', 'pending');

                    console.log('Pending requests result:', { pendingRequests, pendingError });

                    // Load shares WITH you (both pending and accepted)
                    const { data: sharedWithYou, error: sharedError } = await supabase
                        .from('library_shares')
                        .select('id, owner_id, shared_from_email, share_type, permissions, created_at, accepted_at, status')
                        .eq('shared_with_email', currentUser.email);

                    console.log('Shared with you result:', { sharedWithYou, sharedError });

                    // Load active shares (shares you've given to others)
                    const { data: activeShares, error: activeError } = await supabase
                        .from('library_shares')
                        .select('id, shared_with_email, shared_with_user_id, share_type, permissions, created_at, accepted_at, status')
                        .eq('owner_id', currentUser.id)
                        .eq('status', 'accepted');

                    console.log('Active shares result:', { activeShares, activeError });

                    if (pendingError) {
                        console.error('Error loading pending requests:', pendingError);
                        document.getElementById('pendingRequestsList').innerHTML = `<p style="color: red;">Error loading pending requests: ${pendingError.message}</p>`;
                    }
                    if (sharedError) {
                        console.error('Error loading shared with you:', sharedError);
                        document.getElementById('sharedFromList').innerHTML = `<p style="color: red;">Error loading shared libraries: ${sharedError.message}</p>`;
                    }
                    if (activeError) {
                        console.error('Error loading active shares:', activeError);
                        document.getElementById('sharedWithList').innerHTML = `<p style="color: red;">Error loading active shares: ${activeError.message}</p>`;
                    }

                    // Display the data if queries were successful
                    if (!pendingError && pendingRequests) {
                        const pendingContainer = document.getElementById('pendingRequestsList');
                        if (pendingContainer) {
                            if (pendingRequests.length === 0) {
                                pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">No pending requests</p>';
                            } else {
                                let html = '';
                                pendingRequests.forEach(request => {
                                    html += `
                                        <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                            <p><strong>${request.shared_with_email}</strong> requested access to your ${request.share_type} libraries</p>
                                            <p style="font-size: 12px; color: #666;">Requested: ${new Date(request.created_at).toLocaleDateString()}</p>
                                            <button onclick="approveShare('${request.id}')" style="background-color: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">Approve</button>
                                            <button onclick="declineShare('${request.id}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Decline</button>
                                        </div>
                                    `;
                                });
                                pendingContainer.innerHTML = html;
                            }
                        }
                    }

                    if (!sharedError && sharedWithYou) {
                        const sharedFromContainer = document.getElementById('sharedFromList');
                        if (sharedFromContainer) {
                            if (sharedWithYou.length === 0) {
                                sharedFromContainer.innerHTML = '<p style="color: #666; font-style: italic;">No libraries shared with you</p>';
                            } else {
                                let html = '';
                                sharedWithYou.forEach(share => {
                                    const statusColor = share.status === 'accepted' ? '#28a745' : share.status === 'pending' ? '#ffc107' : '#dc3545';
                                    html += `
                                        <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                            <p><strong>Owner:</strong> ${share.shared_from_email || 'Unknown User'}</p>
                                            <p><strong>Type:</strong> ${share.share_type} libraries</p>
                                            <p><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${share.status}</span></p>
                                            ${share.status === 'pending' ? `
                                                <button onclick="acceptShare('${share.id}')" style="background-color: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">Accept</button>
                                                <button onclick="declineShare('${share.id}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Decline</button>
                                            ` : ''}
                                        </div>
                                    `;
                                });
                                sharedFromContainer.innerHTML = html;
                            }
                        }
                    }

                    if (!activeError && activeShares) {
                        const sharedWithContainer = document.getElementById('sharedWithList');
                        if (sharedWithContainer) {
                            if (activeShares.length === 0) {
                                sharedWithContainer.innerHTML = '<p style="color: #666; font-style: italic;">No active shares</p>';
                            } else {
                                let html = '';
                                activeShares.forEach(share => {
                                    html += `
                                        <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                                            <p><strong>${share.shared_with_email}</strong></p>
                                            <p><strong>Type:</strong> ${share.share_type} libraries</p>
                                            <p><strong>Permissions:</strong> ${share.permissions}</p>
                                            <p style="font-size: 12px; color: #666;">Shared: ${new Date(share.created_at).toLocaleDateString()}</p>
                                            <button onclick="revokeShare('${share.id}')" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Revoke Access</button>
                                        </div>
                                    `;
                                });
                                sharedWithContainer.innerHTML = html;
                            }
                        }
                    }

                    // Handle cases where we had errors but can still show something
                    const pendingContainer = document.getElementById('pendingRequestsList');
                    if (pendingContainer && pendingError) {
                        if (!pendingRequests || pendingRequests.length === 0) {
                            pendingContainer.innerHTML = '<div style="text-align: center; color: #666;">No pending requests.</div>';
                        } else {
                            pendingContainer.innerHTML = pendingRequests.map(request => `
                                <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ffc107; border-radius: 4px; background-color: #fff3cd;">
                                    <div style="font-weight: bold; color: #856404;">Request from: ${request.shared_with_email}</div>
                                    <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                        ${request.request_type === 'user_requested' ? 'User requested access' : 'Invited by you'} 
                                        • ${new Date(request.created_at).toLocaleDateString()}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button onclick="approveShare('${request.id}')" style="background: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Approve</button>
                                        <button onclick="rejectShare('${request.id}')" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Reject</button>
                                    </div>
                                </div>
                            `).join('');
                        }
                    }

                    // Update shared with you section
                    const sharedContainer = document.getElementById('sharedWithYou');
                    if (sharedContainer) {
                        if (!sharedWithYou || sharedWithYou.length === 0) {
                            sharedContainer.innerHTML = '<div style="text-align: center; color: #666;">No libraries shared with you.</div>';
                        } else {
                            sharedContainer.innerHTML = sharedWithYou.map(share => {
                                let statusColor = '#666';
                                let statusText = share.status;
                                if (share.status === 'accepted') {
                                    statusColor = '#28a745';
                                    statusText = 'Access Granted';
                                } else if (share.status === 'pending') {
                                    statusColor = '#ffc107';
                                    statusText = 'Pending Approval';
                                } else if (share.status === 'rejected') {
                                    statusColor = '#dc3545';
                                    statusText = 'Rejected';
                                }

                                return `
                                    <div style="margin-bottom: 10px; padding: 10px; border: 1px solid ${statusColor}; border-radius: 4px;">
                                        <div style="font-weight: bold;">Library from: ${share.shared_by_email}</div>
                                        <div style="font-size: 12px; color: ${statusColor}; margin: 5px 0;">
                                            Status: ${statusText} • ${new Date(share.created_at).toLocaleDateString()}
                                        </div>
                                        ${share.status === 'accepted' ? `
                                            <button onclick="loadSharedLibraries()" style="background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">View Library</button>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('');
                        }
                    }

                    // Update active shares section
                    const activeContainer = document.getElementById('activeShares');
                    if (activeContainer) {
                        if (!activeShares || activeShares.length === 0) {
                            activeContainer.innerHTML = '<div style="text-align: center; color: #666;">No active shares. Invite users above to start sharing.</div>';
                        } else {
                            activeContainer.innerHTML = activeShares.map(share => `
                                <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #28a745; border-radius: 4px; background-color: #d4edda;">
                                    <div style="font-weight: bold; color: #155724;">Shared with: ${share.shared_with_email}</div>
                                    <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                        Accepted: ${share.accepted_at ? new Date(share.accepted_at).toLocaleDateString() : 'Recently'}
                                    </div>
                                    <button onclick="revokeShare('${share.id}')" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Revoke Access</button>
                                </div>
                            `).join('');
                        }
                    }

                } catch (error) {
                    console.error('Error loading sharing data:', error);
                }
            };

            // Approve a share request
            window.approveShare = async function(shareId) {
                try {
                    const { error } = await supabase
                        .from('library_shares')
                        .update({ 
                            status: 'accepted',
                            accepted_at: new Date().toISOString()
                        })
                        .eq('id', shareId);

                    if (error) {
                        alert('Error approving share: ' + error.message);
                        return;
                    }

                    alert('Share request approved successfully!');
                    await loadSharingData(); // Reload the data

                } catch (error) {
                    console.error('Error approving share:', error);
                    alert('Error approving share: ' + error.message);
                }
            };

            // Decline a share request
            window.declineShare = async function(shareId) {
                try {
                    const { error } = await supabase
                        .from('library_shares')
                        .update({ status: 'declined' })
                        .eq('id', shareId);

                    if (error) {
                        alert('Error declining share: ' + error.message);
                        return;
                    }

                    alert('Share request declined.');
                    await loadSharingData(); // Reload the data

                } catch (error) {
                    console.error('Error declining share:', error);
                    alert('Error declining share: ' + error.message);
                }
            };

            // Accept a share (when someone shares with you)
            window.acceptShare = async function(shareId) {
                try {
                    const { error } = await supabase
                        .from('library_shares')
                        .update({ 
                            status: 'accepted',
                            accepted_at: new Date().toISOString(),
                            shared_with_user_id: currentUser.id
                        })
                        .eq('id', shareId);

                    if (error) {
                        alert('Error accepting share: ' + error.message);
                        return;
                    }

                    alert('You have successfully accepted the library share!');
                    await loadSharingData(); // Reload the data

                } catch (error) {
                    console.error('Error accepting share:', error);
                    alert('Error accepting share: ' + error.message);
                }
            };

            // Revoke a share
            window.revokeShare = async function(shareId) {
                try {
                    if (!confirm('Are you sure you want to revoke this share? The user will lose access to your libraries.')) {
                        return;
                    }

                    const { error } = await supabase
                        .from('library_shares')
                        .update({ status: 'revoked' })
                        .eq('id', shareId);

                    if (error) {
                        alert('Error revoking share: ' + error.message);
                        return;
                    }

                    alert('Share revoked successfully.');
                    await loadSharingData(); // Reload the data

                } catch (error) {
                    console.error('Error revoking share:', error);
                    alert('Error revoking share: ' + error.message);
                }
            };

            // Approve a share request
            window.approveShare = async function(shareId) {
                try {
                    const { error } = await supabase
                        .from('library_shares')
                        .update({
                            status: 'accepted',
                            accepted_at: new Date().toISOString()
                        })
                        .eq('id', shareId);

                    if (error) {
                        alert('Error approving share: ' + error.message);
                        return;
                    }

                    alert('Share approved successfully!');
                    await loadSharingData();

                } catch (error) {
                    console.error('Error approving share:', error);
                    alert('Error approving share: ' + error.message);
                }
            };

            // Reject a share request
            window.rejectShare = async function(shareId) {
                try {
                    const { error } = await supabase
                        .from('library_shares')
                        .update({
                            status: 'rejected',
                            rejected_at: new Date().toISOString()
                        })
                        .eq('id', shareId);

                    if (error) {
                        alert('Error rejecting share: ' + error.message);
                        return;
                    }

                    alert('Share rejected.');
                    await loadSharingData();

                } catch (error) {
                    console.error('Error rejecting share:', error);
                    alert('Error rejecting share: ' + error.message);
                }
            };

            // Revoke an active share
            window.revokeShare = async function(shareId) {
                try {
                    if (!confirm('Are you sure you want to revoke this share? The user will lose access to your library.')) {
                        return;
                    }

                    const { error } = await supabase
                        .from('library_shares')
                        .delete()
                        .eq('id', shareId);

                    if (error) {
                        alert('Error revoking share: ' + error.message);
                        return;
                    }

                    alert('Share revoked successfully.');
                    await loadSharingData();

                } catch (error) {
                    console.error('Error revoking share:', error);
                    alert('Error revoking share: ' + error.message);
                }
            };

            window.loadBulletLibraryDirect = async function() {
                try {
                    if (!currentUser) {
                        document.getElementById('bulletLibraryContent').innerHTML = '<p>Please log in to view your bullets.</p>';
                        return;
                    }

                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    if (error) {
                        document.getElementById('bulletLibraryContent').innerHTML = '<p>Error loading bullets. Please try again.</p>';
                        return;
                    }

                    const content = document.getElementById('bulletLibraryContent');
                    
                    if (data && data.length > 0) {
                        let tableHTML = `
                            <div style="margin-bottom: 15px;">
                                <button onclick="deleteSelectedBullets()" style="background-color: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Delete Selected</button>
                                <button onclick="selectAllBullets()" style="background-color: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Select All</button>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">
                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                        </th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Manufacturer</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Caliber</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Grain</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">BC</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Drag</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Lot Number</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Production Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Purchase Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Muzzle Velocity (fps)</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Muzzle Energy (ft-lbs)</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.forEach(bullet => {
                            tableHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <input type="checkbox" class="bullet-checkbox" value="${bullet.id}">
                                    </td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.manufacturer_name}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.caliber}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.grain}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.ballistic_coefficient}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.drag_model}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.bullet_type}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.lot_number || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.production_date || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.purchase_date || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.muzzle_velocity || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${bullet.muzzle_energy || '-'}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <button onclick="editBulletDirect(${bullet.id})" style="background-color: #17a2b8; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteBulletDirect(${bullet.id})" style="background-color: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table>';
                        content.innerHTML = tableHTML;
                    } else {
                        content.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No bullets in your library yet. Click "Add New Bullet" to get started!</p>';
                    }
                } catch (e) {
                    document.getElementById('bulletLibraryContent').innerHTML = '<p>Error loading bullets. Please try again.</p>';
                }
            };

            window.showAddBulletFormDirect = function() {
                const content = document.getElementById('bulletLibraryContent');
                content.innerHTML = `
                    <div style="background-color: white; padding: 20px; border-radius: 5px; border: 1px solid #ddd; margin-top: 15px;">
                        <h3>Add New Bullet</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Manufacturer Name:</label>
                            <input type="text" id="bullet_manufacturer_direct" placeholder="e.g. Federal, Hornady, Barnes" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Caliber:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="bullet_caliber_direct" placeholder="Selected caliber will appear here" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                                <button type="button" onclick="showCaliberPicker('bullet')" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Select Caliber</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Grain Weight:</label>
                            <input type="number" id="bullet_grain_direct" placeholder="e.g. 168" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Ballistic Coefficient:</label>
                            <input type="number" step="0.001" id="bullet_bc_direct" placeholder="e.g. 0.462" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Drag Model:</label>
                            <select id="bullet_drag_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="G1">G1</option>
                                <option value="G7">G7</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Bullet Type:</label>
                            <select id="bullet_type_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select bullet type...</option>
                                <option value="FMJ">FMJ</option>
                                <option value="JHP">JHP</option>
                                <option value="Soft Point">Soft Point</option>
                                <option value="TMJ">TMJ</option>
                                <option value="Frangible">Frangible</option>
                                <option value="WC">WC</option>
                                <option value="SWC">SWC</option>
                                <option value="AP">AP</option>
                                <option value="Subsonic">Subsonic</option>
                                <option value="GT">GT</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Lot Number:</label>
                            <input type="text" id="bullet_lot_direct" placeholder="e.g. LOT123456" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Production Date:</label>
                            <input type="date" id="bullet_production_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Purchase Date:</label>
                            <input type="date" id="bullet_purchase_direct" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Muzzle Velocity (fps):</label>
                            <input type="number" id="bullet_velocity_direct" placeholder="e.g. 3020" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Muzzle Energy (ft-lbs):</label>
                            <input type="number" id="bullet_energy_direct" placeholder="e.g. 1255" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveBulletDirect()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Save Bullet</button>
                            <button onclick="loadBulletLibraryDirect()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                `;
            };

            window.saveBulletDirect = async function() {
                try {
                    const bulletData = {
                        user_id: currentUser.id,
                        manufacturer_name: document.getElementById('bullet_manufacturer_direct').value,
                        caliber: document.getElementById('bullet_caliber_direct').value,
                        grain: parseInt(document.getElementById('bullet_grain_direct').value),
                        ballistic_coefficient: parseFloat(document.getElementById('bullet_bc_direct').value),
                        drag_model: document.getElementById('bullet_drag_direct').value,
                        bullet_type: document.getElementById('bullet_type_direct').value,
                        lot_number: document.getElementById('bullet_lot_direct').value,
                        production_date: document.getElementById('bullet_production_direct').value || null,
                        purchase_date: document.getElementById('bullet_purchase_direct').value || null,
                        muzzle_velocity: parseFloat(document.getElementById('bullet_velocity_direct').value) || null,
                        muzzle_energy: parseFloat(document.getElementById('bullet_energy_direct').value) || null
                    };

                    const { error } = await supabase
                        .from('bullet_library')
                        .insert([bulletData]);

                    if (error) {
                        alert('Error saving bullet: ' + error.message);
                        return;
                    }

                    alert('Bullet saved successfully!');
                    await loadBulletLibraryDirect();
                } catch (e) {
                    alert('Error saving bullet. Please try again.');
                }
            };

            window.deleteBulletDirect = async function(bulletId) {
                if (confirm('Are you sure you want to delete this bullet?')) {
                    try {
                        const { error } = await supabase
                            .from('bullet_library')
                            .delete()
                            .eq('id', bulletId);

                        if (error) {
                            alert('Error deleting bullet: ' + error.message);
                            return;
                        }

                        alert('Bullet deleted successfully!');
                        await loadBulletLibraryDirect();
                    } catch (e) {
                        alert('Error deleting bullet. Please try again.');
                    }
                }
            };

            window.editBulletDirect = async function(bulletId) {
                try {
                    // Get the bullet data
                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('id', bulletId)
                        .single();

                    if (error) {
                        alert('Error loading bullet data: ' + error.message);
                        return;
                    }

                    const content = document.getElementById('bulletLibraryContent');
                    content.innerHTML = `
                        <div style="background-color: white; padding: 20px; border-radius: 5px; border: 1px solid #ddd; margin-top: 15px;">
                            <h3>Edit Bullet</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Manufacturer Name:</label>
                                <input type="text" id="edit_bullet_manufacturer" value="${data.manufacturer_name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Caliber:</label>
                                <input type="text" id="edit_bullet_caliber" value="${data.caliber}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Grain Weight:</label>
                                <input type="number" id="edit_bullet_grain" value="${data.grain}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Ballistic Coefficient:</label>
                                <input type="number" step="0.001" id="edit_bullet_bc" value="${data.ballistic_coefficient}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Drag Model:</label>
                                <select id="edit_bullet_drag" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="G1" ${data.drag_model === 'G1' ? 'selected' : ''}>G1</option>
                                    <option value="G7" ${data.drag_model === 'G7' ? 'selected' : ''}>G7</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Bullet Type:</label>
                                <select id="edit_bullet_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Select bullet type...</option>
                                    <option value="FMJ" ${data.bullet_type === 'FMJ' ? 'selected' : ''}>FMJ</option>
                                    <option value="JHP" ${data.bullet_type === 'JHP' ? 'selected' : ''}>JHP</option>
                                    <option value="Soft Point" ${data.bullet_type === 'Soft Point' ? 'selected' : ''}>Soft Point</option>
                                    <option value="TMJ" ${data.bullet_type === 'TMJ' ? 'selected' : ''}>TMJ</option>
                                    <option value="Frangible" ${data.bullet_type === 'Frangible' ? 'selected' : ''}>Frangible</option>
                                    <option value="WC" ${data.bullet_type === 'WC' ? 'selected' : ''}>WC</option>
                                    <option value="SWC" ${data.bullet_type === 'SWC' ? 'selected' : ''}>SWC</option>
                                    <option value="AP" ${data.bullet_type === 'AP' ? 'selected' : ''}>AP</option>
                                    <option value="Subsonic" ${data.bullet_type === 'Subsonic' ? 'selected' : ''}>Subsonic</option>
                                    <option value="GT" ${data.bullet_type === 'GT' ? 'selected' : ''}>GT</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Lot Number:</label>
                                <input type="text" id="edit_bullet_lot" value="${data.lot_number || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Production Date:</label>
                                <input type="date" id="edit_bullet_production" value="${data.production_date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Purchase Date:</label>
                                <input type="date" id="edit_bullet_purchase" value="${data.purchase_date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Muzzle Velocity (fps):</label>
                                <input type="number" id="edit_bullet_velocity" value="${data.muzzle_velocity || ''}" placeholder="e.g. 3020" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">Muzzle Energy (ft-lbs):</label>
                                <input type="number" id="edit_bullet_energy" value="${data.muzzle_energy || ''}" placeholder="e.g. 1255" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="updateBulletDirect(${bulletId})" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Update Bullet</button>
                                <button onclick="loadBulletLibraryDirect()" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    alert('Error loading bullet data. Please try again.');
                }
            };

            window.updateBulletDirect = async function(bulletId) {
                try {
                    const bulletData = {
                        manufacturer_name: document.getElementById('edit_bullet_manufacturer').value,
                        caliber: document.getElementById('edit_bullet_caliber').value,
                        grain: parseInt(document.getElementById('edit_bullet_grain').value),
                        ballistic_coefficient: parseFloat(document.getElementById('edit_bullet_bc').value),
                        drag_model: document.getElementById('edit_bullet_drag').value,
                        bullet_type: document.getElementById('edit_bullet_type').value,
                        lot_number: document.getElementById('edit_bullet_lot').value,
                        production_date: document.getElementById('edit_bullet_production').value || null,
                        purchase_date: document.getElementById('edit_bullet_purchase').value || null,
                        muzzle_velocity: parseFloat(document.getElementById('edit_bullet_velocity').value) || null,
                        muzzle_energy: parseFloat(document.getElementById('edit_bullet_energy').value) || null
                    };

                    const { error } = await supabase
                        .from('bullet_library')
                        .update(bulletData)
                        .eq('id', bulletId);

                    if (error) {
                        alert('Error updating bullet: ' + error.message);
                        return;
                    }

                    alert('Bullet updated successfully!');
                    await loadBulletLibraryDirect();
                } catch (e) {
                    alert('Error updating bullet. Please try again.');
                }
            };

            window.toggleSelectAll = function() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const bulletCheckboxes = document.querySelectorAll('.bullet-checkbox');
                
                bulletCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            };

            window.selectAllBullets = function() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const bulletCheckboxes = document.querySelectorAll('.bullet-checkbox');
                
                const allChecked = Array.from(bulletCheckboxes).every(cb => cb.checked);
                
                bulletCheckboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                
                selectAllCheckbox.checked = !allChecked;
            };

            window.deleteSelectedBullets = async function() {
                const selectedCheckboxes = document.querySelectorAll('.bullet-checkbox:checked');
                
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one bullet to delete.');
                    return;
                }

                const bulletCount = selectedCheckboxes.length;
                const confirmMessage = bulletCount === 1 
                    ? 'Are you sure you want to delete the selected bullet?' 
                    : `Are you sure you want to delete ${bulletCount} selected bullets?`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    const bulletIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                    
                    const { error } = await supabase
                        .from('bullet_library')
                        .delete()
                        .in('id', bulletIds);

                    if (error) {
                        alert('Error deleting bullets: ' + error.message);
                        return;
                    }

                    const successMessage = bulletCount === 1 
                        ? 'Bullet deleted successfully!' 
                        : `${bulletCount} bullets deleted successfully!`;
                    
                    alert(successMessage);
                    await loadBulletLibraryDirect();
                } catch (e) {
                    alert('Error deleting bullets. Please try again.');
                }
            };

            window.loadBulletLibrary = async function() {
                try {
                    console.log('Loading bullet library, currentUser:', currentUser);
                    
                    if (!currentUser) {
                        console.log('No current user available');
                        return;
                    }

                    const { data, error } = await supabase
                        .from('bullet_library')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('manufacturer_name', { ascending: true });

                    console.log('Bullet library query result:', { data, error });

                    if (error) {
                        console.error('Error loading bullets:', error);
                        return;
                    }

                    const tableBody = document.getElementById('bulletTableBody');
                    const table = document.getElementById('bulletTable');
                    const noMessage = document.getElementById('noBulletsMessage');

                    console.log('Found', data ? data.length : 0, 'bullets');
                    console.log('Table element:', table);
                    console.log('NoMessage element:', noMessage);

                    if (data && data.length > 0) {
                        console.log('Showing table and hiding no-message');
                        table.style.display = 'table';
                        noMessage.style.display = 'none';
                        
                        tableBody.innerHTML = '';
                        data.forEach(bullet => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${bullet.manufacturer_name}</td>
                                <td>${bullet.caliber}</td>
                                <td>${bullet.grain}</td>
                                <td>${bullet.ballistic_coefficient}</td>
                                <td>${bullet.drag_model}</td>
                                <td>${bullet.bullet_type}</td>
                                <td>
                                    <button onclick="deleteBullet(${bullet.id})" class="back-to-login" style="padding: 4px 8px; margin: 2px;">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        table.style.display = 'none';
                        noMessage.style.display = 'block';
                    }
                } catch (e) {
                    console.error('Error loading bullet library:', e);
                }
            };

            window.deleteBullet = async function(bulletId) {
                if (!confirm('Are you sure you want to delete this bullet?')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('bullet_library')
                        .delete()
                        .eq('id', bulletId)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error deleting bullet:', error);
                        alert('Error deleting bullet. Please try again.');
                    } else {
                        await loadBulletLibrary();
                    }
                } catch (e) {
                    console.error('Error:', e);
                    alert('Error deleting bullet. Please try again.');
                }
            };
        });

        // DOPE Engagement View and Edit Functions
        window.viewDopeEngagement = async function(engagementId) {
            try {
                console.log('Loading engagement:', engagementId);
                
                // Fetch the engagement data
                const { data: engagement, error: engagementError } = await window.supabaseClient
                    .from('dope_engagements')
                    .select('*')
                    .eq('id', engagementId)
                    .single();

                if (engagementError) {
                    console.error('Error loading engagement:', engagementError);
                    alert('Error loading engagement details: ' + engagementError.message);
                    return;
                }

                console.log('Engagement data loaded:', engagement);
                
                // Fetch linked firearm profile data if available
                let firearmData = null;
                if (engagement.firearm_profile_id) {
                    console.log('Fetching firearm profile with ID:', engagement.firearm_profile_id);
                    
                    const { data: profileData, error: profileError } = await window.supabaseClient
                        .from('firearm_profile')
                        .select('*')
                        .eq('id', engagement.firearm_profile_id)
                        .single();
                    
                    if (!profileError && profileData) {
                        firearmData = profileData;
                        console.log('Found firearm data in firearm_profile:', firearmData);
                    }
                }

                // Fetch linked bullet data if available
                let bulletData = null;
                if (engagement.bullet_library_id) {
                    console.log('Fetching bullet data with ID:', engagement.bullet_library_id);
                    const { data: bulletInfo, error: bulletError } = await window.supabaseClient
                        .from('bullet_library')
                        .select('*')
                        .eq('id', engagement.bullet_library_id)
                        .single();
                    
                    if (!bulletError && bulletInfo) {
                        bulletData = bulletInfo;
                        console.log('Found bullet data:', bulletData);
                    }
                }

                // Combine all data for display
                const data = {
                    ...engagement,
                    // Add firearm data with correct field names from firearm_profile table
                    shooter_name: firearmData?.shooter_name,
                    firearm_type: firearmData?.firearm_type,
                    firearm_name: firearmData?.firearm_name,
                    rifle_caliber: firearmData?.caliber,
                    barrel_length: firearmData?.barrel_length,
                    barrel_twist_rate: firearmData?.barrel_twist_rate,
                    optic_name: firearmData?.optic_name,
                    zero_distance: firearmData?.zero_distance,
                    height_over_bore: firearmData?.height_over_bore,
                    adjustment_units: engagement?.optic_adjustment_units,
                    // Add bullet data
                    bullet_manufacturer_name: bulletData?.manufacturer_name,
                    bullet_caliber: bulletData?.caliber,
                    bullet_grain_weight: bulletData?.grain,
                    bullet_ballistic_coefficient: bulletData?.ballistic_coefficient,
                    bullet_drag_model: bulletData?.drag_model,
                    bullet_type: bulletData?.bullet_type,
                    bullet_lot_number: bulletData?.lot_number,
                    bullet_muzzle_velocity: bulletData?.muzzle_velocity,
                    bullet_muzzle_energy: bulletData?.muzzle_energy
                };

                console.log('Combined data for display:', data);

                const modalHTML = `
                    <div id="viewEngagementModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 900px; max-height: 90vh; overflow-y: auto; width: 95%;">
                            <h3 style="text-align: center; margin-bottom: 25px; color: #333;">DOPE Engagement Details</h3>
                            
                            <!-- 1. Shooter Information -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
                                <h4 style="margin: 0 0 10px 0; color: #007bff;">1. Shooter Information</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Shooter Name:</strong> ${data.shooter_name || (data.shooting_profile_id ? 'Linked to Profile' : 'Not specified')}</div>
                                </div>
                            </div>

                            <!-- 2. Firearm and Optics -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
                                <h4 style="margin: 0 0 10px 0; color: #28a745;">2. Firearm and Optics</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Firearm Type:</strong> ${data.firearm_type || 'Not specified'}</div>
                                    <div><strong>Firearm Name:</strong> ${data.firearm_name || 'Not specified'}</div>
                                    <div><strong>Rifle Caliber:</strong> ${data.rifle_caliber || 'Not specified'}</div>
                                    <div><strong>Barrel Length:</strong> ${data.barrel_length || 'Not specified'}</div>
                                    <div><strong>Barrel Twist Rate:</strong> ${data.barrel_twist_rate || 'Not specified'}</div>
                                    <div><strong>Optic Name:</strong> ${data.optic_name || 'Not specified'}</div>
                                    <div><strong>Optic Magnification:</strong> ${data.optic_magnification || 'Not specified'}</div>
                                    <div><strong>Zero Distance:</strong> ${data.zero_distance || 'Not specified'}</div>
                                    <div><strong>Height over Bore:</strong> ${data.height_over_bore || 'Not specified'}</div>
                                    <div><strong>Adjustment Units:</strong> ${data.adjustment_units || 'Not specified'}</div>
                                    <div><strong>Parallax Setting:</strong> ${data.parallax_setting || 'Not specified'}</div>
                                    <div><strong>Barrel Condition:</strong> ${data.barrel_condition || 'Not specified'}</div>
                                </div>
                            </div>

                            <!-- 3. Bullet and Ballistics -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <h4 style="margin: 0 0 10px 0; color: #ffc107;">3. Bullet and Ballistics</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Bullet Manufacturer:</strong> ${data.bullet_manufacturer_name || (data.bullet_library_id ? 'Linked to Library' : 'Not specified')}</div>
                                    <div><strong>Bullet Caliber:</strong> ${data.bullet_caliber || 'Not specified'}</div>
                                    <div><strong>Bullet Grain Weight:</strong> ${data.bullet_grain_weight || 'Not specified'}</div>
                                    <div><strong>Ballistic Coefficient:</strong> ${data.bullet_ballistic_coefficient || 'Not specified'}</div>
                                    <div><strong>Drag Model:</strong> ${data.bullet_drag_model || 'Not specified'}</div>
                                    <div><strong>Bullet Type:</strong> ${data.bullet_type || 'Not specified'}</div>
                                    <div><strong>Lot Number:</strong> ${data.bullet_lot_number || 'Not specified'}</div>
                                    <div><strong>Muzzle Velocity:</strong> ${data.bullet_muzzle_velocity || 'Not specified'}</div>
                                    <div><strong>Muzzle Energy:</strong> ${data.bullet_muzzle_energy || 'Not specified'}</div>
                                </div>
                            </div>

                            <!-- 4. Environmental Conditions -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #17a2b8;">
                                <h4 style="margin: 0 0 10px 0; color: #17a2b8;">4. Environmental Conditions</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Temperature:</strong> ${data.temperature !== null ? `${data.temperature}°${data.temperature_unit || 'F'}` : 'N/A'}</div>
                                    <div><strong>Humidity:</strong> ${data.humidity ? `${data.humidity}%` : 'N/A'}</div>
                                    <div><strong>Barometric Pressure:</strong> ${data.barometric_pressure ? `${data.barometric_pressure} ${data.pressure_unit || 'inHg'}` : 'N/A'}</div>
                                    <div><strong>Altitude:</strong> ${data.altitude ? `${data.altitude} ${data.altitude_reference || 'ASL'}` : 'N/A'}</div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <div><strong>Atmospheric Conditions:</strong> ${data.atmospheric_conditions || 'N/A'}</div>
                                    <div style="margin-top: 5px;"><strong>Light Conditions:</strong> ${data.light_conditions || 'N/A'}</div>
                                </div>
                            </div>

                            <!-- 5. Wind and External Forces -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #dc3545;">
                                <h4 style="margin: 0 0 10px 0; color: #dc3545;">5. Wind and External Forces</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Wind Speed:</strong> ${data.wind_speed || 'N/A'}</div>
                                    <div><strong>Wind Direction:</strong> ${data.wind_direction || 'N/A'}</div>
                                    <div><strong>Wind Type:</strong> ${data.wind_type || 'N/A'}</div>
                                    <div><strong>Coriolis Effect:</strong> ${data.coriolis_effect || 'N/A'}</div>
                                    <div><strong>Spin Drift:</strong> ${data.spin_drift || 'N/A'}</div>
                                </div>
                            </div>

                            <!-- 6. Engagement Details -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #6f42c1;">
                                <h4 style="margin: 0 0 10px 0; color: #6f42c1;">6. Engagement Details</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div><strong>Engagement Date:</strong> ${data.engagement_date || 'N/A'}</div>
                                    <div><strong>Engagement Time:</strong> ${data.engagement_time || 'N/A'}</div>
                                    <div><strong>Location Name:</strong> ${data.location_name || 'N/A'}</div>
                                    <div><strong>Latitude:</strong> ${data.latitude ? `${data.latitude}° ${data.latitude_direction || 'N'}` : 'N/A'}</div>
                                    <div><strong>Longitude:</strong> ${data.longitude ? `${data.longitude}° ${data.longitude_direction || 'W'}` : 'N/A'}</div>
                                    <div><strong>Range to Target:</strong> ${data.range_to_target ? `${data.range_to_target} ${data.range_unit || 'yards'}` : 'N/A'}</div>
                                    <div><strong>Angle of Fire:</strong> ${data.angle_of_fire || 'N/A'}</div>
                                    <div><strong>Target Speed:</strong> ${data.target_movement_speed || 'N/A'}</div>
                                    <div><strong>Target Direction:</strong> ${data.target_movement_direction || 'N/A'}</div>
                                    <div><strong>Time of Flight:</strong> ${data.time_of_flight || 'N/A'}</div>
                                </div>
                            </div>

                            <!-- 7. Outcome and Notes -->
                            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #fd7e14;">
                                <h4 style="margin: 0 0 10px 0; color: #fd7e14;">7. Outcome and Notes</h4>
                                <div style="margin-bottom: 10px;">
                                    <strong>Engagement Outcome:</strong><br>
                                    <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
                                        ${data.engagement_outcome || 'N/A'}
                                    </div>
                                </div>
                                <div>
                                    <strong>Engagement Notes:</strong><br>
                                    <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px; min-height: 60px;">
                                        ${data.notes || 'N/A'}
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 25px;">
                                <button onclick="closeViewModal()" style="background-color: #6c757d; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            } catch (error) {
                console.error('Error in viewDopeEngagement:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error loading engagement details: ' + (error.message || 'Unknown error'));
            }
        };

        window.editDopeEngagement = async function(engagementId) {
            try {
                // Use the globally accessible supabase client
                const { data, error } = await window.supabaseClient
                    .from('dope_engagements')
                    .select('*')
                    .eq('id', engagementId)
                    .single();

                if (error) {
                    console.error('Error loading engagement:', error);
                    alert('Error loading engagement for editing.');
                    return;
                }

                // Store the editing ID
                window.editingEngagementId = engagementId;
                
                // Show the form
                showAddDopeFormDirect();
                
                // Pre-fill the form with existing data
                setTimeout(() => {
                    if (document.getElementById('engagement_date')) document.getElementById('engagement_date').value = data.engagement_date || '';
                    if (document.getElementById('engagement_time')) document.getElementById('engagement_time').value = data.engagement_time || '';
                    if (document.getElementById('range_to_target')) document.getElementById('range_to_target').value = data.range_to_target || '';
                    if (document.getElementById('range_unit')) document.getElementById('range_unit').value = data.range_unit || 'yards';
                    if (document.getElementById('wind_speed')) document.getElementById('wind_speed').value = data.wind_speed || '';
                    if (document.getElementById('wind_direction')) document.getElementById('wind_direction').value = data.wind_direction || '';
                    if (document.getElementById('wind_type')) document.getElementById('wind_type').value = data.wind_type || '';
                    if (document.getElementById('temperature')) document.getElementById('temperature').value = data.temperature || '';
                    if (document.getElementById('temperature_unit')) document.getElementById('temperature_unit').value = data.temperature_unit || 'F';
                    if (document.getElementById('engagement_outcome')) document.getElementById('engagement_outcome').value = data.engagement_outcome || '';
                    if (document.getElementById('engagement_notes')) document.getElementById('engagement_notes').value = data.notes || '';
                    
                    // Update save button for editing
                    const saveButton = document.querySelector('button[onclick="saveDopeEngagement()"]');
                    if (saveButton) {
                        saveButton.textContent = 'Update Engagement';
                        saveButton.style.backgroundColor = '#ffc107';
                    }
                }, 100);

            } catch (error) {
                console.error('Error:', error);
                alert('Error loading engagement for editing.');
            }
        };

        window.closeViewModal = function() {
            const modal = document.getElementById('viewEngagementModal');
            if (modal) {
                modal.remove();
            }
        };

        
        // Fix button text and form carryover issues
        function fixButtonTextAndCleanup() {
            // Fix question mark characters in ALL home buttons across the site
            const allHomeButtons = document.querySelectorAll('button');
            allHomeButtons.forEach(button => {
                let text = button.innerHTML;
                
                // Fix Home buttons specifically (look for the 🏠 icon and ? patterns)
                if (text.includes('🏠') && text.includes('?')) {
                    button.innerHTML = text.replace(/\?\s*/g, '🏠 ');
                }
                if (text.includes('Home') && text.includes('?')) {
                    button.innerHTML = text.replace(/\?\s*Home/g, '🏠 Home');
                }
                
                // Fix main navigation buttons
                if (text.includes('Shooting Profile') || text.includes('? Shooting')) {
                    button.innerHTML = text.replace(/\?\s*Shooting Profile/g, '📊 Zero Profile').replace(/\?\s*Shooting/g, '📊 Zero');
                }
                if (text.includes('Bullet Library') || text.includes('? Bullet')) {
                    button.innerHTML = text.replace(/\?\s*Bullet Library/g, '🎯 Bullet Library').replace(/\?\s*Bullet/g, '🎯 Bullet');
                }
                if (text.includes('DOPE') && text.includes('?')) {
                    button.innerHTML = text.replace(/\?\s*DOPE/g, '📋 DOPE');
                }
                
                // Force specific onclick-based replacements
                if (button.onclick) {
                    const onclickStr = button.onclick.toString();
                    if (onclickStr.includes('showZeroProfile')) {
                        button.innerHTML = button.innerHTML.replace(/^[^a-zA-Z]*/, '📊 ').replace('Shooting Profile', 'Zero Profile');
                    }
                    if (onclickStr.includes('showBulletLibrary')) {
                        button.innerHTML = button.innerHTML.replace(/^[^a-zA-Z]*/, '🎯 ');
                    }
                    if (onclickStr.includes('showDOPE')) {
                        button.innerHTML = button.innerHTML.replace(/^[^a-zA-Z]*/, '📋 ');
                    }
                    if (onclickStr.includes('showHomePage')) {
                        button.innerHTML = button.innerHTML.replace(/\?\s*/g, '🏠 ');
                    }
                }
            });
        }
        
        // Reliable showHomePage function
        window.showHomePage = function() {
            // Hide all other sections first
            const sections = ['shootingProfileSection', 'firearmLibrarySection', 'dopeSection', 'bulletLibrarySection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Remove the specific dynamic content that gets added by library functions
            const dynamicIds = ['activeFirearmLibrary', 'activeBulletLibrary', 'activeDopeSection', 'activeSetupSection'];
            dynamicIds.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            
            // Show home page
            const homePage = document.getElementById('homePage');
            if (homePage) {
                homePage.style.display = 'block';
            }
            
            // Fix button text after a brief delay
            setTimeout(fixButtonTextAndCleanup, 50);
        };
        
        // Reorganize home page buttons in the requested order
        function reorganizeHomeButtons() {
            const buttonContainer = document.querySelector('#homePage .home-nav-button').parentElement;
            const buttons = Array.from(buttonContainer.querySelectorAll('.home-nav-button'));
            
            // Find buttons by their onclick functions
            let firearmBtn, bulletBtn, zeroBtn, dopeBtn, setupBtn, adminBtn;
            
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes('showFirearmLibrary')) firearmBtn = btn;
                else if (onclick && onclick.includes('showBulletLibrary')) bulletBtn = btn;
                else if (onclick && onclick.includes('showZeroProfile')) zeroBtn = btn;
                else if (onclick && onclick.includes('showDOPE')) dopeBtn = btn;
                else if (onclick && onclick.includes('showSetup')) setupBtn = btn;
                else if (onclick && onclick.includes('showAdminPanel')) adminBtn = btn;
            });
            
            // Remove all buttons
            buttons.forEach(btn => btn.remove());
            
            // Add them back in the correct order: Firearm, Bullet, Zero, DOPE, Setup, Admin
            if (firearmBtn) buttonContainer.appendChild(firearmBtn);
            if (bulletBtn) buttonContainer.appendChild(bulletBtn);
            if (zeroBtn) buttonContainer.appendChild(zeroBtn);
            if (dopeBtn) buttonContainer.appendChild(dopeBtn);
            if (setupBtn) buttonContainer.appendChild(setupBtn);
            if (adminBtn) buttonContainer.appendChild(adminBtn);
        }
        
        // Run fixes on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                fixButtonTextAndCleanup();
                reorganizeHomeButtons();
            }, 100);
        });
        
        // Also run when page becomes visible (for navigation)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(fixButtonTextAndCleanup, 100);
            }
        });
        
        // Run periodically to catch any missed updates
        setInterval(fixButtonTextAndCleanup, 2000);
        
        // Trajectory Graph Functions
        let currentTrajectoryData = null;
        let currentComparisonData = null;
        
        window.showTrajectoryGraph = function() {
            const modal = document.getElementById('trajectoryGraphModal');
            const canvas = document.getElementById('trajectoryCanvas');
            const ctx = canvas.getContext('2d');
            const title = document.getElementById('graphTitle');
            const legend = document.getElementById('graphLegend');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (currentComparisonData && currentComparisonData.length > 0) {
                title.textContent = 'Trajectory Comparison Graph';
                drawComparisonGraph(ctx, canvas, currentComparisonData);
                createComparisonLegend(legend, currentComparisonData);
            } else if (currentTrajectoryData) {
                title.textContent = 'Trajectory Graph';
                drawSingleTrajectory(ctx, canvas, currentTrajectoryData);
                createSingleLegend(legend, currentTrajectoryData);
            }
            
            modal.style.display = 'block';
        };
        
        window.closeTrajectoryGraph = function() {
            document.getElementById('trajectoryGraphModal').style.display = 'none';
        };
        
        function drawSingleTrajectory(ctx, canvas, data) {
            const padding = 60;
            const graphWidth = canvas.width - 2 * padding;
            const graphHeight = canvas.height - 2 * padding;
            
            // Find data ranges
            const maxDistance = Math.max(...data.map(p => parseFloat(p.distance_yd)));
            const minHold = Math.min(...data.map(p => parseFloat(p.hold_in)));
            const maxHold = Math.max(...data.map(p => parseFloat(p.hold_in)));
            const holdRange = Math.max(Math.abs(minHold), Math.abs(maxHold)) * 1.1;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Draw line of sight (horizontal line at y=0)
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            const zeroY = canvas.height - padding - (graphHeight / 2);
            ctx.beginPath();
            ctx.moveTo(padding, zeroY);
            ctx.lineTo(canvas.width - padding, zeroY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw trajectory
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((point, index) => {
                const x = padding + (parseFloat(point.distance_yd) / maxDistance) * graphWidth;
                // Flip the y-axis calculation - positive hold values should be above line of sight
                const y = zeroY + (parseFloat(point.hold_in) / holdRange) * (graphHeight / 2);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw data points
            ctx.fillStyle = '#dc3545';
            data.forEach(point => {
                const x = padding + (parseFloat(point.distance_yd) / maxDistance) * graphWidth;
                // Flip the y-axis calculation for data points too
                const y = zeroY + (parseFloat(point.hold_in) / holdRange) * (graphHeight / 2);
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            drawAxesLabels(ctx, canvas, maxDistance, holdRange, padding);
        }
        
        function drawComparisonGraph(ctx, canvas, sessions) {
            const padding = 60;
            const graphWidth = canvas.width - 2 * padding;
            const graphHeight = canvas.height - 2 * padding;
            const colors = ['#dc3545', '#007bff', '#28a745', '#ffc107', '#17a2b8'];
            
            // Find global ranges across all sessions
            let maxDistance = 0;
            let minHold = 0;
            let maxHold = 0;
            
            sessions.forEach(session => {
                if (session.results_grid) {
                    maxDistance = Math.max(maxDistance, ...session.results_grid.map(p => parseFloat(p.distance_yd)));
                    minHold = Math.min(minHold, ...session.results_grid.map(p => parseFloat(p.hold_in)));
                    maxHold = Math.max(maxHold, ...session.results_grid.map(p => parseFloat(p.hold_in)));
                }
            });
            
            const holdRange = Math.max(Math.abs(minHold), Math.abs(maxHold)) * 1.1;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Draw line of sight
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            const zeroY = canvas.height - padding - (graphHeight / 2);
            ctx.beginPath();
            ctx.moveTo(padding, zeroY);
            ctx.lineTo(canvas.width - padding, zeroY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw each trajectory
            sessions.forEach((session, sessionIndex) => {
                if (!session.results_grid) return;
                
                const color = colors[sessionIndex % colors.length];
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                session.results_grid.forEach((point, index) => {
                    const x = padding + (parseFloat(point.distance_yd) / maxDistance) * graphWidth;
                    // Flip the y-axis calculation for comparison graph
                    const y = zeroY + (parseFloat(point.hold_in) / holdRange) * (graphHeight / 2);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw data points
                ctx.fillStyle = color;
                session.results_grid.forEach(point => {
                    const x = padding + (parseFloat(point.distance_yd) / maxDistance) * graphWidth;
                    // Flip the y-axis calculation for comparison data points
                    const y = zeroY + (parseFloat(point.hold_in) / holdRange) * (graphHeight / 2);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
            });
            
            drawAxesLabels(ctx, canvas, maxDistance, holdRange, padding);
        }
        
        function drawAxesLabels(ctx, canvas, maxDistance, holdRange, padding) {
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // X-axis labels (distance)
            for (let i = 0; i <= 5; i++) {
                const distance = (maxDistance / 5) * i;
                const x = padding + (i / 5) * (canvas.width - 2 * padding);
                const y = canvas.height - padding + 20;
                ctx.fillText(Math.round(distance) + ' yd', x, y);
            }
            
            // Y-axis labels (hold)
            const zeroY = canvas.height - padding - ((canvas.height - 2 * padding) / 2);
            for (let i = -2; i <= 2; i++) {
                const hold = (holdRange / 2) * i;
                // Flip the y-axis labels to match corrected graph orientation
                const y = zeroY + (i / 2) * ((canvas.height - 2 * padding) / 2);
                const x = padding - 10;
                ctx.textAlign = 'right';
                ctx.fillText(hold.toFixed(1) + '"', x, y + 4);
            }
            
            // Axis titles
            ctx.textAlign = 'center';
            ctx.font = '14px Arial';
            ctx.fillText('Distance (yards)', canvas.width / 2, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Hold Adjustment (inches)', 0, 0);
            ctx.restore();
            
            // Line of sight label
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Line of Sight', padding + 10, zeroY - 5);
        }
        
        function createSingleLegend(legend, data) {
            const sessionInfo = data.sessionInfo || {};
            legend.innerHTML = `
                <div style="display: inline-block; margin-right: 20px;">
                    <span style="display: inline-block; width: 20px; height: 3px; background-color: #dc3545; margin-right: 5px;"></span>
                    ${sessionInfo.firearm_name || 'Trajectory'} - ${sessionInfo.caliber || ''} ${sessionInfo.bullet_grain || ''}gr
                </div>
                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    Zero: ${sessionInfo.zero_distance || 'N/A'} yards | BC: ${sessionInfo.ballistic_coefficient || 'N/A'} | MV: ${sessionInfo.muzzle_velocity || 'N/A'} fps
                </div>
            `;
        }
        
        function createComparisonLegend(legend, sessions) {
            const colors = ['#dc3545', '#007bff', '#28a745', '#ffc107', '#17a2b8'];
            let html = '<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">';
            
            sessions.forEach((session, index) => {
                const color = colors[index % colors.length];
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="display: flex; align-items: center;">
                            <span style="display: inline-block; width: 20px; height: 3px; background-color: ${color}; margin-right: 5px;"></span>
                            <span style="font-size: 12px;">${session.firearm_name || 'Session ' + (index + 1)} - ${session.caliber || ''} ${session.bullet_grain || ''}gr</span>
                        </div>
                        <div style="font-size: 10px; color: #666; margin-top: 2px;">
                            Zero: ${session.zero_distance || 'N/A'} yards | BC: ${session.ballistic_coefficient || 'N/A'} | MV: ${session.muzzle_velocity || 'N/A'} fps
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            legend.innerHTML = html;
        }

        // Initialize pending shares check when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Check for pending shares after a delay to allow authentication
            setTimeout(async () => {
                if (window.currentUser && window.supabaseClient) {
                    console.log('Auto-checking for pending shares for user:', window.currentUser.email);
                    try {
                        await checkAndAcceptPendingShares();
                    } catch (error) {
                        console.error('Error in auto-check for pending shares:', error);
                    }
                }
            }, 3000);
        });

        // Also trigger share check when bullet library loads
        const originalLoadBulletLibraryDirect = window.loadBulletLibraryDirect;
        window.loadBulletLibraryDirect = async function() {
            // Check for pending shares before loading library
            if (window.currentUser && window.supabaseClient) {
                try {
                    await checkAndAcceptPendingShares();
                } catch (error) {
                    console.error('Error checking shares before library load:', error);
                }
            }
            // Call original function
            return originalLoadBulletLibraryDirect.call(this);
        };
        
    </script>
    
    <!-- Trajectory Graph Modal -->
    <div id="trajectoryGraphModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
        <div style="background: white; margin: 20px; border-radius: 8px; padding: 20px; max-width: 1200px; margin: 20px auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="graphTitle">Trajectory Graph</h3>
                <button onclick="closeTrajectoryGraph()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
            <canvas id="trajectoryCanvas" width="1000" height="600" style="border: 1px solid #ddd; width: 100%; max-width: 1000px;"></canvas>
            <div id="graphLegend" style="margin-top: 15px; text-align: center; font-size: 14px;"></div>
        </div>
    </div>
</body>
</html>